
–í—ã —Å–∫–∞–∑–∞–ª–∏:
–ø—Ä–∏–≤–µ—Ç, —Å–¥–µ–ª–∞–π —Ç–∞–∫, —á—Ç–æ–±—ã –∫–∞—Ä—Ç–∏–Ω–∫–∏ –∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –≤ —Ü–µ–ª–æ–º –ø–æ–¥–≥—Ä—É–∂–∞–ª–∏—Å—å –ø–æ –æ–¥–Ω–æ–º—É, –ø–ª–∞–≤–Ω–æ, –≤—ã–ø–∏—à–∏ –≤–µ—Å—å –∫–æ–¥

ChatGPT —Å–∫–∞–∑–∞–ª:

–î—É–º–∞–ª –Ω–∞ –ø—Ä–æ—Ç—è–∂–µ–Ω–∏–∏ 5m 32s
–û–∫ ‚Äî —Å–¥–µ–ª–∞–ª –ø–ª–∞–≤–Ω—É—é –ø–æ–¥–≥—Ä—É–∑–∫—É ‚Äú–ø–æ –æ–¥–Ω–æ–º—É‚Äù –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π + –ø–ª–∞–≤–Ω—É—é (–ª–µ–Ω–∏–≤—É—é) –∑–∞–≥—Ä—É–∑–∫—É –∫–∞—Ä—Ç–∏–Ω–æ–∫ (—Å–∫–µ–ª–µ—Ç ‚Üí fade-in, –≥—Ä—É–∑–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –∫–∞—Ä—Ç–æ—á–∫–∞ –±–ª–∏–∑–∫–æ –∫ —ç–∫—Ä–∞–Ω—É).

–ù–∏–∂–µ –≤–µ—Å—å –∫–æ–¥ —Ñ–∞–π–ª–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –º–µ–Ω—è–ª:

HomeView.vue (–ø–æ–ª–Ω–æ—Å—Ç—å—é)
<template>
  <div class="page">
    <div class="container">
      <!-- TAGS WRAP -->
      <div class="tags-shell">
        <div class="tags-title">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</div>
        <div class="tags-content">
          <button
            v-for="cat in categories"
            :key="cat.id"
            class="tag-btn"
            :class="{ active: selectedCategories.includes(cat.id) }"
            @click="toggleCategory(cat.id)"
          >
            {{ cat.name }}
          </button>

          <button v-if="selectedCategories.length" class="tag-btn clear" @click="clearCategories">
            –°–±—Ä–æ—Å–∏—Ç—å
          </button>
        </div>
      </div>

      <!-- STATES -->
      <div v-if="!initialLoaded" class="state">
        <div class="spinner"></div>
        <div>–ó–∞–≥—Ä—É–∑–∫–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π‚Ä¶</div>
      </div>

      <div v-else-if="error" class="state error">
        <div class="error-title">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</div>
        <div class="error-sub">{{ error }}</div>
        <button class="retry" @click="reload">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
      </div>

      <div v-else-if="filteredEvents.length === 0" class="state">–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>

      <!-- EVENTS LIST (ROW / COLUMN) -->
      <div v-else class="events-shell">
        <div class="events-title">
          –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
          <span class="events-count">{{ filteredEvents.length }}</span>

          <span v-if="progressiveLoading" class="events-progress">–ø–æ–¥–≥—Ä—É–∂–∞—é‚Ä¶</span>
        </div>

        <TransitionGroup name="list" tag="div" class="events-list">
          <EventCard
            v-for="event in filteredEvents"
            :key="event.id"
            :event="event"
            :photos="photos[event.id] || []"
            :photos-loading="photosLoading"
            :category-map="categoryMap"
            @open-photo="openPhoto"
          />
        </TransitionGroup>
      </div>
    </div>

    <!-- PHOTO MODAL -->
    <EventPhotoModal v-if="photoModalUrl" :url="photoModalUrl" @close="photoModalUrl = ''" />
  </div>
</template>

<script>
import { ref, computed, onMounted, onBeforeUnmount } from 'vue'
import EventCard from '../../components/EventCard.vue'
import EventPhotoModal from '../../components/EventPhotoModal.vue'
import { useSupabase } from '../../composables/useSupabase'

const sleep = (ms) => new Promise((r) => setTimeout(r, ms))

const withRetry = async (fn, tries = 3) => {
  let lastErr = null
  for (let i = 0; i < tries; i++) {
    try {
      return await fn()
    } catch (e) {
      lastErr = e
      await sleep(350 * (i + 1))
    }
  }
  throw lastErr
}

export default {
  name: 'HomeView',
  components: { EventCard, EventPhotoModal },
  props: {
    globalSearchTerm: { type: String, default: '' }
  },
  setup(props) {
    const { getEvents, getCategories, getEventPhotos } = useSupabase()

    const initialLoaded = ref(false)
    const error = ref(null)

    // –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –ø—Ä–∏—à–µ–¥—à–∏–µ –∏–∑ Supabase
    const allEvents = ref([])

    // —Ç–æ, —á—Ç–æ —É–∂–µ –ø–æ–∫–∞–∑–∞–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (–ø–æ–¥–≥—Ä—É–∂–∞–µ–º –ø–æ –æ–¥–Ω–æ–º—É)
    const visibleEvents = ref([])

    // —Ñ–ª–∞–≥, —á—Ç–æ –º—ã –µ—â—ë ‚Äú–¥–æ–ø–∏—Ö–∏–≤–∞–µ–º‚Äù –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ —Å–ø–∏—Å–æ–∫
    const progressiveLoading = ref(false)

    let progressiveTimer = null

    const photos = ref({})

    const categories = ref([])
    const categoryMap = ref({}) // id -> name

    const selectedCategories = ref([]) // multi-select

    const photosLoading = ref(false)
    const stopPhotosLoading = ref(false)

    const photoModalUrl = ref('')

    const openPhoto = (url) => {
      if (!url) return
      photoModalUrl.value = url
    }

    const toggleCategory = (id) => {
      const idx = selectedCategories.value.indexOf(id)
      if (idx >= 0) selectedCategories.value.splice(idx, 1)
      else selectedCategories.value.push(id)
    }

    const clearCategories = () => {
      selectedCategories.value = []
    }

    const filteredEvents = computed(() => {
      // —Ñ–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ —É–∂–µ –ø–æ–∫–∞–∑–∞–ª–∏ (—á—Ç–æ–±—ã ‚Äú–ø–æ—è–≤–ª—è–ª–æ—Å—å –ø–æ –æ–¥–Ω–æ–º—É‚Äù)
      let list = [...visibleEvents.value]

      // multi-category filter
      if (selectedCategories.value.length) {
        const set = new Set(selectedCategories.value)
        list = list.filter((e) => set.has(e.selectCategory))
      }

      // search
      const term = (props.globalSearchTerm || '').trim().toLowerCase()
      if (term) {
        list = list.filter((e) => {
          const t = (e.title || '').toLowerCase()
          const d = (e.description || '').toLowerCase()
          const a = (e.address || '').toLowerCase()
          const o = (e.organizer || '').toLowerCase()
          return t.includes(term) || d.includes(term) || a.includes(term) || o.includes(term)
        })
      }

      return list
    })

    const stopProgressive = () => {
      progressiveLoading.value = false
      if (progressiveTimer) {
        clearInterval(progressiveTimer)
        progressiveTimer = null
      }
    }

    const startProgressive = (source) => {
      stopProgressive()
      visibleEvents.value = []

      const list = Array.isArray(source) ? source : []
      if (!list.length) return

      progressiveLoading.value = true

      // —á—Ç–æ–±—ã –ø–µ—Ä–≤–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –ø–æ—è–≤–∏–ª–∞—Å—å –ø–æ—á—Ç–∏ —Å—Ä–∞–∑—É
      visibleEvents.value.push(list[0])

      let i = 1
      progressiveTimer = setInterval(() => {
        if (i >= list.length) {
          stopProgressive()
          return
        }
        visibleEvents.value.push(list[i])
        i++
      }, 140)
    }

    const loadCategories = async () => {
      try {
        const { data, error: err } = await withRetry(() => getCategories())
        if (err) throw err

        categories.value = data ?? []
        categoryMap.value = (categories.value || []).reduce((acc, c) => {
          acc[c.id] = c.name
          return acc
        }, {})
      } catch (e) {
        console.warn('Categories load error:', e)
        categories.value = []
        categoryMap.value = {}
      }
    }

    const loadEventsProgressive = async () => {
      error.value = null
      stopPhotosLoading.value = true
      photosLoading.value = false
      stopProgressive()

      try {
        const { data: eventsData, error: eventsErr } = await withRetry(() => getEvents())
        if (eventsErr) throw eventsErr

        allEvents.value = eventsData ?? []
        initialLoaded.value = true

        // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–ª–∞–≤–Ω–æ, –ø–æ –æ–¥–Ω–æ–π
        startProgressive(allEvents.value)

        // background photos
        photos.value = {}
        stopPhotosLoading.value = false

        const ids = allEvents.value.map((e) => e.id).filter(Boolean)
        if (!ids.length) return

        photosLoading.value = true

        const batchSize = 5
        for (let i = 0; i < ids.length; i += batchSize) {
          if (stopPhotosLoading.value) break

          const batch = ids.slice(i, i + batchSize)
          try {
            const { data: ph, error: phErr } = await withRetry(() => getEventPhotos(batch))
            if (phErr) throw phErr

            const next = { ...photos.value }
            for (const p of ph ?? []) {
              if (!p?.event_id) continue
              if (!next[p.event_id]) next[p.event_id] = []
              next[p.event_id].push(p)
            }
            photos.value = next
          } catch (e) {
            console.warn('Photos batch load error:', e)
          }

          await sleep(120)
        }
      } catch (e) {
        console.error('HomeView load error:', e)
        allEvents.value = []
        visibleEvents.value = []
        photos.value = {}
        initialLoaded.value = true
        error.value = e?.message ? String(e.message) : 'TypeError: Failed to fetch'
      } finally {
        photosLoading.value = false
      }
    }

    const reload = async () => {
      await loadEventsProgressive()
    }

    onMounted(async () => {
      await loadCategories()
      await loadEventsProgressive()
    })

    // –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: —á–∏—Å—Ç–∏–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–∏ —É—Ö–æ–¥–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    onBeforeUnmount(() => {
      stopProgressive()
      stopPhotosLoading.value = true
    })

    return {
      initialLoaded,
      error,
      allEvents,
      visibleEvents,
      photos,
      categories,
      categoryMap,
      selectedCategories,
      toggleCategory,
      clearCategories,
      filteredEvents,
      photosLoading,
      progressiveLoading,
      reload,
      photoModalUrl,
      openPhoto
    }
  }
}
</script>

<style scoped>
.page {
  padding: 16px 0 40px;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 20px;
}

/* TAGS */
.tags-shell {
  background: #fff;
  border: 1px solid #efefef;
  border-radius: 18px;
  padding: 14px 14px 10px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.04);
  margin-bottom: 14px;
}

.tags-title {
  font-weight: 800;
  font-size: 13px;
  opacity: 0.7;
  margin-bottom: 10px;
}

.tags-content {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}

.tag-btn {
  border: 1px solid #efefef;
  background: #fafafa;
  border-radius: 999px;
  padding: 8px 12px;
  cursor: pointer;
  font-size: 13px;
}

.tag-btn.active {
  background: #8a75e3;
  border-color: #8a75e3;
  color: #fff;
}

.tag-btn.clear {
  background: #fff;
  border-color: #ddd;
}

/* STATES */
.state {
  display: grid;
  place-items: center;
  gap: 10px;
  padding: 40px 0;
  opacity: 0.75;
  text-align: center;
}

.state.error {
  opacity: 1;
  color: #d9534f;
}

.error-title {
  font-weight: 800;
}

.error-sub {
  font-size: 12px;
  opacity: 0.8;
  max-width: 680px;
}

.retry {
  margin-top: 8px;
  border: none;
  border-radius: 12px;
  padding: 10px 14px;
  cursor: pointer;
  background: #efefef;
}

.spinner {
  width: 26px;
  height: 26px;
  border-radius: 50%;
  border: 3px solid #eee;
  border-top-color: #8a75e3;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}

/* EVENTS */
.events-shell {
  background: #fff;
  border: 1px solid #efefef;
  border-radius: 18px;
  padding: 14px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.04);
}

.events-title {
  display: flex;
  align-items: center;
  gap: 10px;
  font-weight: 900;
  margin-bottom: 12px;
}

.events-count {
  font-size: 12px;
  opacity: 0.6;
  font-weight: 700;
}

.events-progress {
  font-size: 12px;
  opacity: 0.55;
  font-weight: 700;
  margin-left: auto;
}

.events-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

/* –ø–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫ */
.list-enter-active,
.list-leave-active {
  transition: opacity 240ms ease, transform 240ms ease;
}

.list-enter-from,
.list-leave-to {
  opacity: 0;
  transform: translateY(8px);
}
</style>
EventCard.vue (–ø–æ–ª–Ω–æ—Å—Ç—å—é)
<template>
  <div class="card">
    <!-- LEFT: PHOTO -->
    <button ref="photoBtn" class="photo" @click="handleOpenPhoto" aria-label="–û—Ç–∫—Ä—ã—Ç—å —Ñ–æ—Ç–æ">
      <!-- –°–∫–µ–ª–µ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ–º, –ø–æ–∫–∞: –∫–∞—Ä—Ç–æ—á–∫–∞ –Ω–µ –ø–æ–ø–∞–ª–∞ –≤ —ç–∫—Ä–∞–Ω –ò–õ–ò —Ñ–æ—Ç–æ –µ—â—ë –Ω–µ –ø—Ä–∏—à–ª–æ –ò–õ–ò img –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è -->
      <div
        v-if="!inView || !imageUrl || !imgLoaded"
        class="photo-skeleton"
        :class="{ shimmer: photosLoading }"
      ></div>

      <img
        v-if="inView && imageUrl"
        :src="imageUrl"
        alt="event photo"
        loading="lazy"
        decoding="async"
        :class="{ loaded: imgLoaded }"
        @load="onImgLoad"
        @error="onImgError"
      />
    </button>

    <!-- RIGHT: INFO -->
    <div class="info">
      <div class="top-row">
        <div class="title">{{ event.title }}</div>
        <div class="badges">
          <span v-if="event.is_online" class="badge">üü¢ –û–Ω–ª–∞–π–Ω</span>
          <span v-if="event.is_free" class="badge">üÜì –ë–µ—Å–ø–ª–∞—Ç–Ω–æ</span>
          <span v-if="categoryName" class="badge">{{ categoryName }}</span>
        </div>
      </div>

      <div v-if="event.description" class="desc">
        {{ event.description }}
      </div>

      <div class="meta">
        <div class="meta-item">
          <span class="k">üìÖ</span>
          <span class="v">{{ formattedDateTime }}</span>
        </div>

        <div class="meta-item">
          <span class="k">üìç</span>
          <span class="v">{{ event.address || '‚Äî' }}</span>
        </div>

        <div class="meta-item">
          <span class="k">üë§</span>
          <span class="v">{{ event.organizer || '‚Äî' }}</span>
        </div>

        <div class="meta-item">
          <span class="k">üí∞</span>
          <span class="v price">{{ formattedPrice }}</span>
        </div>
      </div>

      <!-- thumbnails (–µ—Å–ª–∏ —Ñ–æ—Ç–æ –±–æ–ª—å—à–µ 1) -->
      <div v-if="morePhotos.length" class="thumbs">
        <button
          v-for="p in morePhotos"
          :key="p.id"
          class="thumb"
          @click="emitOpenPhoto(p.photo_url)"
          aria-label="–û—Ç–∫—Ä—ã—Ç—å —Ñ–æ—Ç–æ"
        >
          <img :src="p.photo_url" alt="thumb" loading="lazy" decoding="async" />
        </button>
      </div>
    </div>
  </div>
</template>

<script>
export default {
  name: 'EventCard',
  emits: ['open-photo'],
  props: {
    event: { type: Object, required: true },
    photos: { type: Array, default: () => [] },
    photosLoading: { type: Boolean, default: false },
    categoryMap: { type: Object, default: () => ({}) }
  },
  computed: {
    imageUrl() {
      const first = Array.isArray(this.photos) ? this.photos[0] : null
      return (first?.photo_url || '').trim()
    },
    morePhotos() {
      if (!Array.isArray(this.photos)) return []
      return this.photos.slice(1, 6).filter((p) => p?.photo_url)
    },
    categoryName() {
      const id = this.event?.selectCategory
      return id && this.categoryMap?.[id] ? this.categoryMap[id] : ''
    },
    formattedDateTime() {
      if (!this.event?.date_time_event) return '‚Äî'
      const d = new Date(this.event.date_time_event)
      if (Number.isNaN(d.getTime())) return String(this.event.date_time_event)
      return d.toLocaleString('ru-RU', {
        day: 'numeric',
        month: 'long',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      })
    },
    formattedPrice() {
      if (this.event?.is_free) return '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ'
      if (this.event?.price === 0 || this.event?.price === null) return '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ'
      return `${this.event.price} ‚ÇΩ`
    }
  },
  data() {
    return {
      inView: false,
      imgLoaded: false,
      io: null
    }
  },
  watch: {
    imageUrl() {
      // –µ—Å–ª–∏ –ø—Ä–∏—à–ª–æ –Ω–æ–≤–æ–µ —Ñ–æ—Ç–æ ‚Äî —Å–Ω–æ–≤–∞ –ø–æ–∫–∞–∂–µ–º —Å–∫–µ–ª–µ—Ç –¥–æ –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
      this.imgLoaded = false
    }
  },
  mounted() {
    // –õ–µ–Ω–∏–≤–∞—è –ø–æ–¥–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∏: –Ω–∞—á–∏–Ω–∞–µ–º –≥—Ä—É–∑–∏—Ç—å —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –∫–∞—Ä—Ç–æ—á–∫–∞ –±–ª–∏–∑–∫–æ –∫ —ç–∫—Ä–∞–Ω—É
    const el = this.$refs.photoBtn
    if (!el || typeof window === 'undefined') {
      this.inView = true
      return
    }

    if (!('IntersectionObserver' in window)) {
      this.inView = true
      return
    }

    this.io = new IntersectionObserver(
      (entries) => {
        const entry = entries[0]
        if (entry?.isIntersecting) {
          this.inView = true
          if (this.io) {
            this.io.disconnect()
            this.io = null
          }
        }
      },
      { root: null, rootMargin: '250px 0px', threshold: 0.01 }
    )

    this.io.observe(el)
  },
  beforeUnmount() {
    if (this.io) {
      this.io.disconnect()
      this.io = null
    }
  },
  methods: {
    onImgLoad() {
      this.imgLoaded = true
    },
    onImgError() {
      // –µ—Å–ª–∏ —Å—Å—ã–ª–∫–∞ –±–∏—Ç–∞—è ‚Äî –ø–µ—Ä–µ—Å—Ç–∞—ë–º –∫—Ä—É—Ç–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É
      this.imgLoaded = true
    },
    emitOpenPhoto(url) {
      if (!url) return
      this.$emit('open-photo', url)
    },
    handleOpenPhoto() {
      // –µ—Å–ª–∏ —Ñ–æ—Ç–æ –µ—â—ë –Ω–µ –ø—Ä–∏—à–ª–æ ‚Äî –Ω–∏—á–µ–≥–æ
      if (!this.imageUrl) return
      this.emitOpenPhoto(this.imageUrl)
    }
  }
}
</script>

<style scoped>
.card {
  display: grid;
  grid-template-columns: 220px 1fr;
  gap: 14px;
  padding: 14px;
  border-radius: 18px;
  border: 1px solid #efefef;
  background: #fff;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.04);
}

.photo {
  width: 220px;
  height: 160px;
  border-radius: 16px;
  overflow: hidden;
  border: none;
  padding: 0;
  background: #f5f5f5;
  cursor: pointer;
  position: relative;
}

.photo img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
  opacity: 0;
  transform: scale(1.01);
  transition: opacity 260ms ease, transform 260ms ease;
}

.photo img.loaded {
  opacity: 1;
  transform: scale(1);
}

.photo-skeleton {
  width: 100%;
  height: 100%;
  background: #f0f0f0;
}

.shimmer {
  position: relative;
  overflow: hidden;
}
.shimmer::after {
  content: '';
  position: absolute;
  inset: 0;
  transform: translateX(-100%);
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.7), transparent);
  animation: shimmer 1.2s infinite;
}
@keyframes shimmer {
  to {
    transform: translateX(100%);
  }
}

.info {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.top-row {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.title {
  font-size: 18px;
  font-weight: 900;
}

.badges {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.badge {
  font-size: 12px;
  font-weight: 700;
  padding: 6px 10px;
  border-radius: 999px;
  background: rgba(138, 117, 227, 0.12);
  border: 1px solid rgba(138, 117, 227, 0.22);
}

.desc {
  font-size: 14px;
  opacity: 0.85;
  line-height: 1.35;
}

.meta {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px 14px;
}

.meta-item {
  display: flex;
  gap: 8px;
  align-items: flex-start;
  font-size: 14px;
}

.k {
  width: 18px;
  opacity: 0.9;
}
.v {
  opacity: 0.9;
}
.price {
  font-weight: 900;
}

.thumbs {
  display: flex;
  gap: 8px;
  margin-top: 4px;
  flex-wrap: wrap;
}

.thumb {
  width: 48px;
  height: 48px;
  border-radius: 12px;
  overflow: hidden;
  border: 1px solid #efefef;
  background: #fff;
  padding: 0;
  cursor: pointer;
}
.thumb img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

@media (max-width: 760px) {
  .card {
    grid-template-columns: 1fr;
  }
  .photo {
    width: 100%;
    height: 200px;
  }
}
</style>
–ï—Å–ª–∏ —Ö–æ—á–µ—à—å ‚Äî –º–æ–≥—É —Å–¥–µ–ª–∞—Ç—å –µ—â—ë –∫—Ä—É—á–µ: ‚Äú–±–µ—Å–∫–æ–Ω–µ—á–Ω—É—é –ø—Ä–æ–∫—Ä—É—Ç–∫—É‚Äù (–ø–æ–¥–≥—Ä—É–∂–∞—Ç—å —Å–ª–µ–¥—É—é—â—É—é –ø–æ—Ä—Ü–∏—é –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π, –∫–æ–≥–¥–∞ –¥–æ–∫—Ä—É—á–∏–≤–∞–µ—à—å –≤–Ω–∏–∑), —á—Ç–æ–±—ã –Ω–µ –≥—Ä—É–∑–∏—Ç—å –≤—Å—ë —Å—Ä–∞–∑—É.


–í—ã —Å–∫–∞–∑–∞–ª–∏:
—Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö –Ω–µ –¥–æ–ª–∂–Ω—ã –≤—ã—Ö–æ–¥–∏—Ç—å –∑–∞ –∏—Ö —Ä–∞–º–∫–∏, –µ—Å–ª–∏ –æ–Ω–æ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ, –ø—É—Å—Ç—å –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—Å—è –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é —Å—Ç—Ä–æ—á–∫—É, –∑–¥–µ—Å—å –∂–µ –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö –Ω—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, –∫ –∫–æ—Ç–æ—Ä–æ—ã–º –ø—Ä–∏–Ω–∞–¥–∂–µ–∏—Ç –¥–∞–Ω–Ω–æ–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ, –∞–¥—Ä–µ—Å—Å –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è

ChatGPT —Å–∫–∞–∑–∞–ª:
–ü–æ–Ω—è–ª. –¢—É—Ç 3 –ø—Ä–∞–≤–∫–∏:

–ù–∏—á–µ–≥–æ –Ω–µ –¥–æ–ª–∂–Ω–æ –≤—ã–ª–µ–∑–∞—Ç—å –∑–∞ —Ä–∞–º–∫–∏ –∫–∞—Ä—Ç–æ—á–∫–∏ ‚Üí –¥–æ–±–∞–≤–ª—è–µ–º min-width:0, overflow-wrap:anywhere, word-break:break-word, –Ω–æ—Ä–º–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–Ω–æ—Å—ã/—Å–∫—Ä–æ–ª–ª–∞ –Ω–µ—Ç.

–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ ‚Üí –ø–æ–¥–¥–µ—Ä–∂–∏–º –æ–¥–Ω—É –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–π: selectCategory –º–æ–∂–µ—Ç –±—ã—Ç—å id, –º–∞—Å—Å–∏–≤–æ–º id, –∏–ª–∏ —Å—Ç—Ä–æ–∫–æ–π "1,2,3" / "music;party". –û—Ç—Ä–∏—Å—É–µ–º –±–µ–π–¥–∂–∞–º–∏ –≤—Å–µ.

–ê–¥—Ä–µ—Å –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è ‚Üí –æ–Ω —É–∂–µ –µ—Å—Ç—å, –Ω–æ —è —Å–¥–µ–ª–∞—é —Ç–∞–∫, —á—Ç–æ–±—ã –æ–Ω —Ç–æ—á–Ω–æ –ø–µ—Ä–µ–Ω–æ—Å–∏–ª—Å—è –∏ –Ω–µ –ª–æ–º–∞–ª —Å–µ—Ç–∫—É.

–ù–∏–∂–µ –ø–æ–ª–Ω—ã–π —Ñ–∞–π–ª, –∫–æ—Ç–æ—Ä—ã–π –º–µ–Ω—è—é.

EventCard.vue (–ø–æ–ª–Ω–æ—Å—Ç—å—é)
<template>
  <div class="card">
    <!-- LEFT: PHOTO -->
    <button ref="photoBtn" class="photo" @click="handleOpenPhoto" aria-label="–û—Ç–∫—Ä—ã—Ç—å —Ñ–æ—Ç–æ">
      <div
        v-if="!inView || !imageUrl || !imgLoaded"
        class="photo-skeleton"
        :class="{ shimmer: photosLoading }"
      ></div>

      <img
        v-if="inView && imageUrl"
        :src="imageUrl"
        alt="event photo"
        loading="lazy"
        decoding="async"
        :class="{ loaded: imgLoaded }"
        @load="onImgLoad"
        @error="onImgError"
      />
    </button>

    <!-- RIGHT: INFO -->
    <div class="info">
      <div class="top-row">
        <div class="title">{{ event.title }}</div>

        <div class="badges">
          <span v-if="event.is_online" class="badge">üü¢ –û–Ω–ª–∞–π–Ω</span>
          <span v-if="event.is_free" class="badge">üÜì –ë–µ—Å–ø–ª–∞—Ç–Ω–æ</span>

          <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ (–æ–¥–Ω–∞/–Ω–µ—Å–∫–æ–ª—å–∫–æ) -->
          <span v-for="c in categoryNames" :key="c" class="badge">
            {{ c }}
          </span>
        </div>
      </div>

      <div v-if="event.description" class="desc">
        {{ event.description }}
      </div>

      <div class="meta">
        <div class="meta-item">
          <span class="k">üìÖ</span>
          <span class="v">{{ formattedDateTime }}</span>
        </div>

        <!-- –ê–¥—Ä–µ—Å –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è -->
        <div class="meta-item">
          <span class="k">üìç</span>
          <span class="v">{{ event.address || '‚Äî' }}</span>
        </div>

        <div class="meta-item">
          <span class="k">üë§</span>
          <span class="v">{{ event.organizer || '‚Äî' }}</span>
        </div>

        <div class="meta-item">
          <span class="k">üí∞</span>
          <span class="v price">{{ formattedPrice }}</span>
        </div>
      </div>

      <!-- thumbnails (–µ—Å–ª–∏ —Ñ–æ—Ç–æ –±–æ–ª—å—à–µ 1) -->
      <div v-if="morePhotos.length" class="thumbs">
        <button
          v-for="p in morePhotos"
          :key="p.id"
          class="thumb"
          @click="emitOpenPhoto(p.photo_url)"
          aria-label="–û—Ç–∫—Ä—ã—Ç—å —Ñ–æ—Ç–æ"
        >
          <img :src="p.photo_url" alt="thumb" loading="lazy" decoding="async" />
        </button>
      </div>
    </div>
  </div>
</template>

<script>
export default {
  name: 'EventCard',
  emits: ['open-photo'],
  props: {
    event: { type: Object, required: true },
    photos: { type: Array, default: () => [] },
    photosLoading: { type: Boolean, default: false },
    categoryMap: { type: Object, default: () => ({}) }
  },
  computed: {
    imageUrl() {
      const first = Array.isArray(this.photos) ? this.photos[0] : null
      return (first?.photo_url || '').trim()
    },
    morePhotos() {
      if (!Array.isArray(this.photos)) return []
      return this.photos.slice(1, 6).filter((p) => p?.photo_url)
    },

    // --- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏: id | [id,id] | "id,id" | "id;id" | "id id"
    categoryIds() {
      const raw = this.event?.selectCategory
      if (!raw) return []

      // –µ—Å–ª–∏ –º–∞—Å—Å–∏–≤
      if (Array.isArray(raw)) {
        return raw.filter(Boolean).map(String)
      }

      // –µ—Å–ª–∏ —á–∏—Å–ª–æ/—Å—Ç—Ä–æ–∫–∞ –æ–¥–∏–Ω–æ—á–Ω–∞—è
      if (typeof raw === 'number') return [String(raw)]
      if (typeof raw === 'string') {
        const s = raw.trim()
        if (!s) return []
        // –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Å—Ç—Ä–æ–∫–æ–≤—ã—Ö —Å–ø–∏—Å–∫–æ–≤
        const parts = s
          .split(/[,;| ]+/g)
          .map((x) => x.trim())
          .filter(Boolean)
        return parts.length ? parts : [s]
      }

      return []
    },

    categoryNames() {
      const ids = this.categoryIds
      if (!ids.length) return []

      // –µ—Å–ª–∏ –≤ categoryMap –∫–ª—é—á–∏ —á–∏—Å–ª–æ–≤—ã–µ, –ø—Ä–∏–≤–æ–¥–∏–º –æ–±–∞ –≤–∏–¥–∞
      const names = ids
        .map((id) => this.categoryMap?.[id] || this.categoryMap?.[Number(id)] || '')
        .filter(Boolean)

      // –µ—Å–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –Ω–µ—Ç –≤ map ‚Äî –ø–æ–∫–∞–∂–µ–º "–ö–∞—Ç–µ–≥–æ—Ä–∏—è: <id>" (—á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –ø—É—Å—Ç–æ)
      if (!names.length) return ids.map((id) => `–ö–∞—Ç–µ–≥–æ—Ä–∏—è ${id}`)
      return names
    },

    formattedDateTime() {
      if (!this.event?.date_time_event) return '‚Äî'
      const d = new Date(this.event.date_time_event)
      if (Number.isNaN(d.getTime())) return String(this.event.date_time_event)
      return d.toLocaleString('ru-RU', {
        day: 'numeric',
        month: 'long',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      })
    },
    formattedPrice() {
      if (this.event?.is_free) return '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ'
      if (this.event?.price === 0 || this.event?.price === null) return '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ'
      return `${this.event.price} ‚ÇΩ`
    }
  },
  data() {
    return {
      inView: false,
      imgLoaded: false,
      io: null
    }
  },
  watch: {
    imageUrl() {
      this.imgLoaded = false
    }
  },
  mounted() {
    const el = this.$refs.photoBtn
    if (!el || typeof window === 'undefined') {
      this.inView = true
      return
    }

    if (!('IntersectionObserver' in window)) {
      this.inView = true
      return
    }

    this.io = new IntersectionObserver(
      (entries) => {
        const entry = entries[0]
        if (entry?.isIntersecting) {
          this.inView = true
          if (this.io) {
            this.io.disconnect()
            this.io = null
          }
        }
      },
      { root: null, rootMargin: '250px 0px', threshold: 0.01 }
    )

    this.io.observe(el)
  },
  beforeUnmount() {
    if (this.io) {
      this.io.disconnect()
      this.io = null
    }
  },
  methods: {
    onImgLoad() {
      this.imgLoaded = true
    },
    onImgError() {
      this.imgLoaded = true
    },
    emitOpenPhoto(url) {
      if (!url) return
      this.$emit('open-photo', url)
    },
    handleOpenPhoto() {
      if (!this.imageUrl) return
      this.emitOpenPhoto(this.imageUrl)
    }
  }
}
</script>

<style scoped>
/* –í–ê–ñ–ù–û: —á—Ç–æ–±—ã —Ç–µ–∫—Å—Ç –ù–ò–ö–û–ì–î–ê –Ω–µ –≤—ã–ª–µ–∑–∞–ª –∏–∑ –∫–∞—Ä—Ç–æ—á–∫–∏ */
.card,
.info,
.title,
.desc,
.meta,
.meta-item,
.v {
  min-width: 0; /* —Ñ–∏–∫—Å –¥–ª—è grid/flex: —Ä–∞–∑—Ä–µ—à–∞–µ—Ç —Å–∂–∏–º–∞—Ç—å—Å—è –∏ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å */
}

.card {
  display: grid;
  grid-template-columns: 220px 1fr;
  gap: 14px;
  padding: 14px;
  border-radius: 18px;
  border: 1px solid #efefef;
  background: #fff;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.04);

  /* –Ω–µ –¥–∞—ë–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É ‚Äú–≤—ã—Ç–∞–ª–∫–∏–≤–∞—Ç—å‚Äù –∫–∞—Ä—Ç–æ—á–∫—É */
  overflow: hidden;
}

.photo {
  width: 220px;
  height: 160px;
  border-radius: 16px;
  overflow: hidden;
  border: none;
  padding: 0;
  background: #f5f5f5;
  cursor: pointer;
  position: relative;
  flex: 0 0 auto;
}

.photo img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
  opacity: 0;
  transform: scale(1.01);
  transition: opacity 260ms ease, transform 260ms ease;
}

.photo img.loaded {
  opacity: 1;
  transform: scale(1);
}

.photo-skeleton {
  width: 100%;
  height: 100%;
  background: #f0f0f0;
}

.shimmer {
  position: relative;
  overflow: hidden;
}
.shimmer::after {
  content: '';
  position: absolute;
  inset: 0;
  transform: translateX(-100%);
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.7), transparent);
  animation: shimmer 1.2s infinite;
}
@keyframes shimmer {
  to {
    transform: translateX(100%);
  }
}

.info {
  display: flex;
  flex-direction: column;
  gap: 10px;

  /* –∫–ª—é—á–µ–≤–æ–µ */
  overflow: hidden;
}

.top-row {
  display: flex;
  flex-direction: column;
  gap: 8px;
  overflow: hidden;
}

.title {
  font-size: 18px;
  font-weight: 900;

  /* –ø–µ—Ä–µ–Ω–æ—Å—ã */
  white-space: normal;
  overflow-wrap: anywhere;
  word-break: break-word;
  line-height: 1.2;
}

.badges {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;

  /* —á—Ç–æ–±—ã –±–µ–π–¥–∂–∏ –Ω–µ –ª–æ–º–∞–ª–∏ —à–∏—Ä–∏–Ω—É */
  overflow: hidden;
}

.badge {
  font-size: 12px;
  font-weight: 700;
  padding: 6px 10px;
  border-radius: 999px;
  background: rgba(138, 117, 227, 0.12);
  border: 1px solid rgba(138, 117, 227, 0.22);

  /* –ø–µ—Ä–µ–Ω–æ—Å —Ç–µ–∫—Å—Ç–∞ –≤–Ω—É—Ç—Ä–∏ –±–µ–π–¥–∂–∞ (–µ—Å–ª–∏ –≤–¥—Ä—É–≥ –¥–ª–∏–Ω–Ω—ã–π) */
  white-space: normal;
  overflow-wrap: anywhere;
  word-break: break-word;
  max-width: 100%;
}

.desc {
  font-size: 14px;
  opacity: 0.85;
  line-height: 1.35;

  /* –ø–µ—Ä–µ–Ω–æ—Å—ã */
  white-space: normal;
  overflow-wrap: anywhere;
  word-break: break-word;
}

.meta {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px 14px;
  overflow: hidden;
}

.meta-item {
  display: flex;
  gap: 8px;
  align-items: flex-start;
  font-size: 14px;

  /* –ø–µ—Ä–µ–Ω–æ—Å—ã –≤–Ω—É—Ç—Ä–∏ —Å—Ç—Ä–æ–∫–∏ */
  overflow: hidden;
}

.k {
  width: 18px;
  opacity: 0.9;
  flex: 0 0 18px;
}

.v {
  opacity: 0.9;

  /* –ø–µ—Ä–µ–Ω–æ—Å—ã */
  white-space: normal;
  overflow-wrap: anywhere;
  word-break: break-word;
}

.price {
  font-weight: 900;
}

.thumbs {
  display: flex;
  gap: 8px;
  margin-top: 4px;
  flex-wrap: wrap;
}

.thumb {
  width: 48px;
  height: 48px;
  border-radius: 12px;
  overflow: hidden;
  border: 1px solid #efefef;
  background: #fff;
  padding: 0;
  cursor: pointer;
}
.thumb img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

@media (max-width: 760px) {
  .card {
    grid-template-columns: 1fr;
  }
  .photo {
    width: 100%;
    height: 200px;
  }
  .meta {
    grid-template-columns: 1fr;
  }
}
</style>
–ï—Å–ª–∏ —É —Ç–µ–±—è selectCategory –≤ Supabase —Ö—Ä–∞–Ω–∏—Ç—Å—è –Ω–µ id, –∞ –Ω–∞–∑–≤–∞–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π (—Å—Ç—Ä–æ–∫–∞–º–∏), —Ç–æ categoryMap –Ω–µ –Ω—É–∂–µ–Ω ‚Äî —Å–∫–∞–∂–∏, –∏ —è –ø–æ–º–µ–Ω—è—é –ª–æ–≥–∏–∫—É —Ç–∞–∫, —á—Ç–æ–±—ã –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∏—Å—å –Ω–∞–∑–≤–∞–Ω–∏—è –Ω–∞–ø—Ä—è–º—É—é (–±–µ–∑ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è).


–í—ã —Å–∫–∞–∑–∞–ª–∏:
–æ–ø–∏—Å–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å –∞–±–∑–∞—Ü–∞, –∫–æ–¥ –≤—ã–ø–∏—à–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é

ChatGPT —Å–∫–∞–∑–∞–ª:
–û–∫. –°–¥–µ–ª–∞–ª —Ç–∞–∫, —á—Ç–æ–±—ã –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–∞—á–∏–Ω–∞–ª–æ—Å—å —Å –∞–±–∑–∞—Ü–∞ (–∫—Ä–∞—Å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞) –∏ –ø—Ä–∏ —ç—Ç–æ–º –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ –≤ —Ç–µ–∫—Å—Ç–µ –æ–ø–∏—Å–∞–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è–ª–∏—Å—å.

–ù–∏–∂–µ EventCard.vue –ø–æ–ª–Ω–æ—Å—Ç—å—é.

<template>
  <div class="card">
    <!-- LEFT: PHOTO -->
    <button ref="photoBtn" class="photo" @click="handleOpenPhoto" aria-label="–û—Ç–∫—Ä—ã—Ç—å —Ñ–æ—Ç–æ">
      <div
        v-if="!inView || !imageUrl || !imgLoaded"
        class="photo-skeleton"
        :class="{ shimmer: photosLoading }"
      ></div>

      <img
        v-if="inView && imageUrl"
        :src="imageUrl"
        alt="event photo"
        loading="lazy"
        decoding="async"
        :class="{ loaded: imgLoaded }"
        @load="onImgLoad"
        @error="onImgError"
      />
    </button>

    <!-- RIGHT: INFO -->
    <div class="info">
      <div class="top-row">
        <div class="title">{{ event.title }}</div>

        <div class="badges">
          <span v-if="event.is_online" class="badge">üü¢ –û–Ω–ª–∞–π–Ω</span>
          <span v-if="event.is_free" class="badge">üÜì –ë–µ—Å–ø–ª–∞—Ç–Ω–æ</span>

          <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ (–æ–¥–Ω–∞/–Ω–µ—Å–∫–æ–ª—å–∫–æ) -->
          <span v-for="c in categoryNames" :key="c" class="badge">
            {{ c }}
          </span>
        </div>
      </div>

      <!-- –û–ü–ò–°–ê–ù–ò–ï: —Å –∞–±–∑–∞—Ü–∞ -->
      <p v-if="event.description" class="desc">
        {{ event.description }}
      </p>

      <div class="meta">
        <div class="meta-item">
          <span class="k">üìÖ</span>
          <span class="v">{{ formattedDateTime }}</span>
        </div>

        <!-- –ê–¥—Ä–µ—Å –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è -->
        <div class="meta-item">
          <span class="k">üìç</span>
          <span class="v">{{ event.address || '‚Äî' }}</span>
        </div>

        <div class="meta-item">
          <span class="k">üë§</span>
          <span class="v">{{ event.organizer || '‚Äî' }}</span>
        </div>

        <div class="meta-item">
          <span class="k">üí∞</span>
          <span class="v price">{{ formattedPrice }}</span>
        </div>
      </div>

      <!-- thumbnails (–µ—Å–ª–∏ —Ñ–æ—Ç–æ –±–æ–ª—å—à–µ 1) -->
      <div v-if="morePhotos.length" class="thumbs">
        <button
          v-for="p in morePhotos"
          :key="p.id"
          class="thumb"
          @click="emitOpenPhoto(p.photo_url)"
          aria-label="–û—Ç–∫—Ä—ã—Ç—å —Ñ–æ—Ç–æ"
        >
          <img :src="p.photo_url" alt="thumb" loading="lazy" decoding="async" />
        </button>
      </div>
    </div>
  </div>
</template>

<script>
export default {
  name: 'EventCard',
  emits: ['open-photo'],
  props: {
    event: { type: Object, required: true },
    photos: { type: Array, default: () => [] },
    photosLoading: { type: Boolean, default: false },
    categoryMap: { type: Object, default: () => ({}) }
  },
  computed: {
    imageUrl() {
      const first = Array.isArray(this.photos) ? this.photos[0] : null
      return (first?.photo_url || '').trim()
    },
    morePhotos() {
      if (!Array.isArray(this.photos)) return []
      return this.photos.slice(1, 6).filter((p) => p?.photo_url)
    },

    // --- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏: id | [id,id] | "id,id" | "id;id" | "id id"
    categoryIds() {
      const raw = this.event?.selectCategory
      if (!raw) return []

      if (Array.isArray(raw)) {
        return raw.filter(Boolean).map(String)
      }

      if (typeof raw === 'number') return [String(raw)]

      if (typeof raw === 'string') {
        const s = raw.trim()
        if (!s) return []
        const parts = s
          .split(/[,;| ]+/g)
          .map((x) => x.trim())
          .filter(Boolean)
        return parts.length ? parts : [s]
      }

      return []
    },

    categoryNames() {
      const ids = this.categoryIds
      if (!ids.length) return []

      const names = ids
        .map((id) => this.categoryMap?.[id] || this.categoryMap?.[Number(id)] || '')
        .filter(Boolean)

      if (!names.length) return ids.map((id) => `–ö–∞—Ç–µ–≥–æ—Ä–∏—è ${id}`)
      return names
    },

    formattedDateTime() {
      if (!this.event?.date_time_event) return '‚Äî'
      const d = new Date(this.event.date_time_event)
      if (Number.isNaN(d.getTime())) return String(this.event.date_time_event)
      return d.toLocaleString('ru-RU', {
        day: 'numeric',
        month: 'long',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      })
    },
    formattedPrice() {
      if (this.event?.is_free) return '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ'
      if (this.event?.price === 0 || this.event?.price === null) return '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ'
      return `${this.event.price} ‚ÇΩ`
    }
  },
  data() {
    return {
      inView: false,
      imgLoaded: false,
      io: null
    }
  },
  watch: {
    imageUrl() {
      this.imgLoaded = false
    }
  },
  mounted() {
    const el = this.$refs.photoBtn
    if (!el || typeof window === 'undefined') {
      this.inView = true
      return
    }

    if (!('IntersectionObserver' in window)) {
      this.inView = true
      return
    }

    this.io = new IntersectionObserver(
      (entries) => {
        const entry = entries[0]
        if (entry?.isIntersecting) {
          this.inView = true
          if (this.io) {
            this.io.disconnect()
            this.io = null
          }
        }
      },
      { root: null, rootMargin: '250px 0px', threshold: 0.01 }
    )

    this.io.observe(el)
  },
  beforeUnmount() {
    if (this.io) {
      this.io.disconnect()
      this.io = null
    }
  },
  methods: {
    onImgLoad() {
      this.imgLoaded = true
    },
    onImgError() {
      this.imgLoaded = true
    },
    emitOpenPhoto(url) {
      if (!url) return
      this.$emit('open-photo', url)
    },
    handleOpenPhoto() {
      if (!this.imageUrl) return
      this.emitOpenPhoto(this.imageUrl)
    }
  }
}
</script>

<style scoped>
/* –í–ê–ñ–ù–û: —á—Ç–æ–±—ã —Ç–µ–∫—Å—Ç –ù–ò–ö–û–ì–î–ê –Ω–µ –≤—ã–ª–µ–∑–∞–ª –∏–∑ –∫–∞—Ä—Ç–æ—á–∫–∏ */
.card,
.info,
.title,
.desc,
.meta,
.meta-item,
.v {
  min-width: 0;
}

.card {
  display: grid;
  grid-template-columns: 220px 1fr;
  gap: 14px;
  padding: 14px;
  border-radius: 18px;
  border: 1px solid #efefef;
  background: #fff;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.04);
  overflow: hidden;
}

.photo {
  width: 220px;
  height: 160px;
  border-radius: 16px;
  overflow: hidden;
  border: none;
  padding: 0;
  background: #f5f5f5;
  cursor: pointer;
  position: relative;
  flex: 0 0 auto;
}

.photo img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
  opacity: 0;
  transform: scale(1.01);
  transition: opacity 260ms ease, transform 260ms ease;
}

.photo img.loaded {
  opacity: 1;
  transform: scale(1);
}

.photo-skeleton {
  width: 100%;
  height: 100%;
  background: #f0f0f0;
}

.shimmer {
  position: relative;
  overflow: hidden;
}
.shimmer::after {
  content: '';
  position: absolute;
  inset: 0;
  transform: translateX(-100%);
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.7), transparent);
  animation: shimmer 1.2s infinite;
}
@keyframes shimmer {
  to {
    transform: translateX(100%);
  }
}

.info {
  display: flex;
  flex-direction: column;
  gap: 10px;
  overflow: hidden;
}

.top-row {
  display: flex;
  flex-direction: column;
  gap: 8px;
  overflow: hidden;
}

.title {
  font-size: 18px;
  font-weight: 900;
  white-space: normal;
  overflow-wrap: anywhere;
  word-break: break-word;
  line-height: 1.2;
}

.badges {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  overflow: hidden;
}

.badge {
  font-size: 12px;
  font-weight: 700;
  padding: 6px 10px;
  border-radius: 999px;
  background: rgba(138, 117, 227, 0.12);
  border: 1px solid rgba(138, 117, 227, 0.22);
  white-space: normal;
  overflow-wrap: anywhere;
  word-break: break-word;
  max-width: 100%;
}

/* –û–ø–∏—Å–∞–Ω–∏–µ: "–∞–±–∑–∞—Ü" + —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ */
.desc {
  margin: 0;              /* —á—Ç–æ–±—ã <p> –Ω–µ –¥–æ–±–∞–≤–ª—è–ª –ª–∏—à–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã */
  font-size: 14px;
  opacity: 0.85;
  line-height: 1.35;

  text-indent: 1.2em;     /* –∫—Ä–∞—Å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ */
  white-space: pre-line;  /* —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç \n –∫–∞–∫ –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏ */
  overflow-wrap: anywhere;
  word-break: break-word;
}

.meta {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px 14px;
  overflow: hidden;
}

.meta-item {
  display: flex;
  gap: 8px;
  align-items: flex-start;
  font-size: 14px;
  overflow: hidden;
}

.k {
  width: 18px;
  opacity: 0.9;
  flex: 0 0 18px;
}

.v {
  opacity: 0.9;
  white-space: normal;
  overflow-wrap: anywhere;
  word-break: break-word;
}

.price {
  font-weight: 900;
}

.thumbs {
  display: flex;
  gap: 8px;
  margin-top: 4px;
  flex-wrap: wrap;
}

.thumb {
  width: 48px;
  height: 48px;
  border-radius: 12px;
  overflow: hidden;
  border: 1px solid #efefef;
  background: #fff;
  padding: 0;
  cursor: pointer;
}
.thumb img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

@media (max-width: 760px) {
  .card {
    grid-template-columns: 1fr;
  }
  .photo {
    width: 100%;
    height: 200px;
  }
  .meta {
    grid-template-columns: 1fr;
  }
}
</style>

–í—ã —Å–∫–∞–∑–∞–ª–∏:
–æ–∫–µ, —Ç–µ–ø–µ—Ä—å —Å–¥–µ–ª–∞–π —Ç–∞–∫, —á—Ç–æ–±—ã –≤ –±–ª–æ–∫–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, –Ω–∞–∂–∏–º–∞—è –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∏ –≤—ã—Å–≤–µ—á–∏–≤–∞–ª–∏—Å—å –≤—Å–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è, –≤ –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å —ç—Ç–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è, –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–π.

–í –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–æ–±–∞–≤—å –∫–Ω–æ–ø–∫—É "–≤—Å–µ", –µ—Å–ª–∏ –æ–Ω–∞ –Ω–∞–∂–∞—Ç–∞, —Ç–æ –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ "–æ—Ç–∂–∏–º–∞—é—Ç—Å—è" –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–µ—Ç –≤—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏


–ö–æ–¥ –≤—ã–ø–∏—à–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é

ChatGPT —Å–∫–∞–∑–∞–ª:
–û–∫ ‚Äî —Å–¥–µ–ª–∞–ª:

–ö–ª–∏–∫ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è, –ø–æ–∫–∞–∑—ã–≤–∞—è —Ç–æ–ª—å–∫–æ —Ç–µ, –≥–¥–µ —ç—Ç–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –µ—Å—Ç—å

–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–π (–ª–æ–≥–∏–∫–∞ OR: –ø–æ–∫–∞–∑–∞–Ω—ã –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è, –≥–¥–µ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π)

–î–æ–±–∞–≤–∏–ª –∫–Ω–æ–ø–∫—É ‚Äú–í—Å–µ‚Äù:

–µ—Å–ª–∏ –Ω–∞–∂–∞—Ç–∞ ‚Äú–í—Å–µ‚Äù ‚Üí –æ—Å—Ç–∞–ª—å–Ω—ã–µ –æ—Ç–∂–∏–º–∞—é—Ç—Å—è, –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –≤—Å–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è

–µ—Å–ª–∏ –≤—ã–±—Ä–∞–ª–∏ –ª—é–±—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é ‚Üí ‚Äú–í—Å–µ‚Äù –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞

–ù–∏–∂–µ HomeView.vue –ø–æ–ª–Ω–æ—Å—Ç—å—é.

HomeView.vue (–ø–æ–ª–Ω–æ—Å—Ç—å—é)
<template>
  <div class="page">
    <div class="container">
      <!-- CATEGORIES -->
      <div class="tags-shell">
        <div class="tags-title">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</div>

        <div class="tags-content">
          <!-- ALL -->
          <button class="tag-btn" :class="{ active: isAllActive }" @click="selectAll">
            –í—Å–µ
          </button>

          <!-- CATEGORY BUTTONS -->
          <button
            v-for="cat in categories"
            :key="cat.id"
            class="tag-btn"
            :class="{ active: selectedCategoryIds.includes(String(cat.id)) }"
            @click="toggleCategory(String(cat.id))"
          >
            {{ cat.name }}
          </button>
        </div>
      </div>

      <!-- STATES -->
      <div v-if="!initialLoaded" class="state">
        <div class="spinner"></div>
        <div>–ó–∞–≥—Ä—É–∑–∫–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π‚Ä¶</div>
      </div>

      <div v-else-if="error" class="state error">
        <div class="error-title">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</div>
        <div class="error-sub">{{ error }}</div>
        <button class="retry" @click="reload">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
      </div>

      <div v-else-if="filteredEvents.length === 0" class="state">–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>

      <!-- EVENTS LIST -->
      <div v-else class="events-shell">
        <div class="events-title">
          –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
          <span class="events-count">{{ filteredEvents.length }}</span>
          <span v-if="progressiveLoading" class="events-progress">–ø–æ–¥–≥—Ä—É–∂–∞—é‚Ä¶</span>
        </div>

        <TransitionGroup name="list" tag="div" class="events-list">
          <EventCard
            v-for="event in filteredEvents"
            :key="event.id"
            :event="event"
            :photos="photos[event.id] || []"
            :photos-loading="photosLoading"
            :category-map="categoryMap"
            @open-photo="openPhoto"
          />
        </TransitionGroup>
      </div>
    </div>

    <!-- PHOTO MODAL -->
    <EventPhotoModal v-if="photoModalUrl" :url="photoModalUrl" @close="photoModalUrl = ''" />
  </div>
</template>

<script>
import { ref, computed, onMounted, onBeforeUnmount } from 'vue'
import EventCard from '../../components/EventCard.vue'
import EventPhotoModal from '../../components/EventPhotoModal.vue'
import { useSupabase } from '../../composables/useSupabase'

const sleep = (ms) => new Promise((r) => setTimeout(r, ms))

const withRetry = async (fn, tries = 3) => {
  let lastErr = null
  for (let i = 0; i < tries; i++) {
    try {
      return await fn()
    } catch (e) {
      lastErr = e
      await sleep(350 * (i + 1))
    }
  }
  throw lastErr
}

// –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ –≤—ã—Ç–∞—Å–∫–∏–≤–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–∑ event.selectCategory:
// –º–æ–∂–µ—Ç –±—ã—Ç—å id, –º–∞—Å—Å–∏–≤ id, —Å—Ç—Ä–æ–∫–∞ "1,2" –∏–ª–∏ "1;2" –∏–ª–∏ "1 2"
const parseEventCategoryIds = (raw) => {
  if (!raw) return []

  if (Array.isArray(raw)) {
    return raw.filter(Boolean).map((x) => String(x))
  }

  if (typeof raw === 'number') return [String(raw)]

  if (typeof raw === 'string') {
    const s = raw.trim()
    if (!s) return []
    const parts = s
      .split(/[,;| ]+/g)
      .map((x) => x.trim())
      .filter(Boolean)
    return parts.length ? parts : [s]
  }

  // –Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ –≤–Ω–µ–∑–∞–ø–Ω–æ –æ–±—ä–µ–∫—Ç
  try {
    return [String(raw)]
  } catch {
    return []
  }
}

export default {
  name: 'HomeView',
  components: { EventCard, EventPhotoModal },
  props: {
    globalSearchTerm: { type: String, default: '' }
  },
  setup(props) {
    const { getEvents, getCategories, getEventPhotos } = useSupabase()

    const initialLoaded = ref(false)
    const error = ref(null)

    const allEvents = ref([])
    const visibleEvents = ref([])

    const progressiveLoading = ref(false)
    let progressiveTimer = null

    const photos = ref({})

    const categories = ref([])
    const categoryMap = ref({}) // id -> name

    // –•—Ä–∞–Ω–∏–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∫–∞–∫ –°–¢–†–û–ö–ò (—á—Ç–æ–±—ã –Ω–µ –ª–æ–≤–∏—Ç—å –±–∞–≥–∏ number/string)
    const selectedCategoryIds = ref([])

    const isAllActive = computed(() => selectedCategoryIds.value.length === 0)

    const photosLoading = ref(false)
    const stopPhotosLoading = ref(false)

    const photoModalUrl = ref('')

    const openPhoto = (url) => {
      if (!url) return
      photoModalUrl.value = url
    }

    const selectAll = () => {
      // "–í—Å–µ" = —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–π
      selectedCategoryIds.value = []
    }

    const toggleCategory = (id) => {
      const sid = String(id)
      const idx = selectedCategoryIds.value.indexOf(sid)
      if (idx >= 0) {
        selectedCategoryIds.value.splice(idx, 1)
      } else {
        selectedCategoryIds.value.push(sid)
      }
      // –µ—Å–ª–∏ –ø–æ—Å–ª–µ –∫–ª–∏–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ ‚Äî "–í—Å–µ" –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞–∫—Ç–∏–≤–Ω–∞ (computed)
    }

    const matchesSelectedCategories = (event) => {
      // –µ—Å–ª–∏ "–í—Å–µ" ‚Äî –ø–æ–¥—Ö–æ–¥–∏—Ç –≤—Å—ë
      if (selectedCategoryIds.value.length === 0) return true

      const eventCats = parseEventCategoryIds(event?.selectCategory)
      if (!eventCats.length) return false

      const selectedSet = new Set(selectedCategoryIds.value)
      // OR –ª–æ–≥–∏–∫–∞: –ø–æ–¥—Ö–æ–¥–∏—Ç, –µ—Å–ª–∏ —Ö–æ—Ç—å –æ–¥–Ω–∞ —Å–æ–≤–ø–∞–ª–∞
      return eventCats.some((c) => selectedSet.has(String(c)))
    }

    const matchesSearch = (event) => {
      const term = (props.globalSearchTerm || '').trim().toLowerCase()
      if (!term) return true

      const t = (event.title || '').toLowerCase()
      const d = (event.description || '').toLowerCase()
      const a = (event.address || '').toLowerCase()
      const o = (event.organizer || '').toLowerCase()
      return t.includes(term) || d.includes(term) || a.includes(term) || o.includes(term)
    }

    const filteredEvents = computed(() => {
      // —Ñ–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —É–∂–µ –ø–æ–∫–∞–∑–∞–Ω–Ω—ã–µ (progressive)
      return visibleEvents.value.filter((e) => matchesSelectedCategories(e) && matchesSearch(e))
    })

    const stopProgressive = () => {
      progressiveLoading.value = false
      if (progressiveTimer) {
        clearInterval(progressiveTimer)
        progressiveTimer = null
      }
    }

    const startProgressive = (source) => {
      stopProgressive()
      visibleEvents.value = []

      const list = Array.isArray(source) ? source : []
      if (!list.length) return

      progressiveLoading.value = true

      // –ø–µ—Ä–≤–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ —Å—Ä–∞–∑—É
      visibleEvents.value.push(list[0])

      let i = 1
      progressiveTimer = setInterval(() => {
        if (i >= list.length) {
          stopProgressive()
          return
        }
        visibleEvents.value.push(list[i])
        i++
      }, 140)
    }

    const loadCategories = async () => {
      try {
        const { data, error: err } = await withRetry(() => getCategories())
        if (err) throw err

        categories.value = data ?? []
        categoryMap.value = (categories.value || []).reduce((acc, c) => {
          acc[String(c.id)] = c.name
          return acc
        }, {})
      } catch (e) {
        console.warn('Categories load error:', e)
        categories.value = []
        categoryMap.value = {}
      }
    }

    const loadEventsProgressive = async () => {
      error.value = null
      stopPhotosLoading.value = true
      photosLoading.value = false
      stopProgressive()

      try {
        const { data: eventsData, error: eventsErr } = await withRetry(() => getEvents())
        if (eventsErr) throw eventsErr

        allEvents.value = eventsData ?? []
        initialLoaded.value = true

        // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–ª–∞–≤–Ω–æ –ø–æ –æ–¥–Ω–æ–π
        startProgressive(allEvents.value)

        // –≥—Ä—É–∑–∏–º —Ñ–æ—Ç–æ –±–∞—Ç—á–∞–º–∏
        photos.value = {}
        stopPhotosLoading.value = false

        const ids = allEvents.value.map((e) => e.id).filter(Boolean)
        if (!ids.length) return

        photosLoading.value = true

        const batchSize = 5
        for (let i = 0; i < ids.length; i += batchSize) {
          if (stopPhotosLoading.value) break

          const batch = ids.slice(i, i + batchSize)
          try {
            const { data: ph, error: phErr } = await withRetry(() => getEventPhotos(batch))
            if (phErr) throw phErr

            const next = { ...photos.value }
            for (const p of ph ?? []) {
              if (!p?.event_id) continue
              if (!next[p.event_id]) next[p.event_id] = []
              next[p.event_id].push(p)
            }
            photos.value = next
          } catch (e) {
            console.warn('Photos batch load error:', e)
          }

          await sleep(120)
        }
      } catch (e) {
        console.error('HomeView load error:', e)
        allEvents.value = []
        visibleEvents.value = []
        photos.value = {}
        initialLoaded.value = true
        error.value = e?.message ? String(e.message) : 'TypeError: Failed to fetch'
      } finally {
        photosLoading.value = false
      }
    }

    const reload = async () => {
      await loadEventsProgressive()
    }

    onMounted(async () => {
      await loadCategories()
      await loadEventsProgressive()
    })

    onBeforeUnmount(() => {
      stopProgressive()
      stopPhotosLoading.value = true
    })

    return {
      initialLoaded,
      error,
      allEvents,
      visibleEvents,
      photos,
      categories,
      categoryMap,

      selectedCategoryIds,
      isAllActive,
      selectAll,
      toggleCategory,

      filteredEvents,
      photosLoading,
      progressiveLoading,
      reload,

      photoModalUrl,
      openPhoto
    }
  }
}
</script>

<style scoped>
.page {
  padding: 16px 0 40px;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 20px;
}

/* TAGS */
.tags-shell {
  background: #fff;
  border: 1px solid #efefef;
  border-radius: 18px;
  padding: 14px 14px 10px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.04);
  margin-bottom: 14px;
}

.tags-title {
  font-weight: 800;
  font-size: 13px;
  opacity: 0.7;
  margin-bottom: 10px;
}

.tags-content {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}

.tag-btn {
  border: 1px solid #efefef;
  background: #fafafa;
  border-radius: 999px;
  padding: 8px 12px;
  cursor: pointer;
  font-size: 13px;
  white-space: nowrap;
}

.tag-btn.active {
  background: #8a75e3;
  border-color: #8a75e3;
  color: #fff;
}

/* STATES */
.state {
  display: grid;
  place-items: center;
  gap: 10px;
  padding: 40px 0;
  opacity: 0.75;
  text-align: center;
}

.state.error {
  opacity: 1;
  color: #d9534f;
}

.error-title {
  font-weight: 800;
}

.error-sub {
  font-size: 12px;
  opacity: 0.8;
  max-width: 680px;
}

.retry {
  margin-top: 8px;
  border: none;
  border-radius: 12px;
  padding: 10px 14px;
  cursor: pointer;
  background: #efefef;
}

.spinner {
  width: 26px;
  height: 26px;
  border-radius: 50%;
  border: 3px solid #eee;
  border-top-color: #8a75e3;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}

/* EVENTS */
.events-shell {
  background: #fff;
  border: 1px solid #efefef;
  border-radius: 18px;
  padding: 14px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.04);
}

.events-title {
  display: flex;
  align-items: center;
  gap: 10px;
  font-weight: 900;
  margin-bottom: 12px;
}

.events-count {
  font-size: 12px;
  opacity: 0.6;
  font-weight: 700;
}

.events-progress {
  font-size: 12px;
  opacity: 0.55;
  font-weight: 700;
  margin-left: auto;
}

.events-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

/* –ø–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫ */
.list-enter-active,
.list-leave-active {
  transition: opacity 240ms ease, transform 240ms ease;
}

.list-enter-from,
.list-leave-to {
  opacity: 0;
  transform: translateY(8px);
}
</style>
–ï—Å–ª–∏ —Ö–æ—á–µ—à—å, –º–æ–≥—É –±—ã—Å—Ç—Ä–æ –¥–æ–±–∞–≤–∏—Ç—å –µ—â—ë —Å—á—ë—Ç—á–∏–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Ä—è–¥–æ–º —Å ‚Äú–ö–∞—Ç–µ–≥–æ—Ä–∏–∏‚Äù –∏ –∫–Ω–æ–ø–∫—É ‚Äú–°–±—Ä–æ—Å–∏—Ç—å‚Äù (–Ω–æ ‚Äú–í—Å–µ‚Äù —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç —ç—Ç—É —Ä–æ–ª—å).


–í—ã —Å–∫–∞–∑–∞–ª–∏:
–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç(
–£ –º–µ–Ω—è —Ç–æ—á–Ω–æ –µ—Å—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è —Å –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏, –Ω–æ –æ–Ω–∏ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è, –∫–æ–≥–¥–∞ —è –≤—ã–±–∏—Ä–∞—é –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é, –Ω–∞–π–¥–∏ –æ—à–∏–±–∫—É –∏ –≤—ã–ø–∏—à–∏ –≤–µ—Å—å –∫–æ–¥

ChatGPT —Å–∫–∞–∑–∞–ª:

–î—É–º–∞–ª –Ω–∞ –ø—Ä–æ—Ç—è–∂–µ–Ω–∏–∏ 9s
–û—à–∏–±–∫–∞ –Ω–∞—à–ª–∞—Å—å —Å—Ä–∞–∑—É –ø–æ —Ç–≤–æ–∏–º —Å–∫—Ä–∏–Ω–∞–º ‚úÖ

–ü–æ—á–µ–º—É ‚Äú–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç‚Äù
–£ —Ç–µ–±—è –≤ events.selectCategory —Ö—Ä–∞–Ω–∏—Ç—Å—è text[] ‚Äî —Ç–æ –µ—Å—Ç—å –ú–ê–°–°–ò–í –ù–ê–ó–í–ê–ù–ò–ô –∫–∞—Ç–µ–≥–æ—Ä–∏–π:

["–ù–∞—É–∫–∞ –∏ –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏"]

["–ë–∏–∑–Ω–µ—Å","–°–ø–æ—Ä—Ç","–•–æ–±–±–∏"]

–ê —è –≤ —Ñ–∏–ª—å—Ç—Ä–µ —Å—Ä–∞–≤–Ω–∏–≤–∞–ª id –∫–∞—Ç–µ–≥–æ—Ä–∏–π (1,2,3‚Ä¶) —Å —Ç–µ–º, —á—Ç–æ –ª–µ–∂–∏—Ç –≤ selectCategory.
–ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ, ["–ë–∏–∑–Ω–µ—Å"] –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —Å–æ–≤–ø–∞–¥—ë—Ç —Å "5" ‚Üí –ø–æ—ç—Ç–æ–º—É –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è ‚Äú–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã‚Äù.

–ù–∏–∂–µ –≤–µ—Å—å –∫–æ–¥ —Ñ–∞–π–ª–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å, —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞–ª–æ:

‚úÖ HomeView.vue (–ø–æ–ª–Ω–æ—Å—Ç—å—é)
<template>
  <div class="page">
    <div class="container">
      <!-- CATEGORIES -->
      <div class="tags-shell">
        <div class="tags-title">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</div>

        <div class="tags-content">
          <!-- ALL -->
          <button class="tag-btn" :class="{ active: isAllActive }" @click="selectAll">
            –í—Å–µ
          </button>

          <!-- CATEGORY BUTTONS -->
          <button
            v-for="cat in categories"
            :key="cat.id"
            class="tag-btn"
            :class="{ active: selectedCategoryNames.includes(cat.name) }"
            @click="toggleCategory(cat.name)"
          >
            {{ cat.name }}
          </button>
        </div>
      </div>

      <!-- STATES -->
      <div v-if="!initialLoaded" class="state">
        <div class="spinner"></div>
        <div>–ó–∞–≥—Ä—É–∑–∫–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π‚Ä¶</div>
      </div>

      <div v-else-if="error" class="state error">
        <div class="error-title">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</div>
        <div class="error-sub">{{ error }}</div>
        <button class="retry" @click="reload">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
      </div>

      <div v-else-if="filteredEvents.length === 0" class="state">–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>

      <!-- EVENTS LIST -->
      <div v-else class="events-shell">
        <div class="events-title">
          –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
          <span class="events-count">{{ filteredEvents.length }}</span>
          <span v-if="progressiveLoading" class="events-progress">–ø–æ–¥–≥—Ä—É–∂–∞—é‚Ä¶</span>
        </div>

        <TransitionGroup name="list" tag="div" class="events-list">
          <EventCard
            v-for="event in filteredEvents"
            :key="event.id"
            :event="event"
            :photos="photos[event.id] || []"
            :photos-loading="photosLoading"
            @open-photo="openPhoto"
          />
        </TransitionGroup>
      </div>
    </div>

    <!-- PHOTO MODAL -->
    <EventPhotoModal v-if="photoModalUrl" :url="photoModalUrl" @close="photoModalUrl = ''" />
  </div>
</template>

<script>
import { ref, computed, onMounted, onBeforeUnmount } from 'vue'
import EventCard from '../../components/EventCard.vue'
import EventPhotoModal from '../../components/EventPhotoModal.vue'
import { useSupabase } from '../../composables/useSupabase'

const sleep = (ms) => new Promise((r) => setTimeout(r, ms))

const withRetry = async (fn, tries = 3) => {
  let lastErr = null
  for (let i = 0; i < tries; i++) {
    try {
      return await fn()
    } catch (e) {
      lastErr = e
      await sleep(350 * (i + 1))
    }
  }
  throw lastErr
}

// –í–ê–ñ–ù–û: selectCategory —É —Ç–µ–±—è TEXT[] —Å–æ —Å—Ç—Ä–æ–∫–∞–º–∏-–∏–º–µ–Ω–∞–º–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π.
// –ü–æ–¥–¥–µ—Ä–∂–∏–º: –º–∞—Å—Å–∏–≤ —Å—Ç—Ä–æ–∫, —Å—Ç—Ä–æ–∫–∞ "A,B", —Å—Ç—Ä–æ–∫–∞ "A;B", –∏ —Ç.–ø.
const parseEventCategoryNames = (raw) => {
  if (!raw) return []

  // Supabase text[] –æ–±—ã—á–Ω–æ –ø—Ä–∏—Ö–æ–¥–∏—Ç –∫–∞–∫ –º–∞—Å—Å–∏–≤ —Å—Ç—Ä–æ–∫
  if (Array.isArray(raw)) {
    return raw
      .map((x) => (x ?? '').toString().trim())
      .filter(Boolean)
  }

  if (typeof raw === 'string') {
    const s = raw.trim()
    if (!s) return []
    return s
      .split(/[,;|]+/g)
      .map((x) => x.trim())
      .filter(Boolean)
  }

  // –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
  try {
    const v = String(raw).trim()
    return v ? [v] : []
  } catch {
    return []
  }
}

export default {
  name: 'HomeView',
  components: { EventCard, EventPhotoModal },
  props: {
    globalSearchTerm: { type: String, default: '' }
  },
  setup(props) {
    const { getEvents, getCategories, getEventPhotos } = useSupabase()

    const initialLoaded = ref(false)
    const error = ref(null)

    const allEvents = ref([])
    const visibleEvents = ref([])

    const progressiveLoading = ref(false)
    let progressiveTimer = null

    const photos = ref({})

    const categories = ref([])

    // ‚ùóÔ∏è–¢–µ–ø–µ—Ä—å –≤—ã–±–∏—Ä–∞–µ–º –ö–ê–¢–ï–ì–û–†–ò–ò –ü–û –ò–ú–ï–ù–ò (–∫–∞–∫ –≤ selectCategory)
    const selectedCategoryNames = ref([])

    const isAllActive = computed(() => selectedCategoryNames.value.length === 0)

    const photosLoading = ref(false)
    const stopPhotosLoading = ref(false)

    const photoModalUrl = ref('')

    const openPhoto = (url) => {
      if (!url) return
      photoModalUrl.value = url
    }

    const selectAll = () => {
      // "–í—Å–µ" = —Å–±—Ä–æ—Å –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
      selectedCategoryNames.value = []
    }

    const toggleCategory = (name) => {
      const n = String(name || '').trim()
      if (!n) return

      const idx = selectedCategoryNames.value.indexOf(n)
      if (idx >= 0) selectedCategoryNames.value.splice(idx, 1)
      else selectedCategoryNames.value.push(n)
      // –µ—Å–ª–∏ —Å–ø–∏—Å–æ–∫ —Å—Ç–∞–Ω–µ—Ç –ø—É—Å—Ç—ã–º ‚Äî "–í—Å–µ" –∞–∫—Ç–∏–≤

–í—ã —Å–∫–∞–∑–∞–ª–∏:
–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
–ø—Ä–∏ —ç—Ç–æ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è, –≤–æ—Ç —Å–¥–µ–ª–∞–π —Ç–∞–∫ —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –ø–æ—Ç–æ–º –ø—É—Ç–∞–Ω–∏—Ü—ã —Å events.selectCategory –∏ id

ChatGPT —Å–∫–∞–∑–∞–ª:

–î—É–º–∞–ª –Ω–∞ –ø—Ä–æ—Ç—è–∂–µ–Ω–∏–∏ 14s
–ü–æ–Ω—è–ª. –°–µ–π—á–∞—Å —É —Ç–µ–±—è –ø—É—Ç–∞–Ω–∏—Ü–∞ –∏–∑-–∑–∞ —Ç–æ–≥–æ, —á—Ç–æ:

–≤ events.selectCategory –ª–µ–∂–∏—Ç text[] —Å –ù–ê–ó–í–ê–ù–ò–Ø–ú–ò (["–°–ø–æ—Ä—Ç","–•–æ–±–±–∏"])

–∞ –≤ –∫–æ–¥–µ –º–µ—Å—Ç–∞–º–∏ –ª–æ–≥–∏–∫–∞ –æ–∂–∏–¥–∞–µ—Ç id (–∏–∑ —Ç–∞–±–ª–∏—Ü—ã category), –ø–æ—ç—Ç–æ–º—É –ø–æ—è–≤–ª—è–µ—Ç—Å—è –ö–∞—Ç–µ–≥–æ—Ä–∏—è –°–ø–æ—Ä—Ç / –ö–∞—Ç–µ–≥–æ—Ä–∏—è 5 –∏ —Ñ–∏–ª—å—Ç—Ä –º–æ–∂–µ—Ç –Ω–µ —Å–æ–≤–ø–∞–¥–∞—Ç—å.

–†–µ—à–µ–Ω–∏–µ –±–µ–∑ –ø—É—Ç–∞–Ω–∏—Ü—ã (–∂–µ–ª–µ–∑–æ–±–µ—Ç–æ–Ω)
–ú—ã –¥–µ–ª–∞–µ–º –µ–¥–∏–Ω—ã–π ‚Äú–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ç–æ—Ä‚Äù –∫–∞—Ç–µ–≥–æ—Ä–∏–π, –∫–æ—Ç–æ—Ä—ã–π:

–ø—Ä–∏–Ω–∏–º–∞–µ—Ç event.selectCategory –≤ –ª—é–±–æ–º –≤–∏–¥–µ (text[], —Å—Ç—Ä–æ–∫–∞, id, –º–∞—Å—Å–∏–≤ id)

–≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞—Å—Å–∏–≤ –ù–ê–ó–í–ê–ù–ò–ô –∫–∞—Ç–µ–≥–æ—Ä–∏–π

–µ—Å–ª–∏ –≤–¥—Ä—É–≥ —Ç—É–¥–∞ –∫–æ–≥–¥–∞-—Ç–æ –ø–æ–ø–∞–¥—É—Ç id ‚Äî –ø–æ–¥—Å—Ç–∞–≤–∏—Ç –∏–º—è —á–µ—Ä–µ–∑ categoryMap

–ò:

–∫–Ω–æ–ø–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Ä–∞–±–æ—Ç–∞—é—Ç –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—è–º

—Ñ–∏–ª—å—Ç—Ä —Å–æ–±—ã—Ç–∏–π —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏—è

–∫–∞—Ä—Ç–æ—á–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏—è

–Ω–∏–∫–∞–∫–∏—Ö –ö–∞—Ç–µ–≥–æ—Ä–∏—è ... –±–æ–ª—å—à–µ –Ω–µ –±—É–¥–µ—Ç

–ù–∏–∂–µ –≤–µ—Å—å –∫–æ–¥ –¥–≤—É—Ö —Ñ–∞–π–ª–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å.

‚úÖ HomeView.vue (–ø–æ–ª–Ω–æ—Å—Ç—å—é)
<template>
  <div class="page">
    <div class="container">
      <!-- CATEGORIES -->
      <div class="tags-shell">
        <div class="tags-title">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</div>

        <div class="tags-content">
          <!-- ALL -->
          <button class="tag-btn" :class="{ active: isAllActive }" @click="selectAll">
            –í—Å–µ
          </button>

          <!-- CATEGORY BUTTONS -->
          <button
            v-for="cat in categories"
            :key="cat.id"
            class="tag-btn"
            :class="{ active: selectedCategoryNames.includes(cat.name) }"
            @click="toggleCategory(cat.name)"
          >
            {{ cat.name }}
          </button>
        </div>
      </div>

      <!-- STATES -->
      <div v-if="!initialLoaded" class="state">
        <div class="spinner"></div>
        <div>–ó–∞–≥—Ä—É–∑–∫–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π‚Ä¶</div>
      </div>

      <div v-else-if="error" class="state error">
        <div class="error-title">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</div>
        <div class="error-sub">{{ error }}</div>
        <button class="retry" @click="reload">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
      </div>

      <div v-else-if="filteredEvents.length === 0" class="state">–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>

      <!-- EVENTS LIST -->
      <div v-else class="events-shell">
        <div class="events-title">
          –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
          <span class="events-count">{{ filteredEvents.length }}</span>
          <span v-if="progressiveLoading" class="events-progress">–ø–æ–¥–≥—Ä—É–∂–∞—é‚Ä¶</span>
        </div>

        <TransitionGroup name="list" tag="div" class="events-list">
          <EventCard
            v-for="event in filteredEvents"
            :key="event.id"
            :event="event"
            :photos="photos[event.id] || []"
            :photos-loading="photosLoading"
            :category-map="categoryMap"
            @open-photo="openPhoto"
          />
        </TransitionGroup>
      </div>
    </div>

    <!-- PHOTO MODAL -->
    <EventPhotoModal v-if="photoModalUrl" :url="photoModalUrl" @close="photoModalUrl = ''" />
  </div>
</template>

<script>
import { ref, computed, onMounted, onBeforeUnmount } from 'vue'
import EventCard from '../../components/EventCard.vue'
import EventPhotoModal from '../../components/EventPhotoModal.vue'
import { useSupabase } from '../../composables/useSupabase'

const sleep = (ms) => new Promise((r) => setTimeout(r, ms))

const withRetry = async (fn, tries = 3) => {
  let lastErr = null
  for (let i = 0; i < tries; i++) {
    try {
      return await fn()
    } catch (e) {
      lastErr = e
      await sleep(350 * (i + 1))
    }
  }
  throw lastErr
}

/**
 * –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º event.selectCategory -> –ú–ê–°–°–ò–í –ù–ê–ó–í–ê–ù–ò–ô
 * –ü–æ–¥–¥–µ—Ä–∂–∫–∞:
 * - text[] (–∫–∞–∫ —É —Ç–µ–±—è —Å–µ–π—á–∞—Å) => ["–°–ø–æ—Ä—Ç","–•–æ–±–±–∏"]
 * - "–°–ø–æ—Ä—Ç,–•–æ–±–±–∏" / "–°–ø–æ—Ä—Ç;–•–æ–±–±–∏"
 * - id / [id,id]  (–µ—Å–ª–∏ –∫–æ–≥–¥–∞-—Ç–æ –ø–æ–º–µ–Ω—è–µ—à—å) -> –ø–æ–¥—Å—Ç–∞–≤–∏–º name –ø–æ categoryMap
 */
const normalizeCategoryNames = (raw, categoryMap) => {
  const map = categoryMap || {}

  const toName = (v) => {
    if (v === null || v === undefined) return ''
    const s = String(v).trim()
    if (!s) return ''
    // –µ—Å–ª–∏ —ç—Ç–æ id –∏ –µ—Å—Ç—å –≤ –º–∞–ø–µ -> –≤–µ—Ä–Ω–µ–º –∏–º—è
    if (map[s]) return String(map[s]).trim()
    // –µ—Å–ª–∏ —ç—Ç–æ —á–∏—Å–ª–æ —Å—Ç—Ä–æ–∫–æ–π "10"
    const n = Number(s)
    if (!Number.isNaN(n) && map[String(n)]) return String(map[String(n)]).trim()
    // –∏–Ω–∞—á–µ —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ —ç—Ç–æ —É–∂–µ –∏–º—è
    return s
  }

  if (!raw) return []

  // Supabase text[] –æ–±—ã—á–Ω–æ –ø—Ä–∏—Ö–æ–¥–∏—Ç –∫–∞–∫ –º–∞—Å—Å–∏–≤
  if (Array.isArray(raw)) {
    return Array.from(new Set(raw.map(toName).filter(Boolean)))
  }

  if (typeof raw === 'string') {
    const s = raw.trim()
    if (!s) return []
    const parts = s
      .split(/[,;|]+/g)
      .map((x) => x.trim())
      .filter(Boolean)
      .map(toName)
      .filter(Boolean)
    return Array.from(new Set(parts))
  }

  // number / object -> —Å—Ç—Ä–æ–∫–∞
  const one = toName(raw)
  return one ? [one] : []
}

export default {
  name: 'HomeView',
  components: { EventCard, EventPhotoModal },
  props: {
    globalSearchTerm: { type: String, default: '' }
  },
  setup(props) {
    const { getEvents, getCategories, getEventPhotos } = useSupabase()

    const initialLoaded = ref(false)
    const error = ref(null)

    const allEvents = ref([])
    const visibleEvents = ref([])

    const progressiveLoading = ref(false)
    let progressiveTimer = null

    const photos = ref({})

    const categories = ref([])
    const categoryMap = ref({}) // id -> name

    // ‚úÖ –≤—ã–±–∏—Ä–∞–µ–º –¢–û–õ–¨–ö–û –ù–ê–ó–í–ê–ù–ò–Ø –∫–∞—Ç–µ–≥–æ—Ä–∏–π (–∫–∞–∫ –Ω–∞ –∫–Ω–æ–ø–∫–∞—Ö)
    const selectedCategoryNames = ref([])
    const isAllActive = computed(() => selectedCategoryNames.value.length === 0)

    const photosLoading = ref(false)
    const stopPhotosLoading = ref(false)

    const photoModalUrl = ref('')

    const openPhoto = (url) => {
      if (!url) return
      photoModalUrl.value = url
    }

    const selectAll = () => {
      selectedCategoryNames.value = []
    }

    const toggleCategory = (name) => {
      const n = String(name || '').trim()
      if (!n) return

      const idx = selectedCategoryNames.value.indexOf(n)
      if (idx >= 0) selectedCategoryNames.value.splice(idx, 1)
      else selectedCategoryNames.value.push(n)
    }

    const matchesSelectedCategories = (event) => {
      // "–í—Å–µ"
      if (selectedCategoryNames.value.length === 0) return true

      const eventCats = normalizeCategoryNames(event?.selectCategory, categoryMap.value)
      if (!eventCats.length) return false

      const selectedSet = new Set(selectedCategoryNames.value)
      // OR –ª–æ–≥–∏–∫–∞: –µ—Å–ª–∏ —Ö–æ—Ç—å –æ–¥–Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω–∞—è –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è –≤ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏
      return eventCats.some((c) => selectedSet.has(c))
    }

    const matchesSearch = (event) => {
      const term = (props.globalSearchTerm || '').trim().toLowerCase()
      if (!term) return true

      const t = (event.title || '').toLowerCase()
      const d = (event.description || '').toLowerCase()
      const a = (event.address || '').toLowerCase()
      const o = (event.organizer || '').toLowerCase()
      return t.includes(term) || d.includes(term) || a.includes(term) || o.includes(term)
    }

    const filteredEvents = computed(() => {
      return visibleEvents.value.filter((e) => matchesSelectedCategories(e) && matchesSearch(e))
    })

    const stopProgressive = () => {
      progressiveLoading.value = false
      if (progressiveTimer) {
        clearInterval(progressiveTimer)
        progressiveTimer = null
      }
    }

    const startProgressive = (source) => {
      stopProgressive()
      visibleEvents.value = []

      const list = Array.isArray(source) ? source : []
      if (!list.length) return

      progressiveLoading.value = true

      visibleEvents.value.push(list[0])

      let i = 1
      progressiveTimer = setInterval(() => {
        if (i >= list.length) {
          stopProgressive()
          return
        }
        visibleEvents.value.push(list[i])
        i++
      }, 140)
    }

    const loadCategories = async () => {
      try {
        const { data, error: err } = await withRetry(() => getCategories())
        if (err) throw err

        categories.value = data ?? []
        categoryMap.value = (categories.value || []).reduce((acc, c) => {
          acc[String(c.id)] = c.name
          return acc
        }, {})
      } catch (e) {
        console.warn('Categories load error:', e)
        categories.value = []
        categoryMap.value = {}
      }
    }

    const loadEventsProgressive = async () => {
      error.value = null
      stopPhotosLoading.value = true
      photosLoading.value = false
      stopProgressive()

      try {
        const { data: eventsData, error: eventsErr } = await withRetry(() => getEvents())
        if (eventsErr) throw eventsErr

        allEvents.value = eventsData ?? []
        initialLoaded.value = true

        startProgressive(allEvents.value)

        photos.value = {}
        stopPhotosLoading.value = false

        const ids = allEvents.value.map((e) => e.id).filter(Boolean)
        if (!ids.length) return

        photosLoading.value = true

        const batchSize = 5
        for (let i = 0; i < ids.length; i += batchSize) {
          if (stopPhotosLoading.value) break

          const batch = ids.slice(i, i + batchSize)
          try {
            const { data: ph, error: phErr } = await withRetry(() => getEventPhotos(batch))
            if (phErr) throw phErr

            const next = { ...photos.value }
            for (const p of ph ?? []) {
              if (!p?.event_id) continue
              if (!next[p.event_id]) next[p.event_id] = []
              next[p.event_id].push(p)
            }
            photos.value = next
          } catch (e) {
            console.warn('Photos batch load error:', e)
          }

          await sleep(120)
        }
      } catch (e) {
        console.error('HomeView load error:', e)
        allEvents.value = []
        visibleEvents.value = []
        photos.value = {}
        initialLoaded.value = true
        error.value = e?.message ? String(e.message) : 'TypeError: Failed to fetch'
      } finally {
        photosLoading.value = false
      }
    }

    const reload = async () => {
      await loadEventsProgressive()
    }

    onMounted(async () => {
      await loadCategories()
      await loadEventsProgressive()
    })

    onBeforeUnmount(() => {
      stopProgressive()
      stopPhotosLoading.value = true
    })

    return {
      initialLoaded,
      error,
      photos,
      categories,
      categoryMap,

      selectedCategoryNames,
      isAllActive,
      selectAll,
      toggleCategory,

      filteredEvents,
      photosLoading,
      progressiveLoading,
      reload,

      photoModalUrl,
      openPhoto
    }
  }
}
</script>

<style scoped>
.page {
  padding: 16px 0 40px;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 20px;
}

/* TAGS */
.tags-shell {
  background: #fff;
  border: 1px solid #efefef;
  border-radius: 18px;
  padding: 14px 14px 10px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.04);
  margin-bottom: 14px;
}

.tags-title {
  font-weight: 800;
  font-size: 13px;
  opacity: 0.7;
  margin-bottom: 10px;
}

.tags-content {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}

.tag-btn {
  border: 1px solid #efefef;
  background: #fafafa;
  border-radius: 999px;
  padding: 8px 12px;
  cursor: pointer;
  font-size: 13px;
  white-space: nowrap;
}

.tag-btn.active {
  background: #8a75e3;
  border-color: #8a75e3;
  color: #fff;
}

/* STATES */
.state {
  display: grid;
  place-items: center;
  gap: 10px;
  padding: 40px 0;
  opacity: 0.75;
  text-align: center;
}

.state.error {
  opacity: 1;
  color: #d9534f;
}

.error-title {
  font-weight: 800;
}

.error-sub {
  font-size: 12px;
  opacity: 0.8;
  max-width: 680px;
}

.retry {
  margin-top: 8px;
  border: none;
  border-radius: 12px;
  padding: 10px 14px;
  cursor: pointer;
  background: #efefef;
}

.spinner {
  width: 26px;
  height: 26px;
  border-radius: 50%;
  border: 3px solid #eee;
  border-top-color: #8a75e3;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}

/* EVENTS */
.events-shell {
  background: #fff;
  border: 1px solid #efefef;
  border-radius: 18px;
  padding: 14px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.04);
}

.events-title {
  display: flex;
  align-items: center;
  gap: 10px;
  font-weight: 900;
  margin-bottom: 12px;
}

.events-count {
  font-size: 12px;
  opacity: 0.6;
  font-weight: 700;
}

.events-progress {
  font-size: 12px;
  opacity: 0.55;
  font-weight: 700;
  margin-left: auto;
}

.events-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

/* –ø–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫ */
.list-enter-active,
.list-leave-active {
  transition: opacity 240ms ease, transform 240ms ease;
}

.list-enter-from,
.list-leave-to {
  opacity: 0;
  transform: translateY(8px);
}
</style>
‚úÖ EventCard.vue (–ø–æ–ª–Ω–æ—Å—Ç—å—é)
–¢—É—Ç —Ç–æ–∂–µ —É–±–∏—Ä–∞–µ–º –ª—é–±—É—é ‚Äúid-—à–Ω—É—é‚Äù –ª–æ–≥–∏–∫—É –∏ –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–º–µ–Ω–∞.

<template>
  <div class="card">
    <!-- LEFT: PHOTO -->
    <button ref="photoBtn" class="photo" @click="handleOpenPhoto" aria-label="–û—Ç–∫—Ä—ã—Ç—å —Ñ–æ—Ç–æ">
      <div
        v-if="!inView || !imageUrl || !imgLoaded"
        class="photo-skeleton"
        :class="{ shimmer: photosLoading }"
      ></div>

      <img
        v-if="inView && imageUrl"
        :src="imageUrl"
        alt="event photo"
        loading="lazy"
        decoding="async"
        :class="{ loaded: imgLoaded }"
        @load="onImgLoad"
        @error="onImgError"
      />
    </button>

    <!-- RIGHT: INFO -->
    <div class="info">
      <div class="top-row">
        <div class="title">{{ event.title }}</div>

        <div class="badges">
          <span v-if="event.is_online" class="badge">üü¢ –û–Ω–ª–∞–π–Ω</span>
          <span v-if="event.is_free" class="badge">üÜì –ë–µ—Å–ø–ª–∞—Ç–Ω–æ</span>

          <!-- ‚úÖ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–ª—å–∫–æ –ø–æ –ò–ú–ï–ù–ê–ú -->
          <span v-for="c in categoryNames" :key="c" class="badge">
            {{ c }}
          </span>
        </div>
      </div>

      <!-- –û–ø–∏—Å–∞–Ω–∏–µ: —Å –∞–±–∑–∞—Ü–∞ -->
      <p v-if="event.description" class="desc">
        {{ event.description }}
      </p>

      <div class="meta">
        <div class="meta-item">
          <span class="k">üìÖ</span>
          <span class="v">{{ formattedDateTime }}</span>
        </div>

        <div class="meta-item">
          <span class="k">üìç</span>
          <span class="v">{{ event.address || '‚Äî' }}</span>
        </div>

        <div class="meta-item">
          <span class="k">üë§</span>
          <span class="v">{{ event.organizer || '‚Äî' }}</span>
        </div>

        <div class="meta-item">
          <span class="k">üí∞</span>
          <span class="v price">{{ formattedPrice }}</span>
        </div>
      </div>

      <div v-if="morePhotos.length" class="thumbs">
        <button
          v-for="p in morePhotos"
          :key="p.id"
          class="thumb"
          @click="emitOpenPhoto(p.photo_url)"
          aria-label="–û—Ç–∫—Ä—ã—Ç—å —Ñ–æ—Ç–æ"
        >
          <img :src="p.photo_url" alt="thumb" loading="lazy" decoding="async" />
        </button>
      </div>
    </div>
  </div>
</template>

<script>
// —Ç–æ—Ç –∂–µ ‚Äú–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ç–æ—Ä‚Äù: —Å–µ–ª–µ–∫—Ç–ö–∞—Ç–µ–≥–æ—Ä–∏ -> –∏–º–µ–Ω–∞
const normalizeCategoryNames = (raw, categoryMap) => {
  const map = categoryMap || {}

  const toName = (v) => {
    if (v === null || v === undefined) return ''
    const s = String(v).trim()
    if (!s) return ''
    if (map[s]) return String(map[s]).trim()
    const n = Number(s)
    if (!Number.isNaN(n) && map[String(n)]) return String(map[String(n)]).trim()
    return s
  }

  if (!raw) return []

  if (Array.isArray(raw)) {
    return Array.from(new Set(raw.map(toName).filter(Boolean)))
  }

  if (typeof raw === 'string') {
    const s = raw.trim()
    if (!s) return []
    const parts = s
      .split(/[,;|]+/g)
      .map((x) => x.trim())
      .filter(Boolean)
      .map(toName)
      .filter(Boolean)
    return Array.from(new Set(parts))
  }

  const one = toName(raw)
  return one ? [one] : []
}

export default {
  name: 'EventCard',
  emits: ['open-photo'],
  props: {
    event: { type: Object, required: true },
    photos: { type: Array, default: () => [] },
    photosLoading: { type: Boolean, default: false },
    // –µ—Å–ª–∏ –≤–¥—Ä—É–≥ selectCategory –∫–æ–≥–¥–∞-–Ω–∏–±—É–¥—å —Å—Ç–∞–Ω–µ—Ç id ‚Äî –º–∞–ø–∞ —Å–ø–∞—Å—ë—Ç
    categoryMap: { type: Object, default: () => ({}) }
  },
  computed: {
    imageUrl() {
      const first = Array.isArray(this.photos) ? this.photos[0] : null
      return (first?.photo_url || '').trim()
    },
    morePhotos() {
      if (!Array.isArray(this.photos)) return []
      return this.photos.slice(1, 6).filter((p) => p?.photo_url)
    },
    categoryNames() {
      return normalizeCategoryNames(this.event?.selectCategory, this.categoryMap)
    },
    formattedDateTime() {
      if (!this.event?.date_time_event) return '‚Äî'
      const d = new Date(this.event.date_time_event)
      if (Number.isNaN(d.getTime())) return String(this.event.date_time_event)
      return d.toLocaleString('ru-RU', {
        day: 'numeric',
        month: 'long',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      })
    },
    formattedPrice() {
      if (this.event?.is_free) return '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ'
      if (this.event?.price === 0 || this.event?.price === null) return '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ'
      return `${this.event.price} ‚ÇΩ`
    }
  },
  data() {
    return {
      inView: false,
      imgLoaded: false,
      io: null
    }
  },
  watch: {
    imageUrl() {
      this.imgLoaded = false
    }
  },
  mounted() {
    const el = this.$refs.photoBtn
    if (!el || typeof window === 'undefined') {
      this.inView = true
      return
    }

    if (!('IntersectionObserver' in window)) {
      this.inView = true
      return
    }

    this.io = new IntersectionObserver(
      (entries) => {
        const entry = entries[0]
        if (entry?.isIntersecting) {
          this.inView = true
          if (this.io) {
            this.io.disconnect()
            this.io = null
          }
        }
      },
      { root: null, rootMargin: '250px 0px', threshold: 0.01 }
    )

    this.io.observe(el)
  },
  beforeUnmount() {
    if (this.io) {
      this.io.disconnect()
      this.io = null
    }
  },
  methods: {
    onImgLoad() {
      this.imgLoaded = true
    },
    onImgError() {
      this.imgLoaded = true
    },
    emitOpenPhoto(url) {
      if (!url) return
      this.$emit('open-photo', url)
    },
    handleOpenPhoto() {
      if (!this.imageUrl) return
      this.emitOpenPhoto(this.imageUrl)
    }
  }
}
</script>

<style scoped>
.card,
.info,
.title,
.desc,
.meta,
.meta-item,
.v {
  min-width: 0;
}

.card {
  display: grid;
  grid-template-columns: 220px 1fr;
  gap: 14px;
  padding: 14px;
  border-radius: 18px;
  border: 1px solid #efefef;
  background: #fff;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.04);
  overflow: hidden;
}

.photo {
  width: 220px;
  height: 160px;
  border-radius: 16px;
  overflow: hidden;
  border: none;
  padding: 0;
  background: #f5f5f5;
  cursor: pointer;
  position: relative;
}

.photo img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
  opacity: 0;
  transform: scale(1.01);
  transition: opacity 260ms ease, transform 260ms ease;
}

.photo img.loaded {
  opacity: 1;
  transform: scale(1);
}

.photo-skeleton {
  width: 100%;
  height: 100%;
  background: #f0f0f0;
}

.shimmer {
  position: relative;
  overflow: hidden;
}
.shimmer::after {
  content: '';
  position: absolute;
  inset: 0;
  transform: translateX(-100%);
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.7), transparent);
  animation: shimmer 1.2s infinite;
}
@keyframes shimmer {
  to {
    transform: translateX(100%);
  }
}

.info {
  display: flex;
  flex-direction: column;
  gap: 10px;
  overflow: hidden;
}

.top-row {
  display: flex;
  flex-direction: column;
  gap: 8px;
  overflow: hidden;
}

.title {
  font-size: 18px;
  font-weight: 900;
  white-space: normal;
  overflow-wrap: anywhere;
  word-break: break-word;
  line-height: 1.2;
}

.badges {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  overflow: hidden;
}

.badge {
  font-size: 12px;
  font-weight: 700;
  padding: 6px 10px;
  border-radius: 999px;
  background: rgba(138, 117, 227, 0.12);
  border: 1px solid rgba(138, 117, 227, 0.22);
  white-space: normal;
  overflow-wrap: anywhere;
  word-break: break-word;
  max-width: 100%;
}

.desc {
  margin: 0;
  font-size: 14px;
  opacity: 0.85;
  line-height: 1.35;
  text-indent: 1.2em;
  white-space: pre-line;
  overflow-wrap: anywhere;
  word-break: break-word;
}

.meta {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px 14px;
  overflow: hidden;
}

.meta-item {
  display: flex;
  gap: 8px;
  align-items: flex-start;
  font-size: 14px;
  overflow: hidden;
}

.k {
  width: 18px;
  opacity: 0.9;
  flex: 0 0 18px;
}

.v {
  opacity: 0.9;
  white-space: normal;
  overflow-wrap: anywhere;
  word-break: break-word;
}

.price {
  font-weight: 900;
}

.thumbs {
  display: flex;
  gap: 8px;
  margin-top: 4px;
  flex-wrap: wrap;
}

.thumb {
  width: 48px;
  height: 48px;
  border-radius: 12px;
  overflow: hidden;
  border: 1px solid #efefef;
  background: #fff;
  padding: 0;
  cursor: pointer;
}
.thumb img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

@media (max-width: 760px) {
  .card {
    grid-template-columns: 1fr;
  }
  .photo {
    width: 100%;
    height: 200px;
  }
  .meta {
    grid-template-columns: 1fr;
  }
}
</style>
–í–∞–∂–Ω–æ (—á—Ç–æ–±—ã –ø—É—Ç–∞–Ω–∏—Ü—ã –≤–æ–æ–±—â–µ –Ω–µ –±—ã–ª–æ)
–ï—Å–ª–∏ —Ç—ã –æ—Å—Ç–∞–≤–ª—è–µ—à—å events.selectCategory –∫–∞–∫ text[] (names) ‚Äî —ç—Ç–æ –æ–∫, –Ω–æ —Ç–æ–≥–¥–∞ –≤–µ–∑–¥–µ —Ä–∞–±–æ—Ç–∞–µ–º —Å –∏–º–µ–Ω–∞–º–∏, –∫–∞–∫ —Å–µ–π—á–∞—Å –≤ –∫–æ–¥–µ.

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å ‚Äú–∏–¥–µ–∞–ª—å–Ω–æ –ø–æ-–±–∞–∑–æ–≤–æ–º—É‚Äù, —Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–µ–µ —Ö—Ä–∞–Ω–∏—Ç—å id[] (int[]) ‚Äî –Ω–æ —ç—Ç–æ —É–∂–µ –º–∏–≥—Ä–∞—Ü–∏—è –ë–î. –°–µ–π—á–∞—Å —è —Å–¥–µ–ª–∞–ª –∫–æ–¥ —Ç–∞–∫, —á—Ç–æ –æ–Ω –Ω–µ —Å–ª–æ–º–∞–µ—Ç—Å—è, –¥–∞–∂–µ –µ—Å–ª–∏ —Ç—ã –ø–æ—Ç–æ–º –ø–æ–º–µ–Ω—è–µ—à—å —Ç–∏–ø –Ω–∞ id: –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ç–æ—Ä –ø–æ–¥—Ö–≤–∞—Ç–∏—Ç –∏ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –≤ –∏–º–µ–Ω–∞ —á–µ—Ä–µ–∑ categoryMap.


–í—ã —Å–∫–∞–∑–∞–ª–∏:
–∫–∞–π—Ñ, —Ç–µ–ø–µ—Ä—å –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø–æ —Å–ª–µ–¥—É—é—â–∏–º –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º.

 –î–æ–±–∞–≤—å –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –¥–ª—è –ø–ª–∞—Ç–Ω—ã—Ö(–±–µ—Å–ø–ª–∞—Ç–Ω–æ, –æ—Ç 100 –¥–æ 1000, –æ—Ç 1000 –¥–æ 3000, –æ—Ç 3000 –¥–æ 10000, –±–æ–ª—å—à–µ 10000, —É–∫–∞–∑–∞—Ç—å —Å–≤–æ–π –¥–∏–∞–ø–∞–∑–æ–Ω)

–ò –¥–æ–±–∞–≤—å –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –¥–ª—è –¥–∞—Ç—ã, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤—ã–±—Ä–∞—Ç—å  –º–µ–∂–¥—É –≤—Å–µ –≤—Ä–µ–º—è, –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—É—é –¥–∞—Ç—É, –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç, –≤—Å—ë —á—Ç–æ –ø–æ—Å–ª–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–π –¥–∞—Ç—ã, –≤—Å—ë —á—Ç–æ –¥–æ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–π –¥–∞—Ç—ã –Ω—É –∏ –º–æ–∂–µ—à—å –æ—Ç —Å–µ–±—è —á—Ç–æ–Ω–∏—Ç—å –¥–æ–±–∞–≤–∏—Ç—å. —Å–¥–µ–ª–∞–π —ç—Ç–æ –∏–Ω—Ç—É–∏—Ç–∏–≤–Ω–æ –ø–æ–Ω—è—Ç–Ω—ã–º —Å –ø–æ–º–æ—â—å—é –∫–∞–∫–æ–≥–æ–Ω–∏—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä–∏–∫–∞

–í—Å—ë –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Å—Ç–∏–ª—å–Ω–µ–Ω—å–∫–æ

–í—ã–ø–∏—à–∏ –≤–µ—Å—å –∫–æ–¥


ChatGPT —Å–∫–∞–∑–∞–ª:
–û–∫, –¥–æ–±–∞–≤–∏–ª 2 –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–∞: –¶–µ–Ω–∞ + –î–∞—Ç–∞ (—Å ‚Äú–∫–∞–ª–µ–Ω–¥–∞—Ä–∏–∫–æ–º‚Äù —á–µ—Ä–µ–∑ input type="date"), –≤—Å—ë –∏–Ω—Ç—É–∏—Ç–∏–≤–Ω–æ –∏ —Å—Ç–∏–ª—å–Ω–æ.
–§–∏–ª—å—Ç—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç –≤–º–µ—Å—Ç–µ —Å –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ –∏ –ø–æ–∏—Å–∫–æ–º.

–ù–∏–∂–µ –≤–µ—Å—å –∫–æ–¥ HomeView.vue –ø–æ–ª–Ω–æ—Å—Ç—å—é (—ç—Ç–æ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Ñ–∞–π–ª, –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏).

‚úÖ HomeView.vue (–ø–æ–ª–Ω–æ—Å—Ç—å—é)
<template>
  <div class="page">
    <div class="container">
      <!-- FILTERS: CATEGORIES -->
      <div class="filters-shell">
        <div class="filters-head">
          <div class="filters-title">–§–∏–ª—å—Ç—Ä—ã</div>
          <button class="reset-btn" @click="resetAllFilters">–°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë</button>
        </div>

        <div class="filter-block">
          <div class="filter-label">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</div>
          <div class="tags-content">
            <button class="tag-btn" :class="{ active: isAllCategoriesActive }" @click="selectAllCategories">
              –í—Å–µ
            </button>

            <button
              v-for="cat in categories"
              :key="cat.id"
              class="tag-btn"
              :class="{ active: selectedCategoryNames.includes(cat.name) }"
              @click="toggleCategory(cat.name)"
            >
              {{ cat.name }}
            </button>
          </div>
        </div>

        <!-- FILTERS: PRICE + DATE -->
        <div class="filter-grid">
          <!-- PRICE -->
          <div class="filter-card">
            <div class="filter-card-title">–¶–µ–Ω–∞</div>

            <div class="segmented">
              <button class="seg-btn" :class="{ active: priceMode === 'all' }" @click="setPriceMode('all')">
                –õ—é–±–∞—è
              </button>
              <button class="seg-btn" :class="{ active: priceMode === 'free' }" @click="setPriceMode('free')">
                –ë–µ—Å–ø–ª–∞—Ç–Ω–æ
              </button>
              <button class="seg-btn" :class="{ active: priceMode === 'custom' }" @click="setPriceMode('custom')">
                –°–≤–æ–π –¥–∏–∞–ø–∞–∑–æ–Ω
              </button>
            </div>

            <div class="chips">
              <button
                class="chip"
                :class="{ active: priceMode === '100_1000' }"
                @click="setPriceMode('100_1000')"
              >
                100‚Äì1000
              </button>
              <button
                class="chip"
                :class="{ active: priceMode === '1000_3000' }"
                @click="setPriceMode('1000_3000')"
              >
                1000‚Äì3000
              </button>
              <button
                class="chip"
                :class="{ active: priceMode === '3000_10000' }"
                @click="setPriceMode('3000_10000')"
              >
                3000‚Äì10000
              </button>
              <button
                class="chip"
                :class="{ active: priceMode === 'gt_10000' }"
                @click="setPriceMode('gt_10000')"
              >
                &gt; 10000
              </button>
            </div>

            <div v-if="priceMode === 'custom'" class="range-row">
              <div class="field">
                <div class="field-label">–æ—Ç</div>
                <input
                  class="input"
                  type="number"
                  min="0"
                  inputmode="numeric"
                  placeholder="0"
                  v-model="customPriceMin"
                />
              </div>
              <div class="field">
                <div class="field-label">–¥–æ</div>
                <input
                  class="input"
                  type="number"
                  min="0"
                  inputmode="numeric"
                  placeholder="‚àû"
                  v-model="customPriceMax"
                />
              </div>
            </div>

            <div class="hint">
              –°—á–∏—Ç–∞–µ–º –ø–æ <b>price</b>. –ï—Å–ª–∏ <b>is_free=true</b> –∏–ª–∏ price=0 ‚Äî —ç—Ç–æ ‚Äú–ë–µ—Å–ø–ª–∞—Ç–Ω–æ‚Äù.
            </div>
          </div>

          <!-- DATE -->
          <div class="filter-card">
            <div class="filter-card-title">–î–∞—Ç–∞</div>

            <div class="segmented">
              <button class="seg-btn" :class="{ active: dateMode === 'all' }" @click="setDateMode('all')">
                –í—Å—ë –≤—Ä–µ–º—è
              </button>
              <button class="seg-btn" :class="{ active: dateMode === 'on' }" @click="setDateMode('on')">
                –ù–∞ –¥–∞—Ç—É
              </button>
              <button class="seg-btn" :class="{ active: dateMode === 'range' }" @click="setDateMode('range')">
                –î–∏–∞–ø–∞–∑–æ–Ω
              </button>
            </div>

            <div class="chips">
              <button class="chip" :class="{ active: dateMode === 'after' }" @click="setDateMode('after')">
                –ü–æ—Å–ª–µ –¥–∞—Ç—ã
              </button>
              <button class="chip" :class="{ active: dateMode === 'before' }" @click="setDateMode('before')">
                –î–æ –¥–∞—Ç—ã
              </button>
              <button class="chip" :class="{ active: dateMode === 'next7' }" @click="setDateMode('next7')">
                –°–ª–µ–¥. 7 –¥–Ω–µ–π
              </button>
              <button class="chip" :class="{ active: dateMode === 'today' }" @click="setDateMode('today')">
                –°–µ–≥–æ–¥–Ω—è
              </button>
            </div>

            <!-- calendar inputs -->
            <div v-if="dateMode === 'on'" class="calendar-row">
              <div class="field grow">
                <div class="field-label">–í—ã–±–µ—Ä–∏ –¥–∞—Ç—É</div>
                <input class="input" type="date" v-model="dateOn" />
              </div>
            </div>

            <div v-else-if="dateMode === 'range'" class="calendar-row">
              <div class="field grow">
                <div class="field-label">—Å</div>
                <input class="input" type="date" v-model="dateFrom" />
              </div>
              <div class="field grow">
                <div class="field-label">–ø–æ</div>
                <input class="input" type="date" v-model="dateTo" />
              </div>
            </div>

            <div v-else-if="dateMode === 'after'" class="calendar-row">
              <div class="field grow">
                <div class="field-label">–ü–æ—Å–ª–µ</div>
                <input class="input" type="date" v-model="datePivot" />
              </div>
            </div>

            <div v-else-if="dateMode === 'before'" class="calendar-row">
              <div class="field grow">
                <div class="field-label">–î–æ</div>
                <input class="input" type="date" v-model="datePivot" />
              </div>
            </div>

            <div class="hint">–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ <b>date_time_event</b> (–¥–∞—Ç–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è).</div>
          </div>
        </div>
      </div>

      <!-- STATES -->
      <div v-if="!initialLoaded" class="state">
        <div class="spinner"></div>
        <div>–ó–∞–≥—Ä—É–∑–∫–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π‚Ä¶</div>
      </div>

      <div v-else-if="error" class="state error">
        <div class="error-title">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</div>
        <div class="error-sub">{{ error }}</div>
        <button class="retry" @click="reload">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
      </div>

      <div v-else-if="filteredEvents.length === 0" class="state">–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>

      <!-- EVENTS LIST -->
      <div v-else class="events-shell">
        <div class="events-title">
          –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
          <span class="events-count">{{ filteredEvents.length }}</span>
          <span v-if="progressiveLoading" class="events-progress">–ø–æ–¥–≥—Ä—É–∂–∞—é‚Ä¶</span>
        </div>

        <TransitionGroup name="list" tag="div" class="events-list">
          <EventCard
            v-for="event in filteredEvents"
            :key="event.id"
            :event="event"
            :photos="photos[event.id] || []"
            :photos-loading="photosLoading"
            :category-map="categoryMap"
            @open-photo="openPhoto"
          />
        </TransitionGroup>
      </div>
    </div>

    <!-- PHOTO MODAL -->
    <EventPhotoModal v-if="photoModalUrl" :url="photoModalUrl" @close="photoModalUrl = ''" />
  </div>
</template>

<script>
import { ref, computed, onMounted, onBeforeUnmount } from 'vue'
import EventCard from '../../components/EventCard.vue'
import EventPhotoModal from '../../components/EventPhotoModal.vue'
import { useSupabase } from '../../composables/useSupabase'

const sleep = (ms) => new Promise((r) => setTimeout(r, ms))

const withRetry = async (fn, tries = 3) => {
  let lastErr = null
  for (let i = 0; i < tries; i++) {
    try {
      return await fn()
    } catch (e) {
      lastErr = e
      await sleep(350 * (i + 1))
    }
  }
  throw lastErr
}

/**
 * –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º event.selectCategory -> –ú–ê–°–°–ò–í –ù–ê–ó–í–ê–ù–ò–ô
 * –ü–æ–¥–¥–µ—Ä–∂–∫–∞:
 * - text[] (–∫–∞–∫ —É —Ç–µ–±—è —Å–µ–π—á–∞—Å) => ["–°–ø–æ—Ä—Ç","–•–æ–±–±–∏"]
 * - "–°–ø–æ—Ä—Ç,–•–æ–±–±–∏" / "–°–ø–æ—Ä—Ç;–•–æ–±–±–∏"
 * - id / [id,id]  (–µ—Å–ª–∏ –∫–æ–≥–¥–∞-—Ç–æ –ø–æ–º–µ–Ω—è–µ—à—å) -> –ø–æ–¥—Å—Ç–∞–≤–∏–º name –ø–æ categoryMap
 */
const normalizeCategoryNames = (raw, categoryMap) => {
  const map = categoryMap || {}

  const toName = (v) => {
    if (v === null || v === undefined) return ''
    const s = String(v).trim()
    if (!s) return ''
    if (map[s]) return String(map[s]).trim()
    const n = Number(s)
    if (!Number.isNaN(n) && map[String(n)]) return String(map[String(n)]).trim()
    return s
  }

  if (!raw) return []

  if (Array.isArray(raw)) {
    return Array.from(new Set(raw.map(toName).filter(Boolean)))
  }

  if (typeof raw === 'string') {
    const s = raw.trim()
    if (!s) return []
    const parts = s
      .split(/[,;|]+/g)
      .map((x) => x.trim())
      .filter(Boolean)
      .map(toName)
      .filter(Boolean)
    return Array.from(new Set(parts))
  }

  const one = toName(raw)
  return one ? [one] : []
}

const toNumberOrNull = (v) => {
  if (v === null || v === undefined) return null
  const n = Number(v)
  return Number.isFinite(n) ? n : null
}

const startOfDay = (d) => new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0, 0, 0, 0)
const endOfDay = (d) => new Date(d.getFullYear(), d.getMonth(), d.getDate(), 23, 59, 59, 999)

const parseEventDate = (value) => {
  if (!value) return null
  const d = new Date(value)
  if (Number.isNaN(d.getTime())) return null
  return d
}

const parseDateInput = (yyyy_mm_dd) => {
  if (!yyyy_mm_dd) return null
  // type="date" -> "YYYY-MM-DD"
  const [y, m, day] = yyyy_mm_dd.split('-').map((x) => Number(x))
  if (!y || !m || !day) return null
  return new Date(y, m - 1, day)
}

export default {
  name: 'HomeView',
  components: { EventCard, EventPhotoModal },
  props: {
    globalSearchTerm: { type: String, default: '' }
  },
  setup(props) {
    const { getEvents, getCategories, getEventPhotos } = useSupabase()

    const initialLoaded = ref(false)
    const error = ref(null)

    const allEvents = ref([])
    const visibleEvents = ref([])

    const progressiveLoading = ref(false)
    let progressiveTimer = null

    const photos = ref({})

    const categories = ref([])
    const categoryMap = ref({}) // id -> name

    // ‚úÖ –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ (–ø–æ –∏–º–µ–Ω–∞–º)
    const selectedCategoryNames = ref([])
    const isAllCategoriesActive = computed(() => selectedCategoryNames.value.length === 0)

    // ‚úÖ –¶–µ–Ω–∞
    // all | free | 100_1000 | 1000_3000 | 3000_10000 | gt_10000 | custom
    const priceMode = ref('all')
    const customPriceMin = ref('')
    const customPriceMax = ref('')

    // ‚úÖ –î–∞—Ç–∞
    // all | on | range | after | before | next7 | today
    const dateMode = ref('all')
    const dateOn = ref('')
    const dateFrom = ref('')
    const dateTo = ref('')
    const datePivot = ref('')

    const photosLoading = ref(false)
    const stopPhotosLoading = ref(false)

    const photoModalUrl = ref('')

    const openPhoto = (url) => {
      if (!url) return
      photoModalUrl.value = url
    }

    // ---------- UI actions ----------
    const selectAllCategories = () => {
      selectedCategoryNames.value = []
    }

    const toggleCategory = (name) => {
      const n = String(name || '').trim()
      if (!n) return
      const idx = selectedCategoryNames.value.indexOf(n)
      if (idx >= 0) selectedCategoryNames.value.splice(idx, 1)
      else selectedCategoryNames.value.push(n)
    }

    const setPriceMode = (mode) => {
      priceMode.value = mode
      if (mode !== 'custom') {
        // –Ω–µ —Ç—Ä–æ–≥–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è, –Ω–æ –æ–Ω–∏ –Ω–µ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è
      }
    }

    const setDateMode = (mode) => {
      dateMode.value = mode
      // –æ—Å—Ç–∞–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –≤ –∏–Ω–ø—É—Ç–∞—Ö ‚Äî –≤–¥—Ä—É–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è
    }

    const resetAllFilters = () => {
      // –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
      selectedCategoryNames.value = []
      // —Ü–µ–Ω–∞
      priceMode.value = 'all'
      customPriceMin.value = ''
      customPriceMax.value = ''
      // –¥–∞—Ç–∞
      dateMode.value = 'all'
      dateOn.value = ''
      dateFrom.value = ''
      dateTo.value = ''
      datePivot.value = ''
    }

    // ---------- filtering ----------
    const matchesSelectedCategories = (event) => {
      if (selectedCategoryNames.value.length === 0) return true

      const eventCats = normalizeCategoryNames(event?.selectCategory, categoryMap.value)
      if (!eventCats.length) return false

      const selectedSet = new Set(selectedCategoryNames.value)
      return eventCats.some((c) => selectedSet.has(c))
    }

    const getEventPrice = (event) => {
      // –µ—Å–ª–∏ is_free true –∏–ª–∏ price=0 -> –±–µ—Å–ø–ª–∞—Ç–Ω–æ
      if (event?.is_free === true) return 0
      const p = toNumberOrNull(event?.price)
      if (p === null) return null
      return p
    }

    const matchesPrice = (event) => {
      const mode = priceMode.value
      if (mode === 'all') return true

      const price = getEventPrice(event)

      if (mode === 'free') {
        return price === 0
      }

      // –µ—Å–ª–∏ price –Ω–µ —á–∏—Å–ª–æ (null) ‚Äî –Ω–µ –≤–∫–ª—é—á–∞–µ–º –≤ –ø–ª–∞—Ç–Ω—ã–µ –¥–∏–∞–ø–∞–∑–æ–Ω—ã
      if (price === null) return false

      if (mode === '100_1000') return price >= 100 && price <= 1000
      if (mode === '1000_3000') return price >= 1000 && price <= 3000
      if (mode === '3000_10000') return price >= 3000 && price <= 10000
      if (mode === 'gt_10000') return price > 10000

      if (mode === 'custom') {
        const min = customPriceMin.value === '' ? null : toNumberOrNull(customPriceMin.value)
        const max = customPriceMax.value === '' ? null : toNumberOrNull(customPriceMax.value)

        // –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤—ë–ª –Ω–µ–≤–∞–ª–∏–¥–Ω–æ ‚Äî –ø—Ä–æ—Å—Ç–æ –Ω–µ —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ø–æ —ç—Ç–æ–º—É –∫—Ä–∞—é
        const okMin = min === null ? true : price >= min
        const okMax = max === null ? true : price <= max
        return okMin && okMax
      }

      return true
    }

    const matchesDate = (event) => {
      const mode = dateMode.value
      if (mode === 'all') return true

      const d = parseEventDate(event?.date_time_event)
      if (!d) return false

      if (mode === 'today') {
        const now = new Date()
        return d >= startOfDay(now) && d <= endOfDay(now)
      }

      if (mode === 'next7') {
        const now = new Date()
        const from = startOfDay(now)
        const to = endOfDay(new Date(now.getFullYear(), now.getMonth(), now.getDate() + 7))
        return d >= from && d <= to
      }

      if (mode === 'on') {
        const on = parseDateInput(dateOn.value)
        if (!on) return true // –µ—Å–ª–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞ –¥–∞—Ç–∞ ‚Äî –Ω–µ —Ä–µ–∂–µ–º
        return d >= startOfDay(on) && d <= endOfDay(on)
      }

      if (mode === 'range') {
        const fromD = parseDateInput(dateFrom.value)
        const toD = parseDateInput(dateTo.value)
        if (!fromD && !toD) return true
        const from = fromD ? startOfDay(fromD) : null
        const to = toD ? endOfDay(toD) : null
        const okFrom = from ? d >= from : true
        const okTo = to ? d <= to : true
        return okFrom && okTo
      }

      if (mode === 'after') {
        const pivot = parseDateInput(datePivot.value)
        if (!pivot) return true
        return d >= startOfDay(pivot)
      }

      if (mode === 'before') {
        const pivot = parseDateInput(datePivot.value)
        if (!pivot) return true
        return d <= endOfDay(pivot)
      }

      return true
    }

    const matchesSearch = (event) => {
      const term = (props.globalSearchTerm || '').trim().toLowerCase()
      if (!term) return true

      const t = (event.title || '').toLowerCase()
      const d = (event.description || '').toLowerCase()
      const a = (event.address || '').toLowerCase()
      const o = (event.organizer || '').toLowerCase()
      return t.includes(term) || d.includes(term) || a.includes(term) || o.includes(term)
    }

    const filteredEvents = computed(() => {
      return visibleEvents.value.filter(
        (e) =>
          matchesSelectedCategories(e) &&
          matchesPrice(e) &&
          matchesDate(e) &&
          matchesSearch(e)
      )
    })

    // ---------- progressive loading ----------
    const stopProgressive = () => {
      progressiveLoading.value = false
      if (progressiveTimer) {
        clearInterval(progressiveTimer)
        progressiveTimer = null
      }
    }

    const startProgressive = (source) => {
      stopProgressive()
      visibleEvents.value = []

      const list = Array.isArray(source) ? source : []
      if (!list.length) return

      progressiveLoading.value = true
      visibleEvents.value.push(list[0])

      let i = 1
      progressiveTimer = setInterval(() => {
        if (i >= list.length) {
          stopProgressive()
          return
        }
        visibleEvents.value.push(list[i])
        i++
      }, 140)
    }

    // ---------- data loading ----------
    const loadCategories = async () => {
      try {
        const { data, error: err } = await withRetry(() => getCategories())
        if (err) throw err

        categories.value = data ?? []
        categoryMap.value = (categories.value || []).reduce((acc, c) => {
          acc[String(c.id)] = c.name
          return acc
        }, {})
      } catch (e) {
        console.warn('Categories load error:', e)
        categories.value = []
        categoryMap.value = {}
      }
    }

    const loadEventsProgressive = async () => {
      error.value = null
      stopPhotosLoading.value = true
      photosLoading.value = false
      stopProgressive()

      try {
        const { data: eventsData, error: eventsErr } = await withRetry(() => getEvents())
        if (eventsErr) throw eventsErr

        allEvents.value = eventsData ?? []
        initialLoaded.value = true

        startProgressive(allEvents.value)

        // photos in background
        photos.value = {}
        stopPhotosLoading.value = false

        const ids = allEvents.value.map((e) => e.id).filter(Boolean)
        if (!ids.length) return

        photosLoading.value = true

        const batchSize = 5
        for (let i = 0; i < ids.length; i += batchSize) {
          if (stopPhotosLoading.value) break

          const batch = ids.slice(i, i + batchSize)
          try {
            const { data: ph, error: phErr } = await withRetry(() => getEventPhotos(batch))
            if (phErr) throw phErr

            const next = { ...photos.value }
            for (const p of ph ?? []) {
              if (!p?.event_id) continue
              if (!next[p.event_id]) next[p.event_id] = []
              next[p.event_id].push(p)
            }
            photos.value = next
          } catch (e) {
            console.warn('Photos batch load error:', e)
          }

          await sleep(120)
        }
      } catch (e) {
        console.error('HomeView load error:', e)
        allEvents.value = []
        visibleEvents.value = []
        photos.value = {}
        initialLoaded.value = true
        error.value = e?.message ? String(e.message) : 'TypeError: Failed to fetch'
      } finally {
        photosLoading.value = false
      }
    }

    const reload = async () => {
      await loadEventsProgressive()
    }

    onMounted(async () => {
      await loadCategories()
      await loadEventsProgressive()
    })

    onBeforeUnmount(() => {
      stopProgressive()
      stopPhotosLoading.value = true
    })

    return {
      // data
      initialLoaded,
      error,
      photos,
      categories,
      categoryMap,
      filteredEvents,
      photosLoading,
      progressiveLoading,

      // categories
      selectedCategoryNames,
      isAllCategoriesActive,
      selectAllCategories,
      toggleCategory,

      // price
      priceMode,
      setPriceMode,
      customPriceMin,
      customPriceMax,

      // date
      dateMode,
      setDateMode,
      dateOn,
      dateFrom,
      dateTo,
      datePivot,

      // actions
      resetAllFilters,
      reload,

      // modal
      photoModalUrl,
      openPhoto
    }
  }
}
</script>

<style scoped>
.page {
  padding: 16px 0 40px;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 20px;
}

/* FILTERS WRAP */
.filters-shell {
  background: #fff;
  border: 1px solid #efefef;
  border-radius: 20px;
  padding: 14px;
  box-shadow: 0 2px 14px rgba(0, 0, 0, 0.04);
  margin-bottom: 14px;
}

.filters-head {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 10px;
}

.filters-title {
  font-weight: 900;
  font-size: 16px;
}

.reset-btn {
  margin-left: auto;
  border: 1px solid #efefef;
  background: #fafafa;
  border-radius: 12px;
  padding: 8px 10px;
  cursor: pointer;
  font-size: 13px;
}

.reset-btn:hover {
  background: #f3f3f3;
}

.filter-block {
  border: 1px solid #f2f2f2;
  border-radius: 16px;
  padding: 12px;
  background: #fcfcfc;
}

.filter-label {
  font-weight: 800;
  font-size: 13px;
  opacity: 0.7;
  margin-bottom: 10px;
}

/* CATEGORY TAGS */
.tags-content {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}

.tag-btn {
  border: 1px solid #efefef;
  background: #fafafa;
  border-radius: 999px;
  padding: 8px 12px;
  cursor: pointer;
  font-size: 13px;
  white-space: nowrap;
}

.tag-btn.active {
  background: #8a75e3;
  border-color: #8a75e3;
  color: #fff;
}

/* GRID for price/date */
.filter-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-top: 12px;
}

.filter-card {
  border: 1px solid #f2f2f2;
  border-radius: 16px;
  padding: 12px;
  background: #fcfcfc;
}

.filter-card-title {
  font-weight: 900;
  margin-bottom: 10px;
}

/* Segmented */
.segmented {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-bottom: 10px;
}

.seg-btn {
  border: 1px solid #efefef;
  background: #fff;
  border-radius: 12px;
  padding: 8px 10px;
  cursor: pointer;
  font-size: 13px;
}

.seg-btn.active {
  background: rgba(138, 117, 227, 0.12);
  border-color: rgba(138, 117, 227, 0.4);
}

/* Chips */
.chips {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 10px;
}

.chip {
  border: 1px solid #efefef;
  background: #fff;
  border-radius: 999px;
  padding: 7px 10px;
  cursor: pointer;
  font-size: 13px;
}

.chip.active {
  background: #8a75e3;
  border-color: #8a75e3;
  color: #fff;
}

.range-row,
.calendar-row {
  display: flex;
  gap: 10px;
  align-items: flex-end;
}

.field {
  display: flex;
  flex-direction: column;
  gap: 6px;
  min-width: 120px;
}

.field.grow {
  flex: 1;
  min-width: 160px;
}

.field-label {
  font-size: 12px;
  opacity: 0.7;
  font-weight: 700;
}

.input {
  border: 1px solid #efefef;
  border-radius: 12px;
  padding: 10px 10px;
  font-size: 14px;
  background: #fff;
  outline: none;
}

.input:focus {
  border-color: rgba(138, 117, 227, 0.55);
  box-shadow: 0 0 0 3px rgba(138, 117, 227, 0.12);
}

.hint {
  margin-top: 10px;
  font-size: 12px;
  opacity: 0.7;
  line-height: 1.25;
}

/* STATES */
.state {
  display: grid;
  place-items: center;
  gap: 10px;
  padding: 40px 0;
  opacity: 0.75;
  text-align: center;
}

.state.error {
  opacity: 1;
  color: #d9534f;
}

.error-title {
  font-weight: 800;
}

.error-sub {
  font-size: 12px;
  opacity: 0.8;
  max-width: 680px;
}

.retry {
  margin-top: 8px;
  border: none;
  border-radius: 12px;
  padding: 10px 14px;
  cursor: pointer;
  background: #efefef;
}

.spinner {
  width: 26px;
  height: 26px;
  border-radius: 50%;
  border: 3px solid #eee;
  border-top-color: #8a75e3;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}

/* EVENTS */
.events-shell {
  background: #fff;
  border: 1px solid #efefef;
  border-radius: 18px;
  padding: 14px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.04);
}

.events-title {
  display: flex;
  align-items: center;
  gap: 10px;
  font-weight: 900;
  margin-bottom: 12px;
}

.events-count {
  font-size: 12px;
  opacity: 0.6;
  font-weight: 700;
}

.events-progress {
  font-size: 12px;
  opacity: 0.55;
  font-weight: 700;
  margin-left: auto;
}

.events-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

/* –ø–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫ */
.list-enter-active,
.list-leave-active {
  transition: opacity 240ms ease, transform 240ms ease;
}

.list-enter-from,
.list-leave-to {
  opacity: 0;
  transform: translateY(8px);
}

@media (max-width: 880px) {
  .filter-grid {
    grid-template-columns: 1fr;
  }
}
</style>
–ï—Å–ª–∏ —Ö–æ—á–µ—à—å —Å–¥–µ–ª–∞—Ç—å –µ—â—ë ‚Äú–¥–æ—Ä–æ–∂–µ‚Äù –≤–∏–∑—É–∞–ª—å–Ω–æ ‚Äî –º–æ–≥—É –∑–∞–º–µ–Ω–∏—Ç—å input type="date" –Ω–∞ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, flatpickr/vue-datepicker), –Ω–æ —Å–µ–π—á–∞—Å —ç—Ç–æ —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ, –ø–æ–Ω—è—Ç–Ω–æ –∏ –∫—Ä–∞—Å–∏–≤–æ, –±–µ–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π.


–í—ã —Å–∫–∞–∑–∞–ª–∏:
–µ—Å—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç —Ñ–∏–ª—å—Ç—Ä—ã –≤—ã–Ω–µ—Å—Ç–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª, —á—Ç–æ–±—ã –æ–Ω–∏ –Ω–µ –∑–∞—Ö–ª–∞–º–ª—è–ª–∏ homeView?
+ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é —Å"–≥–∞–ª–æ—á–∫–æ–π" –¥–ª—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π "isOnline"

ChatGPT —Å–∫–∞–∑–∞–ª:

–î—É–º–∞–ª –Ω–∞ –ø—Ä–æ—Ç—è–∂–µ–Ω–∏–∏ 13s
–î–∞, –ª—É—á—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç ‚Äî –≤—ã–Ω–µ—Å—Ç–∏ —Ñ–∏–ª—å—Ç—Ä—ã –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç, —á—Ç–æ–±—ã HomeView –æ—Å—Ç–∞–ª—Å—è —á–∏—Å—Ç—ã–º.
–ò –¥–æ–±–∞–≤–∏–ª —Ñ–∏–ª—å—Ç—Ä ‚Äú–¢–æ–ª—å–∫–æ –æ–Ω–ª–∞–π–Ω‚Äù (–≥–∞–ª–æ—á–∫–∞). –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—ã–∫–ª—é—á–µ–Ω ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –≤—Å–µ.

–ù–∏–∂–µ –≤–µ—Å—å –∫–æ–¥:

‚úÖ src/components/FiltersPanel.vue ‚Äî –ù–û–í–´–ô –§–ê–ô–õ

‚úÖ HomeView.vue ‚Äî –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–±–Ω–æ–≤–ª—ë–Ω

‚úÖ src/components/FiltersPanel.vue (–Ω–æ–≤—ã–π —Ñ–∞–π–ª –ø–æ–ª–Ω–æ—Å—Ç—å—é)
<template>
  <div class="filters-shell">
    <div class="filters-head">
      <div class="filters-title">–§–∏–ª—å—Ç—Ä—ã</div>

      <button class="reset-btn" @click="$emit('reset')">–°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë</button>
    </div>

    <!-- Categories -->
    <div class="filter-block">
      <div class="filter-label">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</div>

      <div class="tags-content">
        <button class="tag-btn" :class="{ active: isAllCategoriesActive }" @click="selectAllCategories">
          –í—Å–µ
        </button>

        <button
          v-for="cat in categories"
          :key="cat.id"
          class="tag-btn"
          :class="{ active: selectedCategoryNames.includes(cat.name) }"
          @click="toggleCategory(cat.name)"
        >
          {{ cat.name }}
        </button>
      </div>
    </div>

    <!-- Online checkbox -->
    <div class="filter-inline">
      <label class="check">
        <input type="checkbox" :checked="onlineOnly" @change="onToggleOnline" />
        <span class="check-ui"></span>
        <span class="check-text">–¢–æ–ª—å–∫–æ –æ–Ω–ª–∞–π–Ω</span>
      </label>

      <div class="mini-hint">–ü–æ–∫–∞–∂–µ—Ç —Ç–æ–ª—å–∫–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è, –≥–¥–µ <b>is_online = true</b>.</div>
    </div>

    <!-- Price + Date -->
    <div class="filter-grid">
      <!-- PRICE -->
      <div class="filter-card">
        <div class="filter-card-title">–¶–µ–Ω–∞</div>

        <div class="segmented">
          <button class="seg-btn" :class="{ active: priceMode === 'all' }" @click="setPriceMode('all')">
            –õ—é–±–∞—è
          </button>
          <button class="seg-btn" :class="{ active: priceMode === 'free' }" @click="setPriceMode('free')">
            –ë–µ—Å–ø–ª–∞—Ç–Ω–æ
          </button>
          <button class="seg-btn" :class="{ active: priceMode === 'custom' }" @click="setPriceMode('custom')">
            –°–≤–æ–π –¥–∏–∞–ø–∞–∑–æ–Ω
          </button>
        </div>

        <div class="chips">
          <button class="chip" :class="{ active: priceMode === '100_1000' }" @click="setPriceMode('100_1000')">
            100‚Äì1000
          </button>
          <button
            class="chip"
            :class="{ active: priceMode === '1000_3000' }"
            @click="setPriceMode('1000_3000')"
          >
            1000‚Äì3000
          </button>
          <button
            class="chip"
            :class="{ active: priceMode === '3000_10000' }"
            @click="setPriceMode('3000_10000')"
          >
            3000‚Äì10000
          </button>
          <button class="chip" :class="{ active: priceMode === 'gt_10000' }" @click="setPriceMode('gt_10000')">
            &gt; 10000
          </button>
        </div>

        <div v-if="priceMode === 'custom'" class="range-row">
          <div class="field">
            <div class="field-label">–æ—Ç</div>
            <input
              class="input"
              type="number"
              min="0"
              inputmode="numeric"
              placeholder="0"
              :value="customPriceMin"
              @input="$emit('update:customPriceMin', $event.target.value)"
            />
          </div>
          <div class="field">
            <div class="field-label">–¥–æ</div>
            <input
              class="input"
              type="number"
              min="0"
              inputmode="numeric"
              placeholder="‚àû"
              :value="customPriceMax"
              @input="$emit('update:customPriceMax', $event.target.value)"
            />
          </div>
        </div>

        <div class="hint">
          –°—á–∏—Ç–∞–µ–º –ø–æ <b>price</b>. –ï—Å–ª–∏ <b>is_free=true</b> –∏–ª–∏ price=0 ‚Äî —ç—Ç–æ ‚Äú–ë–µ—Å–ø–ª–∞—Ç–Ω–æ‚Äù.
        </div>
      </div>

      <!-- DATE -->
      <div class="filter-card">
        <div class="filter-card-title">–î–∞—Ç–∞</div>

        <div class="segmented">
          <button class="seg-btn" :class="{ active: dateMode === 'all' }" @click="setDateMode('all')">
            –í—Å—ë –≤—Ä–µ–º—è
          </button>
          <button class="seg-btn" :class="{ active: dateMode === 'on' }" @click="setDateMode('on')">
            –ù–∞ –¥–∞—Ç—É
          </button>
          <button class="seg-btn" :class="{ active: dateMode === 'range' }" @click="setDateMode('range')">
            –î–∏–∞–ø–∞–∑–æ–Ω
          </button>
        </div>

        <div class="chips">
          <button class="chip" :class="{ active: dateMode === 'after' }" @click="setDateMode('after')">
            –ü–æ—Å–ª–µ –¥–∞—Ç—ã
          </button>
          <button class="chip" :class="{ active: dateMode === 'before' }" @click="setDateMode('before')">
            –î–æ –¥–∞—Ç—ã
          </button>
          <button class="chip" :class="{ active: dateMode === 'next7' }" @click="setDateMode('next7')">
            –°–ª–µ–¥. 7 –¥–Ω–µ–π
          </button>
          <button class="chip" :class="{ active: dateMode === 'today' }" @click="setDateMode('today')">
            –°–µ–≥–æ–¥–Ω—è
          </button>
        </div>

        <div v-if="dateMode === 'on'" class="calendar-row">
          <div class="field grow">
            <div class="field-label">–í—ã–±–µ—Ä–∏ –¥–∞—Ç—É</div>
            <input class="input" type="date" :value="dateOn" @input="$emit('update:dateOn', $event.target.value)" />
          </div>
        </div>

        <div v-else-if="dateMode === 'range'" class="calendar-row">
          <div class="field grow">
            <div class="field-label">—Å</div>
            <input
              class="input"
              type="date"
              :value="dateFrom"
              @input="$emit('update:dateFrom', $event.target.value)"
            />
          </div>
          <div class="field grow">
            <div class="field-label">–ø–æ</div>
            <input class="input" type="date" :value="dateTo" @input="$emit('update:dateTo', $event.target.value)" />
          </div>
        </div>

        <div v-else-if="dateMode === 'after'" class="calendar-row">
          <div class="field grow">
            <div class="field-label">–ü–æ—Å–ª–µ</div>
            <input
              class="input"
              type="date"
              :value="datePivot"
              @input="$emit('update:datePivot', $event.target.value)"
            />
          </div>
        </div>

        <div v-else-if="dateMode === 'before'" class="calendar-row">
          <div class="field grow">
            <div class="field-label">–î–æ</div>
            <input
              class="input"
              type="date"
              :value="datePivot"
              @input="$emit('update:datePivot', $event.target.value)"
            />
          </div>
        </div>

        <div class="hint">–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ <b>date_time_event</b> (–¥–∞—Ç–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è).</div>
      </div>
    </div>
  </div>
</template>

<script>
export default {
  name: 'FiltersPanel',
  emits: [
    'reset',
    'update:selectedCategoryNames',
    'update:priceMode',
    'update:customPriceMin',
    'update:customPriceMax',
    'update:dateMode',
    'update:dateOn',
    'update:dateFrom',
    'update:dateTo',
    'update:datePivot',
    'update:onlineOnly'
  ],
  props: {
    categories: { type: Array, default: () => [] },

    selectedCategoryNames: { type: Array, default: () => [] },
    isAllCategoriesActive: { type: Boolean, default: true },

    priceMode: { type: String, default: 'all' },
    customPriceMin: { type: String, default: '' },
    customPriceMax: { type: String, default: '' },

    dateMode: { type: String, default: 'all' },
    dateOn: { type: String, default: '' },
    dateFrom: { type: String, default: '' },
    dateTo: { type: String, default: '' },
    datePivot: { type: String, default: '' },

    onlineOnly: { type: Boolean, default: false }
  },
  methods: {
    selectAllCategories() {
      this.$emit('update:selectedCategoryNames', [])
    },
    toggleCategory(name) {
      const n = String(name || '').trim()
      if (!n) return
      const next = [...this.selectedCategoryNames]
      const idx = next.indexOf(n)
      if (idx >= 0) next.splice(idx, 1)
      else next.push(n)
      this.$emit('update:selectedCategoryNames', next)
    },
    setPriceMode(mode) {
      this.$emit('update:priceMode', mode)
    },
    setDateMode(mode) {
      this.$emit('update:dateMode', mode)
    },
    onToggleOnline(e) {
      this.$emit('update:onlineOnly', !!e.target.checked)
    }
  }
}
</script>

<style scoped>
.filters-shell {
  background: #fff;
  border: 1px solid #efefef;
  border-radius: 20px;
  padding: 14px;
  box-shadow: 0 2px 14px rgba(0, 0, 0, 0.04);
  margin-bottom: 14px;
}

.filters-head {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 10px;
}

.filters-title {
  font-weight: 900;
  font-size: 16px;
}

.reset-btn {
  margin-left: auto;
  border: 1px solid #efefef;
  background: #fafafa;
  border-radius: 12px;
  padding: 8px 10px;
  cursor: pointer;
  font-size: 13px;
}
.reset-btn:hover {
  background: #f3f3f3;
}

.filter-block {
  border: 1px solid #f2f2f2;
  border-radius: 16px;
  padding: 12px;
  background: #fcfcfc;
}

.filter-label {
  font-weight: 800;
  font-size: 13px;
  opacity: 0.7;
  margin-bottom: 10px;
}

.tags-content {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}

.tag-btn {
  border: 1px solid #efefef;
  background: #fafafa;
  border-radius: 999px;
  padding: 8px 12px;
  cursor: pointer;
  font-size: 13px;
  white-space: nowrap;
}

.tag-btn.active {
  background: #8a75e3;
  border-color: #8a75e3;
  color: #fff;
}

/* Online checkbox row */
.filter-inline {
  margin-top: 12px;
  border: 1px solid #f2f2f2;
  border-radius: 16px;
  padding: 12px;
  background: #fcfcfc;
  display: flex;
  align-items: center;
  gap: 14px;
  flex-wrap: wrap;
}

.check {
  display: inline-flex;
  align-items: center;
  gap: 10px;
  cursor: pointer;
  user-select: none;
}

.check input {
  display: none;
}

.check-ui {
  width: 44px;
  height: 26px;
  border-radius: 999px;
  border: 1px solid #e9e9e9;
  background: #f3f3f3;
  position: relative;
  transition: background 180ms ease, border-color 180ms ease;
}

.check-ui::after {
  content: '';
  width: 22px;
  height: 22px;
  border-radius: 999px;
  background: #fff;
  position: absolute;
  top: 1px;
  left: 1px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
  transition: transform 180ms ease;
}

.check input:checked + .check-ui {
  background: rgba(138, 117, 227, 0.85);
  border-color: rgba(138, 117, 227, 0.55);
}

.check input:checked + .check-ui::after {
  transform: translateX(18px);
}

.check-text {
  font-weight: 800;
  font-size: 13px;
}

.mini-hint {
  font-size: 12px;
  opacity: 0.7;
}

/* Grid for price/date */
.filter-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-top: 12px;
}

.filter-card {
  border: 1px solid #f2f2f2;
  border-radius: 16px;
  padding: 12px;
  background: #fcfcfc;
}

.filter-card-title {
  font-weight: 900;
  margin-bottom: 10px;
}

.segmented {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-bottom: 10px;
}

.seg-btn {
  border: 1px solid #efefef;
  background: #fff;
  border-radius: 12px;
  padding: 8px 10px;
  cursor: pointer;
  font-size: 13px;
}

.seg-btn.active {
  background: rgba(138, 117, 227, 0.12);
  border-color: rgba(138, 117, 227, 0.4);
}

.chips {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 10px;
}

.chip {
  border: 1px solid #efefef;
  background: #fff;
  border-radius: 999px;
  padding: 7px 10px;
  cursor: pointer;
  font-size: 13px;
}

.chip.active {
  background: #8a75e3;
  border-color: #8a75e3;
  color: #fff;
}

.range-row,
.calendar-row {
  display: flex;
  gap: 10px;
  align-items: flex-end;
}

.field {
  display: flex;
  flex-direction: column;
  gap: 6px;
  min-width: 120px;
}

.field.grow {
  flex: 1;
  min-width: 160px;
}

.field-label {
  font-size: 12px;
  opacity: 0.7;
  font-weight: 700;
}

.input {
  border: 1px solid #efefef;
  border-radius: 12px;
  padding: 10px 10px;
  font-size: 14px;
  background: #fff;
  outline: none;
}

.input:focus {
  border-color: rgba(138, 117, 227, 0.55);
  box-shadow: 0 0 0 3px rgba(138, 117, 227, 0.12);
}

.hint {
  margin-top: 10px;
  font-size: 12px;
  opacity: 0.7;
  line-height: 1.25;
}

@media (max-width: 880px) {
  .filter-grid {
    grid-template-columns: 1fr;
  }
}
</style>
‚úÖ HomeView.vue (–ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–±–Ω–æ–≤–ª—ë–Ω)
<template>
  <div class="page">
    <div class="container">
      <!-- Filters moved to a separate component -->
      <FiltersPanel
        :categories="categories"
        :is-all-categories-active="isAllCategoriesActive"
        v-model:selectedCategoryNames="selectedCategoryNames"
        v-model:priceMode="priceMode"
        v-model:customPriceMin="customPriceMin"
        v-model:customPriceMax="customPriceMax"
        v-model:dateMode="dateMode"
        v-model:dateOn="dateOn"
        v-model:dateFrom="dateFrom"
        v-model:dateTo="dateTo"
        v-model:datePivot="datePivot"
        v-model:onlineOnly="onlineOnly"
        @reset="resetAllFilters"
      />

      <!-- STATES -->
      <div v-if="!initialLoaded" class="state">
        <div class="spinner"></div>
        <div>–ó–∞–≥—Ä—É–∑–∫–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π‚Ä¶</div>
      </div>

      <div v-else-if="error" class="state error">
        <div class="error-title">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</div>
        <div class="error-sub">{{ error }}</div>
        <button class="retry" @click="reload">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
      </div>

      <div v-else-if="filteredEvents.length === 0" class="state">–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>

      <!-- EVENTS LIST -->
      <div v-else class="events-shell">
        <div class="events-title">
          –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
          <span class="events-count">{{ filteredEvents.length }}</span>
          <span v-if="progressiveLoading" class="events-progress">–ø–æ–¥–≥—Ä—É–∂–∞—é‚Ä¶</span>
        </div>

        <TransitionGroup name="list" tag="div" class="events-list">
          <EventCard
            v-for="event in filteredEvents"
            :key="event.id"
            :event="event"
            :photos="photos[event.id] || []"
            :photos-loading="photosLoading"
            :category-map="categoryMap"
            @open-photo="openPhoto"
          />
        </TransitionGroup>
      </div>
    </div>

    <!-- PHOTO MODAL -->
    <EventPhotoModal v-if="photoModalUrl" :url="photoModalUrl" @close="photoModalUrl = ''" />
  </div>
</template>

<script>
import { ref, computed, onMounted, onBeforeUnmount } from 'vue'
import EventCard from '../../components/EventCard.vue'
import EventPhotoModal from '../../components/EventPhotoModal.vue'
import FiltersPanel from '../../components/FiltersPanel.vue'
import { useSupabase } from '../../composables/useSupabase'

const sleep = (ms) => new Promise((r) => setTimeout(r, ms))

const withRetry = async (fn, tries = 3) => {
  let lastErr = null
  for (let i = 0; i < tries; i++) {
    try {
      return await fn()
    } catch (e) {
      lastErr = e
      await sleep(350 * (i + 1))
    }
  }
  throw lastErr
}

/**
 * –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º event.selectCategory -> –ú–ê–°–°–ò–í –ù–ê–ó–í–ê–ù–ò–ô
 * –ü–æ–¥–¥–µ—Ä–∂–∫–∞:
 * - text[] => ["–°–ø–æ—Ä—Ç","–•–æ–±–±–∏"]
 * - "–°–ø–æ—Ä—Ç,–•–æ–±–±–∏" / "–°–ø–æ—Ä—Ç;–•–æ–±–±–∏"
 * - id / [id,id] -> –ø–æ–¥—Å—Ç–∞–≤–∏–º name –ø–æ categoryMap
 */
const normalizeCategoryNames = (raw, categoryMap) => {
  const map = categoryMap || {}

  const toName = (v) => {
    if (v === null || v === undefined) return ''
    const s = String(v).trim()
    if (!s) return ''
    if (map[s]) return String(map[s]).trim()
    const n = Number(s)
    if (!Number.isNaN(n) && map[String(n)]) return String(map[String(n)]).trim()
    return s
  }

  if (!raw) return []

  if (Array.isArray(raw)) {
    return Array.from(new Set(raw.map(toName).filter(Boolean)))
  }

  if (typeof raw === 'string') {
    const s = raw.trim()
    if (!s) return []
    const parts = s
      .split(/[,;|]+/g)
      .map((x) => x.trim())
      .filter(Boolean)
      .map(toName)
      .filter(Boolean)
    return Array.from(new Set(parts))
  }

  const one = toName(raw)
  return one ? [one] : []
}

const toNumberOrNull = (v) => {
  if (v === null || v === undefined) return null
  const n = Number(v)
  return Number.isFinite(n) ? n : null
}

const startOfDay = (d) => new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0, 0, 0, 0)
const endOfDay = (d) => new Date(d.getFullYear(), d.getMonth(), d.getDate(), 23, 59, 59, 999)

const parseEventDate = (value) => {
  if (!value) return null
  const d = new Date(value)
  if (Number.isNaN(d.getTime())) return null
  return d
}

const parseDateInput = (yyyy_mm_dd) => {
  if (!yyyy_mm_dd) return null
  const [y, m, day] = yyyy_mm_dd.split('-').map((x) => Number(x))
  if (!y || !m || !day) return null
  return new Date(y, m - 1, day)
}

export default {
  name: 'HomeView',
  components: { EventCard, EventPhotoModal, FiltersPanel },
  props: {
    globalSearchTerm: { type: String, default: '' }
  },
  setup(props) {
    const { getEvents, getCategories, getEventPhotos } = useSupabase()

    const initialLoaded = ref(false)
    const error = ref(null)

    const allEvents = ref([])
    const visibleEvents = ref([])

    const progressiveLoading = ref(false)
    let progressiveTimer = null

    const photos = ref({})

    const categories = ref([])
    const categoryMap = ref({}) // id -> name

    // Categories (names)
    const selectedCategoryNames = ref([])
    const isAllCategoriesActive = computed(() => selectedCategoryNames.value.length === 0)

    // Online checkbox
    const onlineOnly = ref(false)

    // Price
    const priceMode = ref('all')
    const customPriceMin = ref('')
    const customPriceMax = ref('')

    // Date
    const dateMode = ref('all')
    const dateOn = ref('')
    const dateFrom = ref('')
    const dateTo = ref('')
    const datePivot = ref('')

    const photosLoading = ref(false)
    const stopPhotosLoading = ref(false)

    const photoModalUrl = ref('')

    const openPhoto = (url) => {
      if (!url) return
      photoModalUrl.value = url
    }

    const resetAllFilters = () => {
      selectedCategoryNames.value = []
      onlineOnly.value = false

      priceMode.value = 'all'
      customPriceMin.value = ''
      customPriceMax.value = ''

      dateMode.value = 'all'
      dateOn.value = ''
      dateFrom.value = ''
      dateTo.value = ''
      datePivot.value = ''
    }

    // ---------- filtering ----------
    const matchesSelectedCategories = (event) => {
      if (selectedCategoryNames.value.length === 0) return true

      const eventCats = normalizeCategoryNames(event?.selectCategory, categoryMap.value)
      if (!eventCats.length) return false

      const selectedSet = new Set(selectedCategoryNames.value)
      return eventCats.some((c) => selectedSet.has(c))
    }

    const matchesOnline = (event) => {
      if (!onlineOnly.value) return true
      return event?.is_online === true
    }

    const getEventPrice = (event) => {
      if (event?.is_free === true) return 0
      const p = toNumberOrNull(event?.price)
      if (p === null) return null
      return p
    }

    const matchesPrice = (event) => {
      const mode = priceMode.value
      if (mode === 'all') return true

      const price = getEventPrice(event)

      if (mode === 'free') return price === 0
      if (price === null) return false

      if (mode === '100_1000') return price >= 100 && price <= 1000
      if (mode === '1000_3000') return price >= 1000 && price <= 3000
      if (mode === '3000_10000') return price >= 3000 && price <= 10000
      if (mode === 'gt_10000') return price > 10000

      if (mode === 'custom') {
        const min = customPriceMin.value === '' ? null : toNumberOrNull(customPriceMin.value)
        const max = customPriceMax.value === '' ? null : toNumberOrNull(customPriceMax.value)

        const okMin = min === null ? true : price >= min
        const okMax = max === null ? true : price <= max
        return okMin && okMax
      }

      return true
    }

    const matchesDate = (event) => {
      const mode = dateMode.value
      if (mode === 'all') return true

      const d = parseEventDate(event?.date_time_event)
      if (!d) return false

      if (mode === 'today') {
        const now = new Date()
        return d >= startOfDay(now) && d <= endOfDay(now)
      }

      if (mode === 'next7') {
        const now = new Date()
        const from = startOfDay(now)
        const to = endOfDay(new Date(now.getFullYear(), now.getMonth(), now.getDate() + 7))
        return d >= from && d <= to
      }

      if (mode === 'on') {
        const on = parseDateInput(dateOn.value)
        if (!on) return true
        return d >= startOfDay(on) && d <= endOfDay(on)
      }

      if (mode === 'range') {
        const fromD = parseDateInput(dateFrom.value)
        const toD = parseDateInput(dateTo.value)
        if (!fromD && !toD) return true
        const from = fromD ? startOfDay(fromD) : null
        const to = toD ? endOfDay(toD) : null
        const okFrom = from ? d >= from : true
        const okTo = to ? d <= to : true
        return okFrom && okTo
      }

      if (mode === 'after') {
        const pivot = parseDateInput(datePivot.value)
        if (!pivot) return true
        return d >= startOfDay(pivot)
      }

      if (mode === 'before') {
        const pivot = parseDateInput(datePivot.value)
        if (!pivot) return true
        return d <= endOfDay(pivot)
      }

      return true
    }

    const matchesSearch = (event) => {
      const term = (props.globalSearchTerm || '').trim().toLowerCase()
      if (!term) return true

      const t = (event.title || '').toLowerCase()
      const d = (event.description || '').toLowerCase()
      const a = (event.address || '').toLowerCase()
      const o = (event.organizer || '').toLowerCase()
      return t.includes(term) || d.includes(term) || a.includes(term) || o.includes(term)
    }

    const filteredEvents = computed(() => {
      return visibleEvents.value.filter(
        (e) =>
          matchesSelectedCategories(e) &&
          matchesOnline(e) &&
          matchesPrice(e) &&
          matchesDate(e) &&
          matchesSearch(e)
      )
    })

    // ---------- progressive loading ----------
    const stopProgressive = () => {
      progressiveLoading.value = false
      if (progressiveTimer) {
        clearInterval(progressiveTimer)
        progressiveTimer = null
      }
    }

    const startProgressive = (source) => {
      stopProgressive()
      visibleEvents.value = []

      const list = Array.isArray(source) ? source : []
      if (!list.length) return

      progressiveLoading.value = true
      visibleEvents.value.push(list[0])

      let i = 1
      progressiveTimer = setInterval(() => {
        if (i >= list.length) {
          stopProgressive()
          return
        }
        visibleEvents.value.push(list[i])
        i++
      }, 140)
    }

    // ---------- data loading ----------
    const loadCategories = async () => {
      try {
        const { data, error: err } = await withRetry(() => getCategories())
        if (err) throw err

        categories.value = data ?? []
        categoryMap.value = (categories.value || []).reduce((acc, c) => {
          acc[String(c.id)] = c.name
          return acc
        }, {})
      } catch (e) {
        console.warn('Categories load error:', e)
        categories.value = []
        categoryMap.value = {}
      }
    }

    const loadEventsProgressive = async () => {
      error.value = null
      stopPhotosLoading.value = true
      photosLoading.value = false
      stopProgressive()

      try {
        const { data: eventsData, error: eventsErr } = await withRetry(() => getEvents())
        if (eventsErr) throw eventsErr

        allEvents.value = eventsData ?? []
        initialLoaded.value = true

        startProgressive(allEvents.value)

        // photos in background
        photos.value = {}
        stopPhotosLoading.value = false

        const ids = allEvents.value.map((e) => e.id).filter(Boolean)
        if (!ids.length) return

        photosLoading.value = true

        const batchSize = 5
        for (let i = 0; i < ids.length; i += batchSize) {
          if (stopPhotosLoading.value) break

          const batch = ids.slice(i, i + batchSize)
          try {
            const { data: ph, error: phErr } = await withRetry(() => getEventPhotos(batch))
            if (phErr) throw phErr

            const next = { ...photos.value }
            for (const p of ph ?? []) {
              if (!p?.event_id) continue
              if (!next[p.event_id]) next[p.event_id] = []
              next[p.event_id].push(p)
            }
            photos.value = next
          } catch (e) {
            console.warn('Photos batch load error:', e)
          }

          await sleep(120)
        }
      } catch (e) {
        console.error('HomeView load error:', e)
        allEvents.value = []
        visibleEvents.value = []
        photos.value = {}
        initialLoaded.value = true
        error.value = e?.message ? String(e.message) : 'TypeError: Failed to fetch'
      } finally {
        photosLoading.value = false
      }
    }

    const reload = async () => {
      await loadEventsProgressive()
    }

    onMounted(async () => {
      await loadCategories()
      await loadEventsProgressive()
    })

    onBeforeUnmount(() => {
      stopProgressive()
      stopPhotosLoading.value = true
    })

    return {
      initialLoaded,
      error,

      photos,
      categories,
      categoryMap,

      selectedCategoryNames,
      isAllCategoriesActive,

      onlineOnly,

      priceMode,
      customPriceMin,
      customPriceMax,

      dateMode,
      dateOn,
      dateFrom,
      dateTo,
      datePivot,

      filteredEvents,
      photosLoading,
      progressiveLoading,

      resetAllFilters,
      reload,

      photoModalUrl,
      openPhoto
    }
  }
}
</script>

<style scoped>
.page {
  padding: 16px 0 40px;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 20px;
}

/* STATES */
.state {
  display: grid;
  place-items: center;
  gap: 10px;
  padding: 40px 0;
  opacity: 0.75;
  text-align: center;
}

.state.error {
  opacity: 1;
  color: #d9534f;
}

.error-title {
  font-weight: 800;
}

.error-sub {
  font-size: 12px;
  opacity: 0.8;
  max-width: 680px;
}

.retry {
  margin-top: 8px;
  border: none;
  border-radius: 12px;
  padding: 10px 14px;
  cursor: pointer;
  background: #efefef;
}

.spinner {
  width: 26px;
  height: 26px;
  border-radius: 50%;
  border: 3px solid #eee;
  border-top-color: #8a75e3;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}

/* EVENTS */
.events-shell {
  background: #fff;
  border: 1px solid #efefef;
  border-radius: 18px;
  padding: 14px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.04);
}

.events-title {
  display: flex;
  align-items: center;
  gap: 10px;
  font-weight: 900;
  margin-bottom: 12px;
}

.events-count {
  font-size: 12px;
  opacity: 0.6;
  font-weight: 700;
}

.events-progress {
  font-size: 12px;
  opacity: 0.55;
  font-weight: 700;
  margin-left: auto;
}

.events-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

/* –ø–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫ */
.list-enter-active,
.list-leave-active {
  transition: opacity 240ms ease, transform 240ms ease;
}

.list-enter-from,
.list-leave-to {
  opacity: 0;
  transform: translateY(8px);
}
</style>
–ï—Å–ª–∏ —Ö–æ—á–µ—à—å, –º–æ–≥—É —Å–¥–µ–ª–∞—Ç—å –≥–∞–ª–æ—á–∫—É –Ω–µ –ø—Ä–æ—Å—Ç–æ ‚Äú–¢–æ–ª—å–∫–æ –æ–Ω–ª–∞–π–Ω‚Äù, –∞ —Ç—Ä–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è:

–í—Å–µ

–¢–æ–ª—å–∫–æ –æ–Ω–ª–∞–π–Ω

–¢–æ–ª—å–∫–æ –æ—Ñ—Ñ–ª–∞–π–Ω

–ù–æ —Å–µ–π—á–∞—Å —Ä–æ–≤–Ω–æ —Ç–æ, —á—Ç–æ —Ç—ã –ø—Ä–æ—Å–∏–ª: –ø—Ä–æ—Å—Ç–∞—è –≥–∞–ª–æ—á–∫–∞, —Å—Ç–∏–ª—å–Ω–∞—è, –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç.


–í—ã —Å–∫–∞–∑–∞–ª–∏:
–æ–∫–µ, —Ç–µ–ø–µ—Ä—å –Ω—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é —á–µ—Ä–µ–∑ —Ç–µ–ª–µ–≥—Ä–∞–º. 
–†–∞—Å–ø–∏—à–∏ –ø–æ–¥—Ä–æ–±–Ω–æ, –ø–æ –ø—É–Ω–∫—Ç–∞–º, —á—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å, –º–Ω–µ –Ω—É–∂–Ω–æ –±–æ—Ç–∞ –ø–∏—Å–∞—Ç—å –∑–∞–Ω–æ–≤–æ, —è –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–Ω–∏–º–∞—é? –î–∞–≤–∞–π –±—É–¥–µ–º –ø–∏—Å–∞—Ç—å –µ–≥–æ –Ω–∞ –ø–∞–π—Ç–æ–Ω–µ

ChatGPT —Å–∫–∞–∑–∞–ª:
–û–∫, –¥–∞–≤–∞–π –ø–æ —à–∞–≥–∞–º. –°–ø–æ–π–ª–µ—Ä: –±–æ—Ç ‚Äú–∑–∞–Ω–æ–≤–æ‚Äù –ø–∏—Å–∞—Ç—å –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –Ω–æ –Ω—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å Telegram Login (–≤–∏–¥–∂–µ—Ç) + —Å–µ—Ä–≤–µ—Ä–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ–¥–ø–∏—Å–∏, –∞ –ø–æ—Ç–æ–º ‚Äú–ø—Ä–∏–≤—è–∑–∞—Ç—å‚Äù —ç—Ç–æ –∫ —Ç–≤–æ–µ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (—Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –∫ Supabase).

–ù–∏–∂–µ –ø–ª–∞–Ω —Ç–∞–∫, —á—Ç–æ–±—ã —É —Ç–µ–±—è –≤—Å—ë –∑–∞–≤–µ–ª–æ—Å—å –±–µ–∑ –±–æ–ª–∏.

0) –ß—Ç–æ –≤–æ–æ–±—â–µ –∑–Ω–∞—á–∏—Ç ‚Äú–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram‚Äù
–ï—Å—Ç—å 2 —Ä–∞–∑–Ω—ã—Ö –ø–æ–¥—Ö–æ–¥–∞:

–í–∞—Ä–∏–∞–Ω—Ç A ‚Äî Telegram Login Widget (–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –¥–ª—è —Å–∞–π—Ç–æ–≤)
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∂–º—ë—Ç ‚Äú–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Telegram‚Äù ‚Üí Telegram –æ—Ç–¥–∞—ë—Ç id, username, first_name, photo_url, auth_date, hash ‚Üí —Ç–≤–æ–π —Å–µ—Ä–≤–µ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ø–∏—Å—å (hash) ‚Üí —Å–æ–∑–¥–∞—ë—Ç —Å–µ—Å—Å–∏—é/—Ç–æ–∫–µ–Ω ‚Üí –ª–æ–≥–∏–Ω–∏—Ç –≤ —Ç–≤–æ—ë –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.

‚úÖ –ª—É—á—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç –¥–ª—è –≤–µ–±–∞
‚úÖ –Ω–µ –Ω–∞–¥–æ ‚Äú–≤–µ—Å—Ç–∏ –¥–∏–∞–ª–æ–≥‚Äù —Å –±–æ—Ç–æ–º
‚úÖ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —É–¥–æ–±–Ω–æ

–í–∞—Ä–∏–∞–Ω—Ç B ‚Äî ‚Äú/start –≤ –±–æ—Ç–µ‚Äù –∏ –≤—ã–¥–∞—á–∞ –∫–æ–¥–∞/—Å—Å—ã–ª–∫–∏
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç –±–æ—Ç—É ‚Üí –±–æ—Ç –≤—ã–¥–∞—ë—Ç –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π –∫–æ–¥ –∏–ª–∏ —Å—Å—ã–ª–∫—É ‚Üí —Å–∞–π—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç.

‚úÖ –∏–Ω–æ–≥–¥–∞ –¥–µ–ª–∞—é—Ç, –µ—Å–ª–∏ –Ω—É–∂–µ–Ω —á–∞—Ç-–±–æ—Ç
‚ùå –¥–ª—è ‚Äú–≤–æ–π—Ç–∏‚Äù –Ω–∞ —Å–∞–π—Ç ‚Äî –º–µ–Ω–µ–µ —É–¥–æ–±–Ω–æ
‚ùå –±–æ–ª—å—à–µ –ª–æ–≥–∏–∫–∏

–¢–µ–±–µ –Ω—É–∂–µ–Ω –≤–∞—Ä–∏–∞–Ω—Ç A (Widget).

1) –ù—É–∂–Ω–æ –ª–∏ –ø–∏—Å–∞—Ç—å –±–æ—Ç–∞ –∑–∞–Ω–æ–≤–æ?
–ù–µ—Ç.
–ù—É–∂–µ–Ω –±–æ—Ç –∫–∞–∫ —Å—É—â–Ω–æ—Å—Ç—å –≤ Telegram (BotFather) –∏ –µ–≥–æ token.
–ï—Å–ª–∏ –±–æ—Ç —É —Ç–µ–±—è —É–∂–µ –µ—Å—Ç—å ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ.

‚Äú–ü–∏—Å–∞—Ç—å –∑–∞–Ω–æ–≤–æ‚Äù –Ω—É–∂–Ω–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏:

—Ç—ã –ø–æ—Ç–µ—Ä—è–ª —Ç–æ–∫–µ–Ω/–Ω–µ –¥–æ–≤–µ—Ä—è–µ—à—å —Å—Ç–∞—Ä–æ–º—É

—Ö–æ—á–µ—à—å –¥—Ä—É–≥–æ–π username –±–æ—Ç–∞

–í –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–ª—É—á–∞—è—Ö ‚Äî –±–µ—Ä—ë–º —Ç–µ–∫—É—â–µ–≥–æ.

2) –ß—Ç–æ –Ω–∞–¥–æ —Å–¥–µ–ª–∞—Ç—å –≤ Telegram (BotFather)
–û—Ç–∫—Ä—ã–≤–∞–µ—à—å @BotFather

/mybots ‚Üí –≤—ã–±–∏—Ä–∞–µ—à—å –±–æ—Ç–∞

Bot Settings ‚Üí Domain

–£–∫–∞–∑—ã–≤–∞–µ—à—å –¥–æ–º–µ–Ω —Ç–≤–æ–µ–≥–æ —Å–∞–π—Ç–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä:

biom.site

app.biom.site

localhost –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å https-–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏, –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ngrok

–ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ —É –±–æ—Ç–∞ –≤–∫–ª—é—á–µ–Ω—ã:

Username (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, —Ç–∏–ø–∞ MyCoolBot)

privacy mode —Ç—É—Ç –Ω–µ –∫—Ä–∏—Ç–∏—á–µ–Ω –¥–ª—è login

3) –ß—Ç–æ –Ω–∞–¥–æ —Å–¥–µ–ª–∞—Ç—å –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ (Vue)
–¢—ã –¥–æ–±–∞–≤–ª—è–µ—à—å –∫–Ω–æ–ø–∫—É/–≤–∏–¥–∂–µ—Ç Telegram Login:

Telegram –¥–∞—ë—Ç —Å–∫—Ä–∏–ø—Ç, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–≥–ª—è–¥–∏—Ç –ø—Ä–∏–º–µ—Ä–Ω–æ —Ç–∞–∫:

<script async src="https://telegram.org/js/telegram-widget.js?22"
  data-telegram-login="YOUR_BOT_USERNAME"
  data-size="large"
  data-onauth="onTelegramAuth(user)"
  data-request-access="write">
</script>
onTelegramAuth(user) –ø–æ–ª—É—á–∏—Ç –æ–±—ä–µ–∫—Ç:

{
  id,
  first_name,
  last_name,
  username,
  photo_url,
  auth_date,
  hash
}
–í–∞–∂–Ω–æ: –¥–æ–≤–µ—Ä—è—Ç—å —ç—Ç–æ–º—É –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ –Ω–µ–ª—å–∑—è ‚Äî —ç—Ç–æ —Ç–æ–ª—å–∫–æ ‚Äú–∑–∞—è–≤–∫–∞‚Äù.
–î–∞–ª—å—à–µ —Ç—ã –æ—Ç–ø—Ä–∞–≤–ª—è–µ—à—å —ç—Ç–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä.

4) –°–µ—Ä–≤–µ—Ä –Ω–∞ Python: –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ Telegram (—Å–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ)
–¢—ã –¥–µ–ª–∞–µ—à—å endpoint –Ω–∞–ø—Ä–∏–º–µ—Ä:

POST /auth/telegram

–¢–µ–ª–æ: —Ç–æ—Ç –æ–±—ä–µ–∫—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏—Å–ª–∞–ª Telegram.

–°–µ—Ä–≤–µ—Ä –¥–µ–ª–∞–µ—Ç:

–°–æ–±–∏—Ä–∞–µ—Ç ‚Äúdata-check-string‚Äù

–í—ã—á–∏—Å–ª—è–µ—Ç secret key = sha256(bot_token)

–í—ã—á–∏—Å–ª—è–µ—Ç HMAC_SHA256(data-check-string, secret_key)

–°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Å hash

–ï—Å–ª–∏ —Å–æ–≤–ø–∞–ª–æ ‚Äî –∑–Ω–∞—á–∏—Ç Telegram —Ä–µ–∞–ª—å–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–ª.

–ü–ª—é—Å –Ω–∞–¥–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å auth_date (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ —Å—Ç–∞—Ä—à–µ 1-5 –º–∏–Ω—É—Ç), —á—Ç–æ–±—ã –Ω–∏–∫—Ç–æ –Ω–µ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –¥–∞–Ω–Ω—ã–µ.

5) –ö–∞–∫ —ç—Ç–æ —Å–≤—è–∑–∞—Ç—å —Å Supabase (3 –≤–∞—Ä–∏–∞–Ω—Ç–∞)
–¢—É—Ç –≤–∞–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å. –°–∞–º—ã–π –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π:

–í–∞—Ä–∏–∞–Ω—Ç 1 ‚Äî Supabase Auth —á–µ—Ä–µ–∑ Custom JWT (—Å–∞–º—ã–π —á–∏—Å—Ç—ã–π)
–¢—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —Å–æ–∑–¥–∞—ë—à—å JWT, –∫–æ—Ç–æ—Ä—ã–π Supabase –ø—Ä–∏–Ω–∏–º–∞–µ—Ç (—á–µ—Ä–µ–∑ JWT_SECRET –ø—Ä–æ–µ–∫—Ç–∞).
–ù–æ —ç—Ç–æ —Ç—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏ –ø–æ–Ω–∏–º–∞–Ω–∏—è.

–í–∞—Ä–∏–∞–Ω—Ç 2 ‚Äî –°–æ–∑–¥–∞–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–∞–±–ª–∏—Ü–µ users –∏ –≤–µ—Å—Ç–∏ —Å–≤–æ—é —Å–µ—Å—Å–∏—é
–¢—ã —Ö—Ä–∞–Ω–∏—à—å —Å–µ—Å—Å–∏—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (cookie) –∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å Supabase Auth.
–ü–æ–¥—Ö–æ–¥–∏—Ç, –µ—Å–ª–∏ Supabase Auth —Ç–µ–±–µ –Ω–µ –Ω—É–∂–µ–Ω.

–í–∞—Ä–∏–∞–Ω—Ç 3 ‚Äî –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Supabase Auth, –Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å Telegram –∫–∞–∫ ‚Äúexternal identity‚Äù
–ù–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ –¥–µ–ª–∞—é—Ç —Ç–∞–∫:

—Å–µ—Ä–≤–µ—Ä –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç Telegram

—Å–µ—Ä–≤–µ—Ä —Å–æ–∑–¥–∞—ë—Ç ‚Äú–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è‚Äù –≤ —Ç–≤–æ–µ–π —Ç–∞–±–ª–∏—Ü–µ users (–∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç)

—Å–µ—Ä–≤–µ—Ä –æ—Ç–¥–∞—ë—Ç —Ç–≤–æ–µ–º—É —Ñ—Ä–æ–Ω—Ç—É —Ç–æ–∫–µ–Ω (JWT) –¥–ª—è —Ç–≤–æ–µ–≥–æ API

Supabase –∏—Å–ø–æ–ª—å–∑—É–µ—à—å –∫–∞–∫ –ë–î, –∞ –Ω–µ –∫–∞–∫ Auth

–°–∫–∞–∂–∏, —Ç—ã —Ö–æ—á–µ—à—å –∏–º–µ–Ω–Ω–æ Supabase Auth –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è —Å–µ—Å—Å–∏–π, –∏–ª–∏ –º–æ–∂–Ω–æ —Å–≤–æ—é —Å–µ—Å—Å–∏—é/—Ç–æ–∫–µ–Ω?
(–Ø –Ω–µ –±—É–¥—É –∂–¥–∞—Ç—å –æ—Ç–≤–µ—Ç ‚Äú–ø–æ—Ç–æ–º‚Äù, –Ω–æ —á—Ç–æ–±—ã —Ç–µ–±–µ —Å—Ä–∞–∑—É –¥–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–∫–µ–ª–µ—Ç.)

6) –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Å—Ç–µ–∫ (—Ä–µ–∫–æ–º–µ–Ω–¥—É—é)
Frontend: Vue (—É —Ç–µ–±—è —É–∂–µ)

Backend: FastAPI (Python)

Deploy: —Ç–æ—Ç –∂–µ —Å–µ—Ä–≤–µ—Ä, –≥–¥–µ Nginx

–ë–î: Supabase –∫–∞–∫ storage + tables

Auth: Telegram Login + —Å–µ—Ä–≤–µ—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ + JWT –¥–ª—è —Ñ—Ä–æ–Ω—Ç–∞

7) –ü–ª–∞–Ω —Ä–∞–±–æ—Ç –ø–æ –ø—É–Ω–∫—Ç–∞–º (–±—ã—Å—Ç—Ä–æ –∏ –ø–æ –¥–µ–ª—É)
–®–∞–≥ 1: Telegram
–°–æ–∑–¥–∞—Ç—å/–≤–∑—è—Ç—å –±–æ—Ç–∞

–ó–∞–¥–∞—Ç—å Domain –≤ BotFather

–®–∞–≥ 2: Backend (Python/FastAPI)
POST /auth/telegram:

–ø—Ä–æ–≤–µ—Ä–∫–∞ hash

–ø—Ä–æ–≤–µ—Ä–∫–∞ auth_date

upsert —é–∑–µ—Ä–∞ –≤ Supabase —Ç–∞–±–ª–∏—Ü—É users (–∏–ª–∏ user_telegram)

–≤–µ—Ä–Ω—É—Ç—å —Ñ—Ä–æ–Ω—Ç—É —Ç–≤–æ–π —Ç–æ–∫–µ–Ω (JWT) + –ø—Ä–æ—Ñ–∏–ª—å

–®–∞–≥ 3: Frontend (Vue)
–≤—Å—Ç–∞–≤–∏—Ç—å Telegram Login widget

–Ω–∞ onAuth –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å payload –Ω–∞ POST /auth/telegram

–ø—Ä–∏ —É—Å–ø–µ—Ö–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Ç–æ–∫–µ–Ω (–ª—É—á—à–µ httpOnly cookie, –Ω–æ –º–æ–∂–Ω–æ –∏ localStorage –Ω–∞ —Å—Ç–∞—Ä—Ç–µ)

–æ–±–Ω–æ–≤–∏—Ç—å UI (–ø—Ä–æ—Ñ–∏–ª—å/–∞–≤–∞—Ç–∞—Ä)

–®–∞–≥ 4: –ó–∞—â–∏—Ç–∞
Rate limit –Ω–∞ endpoint

–ü—Ä–æ–≤–µ—Ä–∫–∞ auth_date (–Ω–∞–ø—Ä–∏–º–µ—Ä 60‚Äì120 —Å–µ–∫—É–Ω–¥)

CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

8) –î–∞–ª—å—à–µ: –ø–∏—à–µ–º –±–æ—Ç–∞ –Ω–∞ Python?
–ï—Å–ª–∏ –º—ã –¥–µ–ª–∞–µ–º Telegram Login Widget, —Ç–æ ‚Äú–±–æ—Ç‚Äù –∫–∞–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –Ω—É–∂–µ–Ω, –Ω—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ –∏ —Å–µ—Ä–≤–µ—Ä–Ω—ã–π endpoint.

–ù–æ –µ—Å–ª–∏ —Ç–µ–±–µ –Ω—É–∂–µ–Ω –∏ —á–∞—Ç-–±–æ—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è/–∫–æ–º–∞–Ω–¥—ã), —Ç–æ –¥–∞ ‚Äî –º–æ–∂–Ω–æ –ø–∏—Å–∞—Ç—å –Ω–∞ Python (aiogram).
–≠—Ç–æ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–ª–æ–π –∏ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è –ª–æ–≥–∏–Ω–∞.

–ß—Ç–æ –º–Ω–µ –Ω—É–∂–Ω–æ –æ—Ç —Ç–µ–±—è (1 –≤–æ–ø—Ä–æ—Å, —á—Ç–æ–±—ã –Ω–µ –ø—Ä–æ–º–∞—Ö–Ω—É—Ç—å—Å—è)
–¢—ã —Ö–æ—á–µ—à—å, —á—Ç–æ–±—ã –ø–æ—Å–ª–µ —Ç–µ–ª–µ–≥—Ä–∞–º-–ª–æ–≥–∏–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—á–∏—Ç–∞–ª—Å—è –∑–∞–ª–æ–≥–∏–Ω–µ–Ω–Ω—ã–º –≤ Supabase Auth (–∫–∞–∫ Google), –∏–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–≤–æ–µ–≥–æ —Ç–æ–∫–µ–Ω–∞/—Å–µ—Å—Å–∏–∏ + –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü—É users?

–ï—Å–ª–∏ —Å–∫–∞–∂–µ—à—å ‚Äú–∫–∞–∫ Google —á–µ—Ä–µ–∑ Supabase Auth‚Äù ‚Äî —Å–¥–µ–ª–∞–µ–º –æ–¥–∏–Ω –ø—É—Ç—å.
–ï—Å–ª–∏ ‚Äú–ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏–Ω –≤ –º–æ—ë–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏‚Äù ‚Äî —Å–¥–µ–ª–∞–µ–º –ø—Ä–æ—â–µ –∏ –Ω–∞–¥—ë–∂–Ω–µ–µ –Ω–∞ FastAPI + JWT.

–•–æ—á–µ—à—å ‚Äî —è —Å—Ä–∞–∑—É –¥–∞–º –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤—ã–π –∫–æ–¥ FastAPI + –ø—Ä–æ–≤–µ—Ä–∫–∞ hash + –ø—Ä–∏–º–µ—Ä Vue –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –∫–Ω–æ–ø–∫–∏.


–í—ã —Å–∫–∞–∑–∞–ª–∏:
–Ω–µ, –¥–∞–≤–∞–π –ø–æ –ø–µ—Ä–≤–æ–º—É –≤–∞—Ä–∏–∞–Ω—Ç—É –ê, –µ—Å–ª–∏ –º–æ–∂–Ω–æ –Ω–µ –ø–∏—Å–∞—Ç—å –±–æ—Ç–∞, –ª—É—á—à–µ –Ω–µ –ø–∏—Å–∞—Ç—å, –¥–µ–ª–∞–µ–º –∫–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ

ChatGPT —Å–∫–∞–∑–∞–ª:

–î—É–º–∞–ª –Ω–∞ –ø—Ä–æ—Ç—è–∂–µ–Ω–∏–∏ 24s
–û–∫, –¥–µ–ª–∞–µ–º –≤–∞—Ä–∏–∞–Ω—Ç A (Telegram Login Widget) ‚Äî —ç—Ç–æ –∏ –µ—Å—Ç—å ‚Äú–∫–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ‚Äù –¥–ª—è —Å–∞–π—Ç–∞, –∏ –±–æ—Ç –ø–∏—Å–∞—Ç—å –Ω–µ –Ω–∞–¥–æ (–Ω—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ –±–æ—Ç –∫–∞–∫ ‚Äú–∫–ª—é—á‚Äù ‚Äî username + token –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ).

–ù–∏–∂–µ ‚Äî –ø–æ–¥—Ä–æ–±–Ω–æ –ø–æ –ø—É–Ω–∫—Ç–∞–º, —á—Ç–æ —Å–¥–µ–ª–∞—Ç—å, + —Ä–∞–±–æ—á–∏–µ –ø—Ä–∏–º–µ—Ä—ã –Ω–∞ Python (FastAPI) –∏ Vue.

1) –ß—Ç–æ —Ç–µ–±–µ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è
–ë–æ—Ç –≤ Telegram (–∫–∞–∫ —Å—É—â–Ω–æ—Å—Ç—å) ‚Äî –Ω—É–∂–µ–Ω:

BOT_USERNAME (–Ω–∞–ø—Ä–∏–º–µ—Ä biom_login_bot)

BOT_TOKEN (—Å–µ–∫—Ä–µ—Ç, —Ö—Ä–∞–Ω–∏—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)

–°–µ—Ä–≤–µ—Ä –Ω–∞ Python, –∫–æ—Ç–æ—Ä—ã–π:

–ø—Ä–∏–Ω–∏–º–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ—Ç Telegram widget

–ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ø–∏—Å—å (hash)

–µ—Å–ª–∏ –≤—Å—ë –æ–∫ ‚Äî –≤—ã–¥–∞—ë—Ç JWT, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–Ω–∏–º–∞–µ—Ç Supabase (–¥–ª—è RLS –∏ –∑–∞–ø—Ä–æ—Å–æ–≤)

Supabase JWT Secret (—Å–µ–∫—Ä–µ—Ç –ø–æ–¥–ø–∏—Å–∏ —Ç–æ–∫–µ–Ω–æ–≤):

–±–µ—Ä—ë—Ç—Å—è –≤ Supabase: Project Settings ‚Üí API ‚Üí JWT Secret

—Ö—Ä–∞–Ω–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –≤ .env

–∏–º –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ–º —Ç–æ–∫–µ–Ω—ã, –∫–æ—Ç–æ—Ä—ã–µ Supabase –±—É–¥–µ—Ç –ø—Ä–∏–Ω–∏–º–∞—Ç—å

2) Telegram: –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –±–æ—Ç–∞ (BotFather)
–ï—Å–ª–∏ —É —Ç–µ–±—è —É–∂–µ –µ—Å—Ç—å –±–æ—Ç ‚Äî —Å—É–ø–µ—Ä, –Ω–µ —Å–æ–∑–¥–∞–≤–∞–π –Ω–æ–≤—ã–π.

–®–∞–≥–∏:
–û—Ç–∫—Ä—ã–≤–∞–µ—à—å @BotFather

/mybots ‚Üí –≤—ã–±–∏—Ä–∞–µ—à—å —Å–≤–æ–µ–≥–æ –±–æ—Ç–∞

Bot Settings ‚Üí Domain

–£–∫–∞–∑—ã–≤–∞–µ—à—å –¥–æ–º–µ–Ω(—ã), –≥–¥–µ –±—É–¥–µ—Ç –∫–Ω–æ–ø–∫–∞ –ª–æ–≥–∏–Ω–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä:

biom.site

app.biom.site

‚ö†Ô∏è –í–∞–∂–Ω–æ:

Telegram Login –Ω–æ—Ä–º–∞–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ HTTPS –¥–æ–º–µ–Ω–µ.

–î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π ngrok (–≤—Ä–µ–º–µ–Ω–Ω—ã–π https-–¥–æ–º–µ–Ω).

3) Frontend (Vue): –¥–æ–±–∞–≤–ª—è–µ–º Telegram Login Widget
–ò–¥–µ—è: Telegram –≤—ã–∑—ã–≤–∞–µ—Ç JS callback onTelegramAuth(user) –∏ –æ—Ç–¥–∞—ë—Ç –æ–±—ä–µ–∫—Ç:

{
  id, first_name, last_name, username, photo_url,
  auth_date, hash
}
–¢—ã –Ω–µ –¥–æ–≤–µ—Ä—è–µ—à—å —ç—Ç–æ–º—É –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ, –∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—à—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä:
POST /auth/telegram

–ü—Ä–∏–º–µ—Ä –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ TelegramLoginButton.vue (–∫–æ–Ω—Ü–µ–ø—Ç)
(–≤—Å—Ç–∞–≤–ª—è–µ—à—å –∫—É–¥–∞ —Ç–µ–±–µ –Ω—É–∂–Ω–æ, –Ω–∞–ø—Ä–∏–º–µ—Ä –≤ AuthModal)

–≤—Å—Ç–∞–≤–ª—è–µ–º —Å–∫—Ä–∏–ø—Ç Telegram –æ–¥–∏–Ω —Ä–∞–∑

–ø–æ callback –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º payload –Ω–∞ –±—ç–∫–µ–Ω–¥

–ø–æ–ª—É—á–∞–µ–º jwt –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º (–ª—É—á—à–µ cookie, –Ω–æ –º–æ–∂–Ω–æ localStorage)

–°—É—Ç—å:

data-telegram-login="BOT_USERNAME"

data-onauth="onTelegramAuth(user)"

4) Backend (Python / FastAPI): –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ Telegram (–≥–ª–∞–≤–Ω–æ–µ)
Telegram –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ. –°–µ—Ä–≤–µ—Ä –æ–±—è–∑–∞–Ω –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:

–ê–ª–≥–æ—Ä–∏—Ç–º –ø—Ä–æ–≤–µ—Ä–∫–∏:
–£–±–∏—Ä–∞–µ–º hash –∏–∑ –¥–∞–Ω–Ω—ã—Ö

–°–æ—Ä—Ç–∏—Ä—É–µ–º –∫–ª—é—á–∏ –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É

–°–æ–±–∏—Ä–∞–µ–º —Å—Ç—Ä–æ–∫—É –≤–∏–¥–∞:

auth_date=... \n
first_name=... \n
id=... \n
username=...
–°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á:

secret_key = sha256(BOT_TOKEN) (–±–∞–π—Ç—ã)

–°—á–∏—Ç–∞–µ–º:

check_hash = hmac_sha256(data_check_string, secret_key) –≤ hex

–°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å hash –æ—Ç Telegram

–ü—Ä–æ–≤–µ—Ä—è–µ–º auth_date (–Ω–∞–ø—Ä–∏–º–µ—Ä –Ω–µ —Å—Ç–∞—Ä—à–µ 120 —Å–µ–∫—É–Ω–¥)

–ï—Å–ª–∏ –≤—Å—ë –≤–µ—Ä–Ω–æ ‚Äî –ª–æ–≥–∏–Ω —É—Å–ø–µ—à–µ–Ω.

5) –ö–∞–∫ ‚Äú–ø—Ä–∞–≤–∏–ª—å–Ω–æ‚Äù –ø—Ä–∏–≤—è–∑–∞—Ç—å –∫ Supabase (–±–µ–∑ Supabase Auth –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤)
Telegram –Ω–µ —è–≤–ª—è–µ—Ç—Å—è OAuth –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–º Supabase Auth, –ø–æ—ç—Ç–æ–º—É ‚Äú–∫–∞–∫ Google —á–µ—Ä–µ–∑ supabase.auth‚Äù –Ω–∞–ø—Ä—è–º—É—é –Ω–µ –ø–æ–ª—É—á–∏—Ç—Å—è.

–ù–æ ‚Äú–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¥–ª—è Supabase‚Äù —Ç—É—Ç —Ç–∞–∫–∞—è:

—Ç–≤–æ–π —Å–µ—Ä–≤–µ—Ä –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç Telegram

—Å–µ—Ä–≤–µ—Ä –≤—ã–¥–∞—ë—Ç Custom JWT, –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π Supabase JWT Secret

—Ñ—Ä–æ–Ω—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —ç—Ç–æ—Ç JWT –≤ Authorization: Bearer ...

Supabase –ø—Ä–∏–º–µ–Ω—è–µ—Ç RLS –∏ –≤–∏–¥–∏—Ç auth.uid() –∫–∞–∫ sub –∏–∑ —Ç–æ–∫–µ–Ω–∞

‚úÖ –≠—Ç–æ –¥–∞—ë—Ç –Ω–æ—Ä–º–∞–ª—å–Ω—É—é –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î –∏ –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–æ—Å—Ç—É–ø–∞
‚úÖ –ò –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –ø–∏—Å–∞—Ç—å –±–æ—Ç–∞ –∫–∞–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ/—á–∞—Ç-–±–æ—Ç

6) –ß—Ç–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –≤ Supabase (—á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞–ª–æ —Å RLS)
A) –¢–∞–±–ª–∏—Ü–∞ –ø—Ä–æ—Ñ–∏–ª–µ–π (—Ä–µ–∫–æ–º–µ–Ω–¥—É—é)
–ù–∞–ø—Ä–∏–º–µ—Ä public.users –∏–ª–∏ public.profiles:

id uuid (primary key) ‚Äî –±—É–¥–µ—Ç —Ä–∞–≤–µ–Ω sub (UUID)

telegram_id bigint

username text

first_name text

photo_url text

created_at timestamp

(–ú–æ–∂–Ω–æ –∏ —Ç–≤–æ–π user_telegram –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ‚Äî –Ω–µ –ø—Ä–∏–Ω—Ü–∏–ø–∏–∞–ª—å–Ω–æ.)

B) RLS –ø–æ–ª–∏—Ç–∏–∫–∏
–í–∫–ª—é—á–∞–µ—à—å RLS –Ω–∞ –Ω—É–∂–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö –∏ –ø–∏—à–µ—à—å –ø–æ–ª–∏—Ç–∏–∫–∏ —Ç–∏–ø–∞:

‚Äú–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Å—Ç—Ä–æ–∫–∏‚Äù:

auth.uid() = user_id

–ò–º–µ–Ω–Ω–æ –ø–æ—ç—Ç–æ–º—É –Ω–∞–º –Ω—É–∂–µ–Ω JWT, —á—Ç–æ–±—ã auth.uid() –±—ã–ª –Ω–µ null.

7) –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ FastAPI (–≥–æ—Ç–æ–≤—ã–π —Å–∫–µ–ª–µ—Ç)
–ß—Ç–æ –±—É–¥–µ—Ç –¥–µ–ª–∞—Ç—å endpoint:

–ø—Ä–æ–≤–µ—Ä–∏—Ç—å Telegram hash

—Å–æ–∑–¥–∞—Ç—å ‚Äú–Ω–∞—à–µ–≥–æ‚Äù –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (uuid) –≤ –ë–î (—á–µ—Ä–µ–∑ Supabase service role –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)

—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å JWT —Å sub=<uuid> –∏ role=authenticated

–≤–µ—Ä–Ω—É—Ç—å JWT –Ω–∞ —Ñ—Ä–æ–Ω—Ç

–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (server .env)
TELEGRAM_BOT_TOKEN=...

SUPABASE_URL=...

SUPABASE_SERVICE_ROLE_KEY=... (–¢–û–õ–¨–ö–û —Å–µ—Ä–≤–µ—Ä)

SUPABASE_JWT_SECRET=... (–¢–û–õ–¨–ö–û —Å–µ—Ä–≤–µ—Ä)

ALLOWED_ORIGIN=https://—Ç–≤–æ–π–¥–æ–º–µ–Ω (–¥–ª—è CORS)

8) Frontend: –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ—Ç JWT —Å Supabase
–ü–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞ —Ç—ã –ø–æ–ª—É—á–∞–µ—à—å custom_jwt.

–î–∞–ª—å—à–µ —Å–æ–∑–¥–∞—ë—à—å supabase client —Ç–∞–∫, —á—Ç–æ–±—ã –æ–Ω —Å–ª–∞–ª:
Authorization: Bearer <custom_jwt>

–ü—Ä–∏–º–µ—Ä:

import { createClient } from '@supabase/supabase-js'

export const supabaseAuthed = (jwt) =>
  createClient(import.meta.env.VITE_SUPABASE_URL, import.meta.env.VITE_SUPABASE_ANON_KEY, {
    global: {
      headers: {
        Authorization: `Bearer ${jwt}`
      }
    }
  })
–¢–µ–ø–µ—Ä—å –ª—é–±—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ —Ç–∞–±–ª–∏—Ü–∞–º —Å RLS –±—É–¥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∫ ‚Äú–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ‚Äù.

9) –í–∞–∂–Ω—ã–µ –Ω—é–∞–Ω—Å—ã (—á—Ç–æ–±—ã –Ω–µ —Å–ª–æ–≤–∏—Ç—å –±–∞–≥–∏ –∏ –≤–∑–ª–æ–º)
auth_date –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (60‚Äì120 —Å–µ–∫—É–Ω–¥)

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å HTTPS

CORS –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Å—Ç—Ä–æ–≥–æ –Ω–∞ –¥–æ–º–µ–Ω

JWT –¥–µ–ª–∞—Ç—å –∫–æ—Ä–æ—Ç–∫–æ–∂–∏–≤—É—â–∏–º (–Ω–∞–ø—Ä–∏–º–µ—Ä 1‚Äì7 –¥–Ω–µ–π) + –º–µ—Ö–∞–Ω–∏–∑–º refresh (–º–æ–∂–Ω–æ –ø–æ–∑–∂–µ)

–ù–µ —Ö—Ä–∞–Ω–∏—Ç—å SUPABASE_SERVICE_ROLE_KEY –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ

10) –ò—Ç–æ–≥–æ–≤—ã–π —á–µ–∫–ª–∏—Å—Ç –≤–Ω–µ–¥—Ä–µ–Ω–∏—è
‚úÖ BotFather: –≤—ã—Å—Ç–∞–≤–∏—Ç—å Domain

‚úÖ Vue: –ø–æ—Å—Ç–∞–≤–∏—Ç—å Telegram widget + –æ—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä

‚úÖ FastAPI: –ø—Ä–æ–≤–µ—Ä–∫–∞ hash + –≤—ã–¥–∞—á–∞ custom JWT

‚úÖ Supabase: RLS + –ø–æ–ª–∏—Ç–∏–∫–∏ –ø–æ–¥ auth.uid()

‚úÖ Frontend: —Ö—Ä–∞–Ω–∏—Ç—å JWT –∏ –ø–æ–¥–∫–ª—é—á–∞—Ç—å –∫ Supabase –∑–∞–ø—Ä–æ—Å–∞–º

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å ‚Äî —è —Å–ª–µ–¥—É—é—â–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º –¥–∞–º –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤—ã–π –∫–æ–¥:

FastAPI main.py (endpoint /auth/telegram, –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏, —Å–æ–∑–¥–∞–Ω–∏–µ/–ø–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è JWT)

Vue –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –∫–Ω–æ–ø–∫–∏ Telegram

–ø—Ä–∏–º–µ—Ä useSupabase.js, –∫–æ—Ç–æ—Ä—ã–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç jwt

–°–∫–∞–∂–∏ —Ç–æ–ª—å–∫–æ: —Ç—ã —Ö–æ—á–µ—à—å —Ö—Ä–∞–Ω–∏—Ç—å jwt –≤ localStorage (–±—ã—Å—Ç—Ä–æ) –∏–ª–∏ —Å–¥–µ–ª–∞—Ç—å httpOnly cookie (—Å–∞–º—ã–π –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç)?


–í—ã —Å–∫–∞–∑–∞–ª–∏:

–£–∫–∞–∑—ã–≤–∞–µ—à—å –¥–æ–º–µ–Ω(—ã), –≥–¥–µ –±—É–¥–µ—Ç –∫–Ω–æ–ø–∫–∞ –ª–æ–≥–∏–Ω–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä:

—Å–º–æ—Ç—Ä–∏, —É –º–µ–Ω—è –Ω–µ—Ç –¥–æ–º–µ–Ω–∞, —è –ø–æ–∫–∞ —á—Ç–æ –∑–∞–ø—É—Å–∫–∞—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –±–µ–∑ –Ω–µ–≥–æ

ChatGPT —Å–∫–∞–∑–∞–ª:
–ü–æ–Ω—è–ª. –¢–æ–≥–¥–∞ –≤–∞–∂–Ω–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ:

Telegram Login Widget ‚Äú–∫–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ‚Äù —Ç—Ä–µ–±—É–µ—Ç –¥–æ–º–µ–Ω (–∏ –æ–±—ã—á–Ω–æ HTTPS).
–ë–µ–∑ –¥–æ–º–µ–Ω–∞ (–µ—Å–ª–∏ —Ç—ã –∑–∞—Ö–æ–¥–∏—à—å –ø–æ IP —Ç–∏–ø–∞ http://1.2.3.4:5173 –∏–ª–∏ –¥–∞–∂–µ https://IP) –æ–Ω–æ –ª–∏–±–æ:

–Ω–µ –¥–∞—Å—Ç –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è, –ª–∏–±–æ

–±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ/—á–∞—Å—Ç–∏—á–Ω–æ, –ø–æ—Ç–æ–º—É —á—Ç–æ BotFather ‚ÄúDomain‚Äù –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç –ª–æ–≥–∏–Ω –∫ –¥–æ–º–µ–Ω–∞–º.

–ù–æ —ç—Ç–æ –Ω–µ —Å—Ç–æ–ø–µ—Ä: –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –Ω–æ—Ä–º–∞–ª—å–Ω–æ —É–∂–µ —Å–µ–π—á–∞—Å –¥–≤—É–º—è –ø—É—Ç—è–º–∏.

–í–∞—Ä–∏–∞–Ω—Ç 1 (—Ä–µ–∫–æ–º–µ–Ω–¥—É—é): –≤—Ä–µ–º–µ–Ω–Ω—ã–π –¥–æ–º–µ–Ω —á–µ—Ä–µ–∑ ngrok / Cloudflare Tunnel
–≠—Ç–æ —Å–∞–º—ã–π –±—ã—Å—Ç—Ä—ã–π —Å–ø–æ—Å–æ–± –ø–æ–ª—É—á–∏—Ç—å https + –¥–æ–º–µ–Ω, –Ω–µ –ø–æ–∫—É–ø–∞—è –¥–æ–º–µ–Ω.

–ê) Cloudflare Tunnel (—Å—Ç–∞–±–∏–ª—å–Ω–µ–µ, –º–æ–∂–Ω–æ –±–µ—Å–ø–ª–∞—Ç–Ω–æ, –Ω–æ —á—É—Ç—å –±–æ–ª—å—à–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫)
–¥–∞—ë—Ç —Ç–µ–±–µ –¥–æ–º–µ–Ω –≤–∏–¥–∞ something.trycloudflare.com

–ø—Ä–æ–∫–∏–¥—ã–≤–∞–µ—Ç –Ω–∞ —Ç–≤–æ–π —Å–µ—Ä–≤–µ—Ä/–ø–æ—Ä—Ç

–ë) ngrok (–æ—á–µ–Ω—å –ø—Ä–æ—Å—Ç–æ–π —Å—Ç–∞—Ä—Ç)
–¥–∞—ë—Ç https://xxxx.ngrok-free.app

–ø—Ä–æ–∫–∏–¥—ã–≤–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç —Ç–≤–æ–µ–≥–æ —Ñ—Ä–æ–Ω—Ç–∞ (–∏ –æ—Ç–¥–µ–ª—å–Ω–æ ‚Äî –Ω–∞ backend)

–ü–ª—é—Å: Telegram Login —Å—Ä–∞–∑—É –Ω–∞—á–∏–Ω–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å ‚Äú–∫–∞–∫ –≤ –ø—Ä–æ–¥–µ‚Äù.

–ß—Ç–æ –¥–µ–ª–∞—Ç—å:

–ü–æ–¥–Ω–∏–º–∏ —Ñ—Ä–æ–Ω—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä –Ω–∞ localhost:5173 –∏–ª–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ 127.0.0.1:5173)

–ü–æ–¥–Ω–∏–º–∏ backend (–Ω–∞–ø—Ä–∏–º–µ—Ä 127.0.0.1:8000)

–ó–∞–ø—É—Å—Ç–∏ —Ç—É–Ω–Ω–µ–ª–∏:

ngrok http 5173 (—Ñ—Ä–æ–Ω—Ç)

ngrok http 8000 (–±—ç–∫)

–í BotFather ‚Üí Bot Settings ‚Üí Domain –≤—Å—Ç–∞–≤—å –¥–æ–º–µ–Ω —Ñ—Ä–æ–Ω—Ç–∞ (ngrok/trycloudflare)

–ù–∞ —Ñ—Ä–æ–Ω—Ç–µ –≤ Telegram widget —É–∫–∞–∂–∏ data-auth-url="https://.../auth/telegram" (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å —Ä–µ–¥–∏—Ä–µ–∫—Ç-—Ä–µ–∂–∏–º) –∏–ª–∏ data-onauth="..." + fetch –Ω–∞ —Ç–≤–æ–π backend.

‚ö†Ô∏è –í–∞–∂–Ω–æ: –µ—Å–ª–∏ –¥–æ–º–µ–Ω –º–µ–Ω—è–µ—Ç—Å—è (—É free ngrok —á–∞—Å—Ç–æ –º–µ–Ω—è–µ—Ç—Å—è), –ø—Ä–∏–¥—ë—Ç—Å—è –æ–±–Ω–æ–≤–ª—è—Ç—å Domain –≤ BotFather.

–í–∞—Ä–∏–∞–Ω—Ç 2 (–µ—Å–ª–∏ —Å–æ–≤—Å–µ–º –±–µ–∑ –¥–æ–º–µ–Ω–∞): –±–æ—Ç-–ª–æ–≥–∏–Ω —á–µ—Ä–µ–∑ /start (–Ω–µ Widget)
–≠—Ç–æ —É–∂–µ –Ω–µ –≤–∞—Ä–∏–∞–Ω—Ç A (widget), –Ω–æ –æ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ IP –∏ –±–µ–∑ –¥–æ–º–µ–Ω–∞:

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç –±–æ—Ç—É /start

–ë–æ—Ç –≤—ã–¥–∞—ë—Ç –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π –∫–æ–¥ –∏–ª–∏ —Å—Å—ã–ª–∫—É

–¢—ã –Ω–∞ —Å–∞–π—Ç–µ –≤–≤–æ–¥–∏—à—å –∫–æ–¥ ‚Üí —Å–µ—Ä–≤–µ—Ä –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –∏ –ª–æ–≥–∏–Ω–∏—Ç

‚úÖ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –¥–æ–º–µ–Ω–∞
‚ùå –º–µ–Ω–µ–µ ‚Äú–ø—Ä–∞–≤–∏–ª—å–Ω–æ‚Äù –¥–ª—è —Å–∞–π—Ç–∞, –Ω–æ –ø—Ä–∞–∫—Ç–∏—á–Ω–æ –Ω–∞ —ç—Ç–∞–ø–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

–¢—ã —Å–∫–∞–∑–∞–ª ‚Äú–¥–µ–ª–∞–µ–º –∫–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ‚Äù ‚Äî –∑–Ω–∞—á–∏—Ç –ª—É—á—à–µ –í–∞—Ä–∏–∞–Ω—Ç 1 (—Ç—É–Ω–Ω–µ–ª—å).

–ß—Ç–æ —è –ø—Ä–µ–¥–ª–∞–≥–∞—é —Å–¥–µ–ª–∞—Ç—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å (—Å–∞–º—ã–π –∫–æ—Ä–æ—Ç–∫–∏–π –ø—É—Ç—å)
–í—ã–±–∏—Ä–∞–µ–º: ngrok –∏–ª–∏ Cloudflare Tunnel

–ü–æ–ª—É—á–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π https-–¥–æ–º–µ–Ω

–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º BotFather Domain

–î–∞–ª—å—à–µ —è –¥–∞—é —Ç–µ–±–µ –≥–æ—Ç–æ–≤—ã–π –∫–æ–¥ FastAPI + Vue –∫–Ω–æ–ø–∫—É

–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω (ngrok)
1) –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å ngrok –Ω–∞ —Å–µ—Ä–≤–µ—Ä
–°–∫–∞—á–∞–π –±–∏–Ω–∞—Ä–Ω–∏–∫ ngrok (–ø–æ–¥ Linux x64)

–ê–≤—Ç–æ—Ä–∏–∑—É–π: ngrok config add-authtoken <TOKEN>

2) –ó–∞–ø—É—Å—Ç–∏—Ç—å
–ï—Å–ª–∏ —Ñ—Ä–æ–Ω—Ç —É —Ç–µ–±—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä Vite dev):

ngrok http 5173

–ï—Å–ª–∏ —Ñ—Ä–æ–Ω—Ç —É–∂–µ —Å–æ–±—Ä–∞–Ω –∏ –≤–∏—Å–∏—Ç –Ω–∞ nginx :80:

ngrok http 80 ‚úÖ –ª—É—á—à–µ

Backend:

ngrok http 8000

3) BotFather Domain
–í—Å—Ç–∞–≤–ª—è–µ—à—å –¥–æ–º–µ–Ω —Ñ—Ä–æ–Ω—Ç–∞ https://xxxx.ngrok-free.app (–±–µ–∑ –ø—É—Ç–µ–π).

–í–æ–ø—Ä–æ—Å –±–µ–∑ –ª–∏—à–Ω–µ–π –≤–æ–¥—ã (—á—Ç–æ–±—ã —è –¥–∞–ª —Ç–æ—á–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã)
–°–µ–π—á–∞—Å —Å–∞–π—Ç —É —Ç–µ–±—è –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –∫–∞–∫:

http://IP:PORT (–∫–∞–∫–æ–π –ø–æ—Ä—Ç?)
–∏–ª–∏

—á–µ—Ä–µ–∑ nginx –Ω–∞ http://IP / http://IP:80?
–∏ backend —É —Ç–µ–±—è —É–∂–µ –µ—Å—Ç—å –∏–ª–∏ –ø–æ–∫–∞ –Ω–µ—Ç?

–ï—Å–ª–∏ –Ω–µ —Ö–æ—á–µ—à—å –æ—Ç–≤–µ—á–∞—Ç—å ‚Äî —è –¥–∞–º —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Ä–µ—Ü–µ–ø—Ç –ø–æ–¥ —Å–∞–º—ã–π —á–∞—Å—Ç—ã–π –∫–µ–π—Å: nginx :80 + FastAPI :8000.

–•–æ—á–µ—à—å ‚Äî —Å—Ä–∞–∑—É –≤ —Å–ª–µ–¥—É—é—â–µ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –≤—ã–¥–∞–º:

–∫–æ–º–∞–Ω–¥—ã —É—Å—Ç–∞–Ω–æ–≤–∫–∏ ngrok –Ω–∞ Ubuntu/Debian

–∫–æ–Ω—Ñ–∏–≥ CORS –¥–ª—è FastAPI

–ø—Ä–∏–º–µ—Ä Vue-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ Telegram Login

endpoint /auth/telegram (hash verify + custom JWT –¥–ª—è Supabase)


–í—ã —Å–∫–∞–∑–∞–ª–∏:
–Ω—É–∂–Ω–æ  —Ñ–∏–ª—å—Ç—Ä—ã –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ —Ñ–∏–ª—å—Ç—Ä—ã –≤ "–º–µ–Ω—é—à–∫—É", –∞ –∑–Ω–∞—á–µ–∫ –º–µ–Ω—é—à–∫–∏ –ø–æ–º–µ–Ω—è—Ç—å –Ω–∞ –∑–Ω–∞—á–µ–∫ —Ñ–∏–ª—å—Ç—Ä–∞

ChatGPT —Å–∫–∞–∑–∞–ª:

–î—É–º–∞–ª –Ω–∞ –ø—Ä–æ—Ç—è–∂–µ–Ω–∏–∏ 45s
–û–∫ ‚úÖ –°–¥–µ–ª–∞–ª —Ç–∞–∫:

–§–∏–ª—å—Ç—Ä—ã —É–±—Ä–∞–Ω—ã –∏–∑ HomeView ‚Üí –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç FiltersPanel.vue

–í HomeView –≤–º–µ—Å—Ç–æ –±–ª–æ–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤ —Ç–µ–ø–µ—Ä—å –∫–Ω–æ–ø–∫–∞ —Å –∏–∫–æ–Ω–∫–æ–π ‚Äú—Ñ–∏–ª—å—Ç—Ä‚Äù (–≤–æ—Ä–æ–Ω–∫–∞)

–ü–æ –Ω–∞–∂–∞—Ç–∏—é –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è ‚Äú–º–µ–Ω—é—à–∫–∞‚Äù (drawer/–ø–∞–Ω–µ–ª—å) —Å–ø—Ä–∞–≤–∞ —Å –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ–º —Ñ–æ–Ω–∞

–î–æ–±–∞–≤–ª–µ–Ω–∞ –≥–∞–ª–æ—á–∫–∞ ‚Äú–¢–æ–ª—å–∫–æ –æ–Ω–ª–∞–π–Ω (is_online)‚Äù –≤–Ω—É—Ç—Ä–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤

–í—Å—ë —Å—Ç–∏–ª—å–Ω–æ–µ + –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–µ

–ù–∏–∂–µ –≤–µ—Å—å –∫–æ–¥ (2 —Ñ–∞–π–ª–∞):

1) src/components/FiltersPanel.vue (–ù–û–í–´–ô —Ñ–∞–π–ª, –ø–æ–ª–Ω–æ—Å—Ç—å—é)
–ü–æ–ª–æ–∂–∏ —Ñ–∞–π–ª —Å—é–¥–∞: src/components/FiltersPanel.vue

<template>
  <div class="panel">
    <div class="head">
      <div class="title">–§–∏–ª—å—Ç—Ä—ã</div>
      <button class="reset" @click="$emit('reset')">–°–±—Ä–æ—Å–∏—Ç—å</button>
    </div>

    <!-- Categories -->
    <div class="block">
      <div class="label">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</div>

      <div class="tags">
        <button class="tag" :class="{ active: isAllCategoriesActive }" @click="selectAllCategories">
          –í—Å–µ
        </button>

        <button
          v-for="cat in categories"
          :key="cat.id"
          class="tag"
          :class="{ active: selectedCategoryNames.includes(cat.name) }"
          @click="toggleCategory(cat.name)"
        >
          {{ cat.name }}
        </button>
      </div>
    </div>

    <!-- Online -->
    <div class="block inline">
      <label class="check">
        <input type="checkbox" :checked="onlineOnly" @change="onToggleOnline" />
        <span class="ui"></span>
        <span class="text">–¢–æ–ª—å–∫–æ –æ–Ω–ª–∞–π–Ω</span>
      </label>
      <div class="hint">–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è, –≥–¥–µ <b>is_online = true</b>.</div>
    </div>

    <div class="grid">
      <!-- PRICE -->
      <div class="card">
        <div class="cardTitle">–¶–µ–Ω–∞</div>

        <div class="seg">
          <button class="segBtn" :class="{ active: priceMode === 'all' }" @click="setPriceMode('all')">
            –õ—é–±–∞—è
          </button>
          <button class="segBtn" :class="{ active: priceMode === 'free' }" @click="setPriceMode('free')">
            –ë–µ—Å–ø–ª–∞—Ç–Ω–æ
          </button>
          <button class="segBtn" :class="{ active: priceMode === 'custom' }" @click="setPriceMode('custom')">
            –°–≤–æ–π –¥–∏–∞–ø–∞–∑–æ–Ω
          </button>
        </div>

        <div class="chips">
          <button class="chip" :class="{ active: priceMode === '100_1000' }" @click="setPriceMode('100_1000')">
            100‚Äì1000
          </button>
          <button class="chip" :class="{ active: priceMode === '1000_3000' }" @click="setPriceMode('1000_3000')">
            1000‚Äì3000
          </button>
          <button class="chip" :class="{ active: priceMode === '3000_10000' }" @click="setPriceMode('3000_10000')">
            3000‚Äì10000
          </button>
          <button class="chip" :class="{ active: priceMode === 'gt_10000' }" @click="setPriceMode('gt_10000')">
            &gt; 10000
          </button>
        </div>

        <div v-if="priceMode === 'custom'" class="row">
          <div class="field">
            <div class="fieldLabel">–æ—Ç</div>
            <input
              class="input"
              type="number"
              min="0"
              inputmode="numeric"
              placeholder="0"
              :value="customPriceMin"
              @input="$emit('update:customPriceMin', $event.target.value)"
            />
          </div>

          <div class="field">
            <div class="fieldLabel">–¥–æ</div>
            <input
              class="input"
              type="number"
              min="0"
              inputmode="numeric"
              placeholder="‚àû"
              :value="customPriceMax"
              @input="$emit('update:customPriceMax', $event.target.value)"
            />
          </div>
        </div>

        <div class="hint">
          –ï—Å–ª–∏ <b>is_free=true</b> –∏–ª–∏ <b>price=0</b> ‚Äî —ç—Ç–æ ‚Äú–ë–µ—Å–ø–ª–∞—Ç–Ω–æ‚Äù.
        </div>
      </div>

      <!-- DATE -->
      <div class="card">
        <div class="cardTitle">–î–∞—Ç–∞</div>

        <div class="seg">
          <button class="segBtn" :class="{ active: dateMode === 'all' }" @click="setDateMode('all')">
            –í—Å—ë –≤—Ä–µ–º—è
          </button>
          <button class="segBtn" :class="{ active: dateMode === 'on' }" @click="setDateMode('on')">
            –ù–∞ –¥–∞—Ç—É
          </button>
          <button class="segBtn" :class="{ active: dateMode === 'range' }" @click="setDateMode('range')">
            –î–∏–∞–ø–∞–∑–æ–Ω
          </button>
        </div>

        <div class="chips">
          <button class="chip" :class="{ active: dateMode === 'after' }" @click="setDateMode('after')">
            –ü–æ—Å–ª–µ
          </button>
          <button class="chip" :class="{ active: dateMode === 'before' }" @click="setDateMode('before')">
            –î–æ
          </button>
          <button class="chip" :class="{ active: dateMode === 'next7' }" @click="setDateMode('next7')">
            –°–ª–µ–¥. 7 –¥–Ω–µ–π
          </button>
          <button class="chip" :class="{ active: dateMode === 'today' }" @click="setDateMode('today')">
            –°–µ–≥–æ–¥–Ω—è
          </button>
        </div>

        <div v-if="dateMode === 'on'" class="row">
          <div class="field grow">
            <div class="fieldLabel">–î–∞—Ç–∞</div>
            <input class="input" type="date" :value="dateOn" @input="$emit('update:dateOn', $event.target.value)" />
          </div>
        </div>

        <div v-else-if="dateMode === 'range'" class="row">
          <div class="field grow">
            <div class="fieldLabel">—Å</div>
            <input
              class="input"
              type="date"
              :value="dateFrom"
              @input="$emit('update:dateFrom', $event.target.value)"
            />
          </div>
          <div class="field grow">
            <div class="fieldLabel">–ø–æ</div>
            <input class="input" type="date" :value="dateTo" @input="$emit('update:dateTo', $event.target.value)" />
          </div>
        </div>

        <div v-else-if="dateMode === 'after'" class="row">
          <div class="field grow">
            <div class="fieldLabel">–ü–æ—Å–ª–µ</div>
            <input
              class="input"
              type="date"
              :value="datePivot"
              @input="$emit('update:datePivot', $event.target.value)"
            />
          </div>
        </div>

        <div v-else-if="dateMode === 'before'" class="row">
          <div class="field grow">
            <div class="fieldLabel">–î–æ</div>
            <input
              class="input"
              type="date"
              :value="datePivot"
              @input="$emit('update:datePivot', $event.target.value)"
            />
          </div>
        </div>

        <div class="hint">
          –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ <b>date_time_event</b>.
        </div>
      </div>
    </div>
  </div>
</template>

<script>
export default {
  name: 'FiltersPanel',
  emits: [
    'reset',
    'update:selectedCategoryNames',
    'update:onlineOnly',
    'update:priceMode',
    'update:customPriceMin',
    'update:customPriceMax',
    'update:dateMode',
    'update:dateOn',
    'update:dateFrom',
    'update:dateTo',
    'update:datePivot'
  ],
  props: {
    categories: { type: Array, default: () => [] },

    selectedCategoryNames: { type: Array, default: () => [] },
    isAllCategoriesActive: { type: Boolean, default: true },

    onlineOnly: { type: Boolean, default: false },

    priceMode: { type: String, default: 'all' },
    customPriceMin: { type: String, default: '' },
    customPriceMax: { type: String, default: '' },

    dateMode: { type: String, default: 'all' },
    dateOn: { type: String, default: '' },
    dateFrom: { type: String, default: '' },
    dateTo: { type: String, default: '' },
    datePivot: { type: String, default: '' }
  },
  methods: {
    selectAllCategories() {
      this.$emit('update:selectedCategoryNames', [])
    },
    toggleCategory(name) {
      const n = String(name || '').trim()
      if (!n) return
      const next = [...this.selectedCategoryNames]
      const idx = next.indexOf(n)
      if (idx >= 0) next.splice(idx, 1)
      else next.push(n)
      this.$emit('update:selectedCategoryNames', next)
    },
    onToggleOnline(e) {
      this.$emit('update:onlineOnly', !!e.target.checked)
    },
    setPriceMode(mode) {
      this.$emit('update:priceMode', mode)
    },
    setDateMode(mode) {
      this.$emit('update:dateMode', mode)
    }
  }
}
</script>

<style scoped>
.panel {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.head {
  display: flex;
  align-items: center;
  gap: 12px;
}

.title {
  font-weight: 900;
  font-size: 16px;
}

.reset {
  margin-left: auto;
  border: 1px solid #efefef;
  background: #fafafa;
  border-radius: 12px;
  padding: 8px 10px;
  cursor: pointer;
  font-size: 13px;
}
.reset:hover {
  background: #f3f3f3;
}

.block {
  border: 1px solid #f2f2f2;
  border-radius: 16px;
  padding: 12px;
  background: #fcfcfc;
}

.inline {
  display: grid;
  gap: 8px;
}

.label {
  font-weight: 800;
  font-size: 13px;
  opacity: 0.7;
  margin-bottom: 10px;
}

.tags {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}

.tag {
  border: 1px solid #efefef;
  background: #fafafa;
  border-radius: 999px;
  padding: 8px 12px;
  cursor: pointer;
  font-size: 13px;
  white-space: nowrap;
}

.tag.active {
  background: #8a75e3;
  border-color: #8a75e3;
  color: #fff;
}

/* Toggle */
.check {
  display: inline-flex;
  align-items: center;
  gap: 10px;
  cursor: pointer;
  user-select: none;
}
.check input {
  display: none;
}
.ui {
  width: 44px;
  height: 26px;
  border-radius: 999px;
  border: 1px solid #e9e9e9;
  background: #f3f3f3;
  position: relative;
  transition: background 180ms ease, border-color 180ms ease;
}
.ui::after {
  content: '';
  width: 22px;
  height: 22px;
  border-radius: 999px;
  background: #fff;
  position: absolute;
  top: 1px;
  left: 1px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.08);
  transition: transform 180ms ease;
}
.check input:checked + .ui {
  background: rgba(138, 117, 227, 0.85);
  border-color: rgba(138, 117, 227, 0.55);
}
.check input:checked + .ui::after {
  transform: translateX(18px);
}
.text {
  font-weight: 800;
  font-size: 13px;
}

.grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 12px;
}

.card {
  border: 1px solid #f2f2f2;
  border-radius: 16px;
  padding: 12px;
  background: #fcfcfc;
}

.cardTitle {
  font-weight: 900;
  margin-bottom: 10px;
}

.seg {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-bottom: 10px;
}

.segBtn {
  border: 1px solid #efefef;
  background: #fff;
  border-radius: 12px;
  padding: 8px 10px;
  cursor: pointer;
  font-size: 13px;
}
.segBtn.active {
  background: rgba(138, 117, 227, 0.12);
  border-color: rgba(138, 117, 227, 0.4);
}

.chips {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 10px;
}

.chip {
  border: 1px solid #efefef;
  background: #fff;
  border-radius: 999px;
  padding: 7px 10px;
  cursor: pointer;
  font-size: 13px;
}
.chip.active {
  background: #8a75e3;
  border-color: #8a75e3;
  color: #fff;
}

.row {
  display: flex;
  gap: 10px;
  align-items: flex-end;
}

.field {
  display: flex;
  flex-direction: column;
  gap: 6px;
  min-width: 120px;
}
.field.grow {
  flex: 1;
  min-width: 160px;
}

.fieldLabel {
  font-size: 12px;
  opacity: 0.7;
  font-weight: 700;
}

.input {
  border: 1px solid #efefef;
  border-radius: 12px;
  padding: 10px 10px;
  font-size: 14px;
  background: #fff;
  outline: none;
}
.input:focus {
  border-color: rgba(138, 117, 227, 0.55);
  box-shadow: 0 0 0 3px rgba(138, 117, 227, 0.12);
}

.hint {
  margin-top: 10px;
  font-size: 12px;
  opacity: 0.7;
  line-height: 1.25;
}
</style>
2) src/views/HomeView.vue (–ó–ê–ú–ï–ù–ò –ü–û–õ–ù–û–°–¢–¨–Æ)
–≠—Ç–æ —Ç–≤–æ–π —Ñ–∞–π–ª HomeView.vue (—É —Ç–µ–±—è –æ–Ω —Å–µ–π—á–∞—Å —Å –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ –ø–æ id).
–ó–∞–º–µ–Ω—è–π –ø–æ–ª–Ω–æ—Å—Ç—å—é.

<template>
  <div class="page">
    <div class="container">
      <!-- TOP BAR -->
      <div class="topbar">
        <div class="topbar-left">
          <div class="page-title">–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</div>
          <div class="page-sub">
            <span v-if="initialLoaded">{{ filteredEvents.length }}</span>
            <span v-else>‚Ä¶</span>
          </div>
        </div>

        <!-- FILTER BUTTON (icon instead of menu) -->
        <button class="filter-btn" @click="openFilters" aria-label="–û—Ç–∫—Ä—ã—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã">
          <!-- funnel icon -->
          <svg viewBox="0 0 24 24" class="filter-icon" aria-hidden="true">
            <path
              d="M3 5h18l-7 8v5l-4 2v-7L3 5z"
              fill="currentColor"
            />
          </svg>
          <span class="filter-btn-text">–§–∏–ª—å—Ç—Ä—ã</span>
        </button>
      </div>

      <!-- STATES -->
      <div v-if="!initialLoaded" class="state">
        <div class="spinner"></div>
        <div>–ó–∞–≥—Ä—É–∑–∫–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π‚Ä¶</div>
      </div>

      <div v-else-if="error" class="state error">
        <div class="error-title">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</div>
        <div class="error-sub">{{ error }}</div>
        <button class="retry" @click="reload">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
      </div>

      <div v-else-if="filteredEvents.length === 0" class="state">
        –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
      </div>

      <!-- EVENTS LIST -->
      <div v-else class="events-shell">
        <TransitionGroup name="list" tag="div" class="events-list">
          <EventCard
            v-for="event in filteredEvents"
            :key="event.id"
            :event="event"
            :photos="photos[event.id] || []"
            :photos-loading="photosLoading"
            :category-map="categoryMap"
            @open-photo="openPhoto"
          />
        </TransitionGroup>
      </div>
    </div>

    <!-- FILTERS DRAWER (menu) -->
    <teleport to="body">
      <div v-if="filtersOpen" class="drawer-root" @keydown.esc="closeFilters" tabindex="-1">
        <div class="overlay" @click="closeFilters"></div>

        <aside class="drawer" role="dialog" aria-modal="true" aria-label="–§–∏–ª—å—Ç—Ä—ã">
          <div class="drawer-head">
            <div class="drawer-title">–§–∏–ª—å—Ç—Ä—ã</div>
            <button class="close-btn" @click="closeFilters" aria-label="–ó–∞–∫—Ä—ã—Ç—å">
              ‚úï
            </button>
          </div>

          <div class="drawer-body">
            <FiltersPanel
              :categories="categories"
              :is-all-categories-active="isAllCategoriesActive"
              v-model:selectedCategoryNames="selectedCategoryNames"
              v-model:onlineOnly="onlineOnly"
              v-model:priceMode="priceMode"
              v-model:customPriceMin="customPriceMin"
              v-model:customPriceMax="customPriceMax"
              v-model:dateMode="dateMode"
              v-model:dateOn="dateOn"
              v-model:dateFrom="dateFrom"
              v-model:dateTo="dateTo"
              v-model:datePivot="datePivot"
              @reset="resetAllFilters"
            />
          </div>

          <div class="drawer-foot">
            <button class="apply-btn" @click="closeFilters">–ü–æ–∫–∞–∑–∞—Ç—å</button>
          </div>
        </aside>
      </div>
    </teleport>

    <!-- PHOTO MODAL -->
    <EventPhotoModal
      v-if="photoModalUrl"
      :url="photoModalUrl"
      @close="photoModalUrl = ''"
    />
  </div>
</template>

<script>
import { ref, computed, onMounted, onBeforeUnmount, nextTick } from 'vue'
import EventCard from '../../components/EventCard.vue'
import EventPhotoModal from '../../components/EventPhotoModal.vue'
import FiltersPanel from '../../components/FiltersPanel.vue'
import { useSupabase } from '../../composables/useSupabase'

const sleep = (ms) => new Promise((r) => setTimeout(r, ms))

const withRetry = async (fn, tries = 3) => {
  let lastErr = null
  for (let i = 0; i < tries; i++) {
    try {
      return await fn()
    } catch (e) {
      lastErr = e
      await sleep(350 * (i + 1))
    }
  }
  throw lastErr
}

/**
 * selectCategory —É —Ç–µ–±—è text[] (–∏–º–µ–Ω–∞), –Ω–æ –Ω–∞ –±—É–¥—É—â–µ–µ –ø–æ–¥–¥–µ—Ä–∂–∏–º –∏ id.
 * –ù–∞ –≤—ã—Ö–æ–¥–µ –≤—Å–µ–≥–¥–∞ –º–∞—Å—Å–∏–≤ –ò–ú–Å–ù –∫–∞—Ç–µ–≥–æ—Ä–∏–π.
 */
const normalizeCategoryNames = (raw, categoryMap) => {
  const map = categoryMap || {}

  const toName = (v) => {
    if (v === null || v === undefined) return ''
    const s = String(v).trim()
    if (!s) return ''
    if (map[s]) return String(map[s]).trim()
    const n = Number(s)
    if (!Number.isNaN(n) && map[String(n)]) return String(map[String(n)]).trim()
    return s
  }

  if (!raw) return []

  if (Array.isArray(raw)) return Array.from(new Set(raw.map(toName).filter(Boolean)))

  if (typeof raw === 'string') {
    const s = raw.trim()
    if (!s) return []
    return Array.from(
      new Set(
        s
          .split(/[,;|]+/g)
          .map((x) => x.trim())
          .filter(Boolean)
          .map(toName)
          .filter(Boolean)
      )
    )
  }

  const one = toName(raw)
  return one ? [one] : []
}

const toNumberOrNull = (v) => {
  if (v === null || v === undefined) return null
  const n = Number(v)
  return Number.isFinite(n) ? n : null
}

const startOfDay = (d) => new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0, 0, 0, 0)
const endOfDay = (d) => new Date(d.getFullYear(), d.getMonth(), d.getDate(), 23, 59, 59, 999)

const parseEventDate = (value) => {
  if (!value) return null
  const d = new Date(value)
  if (Number.isNaN(d.getTime())) return null
  return d
}

const parseDateInput = (yyyy_mm_dd) => {
  if (!yyyy_mm_dd) return null
  const [y, m, day] = yyyy_mm_dd.split('-').map((x) => Number(x))
  if (!y || !m || !day) return null
  return new Date(y, m - 1, day)
}

export default {
  name: 'HomeView',
  components: { EventCard, EventPhotoModal, FiltersPanel },
  props: {
    globalSearchTerm: { type: String, default: '' }
  },
  setup(props) {
    const { getEvents, getCategories, getEventPhotos } = useSupabase()

    const initialLoaded = ref(false)
    const error = ref(null)

    const allEvents = ref([])
    const visibleEvents = ref([]) // –¥–ª—è –ø–ª–∞–≤–Ω–æ–π –ø–æ–¥–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç–æ—á–µ–∫
    const photos = ref({})

    const categories = ref([])
    const categoryMap = ref({}) // id -> name

    // Filters state
    const selectedCategoryNames = ref([])
    const onlineOnly = ref(false)

    const priceMode = ref('all')
    const customPriceMin = ref('')
    const customPriceMax = ref('')

    const dateMode = ref('all')
    const dateOn = ref('')
    const dateFrom = ref('')
    const dateTo = ref('')
    const datePivot = ref('')

    const isAllCategoriesActive = computed(() => selectedCategoryNames.value.length === 0)

    const photosLoading = ref(false)
    const stopPhotosLoading = ref(false)

    // Drawer
    const filtersOpen = ref(false)

    // Progressive events timer
    const progressiveLoading = ref(false)
    let progressiveTimer = null

    const stopProgressive = () => {
      progressiveLoading.value = false
      if (progressiveTimer) {
        clearInterval(progressiveTimer)
        progressiveTimer = null
      }
    }

    const startProgressive = (list) => {
      stopProgressive()
      visibleEvents.value = []

      const src = Array.isArray(list) ? list : []
      if (!src.length) return

      progressiveLoading.value = true
      visibleEvents.value.push(src[0])

      let i = 1
      progressiveTimer = setInterval(() => {
        if (i >= src.length) {
          stopProgressive()
          return
        }
        visibleEvents.value.push(src[i])
        i++
      }, 140)
    }

    const photoModalUrl = ref('')
    const openPhoto = (url) => {
      if (!url) return
      photoModalUrl.value = url
    }

    const openFilters = async () => {
      filtersOpen.value = true
      await nextTick()
      // –±–ª–æ–∫–∏—Ä—É–µ–º —Å–∫—Ä–æ–ª–ª —Ñ–æ–Ω–∞
      document.documentElement.style.overflow = 'hidden'
      document.body.style.overflow = 'hidden'
    }

    const closeFilters = () => {
      filtersOpen.value = false
      document.documentElement.style.overflow = ''
      document.body.style.overflow = ''
    }

    const resetAllFilters = () => {
      selectedCategoryNames.value = []
      onlineOnly.value = false

      priceMode.value = 'all'
      customPriceMin.value = ''
      customPriceMax.value = ''

      dateMode.value = 'all'
      dateOn.value = ''
      dateFrom.value = ''
      dateTo.value = ''
      datePivot.value = ''
    }

    // --- filter funcs ---
    const matchesCategories = (event) => {
      if (selectedCategoryNames.value.length === 0) return true
      const eventCats = normalizeCategoryNames(event?.selectCategory, categoryMap.value)
      if (!eventCats.length) return false
      const set = new Set(selectedCategoryNames.value)
      return eventCats.some((c) => set.has(c))
    }

    const matchesOnline = (event) => {
      if (!onlineOnly.value) return true
      return event?.is_online === true
    }

    const getEventPrice = (event) => {
      if (event?.is_free === true) return 0
      const p = toNumberOrNull(event?.price)
      if (p === null) return null
      return p
    }

    const matchesPrice = (event) => {
      const mode = priceMode.value
      if (mode === 'all') return true

      const price = getEventPrice(event)
      if (mode === 'free') return price === 0
      if (price === null) return false

      if (mode === '100_1000') return price >= 100 && price <= 1000
      if (mode === '1000_3000') return price >= 1000 && price <= 3000
      if (mode === '3000_10000') return price >= 3000 && price <= 10000
      if (mode === 'gt_10000') return price > 10000

      if (mode === 'custom') {
        const min = customPriceMin.value === '' ? null : toNumberOrNull(customPriceMin.value)
        const max = customPriceMax.value === '' ? null : toNumberOrNull(customPriceMax.value)
        const okMin = min === null ? true : price >= min
        const okMax = max === null ? true : price <= max
        return okMin && okMax
      }

      return true
    }

    const matchesDate = (event) => {
      const mode = dateMode.value
      if (mode === 'all') return true

      const d = parseEventDate(event?.date_time_event)
      if (!d) return false

      if (mode === 'today') {
        const now = new Date()
        return d >= startOfDay(now) && d <= endOfDay(now)
      }

      if (mode === 'next7') {
        const now = new Date()
        const from = startOfDay(now)
        const to = endOfDay(new Date(now.getFullYear(), now.getMonth(), now.getDate() + 7))
        return d >= from && d <= to
      }

      if (mode === 'on') {
        const on = parseDateInput(dateOn.value)
        if (!on) return true
        return d >= startOfDay(on) && d <= endOfDay(on)
      }

      if (mode === 'range') {
        const fromD = parseDateInput(dateFrom.value)
        const toD = parseDateInput(dateTo.value)
        if (!fromD && !toD) return true
        const from = fromD ? startOfDay(fromD) : null
        const to = toD ? endOfDay(toD) : null
        const okFrom = from ? d >= from : true
        const okTo = to ? d <= to : true
        return okFrom && okTo
      }

      if (mode === 'after') {
        const pivot = parseDateInput(datePivot.value)
        if (!pivot) return true
        return d >= startOfDay(pivot)
      }

      if (mode === 'before') {
        const pivot = parseDateInput(datePivot.value)
        if (!pivot) return true
        return d <= endOfDay(pivot)
      }

      return true
    }

    const matchesSearch = (event) => {
      const term = (props.globalSearchTerm || '').trim().toLowerCase()
      if (!term) return true
      const t = (event.title || '').toLowerCase()
      const desc = (event.description || '').toLowerCase()
      const a = (event.address || '').toLowerCase()
      const o = (event.organizer || '').toLowerCase()
      return t.includes(term) || desc.includes(term) || a.includes(term) || o.includes(term)
    }

    const filteredEvents = computed(() => {
      return visibleEvents.value.filter(
        (e) => matchesCategories(e) && matchesOnline(e) && matchesPrice(e) && matchesDate(e) && matchesSearch(e)
      )
    })

    // --- loading ---
    const loadCategories = async () => {
      try {
        const { data, error: err } = await withRetry(() => getCategories())
        if (err) throw err

        categories.value = data ?? []
        categoryMap.value = (categories.value || []).reduce((acc, c) => {
          acc[String(c.id)] = c.name
          return acc
        }, {})
      } catch (e) {
        console.warn('Categories load error:', e)
        categories.value = []
        categoryMap.value = {}
      }
    }

    const loadEventsProgressive = async () => {
      error.value = null
      stopPhotosLoading.value = true
      photosLoading.value = false
      stopProgressive()

      try {
        const { data: eventsData, error: eventsErr } = await withRetry(() => getEvents())
        if (eventsErr) throw eventsErr

        allEvents.value = eventsData ?? []
        initialLoaded.value = true

        startProgressive(allEvents.value)

        // photos background
        photos.value = {}
        stopPhotosLoading.value = false

        const ids = allEvents.value.map((e) => e.id).filter(Boolean)
        if (!ids.length) return

        photosLoading.value = true

        const batchSize = 5
        for (let i = 0; i < ids.length; i += batchSize) {
          if (stopPhotosLoading.value) break

          const batch = ids.slice(i, i + batchSize)
          try {
            const { data: ph, error: phErr } = await withRetry(() => getEventPhotos(batch))
            if (phErr) throw phErr

            const next = { ...photos.value }
            for (const p of ph ?? []) {
              if (!p?.event_id) continue
              if (!next[p.event_id]) next[p.event_id] = []
              next[p.event_id].push(p)
            }
            photos.value = next
          } catch (e) {
            console.warn('Photos batch load error:', e)
          }

          await sleep(120)
        }
      } catch (e) {
        console.error('HomeView load error:', e)
        allEvents.value = []
        visibleEvents.value = []
        photos.value = {}
        initialLoaded.value = true
        error.value = e?.message ? String(e.message) : 'TypeError: Failed to fetch'
      } finally {
        photosLoading.value = false
      }
    }

    const reload = async () => {
      await loadEventsProgressive()
    }

    onMounted(async () => {
      await loadCategories()
      await loadEventsProgressive()
    })

    onBeforeUnmount(() => {
      stopProgressive()
      stopPhotosLoading.value = true
      document.documentElement.style.overflow = ''
      document.body.style.overflow = ''
    })

    return {
      initialLoaded,
      error,

      categories,
      categoryMap,

      selectedCategoryNames,
      isAllCategoriesActive,

      onlineOnly,

      priceMode,
      customPriceMin,
      customPriceMax,

      dateMode,
      dateOn,
      dateFrom,
      dateTo,
      datePivot,

      photos,
      photosLoading,

      filteredEvents,

      filtersOpen,
      openFilters,
      closeFilters,
      resetAllFilters,

      reload,

      photoModalUrl,
      openPhoto
    }
  }
}
</script>

<style scoped>
.page {
  padding: 16px 0 40px;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 20px;
}

/* TOPBAR */
.topbar {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 12px;
}

.topbar-left {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.page-title {
  font-weight: 900;
  font-size: 18px;
}

.page-sub {
  font-size: 12px;
  opacity: 0.65;
  font-weight: 700;
}

.filter-btn {
  margin-left: auto;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  border: 1px solid #efefef;
  background: #fff;
  border-radius: 14px;
  padding: 10px 12px;
  cursor: pointer;
  box-shadow: 0 2px 10px rgba(0,0,0,0.04);
}

.filter-btn:hover {
  background: #fafafa;
}

.filter-icon {
  width: 18px;
  height: 18px;
  opacity: 0.9;
}

.filter-btn-text {
  font-size: 13px;
  font-weight: 800;
}

/* STATES */
.state {
  display: grid;
  place-items: center;
  gap: 10px;
  padding: 40px 0;
  opacity: 0.75;
  text-align: center;
}

.state.error {
  opacity: 1;
  color: #d9534f;
}

.error-title {
  font-weight: 800;
}

.error-sub {
  font-size: 12px;
  opacity: 0.8;
  max-width: 680px;
}

.retry {
  margin-top: 8px;
  border: none;
  border-radius: 12px;
  padding: 10px 14px;
  cursor: pointer;
  background: #efefef;
}

.spinner {
  width: 26px;
  height: 26px;
  border-radius: 50%;
  border: 3px solid #eee;
  border-top-color: #8a75e3;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* EVENTS */
.events-shell {
  background: #fff;
  border: 1px solid #efefef;
  border-radius: 18px;
  padding: 14px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.04);
}

.events-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

/* –ø–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫ */
.list-enter-active,
.list-leave-active {
  transition: opacity 240ms ease, transform 240ms ease;
}
.list-enter-from,
.list-leave-to {
  opacity: 0;
  transform: translateY(8px);
}

/* DRAWER */
.drawer-root {
  position: fixed;
  inset: 0;
  z-index: 9999;
}

.overlay {
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,0.35);
  backdrop-filter: blur(2px);
}

.drawer {
  position: absolute;
  top: 0;
  right: 0;
  height: 100%;
  width: min(420px, 92vw);
  background: #fff;
  border-left: 1px solid #efefef;
  box-shadow: -10px 0 30px rgba(0,0,0,0.12);
  display: flex;
  flex-direction: column;
  animation: slideIn 180ms ease;
}

@keyframes slideIn {
  from { transform: translateX(18px); opacity: 0.7; }
  to { transform: translateX(0); opacity: 1; }
}

.drawer-head {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 14px;
  border-bottom: 1px solid #f2f2f2;
}

.drawer-title {
  font-weight: 900;
  font-size: 16px;
}

.close-btn {
  margin-left: auto;
  border: 1px solid #efefef;
  background: #fafafa;
  border-radius: 12px;
  padding: 8px 10px;
  cursor: pointer;
}

.drawer-body {
  padding: 14px;
  overflow: auto;
}

.drawer-foot {
  padding: 14px;
  border-top: 1px solid #f2f2f2;
  display: flex;
  justify-content: flex-end;
}

.apply-btn {
  border: none;
  background: #8a75e3;
  color: #fff;
  border-radius: 14px;
  padding: 12px 16px;
  font-weight: 900;
  cursor: pointer;
}
.apply-btn:hover {
  filter: brightness(0.97);
}
</style>
–ß—Ç–æ —Ç—ã –¥–µ–ª–∞–µ—à—å —É —Å–µ–±—è
–°–æ–∑–¥–∞—ë—à—å —Ñ–∞–π–ª: src/components/FiltersPanel.vue –∏ –≤—Å—Ç–∞–≤–ª—è–µ—à—å –∫–æ–¥

–ó–∞–º–µ–Ω—è–µ—à—å src/views/HomeView.vue —Ü–µ–ª–∏–∫–æ–º

–ü—Ä–æ–≤–µ—Ä—è–µ—à—å, —á—Ç–æ –ø—É—Ç–∏ –∏–º–ø–æ—Ä—Ç–æ–≤ —Å–æ–≤–ø–∞–¥–∞—é—Ç (—É —Ç–µ–±—è —É–∂–µ —Ç–∞–∫–∏–µ: ../../components/...)

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å ‚Äî –º–æ–≥—É —Å–¥–µ–ª–∞—Ç—å –µ—â—ë ‚Äú–ø–æ-–±–æ–≥–∞—Ç–æ–º—É‚Äù:

–ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ –∫–Ω–æ–ø–∫–µ —Ñ–∏–ª—å—Ç—Ä–∞ –∫–æ–ª-–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ (badge ‚Äú3‚Äù)

–∫–Ω–æ–ø–∫—É ‚Äú–§–∏–ª—å—Ç—Ä‚Äù —Å–¥–µ–ª–∞—Ç—å —Ç–æ–ª—å–∫–æ –∏–∫–æ–Ω–∫–æ–π –Ω–∞ –º–æ–±–∏–ª–∫–µ (—É–∂–µ –ø–æ—á—Ç–∏ —Ç–∞–∫, –º–æ–∂–Ω–æ –¥–æ–∂–∞—Ç—å)


–í—ã —Å–∫–∞–∑–∞–ª–∏:
–≤ –º–µ–Ω—é—à–∫–µ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤–æ–∑–º–æ–Ω–∂–æ—Å—Ç—å –ø—Ä–µ–æ–±—Ä–µ—Å—Ç–∏ –±–∏–∑–Ω–µ—Å –∞–∫–∫–∞—É–Ω—Ç, –≤–ª–∞–¥–µ–ª—å—Ü—ã –±–∏–∑–Ω–µ—Å –∞–∫–∫–∞—É–Ω—Ç–∞ –±—É–¥—É—Ç –∏–º–µ—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∫–∏–¥–∞—Ç—å –≤ –ø—Ä–µ–¥–ª–æ–∂–∫—É —Å–≤–æ–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è, –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º, –æ–Ω–∏ –±—É–¥—É—Ç –æ–ø—É–±–ª–∏–∫–æ–≤—ã–≤–∞—Ç—å—Å—è, —Ü–µ–Ω–∞ –±–∏–∑–Ω–µ—Å –∞–∫–∫–∞—É–Ω—Ç–∞ 99 —Ä—É–±–ª–µ–π –≤ –º–µ—Å—è—Ü

–¥–ª—è –æ–±–æ–∑–Ω–∞—á–µ–Ω–∏—è –±–∏–∑–Ω–µ—Å—Å –∞–∫–∫–∞—É–Ω—Ç–æ–≤ —É –º–µ–Ω—è –µ—Å—Ç—å —Ç–∞–±–ª–∏—Ü–∞ 
create table public.users (
  id uuid not null,
  created_at timestamp with time zone not null default now(),
  first_name text null,
  last_name text null,
  birth_day text null,
  phone text null,
  email text null,
  gender text null,
  image_path text null default 'https://zzxibxrgnkkzodmbsglc.supabase.co/storage/v1/object/public/Biom/ProfileImage/Default_image.jpg'::text,
  "It_business" boolean null default false,
  constraint users_pkey primary key (id),

–∏ —Ä–∞–∑–±–µ–π –ø–æ –ø—É–Ω–∫—Ç–∞–º, —á—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å, —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞–ª–æ 
  constraint users_id_fkey foreign KEY (id) references auth.users (id) on delete CASCADE
) TABLESPACE pg_default;

ChatGPT —Å–∫–∞–∑–∞–ª:
–û–∫. –°–¥–µ–ª–∞–µ–º —Ç–∞–∫, —á—Ç–æ–±—ã –≤ –º–µ–Ω—é—à–∫–µ (drawer) –ø–æ—è–≤–∏–ª–∞—Å—å –ø–æ–∫—É–ø–∫–∞ Business –∞–∫–∫–∞—É–Ω—Ç–∞ –∑–∞ 99‚ÇΩ/–º–µ—Å, –∞ –≤–ª–∞–¥–µ–ª—å—Ü—ã users.It_business = true –º–æ–≥–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –≤ ‚Äú–ø—Ä–µ–¥–ª–æ–∂–∫—É‚Äù (pending), –∏ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∞–¥–º–∏–Ω–æ–º –æ–Ω–∏ –ø—É–±–ª–∏–∫–æ–≤–∞–ª–∏—Å—å.

–ù–∏–∂–µ ‚Äî —á—ë—Ç–∫–∏–π –ø–ª–∞–Ω –ø–æ –ø—É–Ω–∫—Ç–∞–º + —á—Ç–æ –≥–¥–µ –º–µ–Ω—è—Ç—å (–±–µ–∑ –≤–æ–¥—ã).

1) –ß—Ç–æ —É —Ç–µ–±—è —É–∂–µ –µ—Å—Ç—å
–ï—Å—Ç—å —Ç–∞–±–ª–∏—Ü–∞ public.users —Å —Ñ–ª–∞–≥–æ–º:

"It_business" boolean default false

users.id ‚Üí auth.users.id (FK, CASCADE)

–≠—Ç–æ –æ—Ç–ª–∏—á–Ω–æ: –±–∏–∑–Ω–µ—Å-—Å—Ç–∞—Ç—É—Å —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ø—Ä–æ—Ñ–∏–ª–µ.

2) –ß—Ç–æ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ –ë–î (Supabase)
2.1 –¢–∞–±–ª–∏—Ü–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π (staging/moderation)
–°–æ–∑–¥–∞–π —Ç–∞–±–ª–∏—Ü—É, –Ω–∞–ø—Ä–∏–º–µ—Ä public.event_suggestions:

–ò–¥–µ—è: –±–∏–∑–Ω–µ—Å-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞—ë—Ç –∑–∞–ø–∏—Å—å –≤ event_suggestions —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º pending.
–ê–¥–º–∏–Ω –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç ‚Üí —Å—Ç–∞—Ç—É—Å approved, –∏/–∏–ª–∏ —Å–æ–∑–¥–∞—ë—Ç—Å—è –∑–∞–ø–∏—Å—å –≤ events.

–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ö–µ–º–∞ (–º–æ–∂–µ—à—å —Ä–∞—Å—à–∏—Ä—è—Ç—å):

id uuid (pk)

created_at timestamptz default now()

user_id uuid (–∫—Ç–æ –ø—Ä–µ–¥–ª–æ–∂–∏–ª) ‚Üí FK –Ω–∞ auth.users.id

status text (pending | approved | rejected)

–ø–æ–ª—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è: title, description, date_time_event, address, organizer, price, is_online, is_free, selectCategory

admin_comment text (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–í–∞—Ä–∏–∞–Ω—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏:

–ü—Ä–æ—â–µ –≤—Å–µ–≥–æ: –ø–æ—Å–ª–µ approve –∞–¥–º–∏–Ω –∫–æ–ø–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ events –∏ —Å—Ç–∞–≤–∏—Ç approved_at.

–õ–∏–±–æ —Å–¥–µ–ª–∞—Ç—å events —Å –ø–æ–ª–µ–º is_published, –Ω–æ —É —Ç–µ–±—è —É–∂–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ ‚Äî –ª—É—á—à–µ –æ—Ç–¥–µ–ª—å–Ω–æ.

2.2 RLS –ø–æ–ª–∏—Ç–∏–∫–∏ (–≤–∞–∂–Ω–æ)
–í–∫–ª—é—á–∏ RLS –¥–ª—è event_suggestions.

–ü–æ–ª–∏—Ç–∏–∫–∏:

INSERT: —Ç–æ–ª—å–∫–æ –±–∏–∑–Ω–µ—Å-—é–∑–µ—Ä –º–æ–∂–µ—Ç –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å:

auth.uid() = user_id

–∏ exists(select 1 from public.users u where u.id = auth.uid() and u."It_business" = true)

SELECT:

–±–∏–∑–Ω–µ—Å-—é–∑–µ—Ä –≤–∏–¥–∏—Ç —Å–≤–æ–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è

–∞–¥–º–∏–Ω –≤–∏–¥–∏—Ç –≤—Å—ë (—á–µ—Ä–µ–∑ —Ä–æ–ª—å –∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω—É—é –ø–æ–ª–∏—Ç–∏–∫—É)

UPDATE:

–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ pending —Å–≤–æ–∏ –∑–∞–ø–∏—Å–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–∞–¥–º–∏–Ω –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å status (approved/rejected)

3) –û–ø–ª–∞—Ç–∞ 99 ‚ÇΩ/–º–µ—Å—è—Ü: –∫–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å–¥–µ–ª–∞—Ç—å
–¢—É—Ç –∫—Ä–∏—Ç–∏—á–Ω–æ: –Ω–µ–ª—å–∑—è –ø—Ä–æ—Å—Ç–æ –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å "It_business"=true.
–≠—Ç–æ –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å —Ç–æ–ª—å–∫–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã.

–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Ö–µ–º–∞:
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç ‚Äú–ö—É–ø–∏—Ç—å Business 99‚ÇΩ/–º–µ—Å‚Äù

–¢—ã —Å–æ–∑–¥–∞—ë—à—å –ø–æ–¥–ø–∏—Å–∫—É —É –ø–ª–∞—Ç—ë–∂–∫–∏

–ü–ª–∞—Ç—ë–∂–∫–∞ –ø—Ä–∏—Å—ã–ª–∞–µ—Ç webhook –Ω–∞ —Ç–≤–æ–π —Å–µ—Ä–≤–µ—Ä ‚Äú–æ–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–∞ / –ø–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞‚Äù

–°–µ—Ä–≤–µ—Ä —Å—Ç–∞–≤–∏—Ç public.users."It_business" = true

–ü—Ä–∏ –æ—Ç–º–µ–Ω–µ/–Ω–µ–æ–ø–ª–∞—Ç–µ –ø–æ–¥–ø–∏—Å–∫–∏ ‚Äî —Å—Ç–∞–≤–∏—Ç –æ–±—Ä–∞—Ç–Ω–æ false

–ß–µ–º –ø–ª–∞—Ç–∏—Ç—å (–†–æ—Å—Å–∏—è)
–û–±—ã—á–Ω–æ –¥–µ–ª–∞—é—Ç —á–µ—Ä–µ–∑:

–ÆKassa (–ø–æ–¥–ø–∏—Å–∫–∏ / –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∏)

CloudPayments (–ø–æ–¥–ø–∏—Å–∫–∏)

Stripe (–≤ –†–§ —á–∞—Å—Ç–æ –ø—Ä–æ–±–ª–µ–º—ã, –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å–∏—Ç—É–∞—Ü–∏–∏)

–ï—Å–ª–∏ —Ç—ã —Å–∫–∞–∂–µ—à—å –ø–ª–∞—Ç—ë–∂–∫—É ‚Äî —è —Ä–∞—Å–ø–∏—à—É –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –ø–æ–¥ –Ω–µ—ë.
–ù–æ –æ–±—â–∞—è —Å—Ö–µ–º–∞ –æ–¥–∏–Ω–∞–∫–æ–≤–∞—è.

4) –ß—Ç–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ ‚Äú–º–µ–Ω—é—à–∫—É‚Äù (drawer)
–í drawer –¥–æ–±–∞–≤–ª—è–µ–º –±–ª–æ–∫ Business:

–µ—Å–ª–∏ It_business = false:

–∫–Ω–æ–ø–∫–∞ ‚Äú–ö—É–ø–∏—Ç—å Business ‚Äî 99‚ÇΩ/–º–µ—Å‚Äù

—Ç–µ–∫—Å—Ç ‚Äú—Å Business –º–æ–∂–µ—à—å –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –Ω–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏—é‚Äù

–µ—Å–ª–∏ It_business = true:

–±–µ–π–¥–∂ ‚ÄúBusiness –∞–∫—Ç–∏–≤–µ–Ω‚Äù

–∫–Ω–æ–ø–∫–∞ ‚Äú–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ‚Äù

(–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) ‚Äú–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–æ–π‚Äù

5) –ß—Ç–æ –Ω—É–∂–Ω–æ –≤ –∫–æ–¥–µ —Ñ—Ä–æ–Ω—Ç–∞ (–ø–æ –ø—É–Ω–∫—Ç–∞–º)
5.1 –ü–æ–ª—É—á–∞—Ç—å It_business –∏–∑ public.users
–°–µ–π—á–∞—Å —Ç—ã –ø–æ–∫–∞–∑—ã–≤–∞–µ—à—å –ø—Ä–æ—Ñ–∏–ª—å/–∞–≤–∞—Ç–∞—Ä ‚Äî –∑–Ω–∞—á–∏—Ç –≥–¥–µ-—Ç–æ —É–∂–µ —Ç—è–Ω–µ—à—å public.users.
–ù—É–∂–Ω–æ —á—Ç–æ–±—ã –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±—ã–ª–æ –ø–æ–ª–µ:

userProfile.It_business

–ò drawer –º–æ–≥ –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π UI.

5.2 –ö–Ω–æ–ø–∫–∞ ‚Äú–ö—É–ø–∏—Ç—å Business‚Äù
–û–Ω–∞ –¥–æ–ª–∂–Ω–∞:

–≤—ã–∑–≤–∞—Ç—å POST /api/billing/create-subscription (—Ç–≤–æ–π —Å–µ—Ä–≤–µ—Ä)

–ø–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫—É –æ–ø–ª–∞—Ç—ã / —Ñ–æ—Ä–º—É

—Ä–µ–¥–∏—Ä–µ–∫—Ç–Ω—É—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –æ–ø–ª–∞—Ç—É

5.3 ‚Äú–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ‚Äù
–î–ª—è business:

–æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª–∫—É (–º–æ–∂–Ω–æ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–≤–æ–π EventModal.vue, –Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ event_suggestions)

—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∑–∞–ø–∏—Å—å –≤ event_suggestions —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º pending

6) –ß—Ç–æ –Ω—É–∂–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
6.1 Endpoint —Å–æ–∑–¥–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É
POST /api/billing/create-subscription

–ø—Ä–æ–≤–µ—Ä—è–µ—Ç auth.uid()

—Å–æ–∑–¥–∞—ë—Ç –ø–æ–¥–ø–∏—Å–∫—É —É –ø–ª–∞—Ç—ë–∂–∫–∏

–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç payment_url

6.2 Webhook –æ—Ç –ø–ª–∞—Ç—ë–∂–∫–∏
POST /api/billing/webhook

–ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ø–∏—Å—å webhook (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)

–µ—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ ‚Üí It_business = true

–µ—Å–ª–∏ –æ—Ç–º–µ–Ω–µ–Ω–∞/–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–∞ ‚Üí It_business = false

–î–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è public.users —Å–µ—Ä–≤–µ—Ä –¥–æ–ª–∂–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å service role key (–∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω—ã–π backend –∫–ª—é—á), —á—Ç–æ–±—ã –∏–º–µ—Ç—å –ø—Ä–∞–≤–æ –º–µ–Ω—è—Ç—å.

7) –ê–¥–º–∏–Ω–∫–∞: –º–æ–¥–µ—Ä–∞—Ü–∏—è –ø—Ä–µ–¥–ª–æ–∂–∫–∏
–í –∞–¥–º–∏–Ω–∫–µ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ä–∞–∑–¥–µ–ª ‚Äú–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è‚Äù:

—Å–ø–∏—Å–æ–∫ event_suggestions where status = 'pending'

–∫–Ω–æ–ø–∫–∏:

‚úÖ Approve ‚Üí —Å–æ–∑–¥–∞—Ç—å events + (–µ—Å–ª–∏ —Ñ–æ—Ç–æ ‚Äî –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏/–ø—Ä–∏–≤—è–∑–∞—Ç—å), status='approved'

‚ùå Reject ‚Üí status='rejected', admin_comment

8) –°–≤–æ–¥–∫–∞ ‚Äú—á—Ç–æ —Å–¥–µ–ª–∞—Ç—å, —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞–ª–æ‚Äù (–∫–æ—Ä–æ—Ç–∫–æ)
‚úÖ –ë–î: –¥–æ–±–∞–≤–∏—Ç—å event_suggestions

‚úÖ –ë–î: –≤–∫–ª—é—á–∏—Ç—å RLS + –ø–æ–ª–∏—Ç–∏–∫–∏ (—Ç–æ–ª—å–∫–æ –±–∏–∑–Ω–µ—Å –º–æ–∂–µ—Ç insert)

‚úÖ –°–µ—Ä–≤–µ—Ä: –æ–ø–ª–∞—Ç—É –¥–µ–ª–∞—Ç—å —á–µ—Ä–µ–∑ –ø–æ–¥–ø–∏—Å–∫—É 99‚ÇΩ/–º–µ—Å (create-subscription)

‚úÖ –°–µ—Ä–≤–µ—Ä: webhook –æ–ø–ª–∞—Ç—ã ‚Üí –æ–±–Ω–æ–≤–ª—è–µ—Ç users.It_business

‚úÖ –§—Ä–æ–Ω—Ç: drawer –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –±–ª–æ–∫ Business (–∫—É–ø–∏—Ç—å/–∞–∫—Ç–∏–≤–µ–Ω)

‚úÖ –§—Ä–æ–Ω—Ç: business –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –≤ event_suggestions

‚úÖ –ê–¥–º–∏–Ω–∫–∞: –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å/–æ—Ç–∫–ª–æ–Ω–∏—Ç—å –∏ –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –≤ events

–í–∞–∂–Ω—ã–π –º–æ–º–µ–Ω—Ç –ø–æ —Ç–≤–æ–µ–π —Ç–∞–±–ª–∏—Ü–µ public.users
FK –Ω–∞ auth.users(id) ‚Äî –ø—Ä–∞–≤–∏–ª—å–Ω–æ.
–ù–æ —á—Ç–æ–±—ã –≤—Å—ë —Ä–∞–±–æ—Ç–∞–ª–æ –≥–ª–∞–¥–∫–æ, —É–±–µ–¥–∏—Å—å, —á—Ç–æ —É —Ç–µ–±—è –µ—Å—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–∑–¥–∞—ë—Ç —Å—Ç—Ä–æ–∫—É –≤ public.users –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Supabase Auth (–µ—Å–ª–∏ —Å–µ–π—á–∞—Å —Ç–∞–∫–æ–≥–æ –Ω–µ—Ç ‚Äî –ø—Ä–æ—Ñ–∏–ª—å –º–æ–∂–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å).

–ï—Å–ª–∏ —Å–∫–∞–∂–µ—à—å –∫–∞–∫—É—é –ø–ª–∞—Ç—ë–∂–∫—É –≤—ã–±–∏—Ä–∞–µ–º (–ÆKassa / CloudPayments / –¥—Ä—É–≥–æ–µ), —è —Ä–∞—Å–ø–∏—à—É —Ç–æ—á–Ω—ã–π —ç–Ω–¥-—Ç—É-—ç–Ω–¥ –ø–ª–∞–Ω —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞–º–∏, –ø–æ–ª—è–º–∏ webhook –∏ SQL-–ø–æ–ª–∏—Ç–∏–∫–∞–º–∏ RLS –ø–æ–¥ —Ç–≤–æ—é —Å—Ö–µ–º—É.


–í—ã —Å–∫–∞–∑–∞–ª–∏:
–¥–∞–≤–∞–π —Ç–∞–∫, –¥–æ–±–∞–≤–ª—è–µ–º –≤ events is_published –∏ –º–µ–Ω—è–µ–º –≤–µ—Å—å –∫–æ–¥, –æ–ø–ª–∞—Ç—É —Å–¥–µ–ª–∞–µ–º —á—É—Ç—å –ø–æ–ø–æ–∑–∂–µ, —Å–µ–π—á–∞—Å –ø—Ä–æ—Å—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —Ç–∞–∫, —á—Ç–æ–±—ã —É –ª—é–¥–µ–π —Å –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–º It_buisnes –ø–æ—è–≤–∏–ª–∞—Å—å –∫–Ω–æ–ø–∫–∞ "–¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ" –ü–æ–∫–∞ —á—Ç–æ –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –±–∏–∑–Ω–µ—Å–∞ –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö, –∏ –º–æ–≥—É —ç—Ç–æ —Å–¥–µ–ª–∞—Ç—å —Ç–æ–ª—å–∫–æ —è, –ø–æ–∑–∂–µ –±—É–¥–µ–º —ç—Ç–∏–º –∑–∞–Ω–∏–º–∞—Ç—å—Å—è, —Å–µ–π—á–∞—Å –∑–∞–Ω–∏–º–∞–µ–º—Å—è —Ç–µ–º, —á—Ç–æ —è –ø–µ—Ä–µ—á–∏—Å–ª–∏–ª, –≤—ã–ø–∏—à–∏ –≤–µ—Å—å –∫–æ–¥, —á—Ç–æ–±—ã –≤—Å—ë —Ä–∞–±–æ—Ç–∞–ª–æ

ChatGPT —Å–∫–∞–∑–∞–ª:

–î—É–º–∞–ª –Ω–∞ –ø—Ä–æ—Ç—è–∂–µ–Ω–∏–∏ 47s
–û–∫, –¥–µ–ª–∞–µ–º —Ç–∞–∫:

‚úÖ –í events –¥–æ–±–∞–≤–ª—è–µ–º is_published boolean

‚úÖ –ù–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–º —Å–∞–π—Ç–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–µ (is_published = true)

‚úÖ –í –º–µ–Ω—é—à–∫–µ (drawer) —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å public.users."It_business" = true –ø–æ—è–≤–ª—è–µ—Ç—Å—è –∫–Ω–æ–ø–∫–∞ ‚Äú–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ‚Äù

‚úÖ –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –±–∏–∑–Ω–µ—Å–æ–º –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è —Å is_published = false ‚Üí –æ–Ω–æ –Ω–µ –≤–∏–¥–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º, –ø–æ–∫–∞ —Ç—ã –≤—Ä—É—á–Ω—É—é –Ω–µ –ø–æ—Å—Ç–∞–≤–∏—à—å true –≤ –ë–î

‚úÖ –û–ø–ª–∞—Ç—É –ø–æ–∫–∞ –Ω–µ —Ç—Ä–æ–≥–∞–µ–º (–∫–∞–∫ —Ç—ã –ø—Ä–æ—Å–∏–ª)

–ù–∏–∂–µ: —á—Ç–æ —Å–¥–µ–ª–∞—Ç—å –ø–æ –ø—É–Ω–∫—Ç–∞–º + –≤–µ—Å—å –∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å/–∑–∞–º–µ–Ω–∏—Ç—å.

1) –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –≤ Supabase (–ø–æ –ø—É–Ω–∫—Ç–∞–º)
1.1 –î–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É is_published –≤ events
–í—ã–ø–æ–ª–Ω–∏ SQL –≤ Supabase ‚Üí SQL Editor:

alter table public.events
add column if not exists is_published boolean not null default true;

-- –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –ø—Ä–æ—Å—Ç–∞–≤–∏–º true –≤—Å–µ–º —Å—Ç–∞—Ä—ã–º
update public.events
set is_published = true
where is_published is null;
1.2 (–í–∞–∂–Ω–æ) RLS –ø—Ä–∞–≤–∞ –Ω–∞ –≤—Å—Ç–∞–≤–∫—É
–ï—Å–ª–∏ —É —Ç–µ–±—è –≤–∫–ª—é—á—ë–Ω RLS –Ω–∞ events, —Ç–æ –±–∏–∑–Ω–µ—Å-—é–∑–µ—Ä—É –Ω—É–∂–Ω–æ —Ä–∞–∑—Ä–µ—à–∏—Ç—å insert (–Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–µ–±—è).
–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –ø–æ–ª–∏—Ç–∏–∫–∞ (–ø—Ä–∏–º–µ—Ä):

-- –≤–∫–ª—é—á–∏ RLS –µ—Å–ª–∏ –µ—â—ë –Ω–µ –≤–∫–ª—é—á–µ–Ω–æ
alter table public.events enable row level security;

-- –±–∏–∑–Ω–µ—Å –º–æ–∂–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å —Å–æ–±—ã—Ç–∏—è –æ—Ç —Å–≤–æ–µ–≥–æ user_id
create policy "business_can_insert_events"
on public.events
for insert
to authenticated
with check (
  auth.uid() = user_id
  and exists (
    select 1
    from public.users u
    where u.id = auth.uid()
      and u."It_business" = true
  )
);

-- –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç —Ç–æ–ª—å–∫–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–µ
create policy "public_can_select_published"
on public.events
for select
to anon, authenticated
using (is_published = true);
–ï—Å–ª–∏ RLS —É —Ç–µ–±—è –Ω–µ –≤–∫–ª—é—á—ë–Ω, —ç—Ç–æ—Ç —à–∞–≥ –º–æ–∂–Ω–æ –≤—Ä–µ–º–µ–Ω–Ω–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å (–Ω–æ –ª—É—á—à–µ –≤–∫–ª—é—á–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ).

2) –ö–æ–¥: —á—Ç–æ –º–µ–Ω—è–µ–º/–¥–æ–±–∞–≤–ª—è–µ–º
–ù—É–∂–Ω–æ 3 —Ñ–∞–π–ª–∞:

‚úÖ –ù–æ–≤—ã–π src/components/CreateEventModal.vue

‚úÖ –ó–∞–º–µ–Ω–∏—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é src/views/HomeView.vue (–∏–ª–∏ –ø—É—Ç—å –∫–∞–∫ —É —Ç–µ–±—è —Å–µ–π—á–∞—Å)

‚úÖ –ó–∞–º–µ–Ω–∏—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é src/composables/useSupabase.js (–¥–æ–±–∞–≤–∏–º is_published + createBusinessEvent)

2.1 src/components/CreateEventModal.vue (–ù–û–í–´–ô —Ñ–∞–π–ª –ø–æ–ª–Ω–æ—Å—Ç—å—é)
<template>
  <teleport to="body">
    <div v-if="open" class="root" @keydown.esc="close" tabindex="-1">
      <div class="overlay" @click="close"></div>

      <div class="modal" role="dialog" aria-modal="true" aria-label="–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ">
        <div class="head">
          <div class="title">–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</div>
          <button class="x" @click="close" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
        </div>

        <div class="body">
          <div class="hint">
            –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ —É–π–¥—ë—Ç –≤ –ø—Ä–µ–¥–ª–æ–∂–∫—É –∏ –±—É–¥–µ—Ç –≤–∏–¥–Ω–æ –≤—Å–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –∞–¥–º–∏–Ω –ø–æ—Å—Ç–∞–≤–∏—Ç <b>is_published=true</b>.
          </div>

          <div class="grid">
            <div class="field">
              <div class="label">–ù–∞–∑–≤–∞–Ω–∏–µ *</div>
              <input class="input" v-model="form.title" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –í–µ—á–µ—Ä –Ω–∞—Å—Ç–æ–ª–æ–∫" />
            </div>

            <div class="field">
              <div class="label">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è *</div>
              <input class="input" type="datetime-local" v-model="form.date_time_event" />
            </div>

            <div class="field">
              <div class="label">–ê–¥—Ä–µ—Å</div>
              <input class="input" v-model="form.address" placeholder="–ì–æ—Ä–æ–¥, —É–ª–∏—Ü–∞, –¥–æ–º / –∏–ª–∏ —Å—Å—ã–ª–∫–∞ –¥–ª—è –æ–Ω–ª–∞–π–Ω" />
            </div>

            <div class="field">
              <div class="label">–û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä</div>
              <input class="input" v-model="form.organizer" placeholder="–ò–º—è/–ø—Ä–æ–µ–∫—Ç" />
            </div>

            <div class="field">
              <div class="label">–¶–µ–Ω–∞ (‚ÇΩ)</div>
              <input class="input" type="number" min="0" inputmode="numeric" v-model="form.price" placeholder="0" />
              <div class="mini">
                <span class="badge" v-if="isFree">üÜì –ë–µ—Å–ø–ª–∞—Ç–Ω–æ</span>
              </div>
            </div>

            <div class="field inline">
              <label class="check">
                <input type="checkbox" v-model="form.is_online" />
                <span class="ui"></span>
                <span class="text">–û–Ω–ª–∞–π–Ω (is_online)</span>
              </label>
            </div>
          </div>

          <div class="field">
            <div class="label">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</div>
            <div class="tags">
              <button
                v-for="c in categories"
                :key="c.id"
                class="tag"
                :class="{ active: selectedCategories.includes(c.name) }"
                @click="toggleCategory(c.name)"
                type="button"
              >
                {{ c.name }}
              </button>
            </div>
            <div class="mini">–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ.</div>
          </div>

          <div class="field">
            <div class="label">–û–ø–∏—Å–∞–Ω–∏–µ *</div>
            <textarea class="textarea" v-model="form.description" placeholder="–û–ø–∏—à–∏, —á—Ç–æ –±—É–¥–µ—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å"></textarea>
          </div>

          <div class="field">
            <div class="label">–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</div>
            <input class="input" v-model="form.photo_url" placeholder="https://..." />
            <div class="mini">–ï—Å–ª–∏ —É–∫–∞–∂–µ—à—å ‚Äî –º—ã –¥–æ–±–∞–≤–∏–º –≤ event_photos –∫–∞–∫ –ø–µ—Ä–≤–æ–µ —Ñ–æ—Ç–æ.</div>
          </div>

          <div v-if="error" class="error">{{ error }}</div>
        </div>

        <div class="foot">
          <button class="btn secondary" @click="close">–û—Ç–º–µ–Ω–∞</button>
          <button class="btn primary" :disabled="saving" @click="submit">
            {{ saving ? '–û—Ç–ø—Ä–∞–≤–ª—è—é‚Ä¶' : '–û—Ç–ø—Ä–∞–≤–∏—Ç—å' }}
          </button>
        </div>
      </div>
    </div>
  </teleport>
</template>

<script>
const trimOrNull = (v) => {
  const s = String(v ?? '').trim()
  return s ? s : null
}

export default {
  name: 'CreateEventModal',
  emits: ['close', 'created'],
  props: {
    open: { type: Boolean, default: false },
    categories: { type: Array, default: () => [] },
    createBusinessEvent: { type: Function, required: true } // (payload) => Promise<{data,error}>
  },
  data() {
    return {
      saving: false,
      error: '',
      selectedCategories: [],
      form: {
        title: '',
        description: '',
        date_time_event: '',
        address: '',
        organizer: '',
        price: '0',
        is_online: false,
        photo_url: ''
      }
    }
  },
  computed: {
    isFree() {
      const n = Number(this.form.price)
      return Number.isFinite(n) && n <= 0
    }
  },
  watch: {
    open(v) {
      if (v) this.error = ''
    }
  },
  methods: {
    close() {
      if (this.saving) return
      this.$emit('close')
    },
    toggleCategory(name) {
      const n = String(name || '').trim()
      if (!n) return
      const idx = this.selectedCategories.indexOf(n)
      if (idx >= 0) this.selectedCategories.splice(idx, 1)
      else this.selectedCategories.push(n)
    },
    async submit() {
      this.error = ''

      const title = trimOrNull(this.form.title)
      const description = trimOrNull(this.form.description)
      const dt = trimOrNull(this.form.date_time_event)

      if (!title) return (this.error = '–£–∫–∞–∂–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ.')
      if (!dt) return (this.error = '–£–∫–∞–∂–∏ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è.')
      if (!description) return (this.error = '–£–∫–∞–∂–∏ –æ–ø–∏—Å–∞–Ω–∏–µ.')

      const priceNum = Number(this.form.price)
      const price = Number.isFinite(priceNum) ? priceNum : 0
      const is_free = price <= 0

      const payload = {
        title,
        description,
        date_time_event: dt, // datetime-local –æ—Ç–¥–∞—ë—Ç ISO-–ø–æ–¥–æ–±–Ω—É—é —Å—Ç—Ä–æ–∫—É
        address: trimOrNull(this.form.address),
        organizer: trimOrNull(this.form.organizer),
        price,
        is_online: !!this.form.is_online,
        is_free,
        selectCategory: [...this.selectedCategories], // —Ö—Ä–∞–Ω–∏–º –∏–º–µ–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∫–∞–∫ –∏ —Ä–∞–Ω—å—à–µ
        photo_url: trimOrNull(this.form.photo_url)
      }

      this.saving = true
      try {
        const { data, error } = await this.createBusinessEvent(payload)
        if (error) {
          this.error = String(error.message || error)
          return
        }
        this.$emit('created', data)
        this.$emit('close')
        // reset
        this.selectedCategories = []
        this.form = {
          title: '',
          description: '',
          date_time_event: '',
          address: '',
          organizer: '',
          price: '0',
          is_online: false,
          photo_url: ''
        }
      } finally {
        this.saving = false
      }
    }
  }
}
</script>

<style scoped>
.root { position: fixed; inset: 0; z-index: 10000; }
.overlay { position: absolute; inset: 0; background: rgba(0,0,0,.38); backdrop-filter: blur(2px); }

.modal {
  position: absolute;
  left: 50%;
  top: 50%;
  width: min(760px, 94vw);
  max-height: 90vh;
  transform: translate(-50%, -50%);
  background: #fff;
  border: 1px solid #efefef;
  border-radius: 18px;
  box-shadow: 0 18px 60px rgba(0,0,0,.18);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.head {
  padding: 14px 14px;
  border-bottom: 1px solid #f2f2f2;
  display: flex;
  align-items: center;
  gap: 12px;
}
.title { font-weight: 900; font-size: 16px; }
.x {
  margin-left: auto;
  border: 1px solid #efefef;
  background: #fafafa;
  border-radius: 12px;
  padding: 8px 10px;
  cursor: pointer;
}

.body {
  padding: 14px;
  overflow: auto;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.hint {
  background: #fcfcff;
  border: 1px solid rgba(138,117,227,.18);
  border-radius: 14px;
  padding: 10px 12px;
  font-size: 13px;
  opacity: .9;
}

.grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}
@media (max-width: 720px) {
  .grid { grid-template-columns: 1fr; }
}

.field { display: flex; flex-direction: column; gap: 6px; }
.field.inline { justify-content: flex-end; }

.label { font-size: 12px; font-weight: 800; opacity: .7; }

.input, .textarea {
  border: 1px solid #efefef;
  border-radius: 12px;
  padding: 10px 10px;
  font-size: 14px;
  background: #fff;
  outline: none;
}
.input:focus, .textarea:focus {
  border-color: rgba(138,117,227,.55);
  box-shadow: 0 0 0 3px rgba(138,117,227,.12);
}
.textarea { min-height: 120px; resize: vertical; }

.mini { font-size: 12px; opacity: .7; }
.badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 10px;
  border-radius: 999px;
  background: rgba(138,117,227,.12);
  border: 1px solid rgba(138,117,227,.22);
  width: fit-content;
}

/* tags */
.tags { display: flex; flex-wrap: wrap; gap: 8px; }
.tag {
  border: 1px solid #efefef;
  background: #fff;
  border-radius: 999px;
  padding: 7px 10px;
  cursor: pointer;
  font-size: 13px;
}
.tag.active {
  background: #8a75e3;
  border-color: #8a75e3;
  color: #fff;
}

/* toggle */
.check { display: inline-flex; align-items: center; gap: 10px; cursor: pointer; user-select: none; }
.check input { display: none; }
.ui {
  width: 44px; height: 26px; border-radius: 999px;
  border: 1px solid #e9e9e9; background: #f3f3f3;
  position: relative; transition: background 180ms ease, border-color 180ms ease;
}
.ui::after {
  content: '';
  width: 22px; height: 22px; border-radius: 999px;
  background: #fff; position: absolute; top: 1px; left: 1px;
  box-shadow: 0 2px 10px rgba(0,0,0,.08);
  transition: transform 180ms ease;
}
.check input:checked + .ui {
  background: rgba(138,117,227,.85);
  border-color: rgba(138,117,227,.55);
}
.check input:checked + .ui::after { transform: translateX(18px); }
.text { font-weight: 800; font-size: 13px; }

.error {
  color: #d9534f;
  font-weight: 800;
  font-size: 13px;
}

.foot {
  padding: 14px;
  border-top: 1px solid #f2f2f2;
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}

.btn {
  border-radius: 14px;
  padding: 12px 16px;
  font-weight: 900;
  cursor: pointer;
  border: none;
}
.btn.secondary { background: #efefef; }
.btn.primary { background: #8a75e3; color: #fff; }
.btn:disabled { opacity: .6; cursor: not-allowed; }
</style>
2.2 src/composables/useSupabase.js (–ó–ê–ú–ï–ù–ò–¢–¨ –ü–û–õ–ù–û–°–¢–¨–Æ)
–î–æ–±–∞–≤–∏–ª:

is_published –≤ select

getEvents() —Ç–µ–ø–µ—Ä—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–µ

createBusinessEvent(payload) ‚Äî –≤—Å—Ç–∞–≤–∫–∞ –≤ events —Å is_published=false + —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ event_photos (–µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–ª–∏ photo_url)

import { createClient } from '@supabase/supabase-js'

const supabaseUrl = import.meta.env.VITE_SUPABASE_URL
const supabaseKey = import.meta.env.VITE_SUPABASE_ANON_KEY

export const supabase = createClient(supabaseUrl, supabaseKey)

const normalizeStoragePublicUrl = (url) => {
  if (!url || typeof url !== 'string') return ''
  const u = url.trim()
  if (!u) return ''
  if (u.includes('/storage/v1/object/public/')) return u
  if (u.includes('/storage/v1/object/')) return u.replace('/storage/v1/object/', '/storage/v1/object/public/')
  return u
}

const compact = (obj) => {
  const out = {}
  for (const [k, v] of Object.entries(obj || {})) {
    if (v !== undefined) out[k] = v
  }
  return out
}

export const useSupabase = () => {
  // ---------------------------
  // EVENTS (user site: only published)
  // ---------------------------
  const getEvents = async () => {
    const { data, error } = await supabase
      .from('events')
      .select(
        `
        id,
        title,
        description,
        date_time_event,
        address,
        organizer,
        price,
        is_online,
        is_free,
        user_id,
        selectCategory,
        is_published,
        created_at
      `
      )
      .eq('is_published', true)
      .order('created_at', { ascending: false })

    return { data, error }
  }

  const searchEvents = async (searchTerm) => {
    const term = (searchTerm || '').trim()
    if (!term) return getEvents()

    const { data, error } = await supabase
      .from('events')
      .select(
        `
        id,
        title,
        description,
        date_time_event,
        address,
        organizer,
        price,
        is_online,
        is_free,
        user_id,
        selectCategory,
        is_published,
        created_at
      `
      )
      .eq('is_published', true)
      .ilike('title', `%${term}%`)
      .order('created_at', { ascending: false })

    return { data, error }
  }

  const getCategories = async () => {
    const { data, error } = await supabase.from('category').select('id, name').order('name', { ascending: true })
    return { data, error }
  }

  const getEventPhotos = async (eventIds) => {
    if (!Array.isArray(eventIds) || eventIds.length === 0) return { data: [], error: null }

    const { data, error } = await supabase
      .from('event_photos')
      .select('id, event_id, photo_url')
      .in('event_id', eventIds)
      .order('id', { ascending: true })

    return { data: data ?? [], error }
  }

  // ‚úÖ Business: create draft event (not published)
  const createBusinessEvent = async (payload) => {
    const { user, error: userErr } = await getUser()
    if (userErr) return { data: null, error: userErr }
    if (!user) return { data: null, error: new Error('–ù–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏') }

    const price = Number(payload?.price ?? 0)
    const is_free = payload?.is_free === true || (!Number.isNaN(price) && price <= 0)

    const eventInsert = {
      title: payload?.title ?? null,
      description: payload?.description ?? null,
      date_time_event: payload?.date_time_event ?? null,
      address: payload?.address ?? null,
      organizer: payload?.organizer ?? null,
      price: Number.isFinite(price) ? price : 0,
      is_online: !!payload?.is_online,
      is_free,
      user_id: user.id,
      selectCategory: Array.isArray(payload?.selectCategory) ? payload.selectCategory : [],
      is_published: false
    }

    const { data: eventRow, error: insErr } = await supabase.from('events').insert(eventInsert).select().single()
    if (insErr) return { data: null, error: insErr }

    const photoUrl = String(payload?.photo_url ?? '').trim()
    if (photoUrl) {
      const { error: phErr } = await supabase.from('event_photos').insert({
        event_id: eventRow.id,
        photo_url: photoUrl
      })
      if (phErr) {
        // –Ω–µ —Ñ–µ–π–ª–∏–º —Å–æ–∑–¥–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –∏–∑-–∑–∞ —Ñ–æ—Ç–æ ‚Äî –ø—Ä–æ—Å—Ç–æ –≤–µ—Ä–Ω—ë–º –æ—à–∏–±–∫—É –æ—Ç–¥–µ–ª—å–Ω–æ
        return { data: eventRow, error: phErr }
      }
    }

    return { data: eventRow, error: null }
  }

  // ---------------------------
  // AUTH
  // ---------------------------
  const getSession = async () => {
    const { data, error } = await supabase.auth.getSession()
    return { session: data?.session ?? null, error }
  }

  const getUser = async () => {
    const { data, error } = await supabase.auth.getUser()
    return { user: data?.user ?? null, error }
  }

  const signOut = async () => {
    const { error } = await supabase.auth.signOut()
    return { error }
  }

  const signInWithGoogle = async ({ redirectTo }) => {
    const { data, error } = await supabase.auth.signInWithOAuth({
      provider: 'google',
      options: { redirectTo }
    })
    return { data, error }
  }

  // ---------------------------
  // PROFILE (public.users)
  // ---------------------------
  const ensurePublicUserRow = async (authUser) => {
    if (!authUser?.id) return { data: null, error: null }

    const meta = authUser.user_metadata || {}

    const { data: existing, error: exErr } = await supabase
      .from('users')
      .select('id, email, first_name, last_name')
      .eq('id', authUser.id)
      .maybeSingle()

    if (exErr) return { data: null, error: exErr }

    const firstFromMeta = meta.given_name ?? meta.first_name
    const lastFromMeta = meta.family_name ?? meta.last_name

    const payload = compact({
      id: authUser.id,
      email: existing?.email ?? authUser.email ?? null,
      first_name: existing?.first_name ? undefined : firstFromMeta ?? undefined,
      last_name: existing?.last_name ? undefined : lastFromMeta ?? undefined
    })

    const { data, error } = await supabase.from('users').upsert(payload, { onConflict: 'id' }).select().single()
    return { data, error }
  }

  const getMyPublicUser = async () => {
    const { user } = await getUser()
    if (!user) return { data: null, error: null }

    const { data, error } = await supabase.from('users').select('*').eq('id', user.id).single()
    if (data?.image_path) data.image_path = normalizeStoragePublicUrl(data.image_path)
    return { data, error }
  }

  const updateMyPublicUser = async (patch) => {
    const { user } = await getUser()
    if (!user) return { data: null, error: new Error('No auth user') }

    const safePatch = { ...patch }
    delete safePatch.It_business // –Ω–µ–ª—å–∑—è –º–µ–Ω—è—Ç—å —Å —Ñ—Ä–æ–Ω—Ç–∞

    for (const k of Object.keys(safePatch)) {
      if (safePatch[k] === '') safePatch[k] = null
    }
    if (safePatch.image_path) safePatch.image_path = normalizeStoragePublicUrl(safePatch.image_path)

    const { data, error } = await supabase.from('users').update(safePatch).eq('id', user.id).select().single()
    if (data?.image_path) data.image_path = normalizeStoragePublicUrl(data.image_path)
    return { data, error }
  }

  // ---------------------------
  // AVATAR UPLOAD
  // ---------------------------
  const uploadAvatar = async (file) => {
    const { user } = await getUser()
    if (!user) return { publicUrl: null, error: new Error('No auth user') }
    if (!file) return { publicUrl: null, error: new Error('No file') }

    const envBucket = (import.meta.env.VITE_SUPABASE_AVATAR_BUCKET || '').trim()
    const buckets = [...new Set([envBucket, 'avatars', 'Biom', 'biom'].filter(Boolean))]

    const ext = (file.name.split('.').pop() || 'png').toLowerCase()
    const path = `ProfileImage/${user.id}/${Date.now()}.${ext}`

    let lastErr = null

    for (const bucket of buckets) {
      const { error: upErr } = await supabase.storage.from(bucket).upload(path, file, { upsert: true })
      if (upErr) {
        lastErr = upErr
        if (String(upErr?.message || '').toLowerCase().includes('bucket not found')) continue
        return { publicUrl: null, error: upErr }
      }

      const { data } = supabase.storage.from(bucket).getPublicUrl(path)
      const publicUrl = normalizeStoragePublicUrl(data?.publicUrl || '')
      return { publicUrl, error: null }
    }

    return {
      publicUrl: null,
      error:
        lastErr ||
        new Error('Bucket not found. –°–æ–∑–¥–∞–π bucket –≤ Storage (–Ω–∞–ø—Ä–∏–º–µ—Ä "avatars") –∏ —É–∫–∞–∂–∏ VITE_SUPABASE_AVATAR_BUCKET.')
    }
  }

  // ---------------------------
  // TELEGRAM (–Ω–µ —Ç—Ä–æ–≥–∞–µ–º)
  // ---------------------------
  const linkTelegramViaEdgeFunction = async (telegramAuthData) => {
    const { data, error } = await supabase.functions.invoke('telegram-verify', { body: telegramAuthData })
    return { data, error }
  }

  const getMyTelegramLink = async () => {
    const { user } = await getUser()
    if (!user) return { data: null, error: null }

    const { data, error } = await supabase.from('user_telegram').select('*').eq('user_id', user.id).maybeSingle()
    return { data: data ?? null, error }
  }

  return {
    // events
    getEvents,
    searchEvents,
    getCategories,
    getEventPhotos,
    createBusinessEvent,

    // auth
    getSession,
    getUser,
    signInWithGoogle,
    signOut,

    // profile
    ensurePublicUserRow,
    getMyPublicUser,
    updateMyPublicUser,
    uploadAvatar,

    // telegram
    linkTelegramViaEdgeFunction,
    getMyTelegramLink
  }
}
2.3 src/views/HomeView.vue (–ó–ê–ú–ï–ù–ò–¢–¨ –ü–û–õ–ù–û–°–¢–¨–Æ)
–¢—É—Ç:

—Ñ–∏–ª—å—Ç—Ä—ã –≤ drawer –∫–∞–∫ —Ä–∞–Ω—å—à–µ

–¥–æ–±–∞–≤–ª–µ–Ω –±–ª–æ–∫ Business –≤ drawer

–µ—Å–ª–∏ It_business=true ‚Üí –∫–Ω–æ–ø–∫–∞ ‚Äú–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ‚Äù

–æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è CreateEventModal.vue –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —á–µ—Ä–Ω–æ–≤–∏–∫ (is_published=false)

<template>
  <div class="page">
    <div class="container">
      <!-- TOP BAR -->
      <div class="topbar">
        <div class="topbar-left">
          <div class="page-title">–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</div>
          <div class="page-sub">
            <span v-if="initialLoaded">{{ filteredEvents.length }}</span>
            <span v-else>‚Ä¶</span>
          </div>
        </div>

        <button class="filter-btn" @click="openDrawer" aria-label="–û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é">
          <!-- funnel icon -->
          <svg viewBox="0 0 24 24" class="filter-icon" aria-hidden="true">
            <path d="M3 5h18l-7 8v5l-4 2v-7L3 5z" fill="currentColor" />
          </svg>
          <span class="filter-btn-text">–§–∏–ª—å—Ç—Ä—ã</span>
        </button>
      </div>

      <!-- STATES -->
      <div v-if="!initialLoaded" class="state">
        <div class="spinner"></div>
        <div>–ó–∞–≥—Ä—É–∑–∫–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π‚Ä¶</div>
      </div>

      <div v-else-if="error" class="state error">
        <div class="error-title">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</div>
        <div class="error-sub">{{ error }}</div>
        <button class="retry" @click="reload">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
      </div>

      <div v-else-if="filteredEvents.length === 0" class="state">
        –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
      </div>

      <!-- EVENTS LIST -->
      <div v-else class="events-shell">
        <TransitionGroup name="list" tag="div" class="events-list">
          <EventCard
            v-for="event in filteredEvents"
            :key="event.id"
            :event="event"
            :photos="photos[event.id] || []"
            :photos-loading="photosLoading"
            :category-map="categoryMap"
            @open-photo="openPhoto"
          />
        </TransitionGroup>
      </div>
    </div>

    <!-- DRAWER (Filters + Business) -->
    <teleport to="body">
      <div v-if="drawerOpen" class="drawer-root" @keydown.esc="closeDrawer" tabindex="-1">
        <div class="overlay" @click="closeDrawer"></div>

        <aside class="drawer" role="dialog" aria-modal="true" aria-label="–ú–µ–Ω—é">
          <div class="drawer-head">
            <div class="drawer-title">–ú–µ–Ω—é</div>
            <button class="close-btn" @click="closeDrawer" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
          </div>

          <div class="drawer-body">
            <!-- Business block -->
            <div class="biz-card">
              <div class="biz-top">
                <div class="biz-title">Business –∞–∫–∫–∞—É–Ω—Ç</div>
                <span v-if="isBusiness" class="biz-badge">–ê–∫—Ç–∏–≤–µ–Ω</span>
                <span v-else class="biz-badge off">–ù–µ –∞–∫—Ç–∏–≤–µ–Ω</span>
              </div>

              <div class="biz-text" v-if="isBusiness">
                –¢—ã –º–æ–∂–µ—à—å –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–≤–æ–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –≤ –ø—Ä–µ–¥–ª–æ–∂–∫—É. –û–Ω–∏ –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∞–¥–º–∏–Ω–æ–º.
              </div>
              <div class="biz-text" v-else>
                Business –¥–∞—ë—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è. –û–ø–ª–∞—Ç—É –ø–æ–¥–∫–ª—é—á–∏–º –ø–æ–∑–∂–µ ‚Äî –ø–æ–∫–∞ —Å—Ç–∞—Ç—É—Å –º–µ–Ω—è–µ—Ç—Å—è –≤—Ä—É—á–Ω—É—é.
              </div>

              <button v-if="isBusiness" class="biz-btn" @click="openCreateModal">
                ‚ûï –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ
              </button>
            </div>

            <!-- Filters panel (your existing component) -->
            <FiltersPanel
              :categories="categories"
              :is-all-categories-active="isAllCategoriesActive"
              v-model:selectedCategoryNames="selectedCategoryNames"
              v-model:onlineOnly="onlineOnly"
              v-model:priceMode="priceMode"
              v-model:customPriceMin="customPriceMin"
              v-model:customPriceMax="customPriceMax"
              v-model:dateMode="dateMode"
              v-model:dateOn="dateOn"
              v-model:dateFrom="dateFrom"
              v-model:dateTo="dateTo"
              v-model:datePivot="datePivot"
              @reset="resetAllFilters"
            />

            <div v-if="toast" class="toast">{{ toast }}</div>
          </div>

          <div class="drawer-foot">
            <button class="apply-btn" @click="closeDrawer">–ü–æ–∫–∞–∑–∞—Ç—å</button>
          </div>
        </aside>
      </div>
    </teleport>

    <!-- Create event modal -->
    <CreateEventModal
      :open="createOpen"
      :categories="categories"
      :create-business-event="createBusinessEvent"
      @close="createOpen = false"
      @created="onCreatedDraft"
    />

    <!-- PHOTO MODAL -->
    <EventPhotoModal v-if="photoModalUrl" :url="photoModalUrl" @close="photoModalUrl = ''" />
  </div>
</template>

<script>
import { ref, computed, onMounted, onBeforeUnmount, nextTick } from 'vue'
import EventCard from '../../components/EventCard.vue'
import EventPhotoModal from '../../components/EventPhotoModal.vue'
import FiltersPanel from '../../components/FiltersPanel.vue'
import CreateEventModal from '../../components/CreateEventModal.vue'
import { useSupabase } from '../../composables/useSupabase'

const sleep = (ms) => new Promise((r) => setTimeout(r, ms))

const withRetry = async (fn, tries = 3) => {
  let lastErr = null
  for (let i = 0; i < tries; i++) {
    try {
      return await fn()
    } catch (e) {
      lastErr = e
      await sleep(350 * (i + 1))
    }
  }
  throw lastErr
}

const normalizeCategoryNames = (raw, categoryMap) => {
  const map = categoryMap || {}

  const toName = (v) => {
    if (v === null || v === undefined) return ''
    const s = String(v).trim()
    if (!s) return ''
    if (map[s]) return String(map[s]).trim()
    const n = Number(s)
    if (!Number.isNaN(n) && map[String(n)]) return String(map[String(n)]).trim()
    return s
  }

  if (!raw) return []
  if (Array.isArray(raw)) return Array.from(new Set(raw.map(toName).filter(Boolean)))

  if (typeof raw === 'string') {
    const s = raw.trim()
    if (!s) return []
    return Array.from(
      new Set(
        s
          .split(/[,;|]+/g)
          .map((x) => x.trim())
          .filter(Boolean)
          .map(toName)
          .filter(Boolean)
      )
    )
  }

  const one = toName(raw)
  return one ? [one] : []
}

const toNumberOrNull = (v) => {
  if (v === null || v === undefined) return null
  const n = Number(v)
  return Number.isFinite(n) ? n : null
}

const startOfDay = (d) => new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0, 0, 0, 0)
const endOfDay = (d) => new Date(d.getFullYear(), d.getMonth(), d.getDate(), 23, 59, 59, 999)

const parseEventDate = (value) => {
  if (!value) return null
  const d = new Date(value)
  if (Number.isNaN(d.getTime())) return null
  return d
}

const parseDateInput = (yyyy_mm_dd) => {
  if (!yyyy_mm_dd) return null
  const [y, m, day] = yyyy_mm_dd.split('-').map((x) => Number(x))
  if (!y || !m || !day) return null
  return new Date(y, m - 1, day)
}

export default {
  name: 'HomeView',
  components: { EventCard, EventPhotoModal, FiltersPanel, CreateEventModal },
  props: {
    globalSearchTerm: { type: String, default: '' }
  },
  setup(props) {
    const {
      getEvents,
      getCategories,
      getEventPhotos,
      getMyPublicUser,
      createBusinessEvent
    } = useSupabase()

    const initialLoaded = ref(false)
    const error = ref(null)

    const allEvents = ref([])
    const visibleEvents = ref([])
    const photos = ref({})

    const categories = ref([])
    const categoryMap = ref({})

    // profile
    const myProfile = ref(null)
    const isBusiness = computed(() => myProfile.value?.It_business === true)

    // filters state
    const selectedCategoryNames = ref([])
    const onlineOnly = ref(false)

    const priceMode = ref('all')
    const customPriceMin = ref('')
    const customPriceMax = ref('')

    const dateMode = ref('all')
    const dateOn = ref('')
    const dateFrom = ref('')
    const dateTo = ref('')
    const datePivot = ref('')

    const isAllCategoriesActive = computed(() => selectedCategoryNames.value.length === 0)

    const photosLoading = ref(false)
    const stopPhotosLoading = ref(false)

    // drawer + modal
    const drawerOpen = ref(false)
    const createOpen = ref(false)

    const toast = ref('')
    let toastTimer = null
    const showToast = (msg) => {
      toast.value = msg
      if (toastTimer) clearTimeout(toastTimer)
      toastTimer = setTimeout(() => (toast.value = ''), 3200)
    }

    // progressive
    let progressiveTimer = null
    const stopProgressive = () => {
      if (progressiveTimer) {
        clearInterval(progressiveTimer)
        progressiveTimer = null
      }
    }

    const startProgressive = (list) => {
      stopProgressive()
      visibleEvents.value = []
      const src = Array.isArray(list) ? list : []
      if (!src.length) return

      visibleEvents.value.push(src[0])
      let i = 1
      progressiveTimer = setInterval(() => {
        if (i >= src.length) {
          stopProgressive()
          return
        }
        visibleEvents.value.push(src[i])
        i++
      }, 140)
    }

    const photoModalUrl = ref('')
    const openPhoto = (url) => {
      if (!url) return
      photoModalUrl.value = url
    }

    const openDrawer = async () => {
      drawerOpen.value = true
      await nextTick()
      document.documentElement.style.overflow = 'hidden'
      document.body.style.overflow = 'hidden'
    }

    const closeDrawer = () => {
      drawerOpen.value = false
      document.documentElement.style.overflow = ''
      document.body.style.overflow = ''
    }

    const openCreateModal = () => {
      if (!isBusiness.value) return
      createOpen.value = true
    }

    const onCreatedDraft = () => {
      showToast('‚úÖ –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ. –û–Ω–æ –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∞–¥–º–∏–Ω–æ–º.')
    }

    const resetAllFilters = () => {
      selectedCategoryNames.value = []
      onlineOnly.value = false

      priceMode.value = 'all'
      customPriceMin.value = ''
      customPriceMax.value = ''

      dateMode.value = 'all'
      dateOn.value = ''
      dateFrom.value = ''
      dateTo.value = ''
      datePivot.value = ''
    }

    // filtering
    const matchesCategories = (event) => {
      if (selectedCategoryNames.value.length === 0) return true
      const eventCats = normalizeCategoryNames(event?.selectCategory, categoryMap.value)
      if (!eventCats.length) return false
      const set = new Set(selectedCategoryNames.value)
      return eventCats.some((c) => set.has(c))
    }

    const matchesOnline = (event) => {
      if (!onlineOnly.value) return true
      return event?.is_online === true
    }

    const getEventPrice = (event) => {
      if (event?.is_free === true) return 0
      const p = toNumberOrNull(event?.price)
      if (p === null) return null
      return p
    }

    const matchesPrice = (event) => {
      const mode = priceMode.value
      if (mode === 'all') return true

      const price = getEventPrice(event)
      if (mode === 'free') return price === 0
      if (price === null) return false

      if (mode === '100_1000') return price >= 100 && price <= 1000
      if (mode === '1000_3000') return price >= 1000 && price <= 3000
      if (mode === '3000_10000') return price >= 3000 && price <= 10000
      if (mode === 'gt_10000') return price > 10000

      if (mode === 'custom') {
        const min = customPriceMin.value === '' ? null : toNumberOrNull(customPriceMin.value)
        const max = customPriceMax.value === '' ? null : toNumberOrNull(customPriceMax.value)
        const okMin = min === null ? true : price >= min
        const okMax = max === null ? true : price <= max
        return okMin && okMax
      }

      return true
    }

    const matchesDate = (event) => {
      const mode = dateMode.value
      if (mode === 'all') return true

      const d = parseEventDate(event?.date_time_event)
      if (!d) return false

      if (mode === 'today') {
        const now = new Date()
        return d >= startOfDay(now) && d <= endOfDay(now)
      }

      if (mode === 'next7') {
        const now = new Date()
        const from = startOfDay(now)
        const to = endOfDay(new Date(now.getFullYear(), now.getMonth(), now.getDate() + 7))
        return d >= from && d <= to
      }

      if (mode === 'on') {
        const on = parseDateInput(dateOn.value)
        if (!on) return true
        return d >= startOfDay(on) && d <= endOfDay(on)
      }

      if (mode === 'range') {
        const fromD = parseDateInput(dateFrom.value)
        const toD = parseDateInput(dateTo.value)
        if (!fromD && !toD) return true
        const from = fromD ? startOfDay(fromD) : null
        const to = toD ? endOfDay(toD) : null
        const okFrom = from ? d >= from : true
        const okTo = to ? d <= to : true
        return okFrom && okTo
      }

      if (mode === 'after') {
        const pivot = parseDateInput(datePivot.value)
        if (!pivot) return true
        return d >= startOfDay(pivot)
      }

      if (mode === 'before') {
        const pivot = parseDateInput(datePivot.value)
        if (!pivot) return true
        return d <= endOfDay(pivot)
      }

      return true
    }

    const matchesSearch = (event) => {
      const term = (props.globalSearchTerm || '').trim().toLowerCase()
      if (!term) return true
      const t = (event.title || '').toLowerCase()
      const desc = (event.description || '').toLowerCase()
      const a = (event.address || '').toLowerCase()
      const o = (event.organizer || '').toLowerCase()
      return t.includes(term) || desc.includes(term) || a.includes(term) || o.includes(term)
    }

    const filteredEvents = computed(() => {
      return visibleEvents.value.filter(
        (e) => matchesCategories(e) && matchesOnline(e) && matchesPrice(e) && matchesDate(e) && matchesSearch(e)
      )
    })

    // loading
    const loadCategories = async () => {
      try {
        const { data, error: err } = await withRetry(() => getCategories())
        if (err) throw err
        categories.value = data ?? []
        categoryMap.value = (categories.value || []).reduce((acc, c) => {
          acc[String(c.id)] = c.name
          return acc
        }, {})
      } catch (e) {
        categories.value = []
        categoryMap.value = {}
      }
    }

    const loadProfile = async () => {
      const { data } = await getMyPublicUser()
      myProfile.value = data
    }

    const loadEventsProgressive = async () => {
      error.value = null
      stopPhotosLoading.value = true
      photosLoading.value = false
      stopProgressive()

      try {
        const { data: eventsData, error: eventsErr } = await withRetry(() => getEvents())
        if (eventsErr) throw eventsErr

        allEvents.value = eventsData ?? []
        initialLoaded.value = true

        startProgressive(allEvents.value)

        // photos background
        photos.value = {}
        stopPhotosLoading.value = false

        const ids = allEvents.value.map((e) => e.id).filter(Boolean)
        if (!ids.length) return

        photosLoading.value = true

        const batchSize = 5
        for (let i = 0; i < ids.length; i += batchSize) {
          if (stopPhotosLoading.value) break

          const batch = ids.slice(i, i + batchSize)
          try {
            const { data: ph, error: phErr } = await withRetry(() => getEventPhotos(batch))
            if (phErr) throw phErr

            const next = { ...photos.value }
            for (const p of ph ?? []) {
              if (!p?.event_id) continue
              if (!next[p.event_id]) next[p.event_id] = []
              next[p.event_id].push(p)
            }
            photos.value = next
          } catch (e) {
            // ignore
          }

          await sleep(120)
        }
      } catch (e) {
        allEvents.value = []
        visibleEvents.value = []
        photos.value = {}
        initialLoaded.value = true
        error.value = e?.message ? String(e.message) : 'TypeError: Failed to fetch'
      } finally {
        photosLoading.value = false
      }
    }

    const reload = async () => {
      await loadProfile()
      await loadEventsProgressive()
    }

    onMounted(async () => {
      await loadCategories()
      await loadProfile()
      await loadEventsProgressive()
    })

    onBeforeUnmount(() => {
      stopProgressive()
      stopPhotosLoading.value = true
      if (toastTimer) clearTimeout(toastTimer)
      document.documentElement.style.overflow = ''
      document.body.style.overflow = ''
    })

    return {
      initialLoaded,
      error,

      categories,
      categoryMap,

      myProfile,
      isBusiness,

      selectedCategoryNames,
      isAllCategoriesActive,

      onlineOnly,
      priceMode,
      customPriceMin,
      customPriceMax,

      dateMode,
      dateOn,
      dateFrom,
      dateTo,
      datePivot,

      photos,
      photosLoading,

      filteredEvents,

      drawerOpen,
      openDrawer,
      closeDrawer,

      createOpen,
      openCreateModal,

      createBusinessEvent,
      onCreatedDraft,

      resetAllFilters,
      reload,

      toast,

      photoModalUrl,
      openPhoto
    }
  }
}
</script>

<style scoped>
.page { padding: 16px 0 40px; }
.container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }

/* TOPBAR */
.topbar { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
.topbar-left { display: flex; flex-direction: column; gap: 2px; }
.page-title { font-weight: 900; font-size: 18px; }
.page-sub { font-size: 12px; opacity: 0.65; font-weight: 700; }

.filter-btn {
  margin-left: auto;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  border: 1px solid #efefef;
  background: #fff;
  border-radius: 14px;
  padding: 10px 12px;
  cursor: pointer;
  box-shadow: 0 2px 10px rgba(0,0,0,0.04);
}
.filter-btn:hover { background: #fafafa; }
.filter-icon { width: 18px; height: 18px; opacity: 0.9; }
.filter-btn-text { font-size: 13px; font-weight: 800; }

/* STATES */
.state { display: grid; place-items: center; gap: 10px; padding: 40px 0; opacity: 0.75; text-align: center; }
.state.error { opacity: 1; color: #d9534f; }
.error-title { font-weight: 800; }
.error-sub { font-size: 12px; opacity: 0.8; max-width: 680px; }
.retry { margin-top: 8px; border: none; border-radius: 12px; padding: 10px 14px; cursor: pointer; background: #efefef; }

.spinner {
  width: 26px; height: 26px; border-radius: 50%;
  border: 3px solid #eee; border-top-color: #8a75e3;
  animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* EVENTS */
.events-shell {
  background: #fff;
  border: 1px solid #efefef;
  border-radius: 18px;
  padding: 14px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.04);
}
.events-list { display: flex; flex-direction: column; gap: 12px; }

/* cards animation */
.list-enter-active, .list-leave-active { transition: opacity 240ms ease, transform 240ms ease; }
.list-enter-from, .list-leave-to { opacity: 0; transform: translateY(8px); }

/* DRAWER */
.drawer-root { position: fixed; inset: 0; z-index: 9999; }
.overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.35); backdrop-filter: blur(2px); }

.drawer {
  position: absolute; top: 0; right: 0;
  height: 100%;
  width: min(420px, 92vw);
  background: #fff;
  border-left: 1px solid #efefef;
  box-shadow: -10px 0 30px rgba(0,0,0,0.12);
  display: flex;
  flex-direction: column;
  animation: slideIn 180ms ease;
}
@keyframes slideIn { from { transform: translateX(18px); opacity: .7; } to { transform: translateX(0); opacity: 1; } }

.drawer-head {
  display: flex; align-items: center; gap: 10px;
  padding: 14px;
  border-bottom: 1px solid #f2f2f2;
}
.drawer-title { font-weight: 900; font-size: 16px; }
.close-btn {
  margin-left: auto;
  border: 1px solid #efefef;
  background: #fafafa;
  border-radius: 12px;
  padding: 8px 10px;
  cursor: pointer;
}

.drawer-body { padding: 14px; overflow: auto; display: flex; flex-direction: column; gap: 12px; }
.drawer-foot { padding: 14px; border-top: 1px solid #f2f2f2; display: flex; justify-content: flex-end; }

.apply-btn {
  border: none;
  background: #8a75e3;
  color: #fff;
  border-radius: 14px;
  padding: 12px 16px;
  font-weight: 900;
  cursor: pointer;
}
.apply-btn:hover { filter: brightness(0.97); }

/* Business card */
.biz-card {
  background: #fcfcff;
  border: 1px solid rgba(138,117,227,.18);
  border-radius: 16px;
  padding: 12px;
  display: grid;
  gap: 10px;
}
.biz-top { display: flex; align-items: center; gap: 10px; }
.biz-title { font-weight: 900; }
.biz-badge {
  margin-left: auto;
  font-size: 12px;
  font-weight: 900;
  padding: 6px 10px;
  border-radius: 999px;
  background: rgba(0, 200, 120, .12);
  border: 1px solid rgba(0, 200, 120, .22);
}
.biz-badge.off {
  background: rgba(180,180,180,.16);
  border-color: rgba(180,180,180,.28);
}
.biz-text { font-size: 12px; opacity: .8; line-height: 1.25; }
.biz-btn {
  border: none;
  border-radius: 14px;
  padding: 11px 12px;
  font-weight: 900;
  cursor: pointer;
  background: #8a75e3;
  color: #fff;
}
.biz-btn:hover { filter: brightness(.98); }

/* toast */
.toast {
  position: sticky;
  bottom: 10px;
  background: #111;
  color: #fff;
  border-radius: 14px;
  padding: 10px 12px;
  font-weight: 800;
  font-size: 13px;
  opacity: .92;
}
</style>
3) –ß—Ç–æ —Ç—ã –ø–æ–ª—É—á–∏—à—å –ø–æ—Å–ª–µ —ç—Ç–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
–í —Å–ø–∏—Å–∫–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ is_published = true

Business –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–≤–∏–¥–∏—Ç –≤ –º–µ–Ω—é—à–∫–µ –∫–Ω–æ–ø–∫—É ‚Äú–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ‚Äù

–°–æ–∑–¥–∞–Ω–Ω–æ–µ –∏–º –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –±—É–¥–µ—Ç —Å—Ä–∞–∑—É –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å—Å—è –≤ events, –Ω–æ –∫–∞–∫ –Ω–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω–æ–µ (is_published=false)

–¢—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—à—å –≤—Ä—É—á–Ω—É—é –≤ –±–∞–∑–µ: update events set is_published=true where id=...;

–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –æ–Ω–æ –ø–æ—è–≤–ª—è–µ—Ç—Å—è —É –≤—Å–µ—Ö

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å, —Å–ª–µ–¥—É—é—â–∏–º —à–∞–≥–æ–º —è –¥–æ–±–∞–≤–ª—é:

–≤–∫–ª–∞–¥–∫—É –≤ –º–µ–Ω—é—à–∫–µ ‚Äú–ú–æ–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è‚Äù (—á—Ç–æ–±—ã –±–∏–∑–Ω–µ—Å –≤–∏–¥–µ–ª —Å–≤–æ–∏ is_published=false)

–∏/–∏–ª–∏ –ø—Ä–æ—Å—Ç—É—é –∞–¥–º–∏–Ω-—Å—Ç—Ä–∞–Ω–∏—Ü—É ‚Äú–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å/–û—Ç–∫–ª–æ–Ω–∏—Ç—å‚Äù –±–µ–∑ –æ—Ç–¥–µ–ª—å–Ω–æ–π –∞–¥–º–∏–Ω–∫–∏


–í—ã —Å–∫–∞–∑–∞–ª–∏:
–∫–∞–∫ –±—ã—Å—Ç—Ä–æ –∑–∞–ø—É—à–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é?bash /var/www/deploy-biom-user.sh

ChatGPT —Å–∫–∞–∑–∞–ª:
–ï—Å–ª–∏ —É —Ç–µ–±—è —É–∂–µ –µ—Å—Ç—å —Å–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è –ø–æ –ø—É—Ç–∏ /var/www/deploy-biom-user.sh, —Ç–æ —Å–∞–º—ã–π –±—ã—Å—Ç—Ä—ã–π –ø—É—à –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä ‚Äî –ø—Ä–æ—Å—Ç–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –µ–≥–æ.

1) –ó–∞–π—Ç–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
ssh root@–¢–í–û–ô_IP
2) –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π (–æ–¥–∏–Ω —Ä–∞–∑)
ls -la /var/www/deploy-biom-user.sh
chmod +x /var/www/deploy-biom-user.sh
3) –ó–∞–ø—É—Å—Ç–∏—Ç—å –¥–µ–ø–ª–æ–π
–û–±—ã—á–Ω–æ —Ç–∞–∫:

bash /var/www/deploy-biom-user.sh
–ï—Å–ª–∏ —Å–∫—Ä–∏–ø—Ç –ø–æ–¥—Ä–∞–∑—É–º–µ–≤–∞–µ—Ç sudo:

sudo bash /var/www/deploy-biom-user.sh
4) –ï—Å–ª–∏ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è ‚Äú–Ω–µ –æ–±–Ω–æ–≤–∏–ª–æ—Å—å‚Äù
–°–∞–º—ã–µ —á–∞—Å—Ç—ã–µ –ø—Ä–∏—á–∏–Ω—ã: nginx/pm2/–∫–µ—à/–Ω–µ —Ç—É–¥–∞ —Å–æ–±—Ä–∞–ª–æ—Å—å. –ë—ã—Å—Ç—Ä–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:

A) –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥ —Å–∫—Ä–∏–ø—Ç–∞ (–µ—Å–ª–∏ –æ–Ω –ø–∏—à–µ—Ç –≤—ã–≤–æ–¥)
bash /var/www/deploy-biom-user.sh | tee /tmp/deploy-biom-user.log
tail -n 200 /tmp/deploy-biom-user.log
B) –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –±–∏–ª–¥ —Ä–µ–∞–ª—å–Ω–æ –æ–±–Ω–æ–≤–∏–ª—Å—è (–ø–æ —Ñ–∞–π–ª–∞–º dist)
(–ø—É—Ç—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ø—Ä–æ–µ–∫—Ç–∞)

ls -la /var/www/biom-user
ls -la /var/www/biom-user/dist | head
C) –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å (—á—Ç–æ —É —Ç–µ–±—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
–ï—Å–ª–∏ pm2:

pm2 list
pm2 restart biom-user
pm2 save
–ï—Å–ª–∏ systemd:

systemctl status biom-user
systemctl restart biom-user
systemctl status biom-user --no-pager -l
–ï—Å–ª–∏ —ç—Ç–æ nginx + —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π dist ‚Äî –æ–±—ã—á–Ω–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å —Ñ–∞–π–ª—ã, –Ω–æ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å nginx:

nginx -t && systemctl reload nginx
5) –û–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π (–ø–æ–ª–Ω—ã–π ‚Äú–±—ã—Å—Ç—Ä—ã–π –¥–µ–ø–ª–æ–π‚Äù)
sudo bash /var/www/deploy-biom-user.sh && nginx -t && sudo systemctl reload nginx
–ï—Å–ª–∏ —Å–∫–∏–Ω–µ—à—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ /var/www/deploy-biom-user.sh (–ø—Ä—è–º —Ç–µ–∫—Å—Ç–æ–º), —è —Å–∫–∞–∂—É —Ç–æ—á–Ω–æ, —á—Ç–æ –æ–Ω –¥–µ–ª–∞–µ—Ç –∏ –∫–∞–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã –Ω—É–∂–Ω—ã –ø–æ—Å–ª–µ –Ω–µ–≥–æ (pm2/systemd/nginx).


–í—ã —Å–∫–∞–∑–∞–ª–∏:
–ø–æ—á–µ–º—É  –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ –∞–∫–∫–∞—É–Ω—Ç —Ñ–∏–ª—å—Ç—Ä—ã –æ—Å—Ç–∞–ª–∏—Å—å –Ω–∞ —Å—Ç–∞—Ä–æ–º –º–µ—Å—Ç–µ? –ï—Å–ª–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–æ—à—ë–ª, —Ç–æ –≤—Å—ë –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –∞ –µ—Å–ª–∏ –≤–æ—à–µ–ª, —Ç–æ –æ–Ω–∏ –≥–¥–µ—Ç–æ –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ –≥–¥–µ, –ø–æ—á–µ–º—É –≤–æ–æ–±—â–µ –æ—Å—Ç–∞–ª–∞—Å—å —Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è??? –£–±–µ—Ä–∏ –µ—ë –≤–æ–æ–±—â–µ, –∏ –≤ –ø—Ä–∏–Ω—Ü–∏–ø–µ –≤–µ—Å—å –¥—É–±–ª–∏—Ä—É—é—â–∏–π—Å—è –∫–æ–¥ —É–±–µ—Ä–∏, –µ—Å–ª–∏ –µ—Å—Ç—å 2 –∫–æ–¥–∞ , –¥–µ–ª–∞—é—â–∏—Ö –æ–¥–Ω–æ –∏ —Ç–æ–∂–µ, —Ç–æ –ø—Ä–æ—Å—Ç–æ –Ω—É–∂–Ω–æ —Å—Å—ã–ª–∞—Ç—å—Å—è –Ω–∞ –ø–µ—Ä–≤—ã–π, –∞ –Ω–µ –ø–∏—Å–∞—Ç—å –≤—Ç–æ—Ä–æ–π, –≤—ã–ø–∏—à–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–æ–¥, –ø—Ä–æ–≤–µ—Ä—å –Ω–∞ –º–æ–º–µ–Ω—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –¥—Ä—É–≥–∏–µ –º–æ–º–µ–Ω—Ç—ã. –ö–æ–¥ –Ω—É–∂–Ω–æ –≤—ã–ø–∏—Å–∞—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é

ChatGPT —Å–∫–∞–∑–∞–ª:

–î—É–º–∞–ª –Ω–∞ –ø—Ä–æ—Ç—è–∂–µ–Ω–∏–∏ 1m 40s
–ü—Ä–∏—á–∏–Ω–∞ –ø—Ä–æ—Å—Ç–∞—è: —É —Ç–µ–±—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ/–≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –¥–æ —Å–∏—Ö –ø–æ—Ä –ª–µ–∂–∏—Ç —Å—Ç–∞—Ä–∞—è HomeView.vue, –≥–¥–µ —Ñ–∏–ª—å—Ç—Ä—ã ‚Äú–ö–∞—Ç–µ–≥–æ—Ä–∏–∏‚Äù —Ä–∏—Å—É—é—Ç—Å—è —Å–≤–µ—Ä—Ö—É (tags-shell). –ü—Ä–∏ –ª–æ–≥–∏–Ω–µ —É —Ç–µ–±—è –º–µ–Ω—è–µ—Ç—Å—è —á–∞—Å—Ç—å UI (–ø—Ä–æ—Ñ–∏–ª—å/–º–æ–¥–∞–ª–∫–∏), –∏–∑-–∑–∞ —ç—Ç–æ–≥–æ —Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å—Ç–∫–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç ‚Äú–µ—Ö–∞—Ç—å‚Äù, –∏ –∫–∞–∂–µ—Ç—Å—è, —á—Ç–æ —Ñ–∏–ª—å—Ç—Ä—ã ‚Äú–≥–¥–µ-—Ç–æ –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ –≥–¥–µ‚Äù.
–ù—É–∂–Ω–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—É—é –≤–µ—Ä—Å–∏—é (tags-shell) –∏ –æ—Å—Ç–∞–≤–∏—Ç—å –æ–¥–∏–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ —Ñ–∏–ª—å—Ç—Ä–æ–≤ ‚Äî drawer/–º–µ–Ω—é—à–∫—É.

–ù–∏–∂–µ –¥–∞—é –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–æ–¥ –±–µ–∑ –¥—É–±–ª–µ–π:

HomeView.vue ‚Äî –∑–∞–º–µ–Ω–∏—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é (—Å—Ç–∞—Ä—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã —É–¥–∞–ª–µ–Ω—ã)

FiltersPanel.vue ‚Äî —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ñ–∞–π–ª

CreateEventModal.vue ‚Äî —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ñ–∞–π–ª (–∫–Ω–æ–ø–∫–∞ ‚Äú–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ‚Äù –¥–ª—è –±–∏–∑–Ω–µ—Å–æ–≤)

useSupabase.js ‚Äî –∑–∞–º–µ–Ω–∏—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é (–µ–¥–∏–Ω—ã–µ –º–µ—Ç–æ–¥—ã, –±–µ–∑ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –ª–æ–≥–∏–∫–∏)

1) src/views/HomeView.vue ‚Äî –ó–ê–ú–ï–ù–ò–¢–¨ –ü–û–õ–ù–û–°–¢–¨–Æ
<template>
  <div class="page">
    <div class="container">
      <!-- TOP BAR -->
      <div class="topbar">
        <div class="topbar-left">
          <div class="page-title">–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</div>
          <div class="page-sub">
            <span v-if="initialLoaded">{{ filteredEvents.length }}</span>
            <span v-else>‚Ä¶</span>
          </div>
        </div>

        <!-- FILTER BUTTON -->
        <button class="filter-btn" @click="openDrawer" aria-label="–û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é —Ñ–∏–ª—å—Ç—Ä–æ–≤">
          <!-- funnel icon -->
          <svg viewBox="0 0 24 24" class="filter-icon" aria-hidden="true">
            <path d="M3 5h18l-7 8v5l-4 2v-7L3 5z" fill="currentColor" />
          </svg>
          <span class="filter-btn-text">–§–∏–ª—å—Ç—Ä—ã</span>
        </button>
      </div>

      <!-- STATES -->
      <div v-if="!initialLoaded" class="state">
        <div class="spinner"></div>
        <div>–ó–∞–≥—Ä—É–∑–∫–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π‚Ä¶</div>
      </div>

      <div v-else-if="error" class="state error">
        <div class="error-title">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</div>
        <div class="error-sub">{{ error }}</div>
        <button class="retry" @click="reload">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
      </div>

      <div v-else-if="filteredEvents.length === 0" class="state">
        –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
      </div>

      <!-- EVENTS -->
      <div v-else class="events-shell">
        <TransitionGroup name="list" tag="div" class="events-list">
          <EventCard
            v-for="event in filteredEvents"
            :key="event.id"
            :event="event"
            :photos="photos[event.id] || []"
            :photos-loading="photosLoading"
            :category-map="categoryMap"
            @open-photo="openPhoto"
          />
        </TransitionGroup>
      </div>
    </div>

    <!-- DRAWER -->
    <teleport to="body">
      <div v-if="drawerOpen" class="drawer-root" @keydown.esc="closeDrawer" tabindex="-1">
        <div class="overlay" @click="closeDrawer"></div>

        <aside class="drawer" role="dialog" aria-modal="true" aria-label="–§–∏–ª—å—Ç—Ä—ã">
          <div class="drawer-head">
            <div class="drawer-title">–ú–µ–Ω—é</div>
            <button class="close-btn" @click="closeDrawer" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
          </div>

          <div class="drawer-body">
            <!-- Business block -->
            <div class="biz-card">
              <div class="biz-top">
                <div class="biz-title">Business –∞–∫–∫–∞—É–Ω—Ç</div>
                <span v-if="isBusiness" class="biz-badge">–ê–∫—Ç–∏–≤–µ–Ω</span>
                <span v-else class="biz-badge off">–ù–µ –∞–∫—Ç–∏–≤–µ–Ω</span>
              </div>

              <div class="biz-text" v-if="isBusiness">
                –¢—ã –º–æ–∂–µ—à—å –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–≤–æ–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –≤ –ø—Ä–µ–¥–ª–æ–∂–∫—É. –û–Ω–∏ –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∞–¥–º–∏–Ω–æ–º
                (–ø–æ—Å—Ç–∞–≤–∏—Ç <b>is_published=true</b>).
              </div>
              <div class="biz-text" v-else>
                Business –¥–∞—Å—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è. –û–ø–ª–∞—Ç—É –ø–æ–¥–∫–ª—é—á–∏–º –ø–æ–∑–∂–µ ‚Äî –ø–æ–∫–∞ —Å—Ç–∞—Ç—É—Å –º–µ–Ω—è–µ—Ç—Å—è –≤—Ä—É—á–Ω—É—é.
              </div>

              <button v-if="isBusiness" class="biz-btn" @click="openCreateModal">‚ûï –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</button>
            </div>

            <!-- Filters -->
            <FiltersPanel
              :categories="categories"
              :is-all-categories-active="isAllCategoriesActive"
              v-model:selectedCategoryNames="selectedCategoryNames"
              v-model:onlineOnly="onlineOnly"
              v-model:priceMode="priceMode"
              v-model:customPriceMin="customPriceMin"
              v-model:customPriceMax="customPriceMax"
              v-model:dateMode="dateMode"
              v-model:dateOn="dateOn"
              v-model:dateFrom="dateFrom"
              v-model:dateTo="dateTo"
              v-model:datePivot="datePivot"
              @reset="resetAllFilters"
            />

            <div v-if="toast" class="toast">{{ toast }}</div>
          </div>

          <div class="drawer-foot">
            <button class="apply-btn" @click="closeDrawer">–ü–æ–∫–∞–∑–∞—Ç—å</button>
          </div>
        </aside>
      </div>
    </teleport>

    <!-- CREATE EVENT MODAL -->
    <CreateEventModal
      :open="createOpen"
      :categories="categories"
      :create-business-event="createBusinessEvent"
      @close="createOpen = false"
      @created="onCreatedDraft"
    />

    <!-- PHOTO MODAL -->
    <EventPhotoModal v-if="photoModalUrl" :url="photoModalUrl" @close="photoModalUrl = ''" />
  </div>
</template>

<script>
import { ref, computed, onMounted, onBeforeUnmount, nextTick } from 'vue'
import EventCard from '../../components/EventCard.vue'
import EventPhotoModal from '../../components/EventPhotoModal.vue'
import FiltersPanel from '../../components/FiltersPanel.vue'
import CreateEventModal from '../../components/CreateEventModal.vue'
import { useSupabase } from '../../composables/useSupabase.js'

/** ‚úÖ –µ–¥–∏–Ω—ã–µ —É—Ç–∏–ª–∏—Ç—ã, –±–µ–∑ –¥—É–±–ª–µ–π */
const sleep = (ms) => new Promise((r) => setTimeout(r, ms))

const withRetry = async (fn, tries = 3) => {
  let lastErr = null
  for (let i = 0; i < tries; i++) {
    try {
      return await fn()
    } catch (e) {
      lastErr = e
      await sleep(350 * (i + 1))
    }
  }
  throw lastErr
}

const toNumberOrNull = (v) => {
  if (v === null || v === undefined) return null
  const n = Number(v)
  return Number.isFinite(n) ? n : null
}

const parseEventDate = (value) => {
  if (!value) return null
  const d = new Date(value)
  if (Number.isNaN(d.getTime())) return null
  return d
}

const parseDateInput = (yyyy_mm_dd) => {
  if (!yyyy_mm_dd) return null
  const [y, m, day] = yyyy_mm_dd.split('-').map((x) => Number(x))
  if (!y || !m || !day) return null
  return new Date(y, m - 1, day)
}

const startOfDay = (d) => new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0, 0, 0, 0)
const endOfDay = (d) => new Date(d.getFullYear(), d.getMonth(), d.getDate(), 23, 59, 59, 999)

/**
 * selectCategory —É —Ç–µ–±—è –º–æ–∂–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å:
 * - –º–∞—Å—Å–∏–≤ –∏–º—ë–Ω –∫–∞—Ç–µ–≥–æ—Ä–∏–π (–Ω–æ—Ä–º–∞–ª—å–Ω–æ)
 * - —Å—Ç—Ä–æ–∫—É "—Å–ø–æ—Ä—Ç,–µ–¥–∞"
 * - –∏–Ω–æ–≥–¥–∞ —Ç—É–¥–∞ –º–æ–≥—É—Ç –ø–æ–ø–∞—Å—Ç—å id (–Ω–∞ –±—É–¥—É—â–µ–µ) ‚Äî –∫–æ–Ω–≤–µ—Ä—Ç–∏–º —á–µ—Ä–µ–∑ categoryMap
 */
const normalizeCategoryNames = (raw, categoryMap) => {
  const map = categoryMap || {}

  const toName = (v) => {
    if (v === null || v === undefined) return ''
    const s = String(v).trim()
    if (!s) return ''
    if (map[s]) return String(map[s]).trim() // id -> name
    const n = Number(s)
    if (!Number.isNaN(n) && map[String(n)]) return String(map[String(n)]).trim()
    return s
  }

  if (!raw) return []
  if (Array.isArray(raw)) return Array.from(new Set(raw.map(toName).filter(Boolean)))

  if (typeof raw === 'string') {
    const s = raw.trim()
    if (!s) return []
    return Array.from(
      new Set(
        s
          .split(/[,;|]+/g)
          .map((x) => x.trim())
          .filter(Boolean)
          .map(toName)
          .filter(Boolean)
      )
    )
  }

  const one = toName(raw)
  return one ? [one] : []
}

export default {
  name: 'HomeView',
  components: { EventCard, EventPhotoModal, FiltersPanel, CreateEventModal },
  props: {
    globalSearchTerm: { type: String, default: '' }
  },
  setup(props) {
    const { getEvents, getCategories, getEventPhotos, getMyPublicUser, createBusinessEvent } = useSupabase()

    const initialLoaded = ref(false)
    const error = ref(null)

    const allEvents = ref([])
    const visibleEvents = ref([]) // ‚úÖ —á—Ç–æ–±—ã –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–æ—è–≤–ª—è–ª–∏—Å—å –ø–ª–∞–≤–Ω–æ
    const photos = ref({})

    const categories = ref([])
    const categoryMap = ref({}) // id -> name

    const myProfile = ref(null)
    const isBusiness = computed(() => myProfile.value?.It_business === true)

    // filters
    const selectedCategoryNames = ref([])
    const onlineOnly = ref(false)

    const priceMode = ref('all')
    const customPriceMin = ref('')
    const customPriceMax = ref('')

    const dateMode = ref('all')
    const dateOn = ref('')
    const dateFrom = ref('')
    const dateTo = ref('')
    const datePivot = ref('')

    const isAllCategoriesActive = computed(() => selectedCategoryNames.value.length === 0)

    // ui
    const drawerOpen = ref(false)
    const createOpen = ref(false)

    const photoModalUrl = ref('')
    const openPhoto = (url) => {
      if (!url) return
      photoModalUrl.value = url
    }

    const toast = ref('')
    let toastTimer = null
    const showToast = (msg) => {
      toast.value = msg
      if (toastTimer) clearTimeout(toastTimer)
      toastTimer = setTimeout(() => (toast.value = ''), 3200)
    }

    // ‚úÖ progressive list (one-by-one)
    let progressiveTimer = null
    const stopProgressive = () => {
      if (progressiveTimer) clearInterval(progressiveTimer)
      progressiveTimer = null
    }

    const startProgressive = (list) => {
      stopProgressive()
      visibleEvents.value = []
      const src = Array.isArray(list) ? list : []
      if (!src.length) return

      visibleEvents.value.push(src[0])
      let i = 1

      progressiveTimer = setInterval(() => {
        if (i >= src.length) {
          stopProgressive()
          return
        }
        visibleEvents.value.push(src[i])
        i++
      }, 140)
    }

    // drawer
    const openDrawer = async () => {
      drawerOpen.value = true
      await nextTick()
      document.documentElement.style.overflow = 'hidden'
      document.body.style.overflow = 'hidden'
    }

    const closeDrawer = () => {
      drawerOpen.value = false
      document.documentElement.style.overflow = ''
      document.body.style.overflow = ''
    }

    const openCreateModal = () => {
      if (!isBusiness.value) return
      createOpen.value = true
    }

    const onCreatedDraft = () => {
      showToast('‚úÖ –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ. –û–Ω–æ –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∞–¥–º–∏–Ω–æ–º.')
    }

    const resetAllFilters = () => {
      selectedCategoryNames.value = []
      onlineOnly.value = false

      priceMode.value = 'all'
      customPriceMin.value = ''
      customPriceMax.value = ''

      dateMode.value = 'all'
      dateOn.value = ''
      dateFrom.value = ''
      dateTo.value = ''
      datePivot.value = ''
    }

    // filtering
    const matchesCategories = (event) => {
      if (selectedCategoryNames.value.length === 0) return true
      const eventCats = normalizeCategoryNames(event?.selectCategory, categoryMap.value)
      if (!eventCats.length) return false
      const set = new Set(selectedCategoryNames.value)
      return eventCats.some((c) => set.has(c))
    }

    const matchesOnline = (event) => {
      if (!onlineOnly.value) return true
      return event?.is_online === true
    }

    const getEventPrice = (event) => {
      if (event?.is_free === true) return 0
      const p = toNumberOrNull(event?.price)
      if (p === null) return null
      return p
    }

    const matchesPrice = (event) => {
      const mode = priceMode.value
      if (mode === 'all') return true

      const price = getEventPrice(event)
      if (mode === 'free') return price === 0
      if (price === null) return false

      if (mode === '100_1000') return price >= 100 && price <= 1000
      if (mode === '1000_3000') return price >= 1000 && price <= 3000
      if (mode === '3000_10000') return price >= 3000 && price <= 10000
      if (mode === 'gt_10000') return price > 10000

      if (mode === 'custom') {
        const min = customPriceMin.value === '' ? null : toNumberOrNull(customPriceMin.value)
        const max = customPriceMax.value === '' ? null : toNumberOrNull(customPriceMax.value)
        const okMin = min === null ? true : price >= min
        const okMax = max === null ? true : price <= max
        return okMin && okMax
      }

      return true
    }

    const matchesDate = (event) => {
      const mode = dateMode.value
      if (mode === 'all') return true

      const d = parseEventDate(event?.date_time_event)
      if (!d) return false

      if (mode === 'today') {
        const now = new Date()
        return d >= startOfDay(now) && d <= endOfDay(now)
      }

      if (mode === 'next7') {
        const now = new Date()
        const from = startOfDay(now)
        const to = endOfDay(new Date(now.getFullYear(), now.getMonth(), now.getDate() + 7))
        return d >= from && d <= to
      }

      if (mode === 'on') {
        const on = parseDateInput(dateOn.value)
        if (!on) return true
        return d >= startOfDay(on) && d <= endOfDay(on)
      }

      if (mode === 'range') {
        const fromD = parseDateInput(dateFrom.value)
        const toD = parseDateInput(dateTo.value)
        if (!fromD && !toD) return true
        const from = fromD ? startOfDay(fromD) : null
        const to = toD ? endOfDay(toD) : null
        const okFrom = from ? d >= from : true
        const okTo = to ? d <= to : true
        return okFrom && okTo
      }

      if (mode === 'after') {
        const pivot = parseDateInput(datePivot.value)
        if (!pivot) return true
        return d >= startOfDay(pivot)
      }

      if (mode === 'before') {
        const pivot = parseDateInput(datePivot.value)
        if (!pivot) return true
        return d <= endOfDay(pivot)
      }

      return true
    }

    const matchesSearch = (event) => {
      const term = (props.globalSearchTerm || '').trim().toLowerCase()
      if (!term) return true
      const t = (event.title || '').toLowerCase()
      const desc = (event.description || '').toLowerCase()
      const a = (event.address || '').toLowerCase()
      const o = (event.organizer || '').toLowerCase()
      return t.includes(term) || desc.includes(term) || a.includes(term) || o.includes(term)
    }

    const filteredEvents = computed(() => {
      return visibleEvents.value.filter(
        (e) => matchesCategories(e) && matchesOnline(e) && matchesPrice(e) && matchesDate(e) && matchesSearch(e)
      )
    })

    // loading
    const photosLoading = ref(false)
    const stopPhotosLoading = ref(false)

    const loadCategories = async () => {
      const { data, error: err } = await withRetry(() => getCategories())
      if (err) throw err

      categories.value = data ?? []
      categoryMap.value = (categories.value || []).reduce((acc, c) => {
        acc[String(c.id)] = c.name
        return acc
      }, {})
    }

    const loadProfile = async () => {
      const { data } = await getMyPublicUser()
      myProfile.value = data
    }

    const loadEventsProgressive = async () => {
      error.value = null
      stopPhotosLoading.value = true
      photosLoading.value = false
      stopProgressive()

      try {
        const { data: eventsData, error: eventsErr } = await withRetry(() => getEvents())
        if (eventsErr) throw eventsErr

        allEvents.value = eventsData ?? []
        initialLoaded.value = true
        startProgressive(allEvents.value)

        // photos background
        photos.value = {}
        stopPhotosLoading.value = false

        const ids = allEvents.value.map((e) => e.id).filter(Boolean)
        if (!ids.length) return

        photosLoading.value = true
        const batchSize = 5

        for (let i = 0; i < ids.length; i += batchSize) {
          if (stopPhotosLoading.value) break
          const batch = ids.slice(i, i + batchSize)

          const { data: ph, error: phErr } = await withRetry(() => getEventPhotos(batch))
          if (!phErr) {
            const next = { ...photos.value }
            for (const p of ph ?? []) {
              if (!p?.event_id) continue
              if (!next[p.event_id]) next[p.event_id] = []
              next[p.event_id].push(p)
            }
            photos.value = next
          }

          await sleep(120)
        }
      } catch (e) {
        allEvents.value = []
        visibleEvents.value = []
        photos.value = {}
        initialLoaded.value = true
        error.value = e?.message ? String(e.message) : 'TypeError: Failed to fetch'
      } finally {
        photosLoading.value = false
      }
    }

    const reload = async () => {
      await loadProfile()
      await loadEventsProgressive()
    }

    onMounted(async () => {
      try {
        await loadCategories()
      } catch (e) {
        categories.value = []
        categoryMap.value = {}
      }
      await loadProfile()
      await loadEventsProgressive()
    })

    onBeforeUnmount(() => {
      stopProgressive()
      stopPhotosLoading.value = true
      if (toastTimer) clearTimeout(toastTimer)
      document.documentElement.style.overflow = ''
      document.body.style.overflow = ''
    })

    return {
      initialLoaded,
      error,

      categories,
      categoryMap,

      myProfile,
      isBusiness,

      selectedCategoryNames,
      isAllCategoriesActive,

      onlineOnly,
      priceMode,
      customPriceMin,
      customPriceMax,

      dateMode,
      dateOn,
      dateFrom,
      dateTo,
      datePivot,

      photos,
      photosLoading,

      filteredEvents,

      drawerOpen,
      openDrawer,
      closeDrawer,

      createOpen,
      openCreateModal,

      createBusinessEvent,
      onCreatedDraft,

      resetAllFilters,
      reload,

      toast,

      photoModalUrl,
      openPhoto
    }
  }
}
</script>

<style scoped>
.page { padding: 16px 0 40px; }
.container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }

/* TOPBAR */
.topbar { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
.topbar-left { display: flex; flex-direction: column; gap: 2px; }
.page-title { font-weight: 900; font-size: 18px; }
.page-sub { font-size: 12px; opacity: .65; font-weight: 700; }

.filter-btn {
  margin-left: auto;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  border: 1px solid #efefef;
  background: #fff;
  border-radius: 14px;
  padding: 10px 12px;
  cursor: pointer;
  box-shadow: 0 2px 10px rgba(0,0,0,0.04);
}
.filter-btn:hover { background: #fafafa; }
.filter-icon { width: 18px; height: 18px; opacity: .9; }
.filter-btn-text { font-size: 13px; font-weight: 800; }

/* STATES */
.state { display: grid; place-items: center; gap: 10px; padding: 40px 0; opacity: .75; text-align: center; }
.state.error { opacity: 1; color: #d9534f; }
.error-title { font-weight: 800; }
.error-sub { font-size: 12px; opacity: .8; max-width: 680px; }
.retry { margin-top: 8px; border: none; border-radius: 12px; padding: 10px 14px; cursor: pointer; background: #efefef; }

.spinner {
  width: 26px; height: 26px; border-radius: 50%;
  border: 3px solid #eee; border-top-color: #8a75e3;
  animation: spin .8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* EVENTS */
.events-shell {
  background: #fff;
  border: 1px solid #efefef;
  border-radius: 18px;
  padding: 14px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.04);
}
.events-list { display: flex; flex-direction: column; gap: 12px; }

/* appear animation */
.list-enter-active, .list-leave-active { transition: opacity 240ms ease, transform 240ms ease; }
.list-enter-from, .list-leave-to { opacity: 0; transform: translateY(8px); }

/* DRAWER */
.drawer-root { position: fixed; inset: 0; z-index: 9999; }
.overlay { position: absolute; inset: 0; background: rgba(0,0,0,.35); backdrop-filter: blur(2px); }

.drawer {
  position: absolute; top: 0; right: 0; height: 100%;
  width: min(420px, 92vw);
  background: #fff;
  border-left: 1px solid #efefef;
  box-shadow: -10px 0 30px rgba(0,0,0,0.12);
  display: flex; flex-direction: column;
  animation: slideIn 180ms ease;
}
@keyframes slideIn { from { transform: translateX(18px); opacity: .7; } to { transform: translateX(0); opacity: 1; } }

.drawer-head {
  display: flex; align-items: center; gap: 10px;
  padding: 14px;
  border-bottom: 1px solid #f2f2f2;
}
.drawer-title { font-weight: 900; font-size: 16px; }
.close-btn {
  margin-left: auto;
  border: 1px solid #efefef;
  background: #fafafa;
  border-radius: 12px;
  padding: 8px 10px;
  cursor: pointer;
}

.drawer-body { padding: 14px; overflow: auto; display: flex; flex-direction: column; gap: 12px; }
.drawer-foot { padding: 14px; border-top: 1px solid #f2f2f2; display: flex; justify-content: flex-end; }

.apply-btn {
  border: none;
  background: #8a75e3;
  color: #fff;
  border-radius: 14px;
  padding: 12px 16px;
  font-weight: 900;
  cursor: pointer;
}
.apply-btn:hover { filter: brightness(.97); }

/* Business card */
.biz-card {
  background: #fcfcff;
  border: 1px solid rgba(138,117,227,.18);
  border-radius: 16px;
  padding: 12px;
  display: grid;
  gap: 10px;
}
.biz-top { display: flex; align-items: center; gap: 10px; }
.biz-title { font-weight: 900; }
.biz-badge {
  margin-left: auto;
  font-size: 12px;
  font-weight: 900;
  padding: 6px 10px;
  border-radius: 999px;
  background: rgba(0, 200, 120, .12);
  border: 1px solid rgba(0, 200, 120, .22);
}
.biz-badge.off { background: rgba(180,180,180,.16); border-color: rgba(180,180,180,.28); }
.biz-text { font-size: 12px; opacity: .8; line-height: 1.25; }
.biz-btn {
  border: none;
  border-radius: 14px;
  padding: 11px 12px;
  font-weight: 900;
  cursor: pointer;
  background: #8a75e3;
  color: #fff;
}
.biz-btn:hover { filter: brightness(.98); }

/* toast */
.toast {
  position: sticky;
  bottom: 10px;
  background: #111;
  color: #fff;
  border-radius: 14px;
  padding: 10px 12px;
  font-weight: 800;
  font-size: 13px;
  opacity: .92;
}
</style>
2) src/components/FiltersPanel.vue ‚Äî –°–û–ó–î–ê–¢–¨ (–ø–æ–ª–Ω–æ—Å—Ç—å—é)
<template>
  <div class="panel">
    <div class="head">
      <div class="title">–§–∏–ª—å—Ç—Ä—ã</div>
      <button class="reset" @click="$emit('reset')">–°–±—Ä–æ—Å–∏—Ç—å</button>
    </div>

    <!-- Categories -->
    <div class="block">
      <div class="label">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</div>

      <div class="tags">
        <button class="tag" :class="{ active: isAllCategoriesActive }" @click="selectAllCategories">
          –í—Å–µ
        </button>

        <button
          v-for="cat in categories"
          :key="cat.id"
          class="tag"
          :class="{ active: selectedCategoryNames.includes(cat.name) }"
          @click="toggleCategory(cat.name)"
        >
          {{ cat.name }}
        </button>
      </div>
    </div>

    <!-- Online -->
    <div class="block inline">
      <label class="check">
        <input type="checkbox" :checked="onlineOnly" @change="onToggleOnline" />
        <span class="ui"></span>
        <span class="text">–¢–æ–ª—å–∫–æ –æ–Ω–ª–∞–π–Ω</span>
      </label>
      <div class="hint">–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è, –≥–¥–µ <b>is_online = true</b>.</div>
    </div>

    <div class="grid">
      <!-- PRICE -->
      <div class="card">
        <div class="cardTitle">–¶–µ–Ω–∞</div>

        <div class="seg">
          <button class="segBtn" :class="{ active: priceMode === 'all' }" @click="setPriceMode('all')">
            –õ—é–±–∞—è
          </button>
          <button class="segBtn" :class="{ active: priceMode === 'free' }" @click="setPriceMode('free')">
            –ë–µ—Å–ø–ª–∞—Ç–Ω–æ
          </button>
          <button class="segBtn" :class="{ active: priceMode === 'custom' }" @click="setPriceMode('custom')">
            –°–≤–æ–π –¥–∏–∞–ø–∞–∑–æ–Ω
          </button>
        </div>

        <div class="chips">
          <button class="chip" :class="{ active: priceMode === '100_1000' }" @click="setPriceMode('100_1000')">
            100‚Äì1000
          </button>
          <button class="chip" :class="{ active: priceMode === '1000_3000' }" @click="setPriceMode('1000_3000')">
            1000‚Äì3000
          </button>
          <button class="chip" :class="{ active: priceMode === '3000_10000' }" @click="setPriceMode('3000_10000')">
            3000‚Äì10000
          </button>
          <button class="chip" :class="{ active: priceMode === 'gt_10000' }" @click="setPriceMode('gt_10000')">
            &gt; 10000
          </button>
        </div>

        <div v-if="priceMode === 'custom'" class="row">
          <div class="field">
            <div class="fieldLabel">–æ—Ç</div>
            <input
              class="input"
              type="number"
              min="0"
              inputmode="numeric"
              placeholder="0"
              :value="customPriceMin"
              @input="$emit('update:customPriceMin', $event.target.value)"
            />
          </div>

          <div class="field">
            <div class="fieldLabel">–¥–æ</div>
            <input
              class="input"
              type="number"
              min="0"
              inputmode="numeric"
              placeholder="‚àû"
              :value="customPriceMax"
              @input="$emit('update:customPriceMax', $event.target.value)"
            />
          </div>
        </div>

        <div class="hint">
          –ï—Å–ª–∏ <b>is_free=true</b> –∏–ª–∏ <b>price=0</b> ‚Äî —ç—Ç–æ ‚Äú–ë–µ—Å–ø–ª–∞—Ç–Ω–æ‚Äù.
        </div>
      </div>

      <!-- DATE -->
      <div class="card">
        <div class="cardTitle">–î–∞—Ç–∞</div>

        <div class="seg">
          <button class="segBtn" :class="{ active: dateMode === 'all' }" @click="setDateMode('all')">
            –í—Å—ë –≤—Ä–µ–º—è
          </button>
          <button class="segBtn" :class="{ active: dateMode === 'on' }" @click="setDateMode('on')">
            –ù–∞ –¥–∞—Ç—É
          </button>
          <button class="segBtn" :class="{ active: dateMode === 'range' }" @click="setDateMode('range')">
            –î–∏–∞–ø–∞–∑–æ–Ω
          </button>
        </div>

        <div class="chips">
          <button class="chip" :class="{ active: dateMode === 'after' }" @click="setDateMode('after')">
            –ü–æ—Å–ª–µ
          </button>
          <button class="chip" :class="{ active: dateMode === 'before' }" @click="setDateMode('before')">
            –î–æ
          </button>
          <button class="chip" :class="{ active: dateMode === 'next7' }" @click="setDateMode('next7')">
            –°–ª–µ–¥. 7 –¥–Ω–µ–π
          </button>
          <button class="chip" :class="{ active: dateMode === 'today' }" @click="setDateMode('today')">
            –°–µ–≥–æ–¥–Ω—è
          </button>
        </div>

        <div v-if="dateMode === 'on'" class="row">
          <div class="field grow">
            <div class="fieldLabel">–î–∞—Ç–∞</div>
            <input class="input" type="date" :value="dateOn" @input="$emit('update:dateOn', $event.target.value)" />
          </div>
        </div>

        <div v-else-if="dateMode === 'range'" class="row">
          <div class="field grow">
            <div class="fieldLabel">—Å</div>
            <input class="input" type="date" :value="dateFrom" @input="$emit('update:dateFrom', $event.target.value)" />
          </div>
          <div class="field grow">
            <div class="fieldLabel">–ø–æ</div>
            <input class="input" type="date" :value="dateTo" @input="$emit('update:dateTo', $event.target.value)" />
          </div>
        </div>

        <div v-else-if="dateMode === 'after'" class="row">
          <div class="field grow">
            <div class="fieldLabel">–ü–æ—Å–ª–µ</div>
            <input class="input" type="date" :value="datePivot" @input="$emit('update:datePivot', $event.target.value)" />
          </div>
        </div>

        <div v-else-if="dateMode === 'before'" class="row">
          <div class="field grow">
            <div class="fieldLabel">–î–æ</div>
            <input class="input" type="date" :value="datePivot" @input="$emit('update:datePivot', $event.target.value)" />
          </div>
        </div>

        <div class="hint">–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ <b>date_time_event</b>.</div>
      </div>
    </div>
  </div>
</template>

<script>
export default {
  name: 'FiltersPanel',
  emits: [
    'reset',
    'update:selectedCategoryNames',
    'update:onlineOnly',
    'update:priceMode',
    'update:customPriceMin',
    'update:customPriceMax',
    'update:dateMode',
    'update:dateOn',
    'update:dateFrom',
    'update:dateTo',
    'update:datePivot'
  ],
  props: {
    categories: { type: Array, default: () => [] },

    selectedCategoryNames: { type: Array, default: () => [] },
    isAllCategoriesActive: { type: Boolean, default: true },

    onlineOnly: { type: Boolean, default: false },

    priceMode: { type: String, default: 'all' },
    customPriceMin: { type: String, default: '' },
    customPriceMax: { type: String, default: '' },

    dateMode: { type: String, default: 'all' },
    dateOn: { type: String, default: '' },
    dateFrom: { type: String, default: '' },
    dateTo: { type: String, default: '' },
    datePivot: { type: String, default: '' }
  },
  methods: {
    selectAllCategories() {
      this.$emit('update:selectedCategoryNames', [])
    },
    toggleCategory(name) {
      const n = String(name || '').trim()
      if (!n) return
      const next = [...this.selectedCategoryNames]
      const idx = next.indexOf(n)
      if (idx >= 0) next.splice(idx, 1)
      else next.push(n)
      this.$emit('update:selectedCategoryNames', next)
    },
    onToggleOnline(e) {
      this.$emit('update:onlineOnly', !!e.target.checked)
    },
    setPriceMode(mode) {
      this.$emit('update:priceMode', mode)
    },
    setDateMode(mode) {
      this.$emit('update:dateMode', mode)
    }
  }
}
</script>

<style scoped>
.panel { display: flex; flex-direction: column; gap: 12px; }

.head { display: flex; align-items: center; gap: 12px; }
.title { font-weight: 900; font-size: 16px; }
.reset {
  margin-left: auto;
  border: 1px solid #efefef;
  background: #fafafa;
  border-radius: 12px;
  padding: 8px 10px;
  cursor: pointer;
  font-size: 13px;
}
.reset:hover { background: #f3f3f3; }

.block { border: 1px solid #f2f2f2; border-radius: 16px; padding: 12px; background: #fcfcfc; }
.inline { display: grid; gap: 8px; }

.label { font-weight: 800; font-size: 13px; opacity: .7; margin-bottom: 10px; }

.tags { display: flex; flex-wrap: wrap; gap: 10px; }
.tag {
  border: 1px solid #efefef;
  background: #fafafa;
  border-radius: 999px;
  padding: 8px 12px;
  cursor: pointer;
  font-size: 13px;
  white-space: nowrap;
}
.tag.active { background: #8a75e3; border-color: #8a75e3; color: #fff; }

/* Toggle */
.check { display: inline-flex; align-items: center; gap: 10px; cursor: pointer; user-select: none; }
.check input { display: none; }
.ui {
  width: 44px; height: 26px; border-radius: 999px;
  border: 1px solid #e9e9e9; background: #f3f3f3;
  position: relative; transition: background 180ms ease, border-color 180ms ease;
}
.ui::after {
  content: '';
  width: 22px; height: 22px; border-radius: 999px;
  background: #fff; position: absolute; top: 1px; left: 1px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.08);
  transition: transform 180ms ease;
}
.check input:checked + .ui { background: rgba(138,117,227,0.85); border-color: rgba(138,117,227,0.55); }
.check input:checked + .ui::after { transform: translateX(18px); }
.text { font-weight: 800; font-size: 13px; }

.grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
.card { border: 1px solid #f2f2f2; border-radius: 16px; padding: 12px; background: #fcfcfc; }
.cardTitle { font-weight: 900; margin-bottom: 10px; }

.seg { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px; }
.segBtn {
  border: 1px solid #efefef;
  background: #fff;
  border-radius: 12px;
  padding: 8px 10px;
  cursor: pointer;
  font-size: 13px;
}
.segBtn.active { background: rgba(138,117,227,0.12); border-color: rgba(138,117,227,0.4); }

.chips { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; }
.chip {
  border: 1px solid #efefef;
  background: #fff;
  border-radius: 999px;
  padding: 7px 10px;
  cursor: pointer;
  font-size: 13px;
}
.chip.active { background: #8a75e3; border-color: #8a75e3; color: #fff; }

.row { display: flex; gap: 10px; align-items: flex-end; }
.field { display: flex; flex-direction: column; gap: 6px; min-width: 120px; }
.field.grow { flex: 1; min-width: 160px; }

.fieldLabel { font-size: 12px; opacity: .7; font-weight: 700; }

.input {
  border: 1px solid #efefef;
  border-radius: 12px;
  padding: 10px 10px;
  font-size: 14px;
  background: #fff;
  outline: none;
}
.input:focus { border-color: rgba(138,117,227,0.55); box-shadow: 0 0 0 3px rgba(138,117,227,0.12); }

.hint { margin-top: 10px; font-size: 12px; opacity: .7; line-height: 1.25; }
</style>
3) src/components/CreateEventModal.vue ‚Äî –°–û–ó–î–ê–¢–¨ (–ø–æ–ª–Ω–æ—Å—Ç—å—é)
–≠—Ç–æ –º–æ–¥–∞–ª–∫–∞ ‚Äú–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ‚Äù –¥–ª—è –±–∏–∑–Ω–µ—Å-–∞–∫–∫–∞—É–Ω—Ç–∞. –°–æ–±—ã—Ç–∏–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è —Å is_published=false.

<template>
  <teleport to="body">
    <div v-if="open" class="root" @keydown.esc="close" tabindex="-1">
      <div class="overlay" @click="close"></div>

      <div class="modal" role="dialog" aria-modal="true" aria-label="–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ">
        <div class="head">
          <div class="title">–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</div>
          <button class="x" @click="close" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
        </div>

        <div class="body">
          <div class="hint">
            –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–æ —Å <b>is_published=false</b> –∏ —Å—Ç–∞–Ω–µ—Ç –≤–∏–¥–Ω–æ –≤—Å–µ–º –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∞–¥–º–∏–Ω–æ–º.
          </div>

          <div class="grid">
            <div class="field">
              <div class="label">–ù–∞–∑–≤–∞–Ω–∏–µ *</div>
              <input class="input" v-model="form.title" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –í–µ—á–µ—Ä –Ω–∞—Å—Ç–æ–ª–æ–∫" />
            </div>

            <div class="field">
              <div class="label">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è *</div>
              <input class="input" type="datetime-local" v-model="form.date_time_event" />
            </div>

            <div class="field">
              <div class="label">–ê–¥—Ä–µ—Å</div>
              <input class="input" v-model="form.address" placeholder="–ì–æ—Ä–æ–¥, —É–ª–∏—Ü–∞, –¥–æ–º / –∏–ª–∏ —Å—Å—ã–ª–∫–∞ –¥–ª—è –æ–Ω–ª–∞–π–Ω" />
            </div>

            <div class="field">
              <div class="label">–û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä</div>
              <input class="input" v-model="form.organizer" placeholder="–ò–º—è/–ø—Ä–æ–µ–∫—Ç" />
            </div>

            <div class="field">
              <div class="label">–¶–µ–Ω–∞ (‚ÇΩ)</div>
              <input class="input" type="number" min="0" inputmode="numeric" v-model="form.price" placeholder="0" />
              <div class="mini">
                <span class="badge" v-if="isFree">üÜì –ë–µ—Å–ø–ª–∞—Ç–Ω–æ</span>
              </div>
            </div>

            <div class="field inline">
              <label class="check">
                <input type="checkbox" v-model="form.is_online" />
                <span class="ui"></span>
                <span class="text">–û–Ω–ª–∞–π–Ω (is_online)</span>
              </label>
            </div>
          </div>

          <div class="field">
            <div class="label">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</div>
            <div class="tags">
              <button
                v-for="c in categories"
                :key="c.id"
                class="tag"
                :class="{ active: selectedCategories.includes(c.name) }"
                @click="toggleCategory(c.name)"
                type="button"
              >
                {{ c.name }}
              </button>
            </div>
            <div class="mini">–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ.</div>
          </div>

          <div class="field">
            <div class="label">–û–ø–∏—Å–∞–Ω–∏–µ *</div>
            <textarea class="textarea" v-model="form.description" placeholder="–û–ø–∏—à–∏, —á—Ç–æ –±—É–¥–µ—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å"></textarea>
          </div>

          <div class="field">
            <div class="label">–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</div>
            <input class="input" v-model="form.photo_url" placeholder="https://..." />
            <div class="mini">–ï—Å–ª–∏ —É–∫–∞–∂–µ—à—å ‚Äî –¥–æ–±–∞–≤–∏–º –≤ event_photos –∫–∞–∫ –ø–µ—Ä–≤–æ–µ —Ñ–æ—Ç–æ.</div>
          </div>

          <div v-if="error" class="error">{{ error }}</div>
        </div>

        <div class="foot">
          <button class="btn secondary" @click="close">–û—Ç–º–µ–Ω–∞</button>
          <button class="btn primary" :disabled="saving" @click="submit">
            {{ saving ? '–û—Ç–ø—Ä–∞–≤–ª—è—é‚Ä¶' : '–û—Ç–ø—Ä–∞–≤–∏—Ç—å' }}
          </button>
        </div>
      </div>
    </div>
  </teleport>
</template>

<script>
const trimOrNull = (v) => {
  const s = String(v ?? '').trim()
  return s ? s : null
}

export default {
  name: 'CreateEventModal',
  emits: ['close', 'created'],
  props: {
    open: { type: Boolean, default: false },
    categories: { type: Array, default: () => [] },
    createBusinessEvent: { type: Function, required: true }
  },
  data() {
    return {
      saving: false,
      error: '',
      selectedCategories: [],
      form: {
        title: '',
        description: '',
        date_time_event: '',
        address: '',
        organizer: '',
        price: '0',
        is_online: false,
        photo_url: ''
      }
    }
  },
  computed: {
    isFree() {
      const n = Number(this.form.price)
      return Number.isFinite(n) && n <= 0
    }
  },
  methods: {
    close() {
      if (this.saving) return
      this.$emit('close')
    },
    toggleCategory(name) {
      const n = String(name || '').trim()
      if (!n) return
      const idx = this.selectedCategories.indexOf(n)
      if (idx >= 0) this.selectedCategories.splice(idx, 1)
      else this.selectedCategories.push(n)
    },
    async submit() {
      this.error = ''

      const title = trimOrNull(this.form.title)
      const description = trimOrNull(this.form.description)
      const dt = trimOrNull(this.form.date_time_event)

      if (!title) return (this.error = '–£–∫–∞–∂–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ.')
      if (!dt) return (this.error = '–£–∫–∞–∂–∏ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è.')
      if (!description) return (this.error = '–£–∫–∞–∂–∏ –æ–ø–∏—Å–∞–Ω–∏–µ.')

      const priceNum = Number(this.form.price)
      const price = Number.isFinite(priceNum) ? priceNum : 0
      const is_free = price <= 0

      const payload = {
        title,
        description,
        date_time_event: dt,
        address: trimOrNull(this.form.address),
        organizer: trimOrNull(this.form.organizer),
        price,
        is_online: !!this.form.is_online,
        is_free,
        selectCategory: [...this.selectedCategories],
        photo_url: trimOrNull(this.form.photo_url)
      }

      this.saving = true
      try {
        const { data, error } = await this.createBusinessEvent(payload)
        if (error) {
          this.error = String(error.message || error)
          return
        }
        this.$emit('created', data)
        this.$emit('close')

        this.selectedCategories = []
        this.form = {
          title: '',
          description: '',
          date_time_event: '',
          address: '',
          organizer: '',
          price: '0',
          is_online: false,
          photo_url: ''
        }
      } finally {
        this.saving = false
      }
    }
  }
}
</script>

<style scoped>
.root { position: fixed; inset: 0; z-index: 10000; }
.overlay { position: absolute; inset: 0; background: rgba(0,0,0,.38); backdrop-filter: blur(2px); }

.modal {
  position: absolute;
  left: 50%;
  top: 50%;
  width: min(760px, 94vw);
  max-height: 90vh;
  transform: translate(-50%, -50%);
  background: #fff;
  border: 1px solid #efefef;
  border-radius: 18px;
  box-shadow: 0 18px 60px rgba(0,0,0,.18);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.head {
  padding: 14px;
  border-bottom: 1px solid #f2f2f2;
  display: flex;
  align-items: center;
  gap: 12px;
}
.title { font-weight: 900; font-size: 16px; }
.x {
  margin-left: auto;
  border: 1px solid #efefef;
  background: #fafafa;
  border-radius: 12px;
  padding: 8px 10px;
  cursor: pointer;
}

.body {
  padding: 14px;
  overflow: auto;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.hint {
  background: #fcfcff;
  border: 1px solid rgba(138,117,227,.18);
  border-radius: 14px;
  padding: 10px 12px;
  font-size: 13px;
  opacity: .9;
}

.grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
@media (max-width: 720px) { .grid { grid-template-columns: 1fr; } }

.field { display: flex; flex-direction: column; gap: 6px; }
.field.inline { justify-content: flex-end; }

.label { font-size: 12px; font-weight: 800; opacity: .7; }
.input, .textarea {
  border: 1px solid #efefef;
  border-radius: 12px;
  padding: 10px 10px;
  font-size: 14px;
  background: #fff;
  outline: none;
}
.input:focus, .textarea:focus {
  border-color: rgba(138,117,227,.55);
  box-shadow: 0 0 0 3px rgba(138,117,227,.12);
}
.textarea { min-height: 120px; resize: vertical; }

.mini { font-size: 12px; opacity: .7; }
.badge {
  display: inline-flex;
  align-items: center;
  padding: 6px 10px;
  border-radius: 999px;
  background: rgba(138,117,227,.12);
  border: 1px solid rgba(138,117,227,.22);
  width: fit-content;
}

.tags { display: flex; flex-wrap: wrap; gap: 8px; }
.tag {
  border: 1px solid #efefef;
  background: #fff;
  border-radius: 999px;
  padding: 7px 10px;
  cursor: pointer;
  font-size: 13px;
}
.tag.active { background: #8a75e3; border-color: #8a75e3; color: #fff; }

/* toggle */
.check { display: inline-flex; align-items: center; gap: 10px; cursor: pointer; user-select: none; }
.check input { display: none; }
.ui {
  width: 44px; height: 26px; border-radius: 999px;
  border: 1px solid #e9e9e9; background: #f3f3f3;
  position: relative; transition: background 180ms ease, border-color 180ms ease;
}
.ui::after {
  content: '';
  width: 22px; height: 22px; border-radius: 999px;
  background: #fff; position: absolute; top: 1px; left: 1px;
  box-shadow: 0 2px 10px rgba(0,0,0,.08);
  transition: transform 180ms ease;
}
.check input:checked + .ui { background: rgba(138,117,227,.85); border-color: rgba(138,117,227,.55); }
.check input:checked + .ui::after { transform: translateX(18px); }
.text { font-weight: 800; font-size: 13px; }

.error { color: #d9534f; font-weight: 800; font-size: 13px; }

.foot {
  padding: 14px;
  border-top: 1px solid #f2f2f2;
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}

.btn {
  border-radius: 14px;
  padding: 12px 16px;
  font-weight: 900;
  cursor: pointer;
  border: none;
}
.btn.secondary { background: #efefef; }
.btn.primary { background: #8a75e3; color: #fff; }
.btn:disabled { opacity: .6; cursor: not-allowed; }
</style>
4) src/composables/useSupabase.js ‚Äî –ó–ê–ú–ï–ù–ò–¢–¨ –ü–û–õ–ù–û–°–¢–¨–Æ
–¢—É—Ç –Ω–µ—Ç –¥—É–±–ª–µ–π: –æ–¥–∏–Ω –∫–ª–∏–µ–Ω—Ç, –µ–¥–∏–Ω—ã–µ –º–µ—Ç–æ–¥—ã.
getEvents() —Å—Ä–∞–∑—É –æ—Ç–¥–∞—ë—Ç —Ç–æ–ª—å–∫–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–µ (is_published=true).
createBusinessEvent() —Å–æ–∑–¥–∞—ë—Ç —Å–æ–±—ã—Ç–∏–µ –∫–∞–∫ —á–µ—Ä–Ω–æ–≤–∏–∫ (is_published=false) + –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ —Ñ–æ—Ç–æ.

import { createClient } from '@supabase/supabase-js'

const supabaseUrl = import.meta.env.VITE_SUPABASE_URL
const supabaseKey = import.meta.env.VITE_SUPABASE_ANON_KEY

export const supabase = createClient(supabaseUrl, supabaseKey)

const normalizeStoragePublicUrl = (url) => {
  if (!url || typeof url !== 'string') return ''
  const u = url.trim()
  if (!u) return ''
  if (u.includes('/storage/v1/object/public/')) return u
  if (u.includes('/storage/v1/object/')) return u.replace('/storage/v1/object/', '/storage/v1/object/public/')
  return u
}

const compact = (obj) => {
  const out = {}
  for (const [k, v] of Object.entries(obj || {})) {
    if (v !== undefined) out[k] = v
  }
  return out
}

export const useSupabase = () => {
  // ---------------------------
  // EVENTS (ONLY PUBLISHED)
  // ---------------------------
  const getEvents = async () => {
    const { data, error } = await supabase
      .from('events')
      .select(
        `
        id,
        title,
        description,
        date_time_event,
        address,
        organizer,
        price,
        is_online,
        is_free,
        user_id,
        selectCategory,
        is_published,
        created_at
      `
      )
      .eq('is_published', true)
      .order('created_at', { ascending: false })

    return { data, error }
  }

  const getCategories = async () => {
    const { data, error } = await supabase.from('category').select('id, name').order('name', { ascending: true })
    return { data, error }
  }

  const getEventPhotos = async (eventIds) => {
    if (!Array.isArray(eventIds) || eventIds.length === 0) return { data: [], error: null }

    const { data, error } = await supabase
      .from('event_photos')
      .select('id, event_id, photo_url')
      .in('event_id', eventIds)
      .order('id', { ascending: true })

    return { data: data ?? [], error }
  }

  // ‚úÖ BUSINESS: create draft (not published)
  const createBusinessEvent = async (payload) => {
    const { user, error: userErr } = await getUser()
    if (userErr) return { data: null, error: userErr }
    if (!user) return { data: null, error: new Error('–ù–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏') }

    const price = Number(payload?.price ?? 0)
    const is_free = payload?.is_free === true || (Number.isFinite(price) && price <= 0)

    const eventInsert = {
      title: payload?.title ?? null,
      description: payload?.description ?? null,
      date_time_event: payload?.date_time_event ?? null,
      address: payload?.address ?? null,
      organizer: payload?.organizer ?? null,
      price: Number.isFinite(price) ? price : 0,
      is_online: !!payload?.is_online,
      is_free,
      user_id: user.id,
      selectCategory: Array.isArray(payload?.selectCategory) ? payload.selectCategory : [],
      is_published: false
    }

    const { data: eventRow, error: insErr } = await supabase.from('events').insert(eventInsert).select().single()
    if (insErr) return { data: null, error: insErr }

    const photoUrl = String(payload?.photo_url ?? '').trim()
    if (photoUrl) {
      const { error: phErr } = await supabase.from('event_photos').insert({
        event_id: eventRow.id,
        photo_url: photoUrl
      })
      if (phErr) return { data: eventRow, error: phErr }
    }

    return { data: eventRow, error: null }
  }

  // ---------------------------
  // AUTH
  // ---------------------------
  const getSession = async () => {
    const { data, error } = await supabase.auth.getSession()
    return { session: data?.session ?? null, error }
  }

  const getUser = async () => {
    const { data, error } = await supabase.auth.getUser()
    return { user: data?.user ?? null, error }
  }

  const signOut = async () => {
    const { error } = await supabase.auth.signOut()
    return { error }
  }

  const signInWithGoogle = async ({ redirectTo }) => {
    const { data, error } = await supabase.auth.signInWithOAuth({
      provider: 'google',
      options: { redirectTo }
    })
    return { data, error }
  }

  // ---------------------------
  // PROFILE (public.users)
  // ---------------------------
  const ensurePublicUserRow = async (authUser) => {
    if (!authUser?.id) return { data: null, error: null }

    const meta = authUser.user_metadata || {}

    const { data: existing, error: exErr } = await supabase
      .from('users')
      .select('id, email, first_name, last_name')
      .eq('id', authUser.id)
      .maybeSingle()

    if (exErr) return { data: null, error: exErr }

    const firstFromMeta = meta.given_name ?? meta.first_name
    const lastFromMeta = meta.family_name ?? meta.last_name

    const payload = compact({
      id: authUser.id,
      email: existing?.email ?? authUser.email ?? null,
      first_name: existing?.first_name ? undefined : firstFromMeta ?? undefined,
      last_name: existing?.last_name ? undefined : lastFromMeta ?? undefined
    })

    const { data, error } = await supabase.from('users').upsert(payload, { onConflict: 'id' }).select().single()
    return { data, error }
  }

  const getMyPublicUser = async () => {
    const { user } = await getUser()
    if (!user) return { data: null, error: null }

    const { data, error } = await supabase.from('users').select('*').eq('id', user.id).single()
    if (data?.image_path) data.image_path = normalizeStoragePublicUrl(data.image_path)
    return { data, error }
  }

  const updateMyPublicUser = async (patch) => {
    const { user } = await getUser()
    if (!user) return { data: null, error: new Error('No auth user') }

    const safePatch = { ...patch }
    delete safePatch.It_business // ‚ùå –±–∏–∑–Ω–µ—Å –º–µ–Ω—è–µ—à—å —Ç–æ–ª—å–∫–æ –≤—Ä—É—á–Ω—É—é

    for (const k of Object.keys(safePatch)) {
      if (safePatch[k] === '') safePatch[k] = null
    }
    if (safePatch.image_path) safePatch.image_path = normalizeStoragePublicUrl(safePatch.image_path)

    const { data, error } = await supabase.from('users').update(safePatch).eq('id', user.id).select().single()
    if (data?.image_path) data.image_path = normalizeStoragePublicUrl(data.image_path)
    return { data, error }
  }

  // ---------------------------
  // AVATAR UPLOAD
  // ---------------------------
  const uploadAvatar = async (file) => {
    const { user } = await getUser()
    if (!user) return { publicUrl: null, error: new Error('No auth user') }
    if (!file) return { publicUrl: null, error: new Error('No file') }

    const envBucket = (import.meta.env.VITE_SUPABASE_AVATAR_BUCKET || '').trim()
    const buckets = [...new Set([envBucket, 'avatars', 'Biom', 'biom'].filter(Boolean))]

    const ext = (file.name.split('.').pop() || 'png').toLowerCase()
    const path = `ProfileImage/${user.id}/${Date.now()}.${ext}`

    let lastErr = null

    for (const bucket of buckets) {
      const { error: upErr } = await supabase.storage.from(bucket).upload(path, file, { upsert: true })
      if (upErr) {
        lastErr = upErr
        if (String(upErr?.message || '').toLowerCase().includes('bucket not found')) continue
        return { publicUrl: null, error: upErr }
      }

      const { data } = supabase.storage.from(bucket).getPublicUrl(path)
      const publicUrl = normalizeStoragePublicUrl(data?.publicUrl || '')
      return { publicUrl, error: null }
    }

    return {
      publicUrl: null,
      error:
        lastErr ||
        new Error('Bucket not found. –°–æ–∑–¥–∞–π bucket –≤ Storage (–Ω–∞–ø—Ä–∏–º–µ—Ä "avatars") –∏ —É–∫–∞–∂–∏ VITE_SUPABASE_AVATAR_BUCKET.')
    }
  }

  // ---------------------------
  // TELEGRAM (–∫–∞–∫ –±—ã–ª–æ)
  // ---------------------------
  const linkTelegramViaEdgeFunction = async (telegramAuthData) => {
    const { data, error } = await supabase.functions.invoke('telegram-verify', { body: telegramAuthData })
    return { data, error }
  }

  const getMyTelegramLink = async () => {
    const { user } = await getUser()
    if (!user) return { data: null, error: null }

    const { data, error } = await supabase.from('user_telegram').select('*').eq('user_id', user.id).maybeSingle()
    return { data: data ?? null, error }
  }

  return {
    // events
    getEvents,
    getCategories,
    getEventPhotos,
    createBusinessEvent,

    // auth
    getSession,
    getUser,
    signInWithGoogle,
    signOut,

    // profile
    ensurePublicUserRow,
    getMyPublicUser,
    updateMyPublicUser,
    uploadAvatar,

    // telegram
    linkTelegramViaEdgeFunction,
    getMyTelegramLink
  }
}
–ß—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ ‚Äú—É–±—Ä–∞–Ω–æ‚Äù, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏
‚úÖ –í HomeView.vue –≤–æ–æ–±—â–µ –Ω–µ—Ç —Å—Ç–∞—Ä–æ–≥–æ –±–ª–æ–∫–∞:

tags-shell

tags-content

toggleCategory(cat.id) –∏ —Ñ–∏–ª—å—Ç—Ä –ø–æ cat.id

–¢–æ –µ—Å—Ç—å —Å—Ç–∞—Ä—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã —Ñ–∏–∑–∏—á–µ—Å–∫–∏ –∏—Å—á–µ–∑–ª–∏ ‚Äî –Ω–µ–æ—Ç–∫—É–¥–∞ –∏–º ‚Äú–æ—Å—Ç–∞—Ç—å—Å—è‚Äù.

–í–∞–∂–Ω–æ –ø—Ä–æ ‚Äú—Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è –æ—Å—Ç–∞–ª–∞—Å—å‚Äù
–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ –º–æ–∂–µ—Ç –¥–µ—Ä–∂–∞—Ç—å—Å—è —Å—Ç–∞—Ä—ã–π –∫–µ—à. –ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:

–û—Ç–∫—Ä–æ–π —Å–∞–π—Ç ‚Üí Ctrl+F5

–ò–ª–∏ –≤ DevTools ‚Üí Network ‚Üí Disable cache –∏ –æ–±–Ω–æ–≤–∏

–ï—Å–ª–∏ –µ—Å—Ç—å service worker/PWA ‚Äî –Ω—É–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å (–µ—Å–ª–∏ –Ω–µ –¥–µ–ª–∞–ª, —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –Ω–µ—Ç)

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å, —è —Å–ª–µ–¥—É—é—â–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º –¥–∞–º —Ç–æ—á–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, —á—Ç–æ —Ä–µ–∞–ª—å–Ω–æ –∑–∞–¥–µ–ø–ª–æ–∏–ª—Å—è –Ω–æ–≤—ã–π dist (–ø—Ä–æ–≤–µ—Ä–∏–º –ø–æ —Ö—ç—à—É/–¥–∞—Ç–∞–º —Ñ–∞–π–ª–æ–≤), —á—Ç–æ–±—ã –∏—Å–∫–ª—é—á–∏—Ç—å —Å–∏—Ç—É–∞—Ü–∏—é ‚Äú—Å–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è –Ω–µ –≤ —Ç—É –ø–∞–ø–∫—É –∫–æ–ø–∏—Ä—É–µ—Ç‚Äù.


–í—ã —Å–∫–∞–∑–∞–ª–∏:
—Å–º–æ—Ç—Ä–∏, –≤–æ—Ç —Ç–∞–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞, –µ—Å–ª–∏ –≤—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞ –∏ –≤–æ–π—Ç–∏, —Ç–æ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è —Å filters-shell, –µ—ë –≤–æ–æ–±—â–µ —É–±—Ä–∞—Ç—å –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–ª–∞—Å—å –≤–µ—Ä—Å–∏—è –Ω–æ–≤–∞—è - —Å drawer-root ,—ç—Ç–æ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è, –≤–æ—Ç –µ—ë –Ω—É–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å. –≤—ã–ø–∏—à–∏ –≤–µ—Å—å –∫–æ–¥

ChatGPT —Å–∫–∞–∑–∞–ª:

–î—É–º–∞–ª –Ω–∞ –ø—Ä–æ—Ç—è–∂–µ–Ω–∏–∏ 1m 55s
–ü–æ–Ω—è–ª. –°—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Ç–æ–º—É, —á—Ç–æ –≤ –ø—Ä–æ–µ–∫—Ç–µ —Ä–µ–∞–ª—å–Ω–æ –æ—Å—Ç–∞–ª—Å—è —Å—Ç–∞—Ä—ã–π HomeView.vue —Å –±–ª–æ–∫–æ–º tags-shell (—ç—Ç–æ –∏ –µ—Å—Ç—å ‚Äúfilters-shell‚Äù) ‚Äî –æ–Ω –Ω–∏–∫—É–¥–∞ –Ω–µ –¥–µ–ª—Å—è, –∏ –ø–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞/—Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ —Ç—ã —Å–Ω–æ–≤–∞ –ø–æ–ø–∞–¥–∞–µ—à—å –Ω–∞ /, –≥–¥–µ —Ä–µ–Ω–¥–µ—Ä–∏—Ç—Å—è —ç—Ç–æ—Ç —Ñ–∞–π–ª.

‚úÖ –†–µ—à–µ–Ω–∏–µ: –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–º–µ–Ω–∏—Ç—å HomeView.vue –Ω–∞ –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é –¢–û–õ–¨–ö–û —Å drawer-root –∏ –≤–æ–æ–±—â–µ —É–¥–∞–ª–∏—Ç—å tags-shell/tags-content.
–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —É–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ: —Ñ–∏–ª—å—Ç—Ä—ã –∂–∏–≤—É—Ç –≤ –æ–¥–Ω–æ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ FiltersPanel.vue, –∞ ‚Äú–¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ‚Äù ‚Äî –≤ –æ–¥–Ω–æ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ CreateEventModal.vue.

–ù–∏–∂–µ ‚Äî –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–æ–¥ (4 —Ñ–∞–π–ª–∞). –ü—Ä–æ—Å—Ç–æ –∑–∞–º–µ–Ω–∏/—Å–æ–∑–¥–∞–π —Ä–æ–≤–Ω–æ —Ç–∞–∫.

1) src/views/HomeView.vue ‚Äî –ó–ê–ú–ï–ù–ò–¢–¨ –ü–û–õ–ù–û–°–¢–¨–Æ (—Å—Ç–∞—Ä—ã–π tags-shell —É–¥–∞–ª—ë–Ω)
<template>
  <div class="page">
    <div class="container">
      <!-- TOP BAR -->
      <div class="topbar">
        <div class="topbar-left">
          <div class="page-title">–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</div>
          <div class="page-sub">
            <span v-if="initialLoaded">{{ filteredEvents.length }}</span>
            <span v-else>‚Ä¶</span>
          </div>
        </div>

        <!-- FILTER BUTTON -->
        <button class="filter-btn" @click="openDrawer" aria-label="–û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é —Ñ–∏–ª—å—Ç—Ä–æ–≤">
          <svg viewBox="0 0 24 24" class="filter-icon" aria-hidden="true">
            <path d="M3 5h18l-7 8v5l-4 2v-7L3 5z" fill="currentColor" />
          </svg>
          <span class="filter-btn-text">–§–∏–ª—å—Ç—Ä—ã</span>
        </button>
      </div>

      <!-- STATES -->
      <div v-if="!initialLoaded" class="state">
        <div class="spinner"></div>
        <div>–ó–∞–≥—Ä—É–∑–∫–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π‚Ä¶</div>
      </div>

      <div v-else-if="error" class="state error">
        <div class="error-title">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</div>
        <div class="error-sub">{{ error }}</div>
        <button class="retry" @click="reload">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
      </div>

      <div v-else-if="filteredEvents.length === 0" class="state">
        –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
      </div>

      <!-- EVENTS -->
      <div v-else class="events-shell">
        <TransitionGroup name="list" tag="div" class="events-list">
          <EventCard
            v-for="event in filteredEvents"
            :key="event.id"
            :event="event"
            :photos="photos[event.id] || []"
            :photos-loading="photosLoading"
            :category-map="categoryMap"
            @open-photo="openPhoto"
          />
        </TransitionGroup>
      </div>
    </div>

    <!-- DRAWER -->
    <teleport to="body">
      <div v-if="drawerOpen" class="drawer-root" @keydown.esc="closeDrawer" tabindex="-1">
        <div class="overlay" @click="closeDrawer"></div>

        <aside class="drawer" role="dialog" aria-modal="true" aria-label="–§–∏–ª—å—Ç—Ä—ã">
          <div class="drawer-head">
            <div class="drawer-title">–ú–µ–Ω—é</div>
            <button class="close-btn" @click="closeDrawer" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
          </div>

          <div class="drawer-body">
            <!-- Business block -->
            <div class="biz-card">
              <div class="biz-top">
                <div class="biz-title">Business –∞–∫–∫–∞—É–Ω—Ç</div>
                <span v-if="isBusiness" class="biz-badge">–ê–∫—Ç–∏–≤–µ–Ω</span>
                <span v-else class="biz-badge off">–ù–µ –∞–∫—Ç–∏–≤–µ–Ω</span>
              </div>

              <div class="biz-text" v-if="isBusiness">
                –¢—ã –º–æ–∂–µ—à—å –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –≤ –ø—Ä–µ–¥–ª–æ–∂–∫—É. –û–Ω–∏ –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∞–¥–º–∏–Ω–æ–º
                (—É —Å–æ–±—ã—Ç–∏—è –±—É–¥–µ—Ç <b>is_published=true</b>).
              </div>
              <div class="biz-text" v-else>
                Business –¥–∞—Å—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è. –ü–æ–∫–∞ —Å—Ç–∞—Ç—É—Å –º–µ–Ω—è–µ—Ç—Å—è –≤—Ä—É—á–Ω—É—é –≤ –±–∞–∑–µ.
              </div>

              <button v-if="isBusiness" class="biz-btn" @click="openCreateModal">
                ‚ûï –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ
              </button>
            </div>

            <!-- Filters -->
            <FiltersPanel
              :categories="categories"
              :is-all-categories-active="isAllCategoriesActive"
              v-model:selectedCategoryNames="selectedCategoryNames"
              v-model:onlineOnly="onlineOnly"
              v-model:priceMode="priceMode"
              v-model:customPriceMin="customPriceMin"
              v-model:customPriceMax="customPriceMax"
              v-model:dateMode="dateMode"
              v-model:dateOn="dateOn"
              v-model:dateFrom="dateFrom"
              v-model:dateTo="dateTo"
              v-model:datePivot="datePivot"
              @reset="resetAllFilters"
            />

            <div v-if="toast" class="toast">{{ toast }}</div>
          </div>

          <div class="drawer-foot">
            <button class="apply-btn" @click="closeDrawer">–ü–æ–∫–∞–∑–∞—Ç—å</button>
          </div>
        </aside>
      </div>
    </teleport>

    <!-- CREATE EVENT MODAL -->
    <CreateEventModal
      :open="createOpen"
      :categories="categories"
      :create-business-event="createBusinessEvent"
      @close="createOpen = false"
      @created="onCreatedDraft"
    />

    <!-- PHOTO MODAL -->
    <EventPhotoModal v-if="photoModalUrl" :url="photoModalUrl" @close="photoModalUrl = ''" />
  </div>
</template>

<script>
import { ref, computed, onMounted, onBeforeUnmount, nextTick } from 'vue'
import EventCard from '../../components/EventCard.vue'
import EventPhotoModal from '../../components/EventPhotoModal.vue'
import FiltersPanel from '../../components/FiltersPanel.vue'
import CreateEventModal from '../../components/CreateEventModal.vue'
import { useSupabase } from '../../composables/useSupabase'

/** –µ–¥–∏–Ω—ã–µ —É—Ç–∏–ª–∏—Ç—ã, –±–µ–∑ –¥—É–±–ª–µ–π */
const sleep = (ms) => new Promise((r) => setTimeout(r, ms))

const withRetry = async (fn, tries = 3) => {
  let lastErr = null
  for (let i = 0; i < tries; i++) {
    try {
      return await fn()
    } catch (e) {
      lastErr = e
      await sleep(350 * (i + 1))
    }
  }
  throw lastErr
}

const toNumberOrNull = (v) => {
  if (v === null || v === undefined) return null
  const n = Number(v)
  return Number.isFinite(n) ? n : null
}

const parseEventDate = (value) => {
  if (!value) return null
  const d = new Date(value)
  if (Number.isNaN(d.getTime())) return null
  return d
}

const parseDateInput = (yyyy_mm_dd) => {
  if (!yyyy_mm_dd) return null
  const [y, m, day] = yyyy_mm_dd.split('-').map((x) => Number(x))
  if (!y || !m || !day) return null
  return new Date(y, m - 1, day)
}

const startOfDay = (d) => new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0, 0, 0, 0)
const endOfDay = (d) => new Date(d.getFullYear(), d.getMonth(), d.getDate(), 23, 59, 59, 999)

/**
 * selectCategory –º–æ–∂–µ—Ç –±—ã—Ç—å:
 * - –º–∞—Å—Å–∏–≤ –∏–º—ë–Ω
 * - —Å—Ç—Ä–æ–∫–∞ "—Å–ø–æ—Ä—Ç,–µ–¥–∞"
 * - –∏–Ω–æ–≥–¥–∞ id -> –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —á–µ—Ä–µ–∑ categoryMap
 */
const normalizeCategoryNames = (raw, categoryMap) => {
  const map = categoryMap || {}

  const toName = (v) => {
    if (v === null || v === undefined) return ''
    const s = String(v).trim()
    if (!s) return ''
    if (map[s]) return String(map[s]).trim()
    const n = Number(s)
    if (!Number.isNaN(n) && map[String(n)]) return String(map[String(n)]).trim()
    return s
  }

  if (!raw) return []
  if (Array.isArray(raw)) return Array.from(new Set(raw.map(toName).filter(Boolean)))

  if (typeof raw === 'string') {
    const s = raw.trim()
    if (!s) return []
    return Array.from(
      new Set(
        s
          .split(/[,;|]+/g)
          .map((x) => x.trim())
          .filter(Boolean)
          .map(toName)
          .filter(Boolean)
      )
    )
  }

  const one = toName(raw)
  return one ? [one] : []
}

export default {
  name: 'HomeView',
  components: { EventCard, EventPhotoModal, FiltersPanel, CreateEventModal },
  props: {
    globalSearchTerm: { type: String, default: '' }
  },
  setup(props) {
    const { getEvents, getCategories, getEventPhotos, getMyPublicUser, createBusinessEvent } = useSupabase()

    const initialLoaded = ref(false)
    const error = ref(null)

    const allEvents = ref([])
    const visibleEvents = ref([]) // –ø–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ
    const photos = ref({})

    const categories = ref([])
    const categoryMap = ref({}) // id -> name

    const myProfile = ref(null)
    const isBusiness = computed(() => myProfile.value?.It_business === true)

    // filters
    const selectedCategoryNames = ref([])
    const onlineOnly = ref(false)

    const priceMode = ref('all')
    const customPriceMin = ref('')
    const customPriceMax = ref('')

    const dateMode = ref('all')
    const dateOn = ref('')
    const dateFrom = ref('')
    const dateTo = ref('')
    const datePivot = ref('')

    const isAllCategoriesActive = computed(() => selectedCategoryNames.value.length === 0)

    // ui
    const drawerOpen = ref(false)
    const createOpen = ref(false)

    const photoModalUrl = ref('')
    const openPhoto = (url) => {
      if (!url) return
      photoModalUrl.value = url
    }

    const toast = ref('')
    let toastTimer = null
    const showToast = (msg) => {
      toast.value = msg
      if (toastTimer) clearTimeout(toastTimer)
      toastTimer = setTimeout(() => (toast.value = ''), 3200)
    }

    // progressive list
    let progressiveTimer = null
    const stopProgressive = () => {
      if (progressiveTimer) clearInterval(progressiveTimer)
      progressiveTimer = null
    }

    const startProgressive = (list) => {
      stopProgressive()
      visibleEvents.value = []
      const src = Array.isArray(list) ? list : []
      if (!src.length) return

      visibleEvents.value.push(src[0])
      let i = 1
      progressiveTimer = setInterval(() => {
        if (i >= src.length) {
          stopProgressive()
          return
        }
        visibleEvents.value.push(src[i])
        i++
      }, 140)
    }

    // drawer
    const openDrawer = async () => {
      drawerOpen.value = true
      await nextTick()
      document.documentElement.style.overflow = 'hidden'
      document.body.style.overflow = 'hidden'
    }

    const closeDrawer = () => {
      drawerOpen.value = false
      document.documentElement.style.overflow = ''
      document.body.style.overflow = ''
    }

    const openCreateModal = () => {
      if (!isBusiness.value) return
      createOpen.value = true
    }

    const onCreatedDraft = () => {
      showToast('‚úÖ –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ. –û–Ω–æ –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∞–¥–º–∏–Ω–æ–º.')
    }

    const resetAllFilters = () => {
      selectedCategoryNames.value = []
      onlineOnly.value = false

      priceMode.value = 'all'
      customPriceMin.value = ''
      customPriceMax.value = ''

      dateMode.value = 'all'
      dateOn.value = ''
      dateFrom.value = ''
      dateTo.value = ''
      datePivot.value = ''
    }

    // filtering
    const matchesCategories = (event) => {
      if (selectedCategoryNames.value.length === 0) return true
      const eventCats = normalizeCategoryNames(event?.selectCategory, categoryMap.value)
      if (!eventCats.length) return false
      const set = new Set(selectedCategoryNames.value)
      return eventCats.some((c) => set.has(c))
    }

    const matchesOnline = (event) => {
      if (!onlineOnly.value) return true
      return event?.is_online === true
    }

    const getEventPrice = (event) => {
      if (event?.is_free === true) return 0
      const p = toNumberOrNull(event?.price)
      if (p === null) return null
      return p
    }

    const matchesPrice = (event) => {
      const mode = priceMode.value
      if (mode === 'all') return true

      const price = getEventPrice(event)
      if (mode === 'free') return price === 0
      if (price === null) return false

      if (mode === '100_1000') return price >= 100 && price <= 1000
      if (mode === '1000_3000') return price >= 1000 && price <= 3000
      if (mode === '3000_10000') return price >= 3000 && price <= 10000
      if (mode === 'gt_10000') return price > 10000

      if (mode === 'custom') {
        const min = customPriceMin.value === '' ? null : toNumberOrNull(customPriceMin.value)
        const max = customPriceMax.value === '' ? null : toNumberOrNull(customPriceMax.value)
        const okMin = min === null ? true : price >= min
        const okMax = max === null ? true : price <= max
        return okMin && okMax
      }

      return true
    }

    const matchesDate = (event) => {
      const mode = dateMode.value
      if (mode === 'all') return true

      const d = parseEventDate(event?.date_time_event)
      if (!d) return false

      if (mode === 'today') {
        const now = new Date()
        return d >= startOfDay(now) && d <= endOfDay(now)
      }

      if (mode === 'next7') {
        const now = new Date()
        const from = startOfDay(now)
        const to = endOfDay(new Date(now.getFullYear(), now.getMonth(), now.getDate() + 7))
        return d >= from && d <= to
      }

      if (mode === 'on') {
        const on = parseDateInput(dateOn.value)
        if (!on) return true
        return d >= startOfDay(on) && d <= endOfDay(on)
      }

      if (mode === 'range') {
        const fromD = parseDateInput(dateFrom.value)
        const toD = parseDateInput(dateTo.value)
        if (!fromD && !toD) return true
        const from = fromD ? startOfDay(fromD) : null
        const to = toD ? endOfDay(toD) : null
        const okFrom = from ? d >= from : true
        const okTo = to ? d <= to : true
        return okFrom && okTo
      }

      if (mode === 'after') {
        const pivot = parseDateInput(datePivot.value)
        if (!pivot) return true
        return d >= startOfDay(pivot)
      }

      if (mode === 'before') {
        const pivot = parseDateInput(datePivot.value)
        if (!pivot) return true
        return d <= endOfDay(pivot)
      }

      return true
    }

    const matchesSearch = (event) => {
      const term = (props.globalSearchTerm || '').trim().toLowerCase()
      if (!term) return true
      const t = (event.title || '').toLowerCase()
      const desc = (event.description || '').toLowerCase()
      const a = (event.address || '').toLowerCase()
      const o = (event.organizer || '').toLowerCase()
      return t.includes(term) || desc.includes(term) || a.includes(term) || o.includes(term)
    }

    const filteredEvents = computed(() => {
      return visibleEvents.value.filter(
        (e) => matchesCategories(e) && matchesOnline(e) && matchesPrice(e) && matchesDate(e) && matchesSearch(e)
      )
    })

    // loading
    const photosLoading = ref(false)
    const stopPhotosLoading = ref(false)

    const loadCategories = async () => {
      const { data, error: err } = await withRetry(() => getCategories())
      if (err) throw err
      categories.value = data ?? []
      categoryMap.value = (categories.value || []).reduce((acc, c) => {
        acc[String(c.id)] = c.name
        return acc
      }, {})
    }

    const loadProfile = async () => {
      const { data } = await getMyPublicUser()
      myProfile.value = data
    }

    const loadEventsProgressive = async () => {
      error.value = null
      stopPhotosLoading.value = true
      photosLoading.value = false
      stopProgressive()

      try {
        const { data: eventsData, error: eventsErr } = await withRetry(() => getEvents())
        if (eventsErr) throw eventsErr

        allEvents.value = eventsData ?? []
        initialLoaded.value = true
        startProgressive(allEvents.value)

        // photos background
        photos.value = {}
        stopPhotosLoading.value = false

        const ids = allEvents.value.map((e) => e.id).filter(Boolean)
        if (!ids.length) return

        photosLoading.value = true
        const batchSize = 5

        for (let i = 0; i < ids.length; i += batchSize) {
          if (stopPhotosLoading.value) break
          const batch = ids.slice(i, i + batchSize)

          const { data: ph, error: phErr } = await withRetry(() => getEventPhotos(batch))
          if (!phErr) {
            const next = { ...photos.value }
            for (const p of ph ?? []) {
              if (!p?.event_id) continue
              if (!next[p.event_id]) next[p.event_id] = []
              next[p.event_id].push(p)
            }
            photos.value = next
          }

          await sleep(120)
        }
      } catch (e) {
        allEvents.value = []
        visibleEvents.value = []
        photos.value = {}
        initialLoaded.value = true
        error.value = e?.message ? String(e.message) : 'TypeError: Failed to fetch'
      } finally {
        photosLoading.value = false
      }
    }

    const reload = async () => {
      await loadProfile()
      await loadEventsProgressive()
    }

    onMounted(async () => {
      try {
        await loadCategories()
      } catch (e) {
        categories.value = []
        categoryMap.value = {}
      }
      await loadProfile()
      await loadEventsProgressive()
    })

    onBeforeUnmount(() => {
      stopProgressive()
      stopPhotosLoading.value = true
      if (toastTimer) clearTimeout(toastTimer)
      document.documentElement.style.overflow = ''
      document.body.style.overflow = ''
    })

    return {
      initialLoaded,
      error,

      categories,
      categoryMap,

      isBusiness,

      selectedCategoryNames,
      isAllCategoriesActive,

      onlineOnly,
      priceMode,
      customPriceMin,
      customPriceMax,

      dateMode,
      dateOn,
      dateFrom,
      dateTo,
      datePivot,

      photos,
      photosLoading,

      filteredEvents,

      drawerOpen,
      openDrawer,
      closeDrawer,

      createOpen,
      openCreateModal,

      createBusinessEvent,
      onCreatedDraft,

      resetAllFilters,
      reload,

      toast,

      photoModalUrl,
      openPhoto
    }
  }
}
</script>

<style scoped>
.page { padding: 16px 0 40px; }
.container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }

.topbar { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
.topbar-left { display: flex; flex-direction: column; gap: 2px; }
.page-title { font-weight: 900; font-size: 18px; }
.page-sub { font-size: 12px; opacity: .65; font-weight: 700; }

.filter-btn {
  margin-left: auto;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  border: 1px solid #efefef;
  background: #fff;
  border-radius: 14px;
  padding: 10px 12px;
  cursor: pointer;
  box-shadow: 0 2px 10px rgba(0,0,0,0.04);
}
.filter-btn:hover { background: #fafafa; }
.filter-icon { width: 18px; height: 18px; opacity: .9; }
.filter-btn-text { font-size: 13px; font-weight: 800; }

.state { display: grid; place-items: center; gap: 10px; padding: 40px 0; opacity: .75; text-align: center; }
.state.error { opacity: 1; color: #d9534f; }
.error-title { font-weight: 800; }
.error-sub { font-size: 12px; opacity: .8; max-width: 680px; }
.retry { margin-top: 8px; border: none; border-radius: 12px; padding: 10px 14px; cursor: pointer; background: #efefef; }

.spinner {
  width: 26px; height: 26px; border-radius: 50%;
  border: 3px solid #eee; border-top-color: #8a75e3;
  animation: spin .8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

.events-shell {
  background: #fff;
  border: 1px solid #efefef;
  border-radius: 18px;
  padding: 14px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.04);
}
.events-list { display: flex; flex-direction: column; gap: 12px; }

.list-enter-active, .list-leave-active { transition: opacity 240ms ease, transform 240ms ease; }
.list-enter-from, .list-leave-to { opacity: 0; transform: translateY(8px); }

/* DRAWER */
.drawer-root { position: fixed; inset: 0; z-index: 9999; }
.overlay { position: absolute; inset: 0; background: rgba(0,0,0,.35); backdrop-filter: blur(2px); }

.drawer {
  position: absolute; top: 0; right: 0; height: 100%;
  width: min(420px, 92vw);
  background: #fff;
  border-left: 1px solid #efefef;
  box-shadow: -10px 0 30px rgba(0,0,0,0.12);
  display: flex; flex-direction: column;
  animation: slideIn 180ms ease;
}
@keyframes slideIn { from { transform: translateX(18px); opacity: .7; } to { transform: translateX(0); opacity: 1; } }

.drawer-head {
  display: flex; align-items: center; gap: 10px;
  padding: 14px;
  border-bottom: 1px solid #f2f2f2;
}
.drawer-title { font-weight: 900; font-size: 16px; }
.close-btn {
  margin-left: auto;
  border: 1px solid #efefef;
  background: #fafafa;
  border-radius: 12px;
  padding: 8px 10px;
  cursor: pointer;
}

.drawer-body { padding: 14px; overflow: auto; display: flex; flex-direction: column; gap: 12px; }
.drawer-foot { padding: 14px; border-top: 1px solid #f2f2f2; display: flex; justify-content: flex-end; }

.apply-btn {
  border: none;
  background: #8a75e3;
  color: #fff;
  border-radius: 14px;
  padding: 12px 16px;
  font-weight: 900;
  cursor: pointer;
}
.apply-btn:hover { filter: brightness(.97); }

/* Business */
.biz-card {
  background: #fcfcff;
  border: 1px solid rgba(138,117,227,.18);
  border-radius: 16px;
  padding: 12px;
  display: grid;
  gap: 10px;
}
.biz-top { display: flex; align-items: center; gap: 10px; }
.biz-title { font-weight: 900; }
.biz-badge {
  margin-left: auto;
  font-size: 12px;
  font-weight: 900;
  padding: 6px 10px;
  border-radius: 999px;
  background: rgba(0, 200, 120, .12);
  border: 1px solid rgba(0, 200, 120, .22);
}
.biz-badge.off { background: rgba(180,180,180,.16); border-color: rgba(180,180,180,.28); }
.biz-text { font-size: 12px; opacity: .8; line-height: 1.25; }
.biz-btn {
  border: none;
  border-radius: 14px;
  padding: 11px 12px;
  font-weight: 900;
  cursor: pointer;
  background: #8a75e3;
  color: #fff;
}
.biz-btn:hover { filter: brightness(.98); }

.toast {
  position: sticky;
  bottom: 10px;
  background: #111;
  color: #fff;
  border-radius: 14px;
  padding: 10px 12px;
  font-weight: 800;
  font-size: 13px;
  opacity: .92;
}
</style>
2) src/components/FiltersPanel.vue ‚Äî –°–û–ó–î–ê–¢–¨ (–µ–¥–∏–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Ñ–∏–ª—å—Ç—Ä–æ–≤)
<template>
  <div class="panel">
    <div class="head">
      <div class="title">–§–∏–ª—å—Ç—Ä—ã</div>
      <button class="reset" @click="$emit('reset')">–°–±—Ä–æ—Å–∏—Ç—å</button>
    </div>

    <!-- Categories -->
    <div class="block">
      <div class="label">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</div>

      <div class="tags">
        <button class="tag" :class="{ active: isAllCategoriesActive }" @click="selectAllCategories">
          –í—Å–µ
        </button>

        <button
          v-for="cat in categories"
          :key="cat.id"
          class="tag"
          :class="{ active: selectedCategoryNames.includes(cat.name) }"
          @click="toggleCategory(cat.name)"
        >
          {{ cat.name }}
        </button>
      </div>
    </div>

    <!-- Online -->
    <div class="block inline">
      <label class="check">
        <input type="checkbox" :checked="onlineOnly" @change="onToggleOnline" />
        <span class="ui"></span>
        <span class="text">–¢–æ–ª—å–∫–æ –æ–Ω–ª–∞–π–Ω</span>
      </label>
      <div class="hint">–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è, –≥–¥–µ <b>is_online=true</b>.</div>
    </div>

    <div class="grid">
      <!-- PRICE -->
      <div class="card">
        <div class="cardTitle">–¶–µ–Ω–∞</div>

        <div class="seg">
          <button class="segBtn" :class="{ active: priceMode === 'all' }" @click="setPriceMode('all')">–õ—é–±–∞—è</button>
          <button class="segBtn" :class="{ active: priceMode === 'free' }" @click="setPriceMode('free')">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ</button>
          <button class="segBtn" :class="{ active: priceMode === 'custom' }" @click="setPriceMode('custom')">–°–≤–æ–π –¥–∏–∞–ø–∞–∑–æ–Ω</button>
        </div>

        <div class="chips">
          <button class="chip" :class="{ active: priceMode === '100_1000' }" @click="setPriceMode('100_1000')">100‚Äì1000</button>
          <button class="chip" :class="{ active: priceMode === '1000_3000' }" @click="setPriceMode('1000_3000')">1000‚Äì3000</button>
          <button class="chip" :class="{ active: priceMode === '3000_10000' }" @click="setPriceMode('3000_10000')">3000‚Äì10000</button>
          <button class="chip" :class="{ active: priceMode === 'gt_10000' }" @click="setPriceMode('gt_10000')">&gt; 10000</button>
        </div>

        <div v-if="priceMode === 'custom'" class="row">
          <div class="field">
            <div class="fieldLabel">–æ—Ç</div>
            <input
              class="input"
              type="number"
              min="0"
              inputmode="numeric"
              placeholder="0"
              :value="customPriceMin"
              @input="$emit('update:customPriceMin', $event.target.value)"
            />
          </div>

          <div class="field">
            <div class="fieldLabel">–¥–æ</div>
            <input
              class="input"
              type="number"
              min="0"
              inputmode="numeric"
              placeholder="‚àû"
              :value="customPriceMax"
              @input="$emit('update:customPriceMax', $event.target.value)"
            />
          </div>
        </div>

        <div class="hint">
          –ï—Å–ª–∏ <b>is_free=true</b> –∏–ª–∏ <b>price=0</b> ‚Äî —ç—Ç–æ ‚Äú–ë–µ—Å–ø–ª–∞—Ç–Ω–æ‚Äù.
        </div>
      </div>

      <!-- DATE -->
      <div class="card">
        <div class="cardTitle">–î–∞—Ç–∞</div>

        <div class="seg">
          <button class="segBtn" :class="{ active: dateMode === 'all' }" @click="setDateMode('all')">–í—Å—ë –≤—Ä–µ–º—è</button>
          <button class="segBtn" :class="{ active: dateMode === 'on' }" @click="setDateMode('on')">–ù–∞ –¥–∞—Ç—É</button>
          <button class="segBtn" :class="{ active: dateMode === 'range' }" @click="setDateMode('range')">–î–∏–∞–ø–∞–∑–æ–Ω</button>
        </div>

        <div class="chips">
          <button class="chip" :class="{ active: dateMode === 'after' }" @click="setDateMode('after')">–ü–æ—Å–ª–µ</button>
          <button class="chip" :class="{ active: dateMode === 'before' }" @click="setDateMode('before')">–î–æ</button>
          <button class="chip" :class="{ active: dateMode === 'next7' }" @click="setDateMode('next7')">–°–ª–µ–¥. 7 –¥–Ω–µ–π</button>
          <button class="chip" :class="{ active: dateMode === 'today' }" @click="setDateMode('today')">–°–µ–≥–æ–¥–Ω—è</button>
        </div>

        <div v-if="dateMode === 'on'" class="row">
          <div class="field grow">
            <div class="fieldLabel">–î–∞—Ç–∞</div>
            <input class="input" type="date" :value="dateOn" @input="$emit('update:dateOn', $event.target.value)" />
          </div>
        </div>

        <div v-else-if="dateMode === 'range'" class="row">
          <div class="field grow">
            <div class="fieldLabel">—Å</div>
            <input class="input" type="date" :value="dateFrom" @input="$emit('update:dateFrom', $event.target.value)" />
          </div>
          <div class="field grow">
            <div class="fieldLabel">–ø–æ</div>
            <input class="input" type="date" :value="dateTo" @input="$emit('update:dateTo', $event.target.value)" />
          </div>
        </div>

        <div v-else-if="dateMode === 'after'" class="row">
          <div class="field grow">
            <div class="fieldLabel">–ü–æ—Å–ª–µ</div>
            <input class="input" type="date" :value="datePivot" @input="$emit('update:datePivot', $event.target.value)" />
          </div>
        </div>

        <div v-else-if="dateMode === 'before'" class="row">
          <div class="field grow">
            <div class="fieldLabel">–î–æ</div>
            <input class="input" type="date" :value="datePivot" @input="$emit('update:datePivot', $event.target.value)" />
          </div>
        </div>

        <div class="hint">–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ <b>date_time_event</b>.</div>
      </div>
    </div>
  </div>
</template>

<script>
export default {
  name: 'FiltersPanel',
  emits: [
    'reset',
    'update:selectedCategoryNames',
    'update:onlineOnly',
    'update:priceMode',
    'update:customPriceMin',
    'update:customPriceMax',
    'update:dateMode',
    'update:dateOn',
    'update:dateFrom',
    'update:dateTo',
    'update:datePivot'
  ],
  props: {
    categories: { type: Array, default: () => [] },

    selectedCategoryNames: { type: Array, default: () => [] },
    isAllCategoriesActive: { type: Boolean, default: true },

    onlineOnly: { type: Boolean, default: false },

    priceMode: { type: String, default: 'all' },
    customPriceMin: { type: String, default: '' },
    customPriceMax: { type: String, default: '' },

    dateMode: { type: String, default: 'all' },
    dateOn: { type: String, default: '' },
    dateFrom: { type: String, default: '' },
    dateTo: { type: String, default: '' },
    datePivot: { type: String, default: '' }
  },
  methods: {
    selectAllCategories() {
      this.$emit('update:selectedCategoryNames', [])
    },
    toggleCategory(name) {
      const n = String(name || '').trim()
      if (!n) return
      const next = [...this.selectedCategoryNames]
      const idx = next.indexOf(n)
      if (idx >= 0) next.splice(idx, 1)
      else next.push(n)
      this.$emit('update:selectedCategoryNames', next)
    },
    onToggleOnline(e) {
      this.$emit('update:onlineOnly', !!e.target.checked)
    },
    setPriceMode(mode) {
      this.$emit('update:priceMode', mode)
    },
    setDateMode(mode) {
      this.$emit('update:dateMode', mode)
    }
  }
}
</script>

<style scoped>
.panel { display: flex; flex-direction: column; gap: 12px; }

.head { display: flex; align-items: center; gap: 12px; }
.title { font-weight: 900; font-size: 16px; }
.reset {
  margin-left: auto;
  border: 1px solid #efefef;
  background: #fafafa;
  border-radius: 12px;
  padding: 8px 10px;
  cursor: pointer;
  font-size: 13px;
}
.reset:hover { background: #f3f3f3; }

.block { border: 1px solid #f2f2f2; border-radius: 16px; padding: 12px; background: #fcfcfc; }
.inline { display: grid; gap: 8px; }

.label { font-weight: 800; font-size: 13px; opacity: .7; margin-bottom: 10px; }

.tags { display: flex; flex-wrap: wrap; gap: 10px; }
.tag {
  border: 1px solid #efefef;
  background: #fafafa;
  border-radius: 999px;
  padding: 8px 12px;
  cursor: pointer;
  font-size: 13px;
  white-space: nowrap;
}
.tag.active { background: #8a75e3; border-color: #8a75e3; color: #fff; }

.check { display: inline-flex; align-items: center; gap: 10px; cursor: pointer; user-select: none; }
.check input { display: none; }
.ui {
  width: 44px; height: 26px; border-radius: 999px;
  border: 1px solid #e9e9e9; background: #f3f3f3;
  position: relative; transition: background 180ms ease, border-color 180ms ease;
}
.ui::after {
  content: '';
  width: 22px; height: 22px; border-radius: 999px;
  background: #fff; position: absolute; top: 1px; left: 1px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.08);
  transition: transform 180ms ease;
}
.check input:checked + .ui { background: rgba(138,117,227,0.85); border-color: rgba(138,117,227,0.55); }
.check input:checked + .ui::after { transform: translateX(18px); }
.text { font-weight: 800; font-size: 13px; }
.hint { font-size: 12px; opacity: .7; line-height: 1.25; }

.grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
.card { border: 1px solid #f2f2f2; border-radius: 16px; padding: 12px; background: #fcfcfc; }
.cardTitle { font-weight: 900; margin-bottom: 10px; }

.seg { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px; }
.segBtn {
  border: 1px solid #efefef;
  background: #fff;
  border-radius: 12px;
  padding: 8px 10px;
  cursor: pointer;
  font-size: 13px;
}
.segBtn.active { background: rgba(138,117,227,0.12); border-color: rgba(138,117,227,0.4); }

.chips { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; }
.chip {
  border: 1px solid #efefef;
  background: #fff;
  border-radius: 999px;
  padding: 7px 10px;
  cursor: pointer;
  font-size: 13px;
}
.chip.active { background: #8a75e3; border-color: #8a75e3; color: #fff; }

.row { display: flex; gap: 10px; align-items: flex-end; }
.field { display: flex; flex-direction: column; gap: 6px; min-width: 120px; }
.field.grow { flex: 1; min-width: 160px; }

.fieldLabel { font-size: 12px; opacity: .7; font-weight: 700; }
.input {
  border: 1px solid #efefef;
  border-radius: 12px;
  padding: 10px 10px;
  font-size: 14px;
  background: #fff;
  outline: none;
}
.input:focus { border-color: rgba(138,117,227,0.55); box-shadow: 0 0 0 3px rgba(138,117,227,0.12); }
</style>
3) src/components/CreateEventModal.vue ‚Äî –°–û–ó–î–ê–¢–¨
<template>
  <teleport to="body">
    <div v-if="open" class="root" @keydown.esc="close" tabindex="-1">
      <div class="overlay" @click="close"></div>

      <div class="modal" role="dialog" aria-modal="true" aria-label="–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ">
        <div class="head">
          <div class="title">–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</div>
          <button class="x" @click="close" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
        </div>

        <div class="body">
          <div class="hint">
            –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–æ —Å <b>is_published=false</b> –∏ —Å—Ç–∞–Ω–µ—Ç –≤–∏–¥–Ω–æ –≤—Å–µ–º –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∞–¥–º–∏–Ω–æ–º.
          </div>

          <div class="grid">
            <div class="field">
              <div class="label">–ù–∞–∑–≤–∞–Ω–∏–µ *</div>
              <input class="input" v-model="form.title" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –í–µ—á–µ—Ä –Ω–∞—Å—Ç–æ–ª–æ–∫" />
            </div>

            <div class="field">
              <div class="label">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è *</div>
              <input class="input" type="datetime-local" v-model="form.date_time_event" />
            </div>

            <div class="field">
              <div class="label">–ê–¥—Ä–µ—Å</div>
              <input class="input" v-model="form.address" placeholder="–ì–æ—Ä–æ–¥, —É–ª–∏—Ü–∞, –¥–æ–º / –∏–ª–∏ —Å—Å—ã–ª–∫–∞ –¥–ª—è –æ–Ω–ª–∞–π–Ω" />
            </div>

            <div class="field">
              <div class="label">–û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä</div>
              <input class="input" v-model="form.organizer" placeholder="–ò–º—è/–ø—Ä–æ–µ–∫—Ç" />
            </div>

            <div class="field">
              <div class="label">–¶–µ–Ω–∞ (‚ÇΩ)</div>
              <input class="input" type="number" min="0" inputmode="numeric" v-model="form.price" placeholder="0" />
              <div class="mini">
                <span class="badge" v-if="isFree">üÜì –ë–µ—Å–ø–ª–∞—Ç–Ω–æ</span>
              </div>
            </div>

            <div class="field inline">
              <label class="check">
                <input type="checkbox" v-model="form.is_online" />
                <span class="ui"></span>
                <span class="text">–û–Ω–ª–∞–π–Ω (is_online)</span>
              </label>
            </div>
          </div>

          <div class="field">
            <div class="label">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</div>
            <div class="tags">
              <button
                v-for="c in categories"
                :key="c.id"
                class="tag"
                :class="{ active: selectedCategories.includes(c.name) }"
                @click="toggleCategory(c.name)"
                type="button"
              >
                {{ c.name }}
              </button>
            </div>
            <div class="mini">–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ.</div>
          </div>

          <div class="field">
            <div class="label">–û–ø–∏—Å–∞–Ω–∏–µ *</div>
            <textarea class="textarea" v-model="form.description" placeholder="–û–ø–∏—à–∏, —á—Ç–æ –±—É–¥–µ—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å"></textarea>
          </div>

          <div class="field">
            <div class="label">–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</div>
            <input class="input" v-model="form.photo_url" placeholder="https://..." />
            <div class="mini">–ï—Å–ª–∏ —É–∫–∞–∂–µ—à—å ‚Äî –¥–æ–±–∞–≤–∏–º –≤ event_photos –∫–∞–∫ –ø–µ—Ä–≤–æ–µ —Ñ–æ—Ç–æ.</div>
          </div>

          <div v-if="error" class="error">{{ error }}</div>
        </div>

        <div class="foot">
          <button class="btn secondary" @click="close">–û—Ç–º–µ–Ω–∞</button>
          <button class="btn primary" :disabled="saving" @click="submit">
            {{ saving ? '–û—Ç–ø—Ä–∞–≤–ª—è—é‚Ä¶' : '–û—Ç–ø—Ä–∞–≤–∏—Ç—å' }}
          </button>
        </div>
      </div>
    </div>
  </teleport>
</template>

<script>
const trimOrNull = (v) => {
  const s = String(v ?? '').trim()
  return s ? s : null
}

export default {
  name: 'CreateEventModal',
  emits: ['close', 'created'],
  props: {
    open: { type: Boolean, default: false },
    categories: { type: Array, default: () => [] },
    createBusinessEvent: { type: Function, required: true }
  },
  data() {
    return {
      saving: false,
      error: '',
      selectedCategories: [],
      form: {
        title: '',
        description: '',
        date_time_event: '',
        address: '',
        organizer: '',
        price: '0',
        is_online: false,
        photo_url: ''
      }
    }
  },
  computed: {
    isFree() {
      const n = Number(this.form.price)
      return Number.isFinite(n) && n <= 0
    }
  },
  methods: {
    close() {
      if (this.saving) return
      this.$emit('close')
    },
    toggleCategory(name) {
      const n = String(name || '').trim()
      if (!n) return
      const idx = this.selectedCategories.indexOf(n)
      if (idx >= 0) this.selectedCategories.splice(idx, 1)
      else this.selectedCategories.push(n)
    },
    async submit() {
      this.error = ''

      const title = trimOrNull(this.form.title)
      const description = trimOrNull(this.form.description)
      const dt = trimOrNull(this.form.date_time_event)

      if (!title) return (this.error = '–£–∫–∞–∂–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ.')
      if (!dt) return (this.error = '–£–∫–∞–∂–∏ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è.')
      if (!description) return (this.error = '–£–∫–∞–∂–∏ –æ–ø–∏—Å–∞–Ω–∏–µ.')

      const priceNum = Number(this.form.price)
      const price = Number.isFinite(priceNum) ? priceNum : 0
      const is_free = price <= 0

      const payload = {
        title,
        description,
        date_time_event: dt,
        address: trimOrNull(this.form.address),
        organizer: trimOrNull(this.form.organizer),
        price,
        is_online: !!this.form.is_online,
        is_free,
        selectCategory: [...this.selectedCategories],
        photo_url: trimOrNull(this.form.photo_url)
      }

      this.saving = true
      try {
        const { data, error } = await this.createBusinessEvent(payload)
        if (error) {
          this.error = String(error.message || error)
          return
        }
        this.$emit('created', data)
        this.$emit('close')

        this.selectedCategories = []
        this.form = {
          title: '',
          description: '',
          date_time_event: '',
          address: '',
          organizer: '',
          price: '0',
          is_online: false,
          photo_url: ''
        }
      } finally {
        this.saving = false
      }
    }
  }
}
</script>

<style scoped>
.root { position: fixed; inset: 0; z-index: 10000; }
.overlay { position: absolute; inset: 0; background: rgba(0,0,0,.38); backdrop-filter: blur(2px); }

.modal {
  position: absolute;
  left: 50%;
  top: 50%;
  width: min(760px, 94vw);
  max-height: 90vh;
  transform: translate(-50%, -50%);
  background: #fff;
  border: 1px solid #efefef;
  border-radius: 18px;
  box-shadow: 0 18px 60px rgba(0,0,0,.18);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.head {
  padding: 14px;
  border-bottom: 1px solid #f2f2f2;
  display: flex;
  align-items: center;
  gap: 12px;
}
.title { font-weight: 900; font-size: 16px; }
.x {
  margin-left: auto;
  border: 1px solid #efefef;
  background: #fafafa;
  border-radius: 12px;
  padding: 8px 10px;
  cursor: pointer;
}

.body {
  padding: 14px;
  overflow: auto;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.hint {
  background: #fcfcff;
  border: 1px solid rgba(138,117,227,.18);
  border-radius: 14px;
  padding: 10px 12px;
  font-size: 13px;
  opacity: .9;
}

.grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
@media (max-width: 720px) { .grid { grid-template-columns: 1fr; } }

.field { display: flex; flex-direction: column; gap: 6px; }
.field.inline { justify-content: flex-end; }

.label { font-size: 12px; font-weight: 800; opacity: .7; }
.input, .textarea {
  border: 1px solid #efefef;
  border-radius: 12px;
  padding: 10px 10px;
  font-size: 14px;
  background: #fff;
  outline: none;
}
.input:focus, .textarea:focus { border-color: rgba(138,117,227,.55); box-shadow: 0 0 0 3px rgba(138,117,227,.12); }
.textarea { min-height: 120px; resize: vertical; }

.mini { font-size: 12px; opacity: .7; }
.badge {
  display: inline-flex;
  align-items: center;
  padding: 6px 10px;
  border-radius: 999px;
  background: rgba(138,117,227,.12);
  border: 1px solid rgba(138,117,227,.22);
  width: fit-content;
}

.tags { display: flex; flex-wrap: wrap; gap: 8px; }
.tag {
  border: 1px solid #efefef;
  background: #fff;
  border-radius: 999px;
  padding: 7px 10px;
  cursor: pointer;
  font-size: 13px;
}
.tag.active { background: #8a75e3; border-color: #8a75e3; color: #fff; }

/* toggle */
.check { display: inline-flex; align-items: center; gap: 10px; cursor: pointer; user-select: none; }
.check input { display: none; }
.ui {
  width: 44px; height: 26px; border-radius: 999px;
  border: 1px solid #e9e9e9; background: #f3f3f3;
  position: relative; transition: background 180ms ease, border-color 180ms ease;
}
.ui::after {
  content: '';
  width: 22px; height: 22px; border-radius: 999px;
  background: #fff; position: absolute; top: 1px; left: 1px;
  box-shadow: 0 2px 10px rgba(0,0,0,.08);
  transition: transform 180ms ease;
}
.check input:checked + .ui { background: rgba(138,117,227,.85); border-color: rgba(138,117,227,.55); }
.check input:checked + .ui::after { transform: translateX(18px); }
.text { font-weight: 800; font-size: 13px; }

.error { color: #d9534f; font-weight: 800; font-size: 13px; }

.foot {
  padding: 14px;
  border-top: 1px solid #f2f2f2;
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}

.btn { border-radius: 14px; padding: 12px 16px; font-weight: 900; cursor: pointer; border: none; }
.btn.secondary { background: #efefef; }
.btn.primary { background: #8a75e3; color: #fff; }
.btn:disabled { opacity: .6; cursor: not-allowed; }
</style>
4) src/composables/useSupabase.js ‚Äî –ó–ê–ú–ï–ù–ò–¢–¨ –ü–û–õ–ù–û–°–¢–¨–Æ (–¥–æ–±–∞–≤–ª–µ–Ω–æ is_published + createBusinessEvent)
import { createClient } from '@supabase/supabase-js'

const supabaseUrl = import.meta.env.VITE_SUPABASE_URL
const supabaseKey = import.meta.env.VITE_SUPABASE_ANON_KEY

export const supabase = createClient(supabaseUrl, supabaseKey)

const normalizeStoragePublicUrl = (url) => {
  if (!url || typeof url !== 'string') return ''
  const u = url.trim()
  if (!u) return ''
  if (u.includes('/storage/v1/object/public/')) return u
  if (u.includes('/storage/v1/object/')) return u.replace('/storage/v1/object/', '/storage/v1/object/public/')
  return u
}

const compact = (obj) => {
  const out = {}
  for (const [k, v] of Object.entries(obj || {})) {
    if (v !== undefined) out[k] = v
  }
  return out
}

export const useSupabase = () => {
  // ---------------------------
  // EVENTS (ONLY PUBLISHED)
  // ---------------------------
  const getEvents = async () => {
    const { data, error } = await supabase
      .from('events')
      .select(
        `
        id,
        title,
        description,
        date_time_event,
        address,
        organizer,
        price,
        is_online,
        is_free,
        user_id,
        selectCategory,
        is_published,
        created_at
      `
      )
      .eq('is_published', true)
      .order('created_at', { ascending: false })

    return { data, error }
  }

  const getCategories = async () => {
    const { data, error } = await supabase.from('category').select('id, name').order('name', { ascending: true })
    return { data, error }
  }

  const getEventPhotos = async (eventIds) => {
    if (!Array.isArray(eventIds) || eventIds.length === 0) return { data: [], error: null }

    const { data, error } = await supabase
      .from('event_photos')
      .select('id, event_id, photo_url')
      .in('event_id', eventIds)
      .order('id', { ascending: true })

    return { data: data ?? [], error }
  }

  // ‚úÖ BUSINESS: create draft event (not published)
  const createBusinessEvent = async (payload) => {
    const { user, error: userErr } = await getUser()
    if (userErr) return { data: null, error: userErr }
    if (!user) return { data: null, error: new Error('–ù–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏') }

    const price = Number(payload?.price ?? 0)
    const is_free = payload?.is_free === true || (Number.isFinite(price) && price <= 0)

    const eventInsert = {
      title: payload?.title ?? null,
      description: payload?.description ?? null,
      date_time_event: payload?.date_time_event ?? null,
      address: payload?.address ?? null,
      organizer: payload?.organizer ?? null,
      price: Number.isFinite(price) ? price : 0,
      is_online: !!payload?.is_online,
      is_free,
      user_id: user.id,
      selectCategory: Array.isArray(payload?.selectCategory) ? payload.selectCategory : [],
      is_published: false
    }

    const { data: eventRow, error: insErr } = await supabase.from('events').insert(eventInsert).select().single()
    if (insErr) return { data: null, error: insErr }

    const photoUrl = String(payload?.photo_url ?? '').trim()
    if (photoUrl) {
      const { error: phErr } = await supabase.from('event_photos').insert({
        event_id: eventRow.id,
        photo_url: photoUrl
      })
      if (phErr) return { data: eventRow, error: phErr }
    }

    return { data: eventRow, error: null }
  }

  // ---------------------------
  // AUTH
  // ---------------------------
  const getSession = async () => {
    const { data, error } = await supabase.auth.getSession()
    return { session: data?.session ?? null, error }
  }

  const getUser = async () => {
    const { data, error } = await supabase.auth.getUser()
    return { user: data?.user ?? null, error }
  }

  const signOut = async () => {
    const { error } = await supabase.auth.signOut()
    return { error }
  }

  const signInWithGoogle = async ({ redirectTo }) => {
    const { data, error } = await supabase.auth.signInWithOAuth({
      provider: 'google',
      options: { redirectTo }
    })
    return { data, error }
  }

  // ---------------------------
  // PROFILE (public.users)
  // ---------------------------
  const ensurePublicUserRow = async (authUser) => {
    if (!authUser?.id) return { data: null, error: null }

    const meta = authUser.user_metadata || {}

    const { data: existing, error: exErr } = await supabase
      .from('users')
      .select('id, email, first_name, last_name')
      .eq('id', authUser.id)
      .maybeSingle()

    if (exErr) return { data: null, error: exErr }

    const firstFromMeta = meta.given_name ?? meta.first_name
    const lastFromMeta = meta.family_name ?? meta.last_name

    const payload = compact({
      id: authUser.id,
      email: existing?.email ?? authUser.email ?? null,
      first_name: existing?.first_name ? undefined : firstFromMeta ?? undefined,
      last_name: existing?.last_name ? undefined : lastFromMeta ?? undefined
    })

    const { data, error } = await supabase.from('users').upsert(payload, { onConflict: 'id' }).select().single()
    return { data, error }
  }

  const getMyPublicUser = async () => {
    const { user } = await getUser()
    if (!user) return { data: null, error: null }

    const { data, error } = await supabase.from('users').select('*').eq('id', user.id).single()
    if (data?.image_path) data.image_path = normalizeStoragePublicUrl(data.image_path)
    return { data, error }
  }

  const updateMyPublicUser = async (patch) => {
    const { user } = await getUser()
    if (!user) return { data: null, error: new Error('No auth user') }

    const safePatch = { ...patch }
    delete safePatch.It_business

    for (const k of Object.keys(safePatch)) {
      if (safePatch[k] === '') safePatch[k] = null
    }
    if (safePatch.image_path) safePatch.image_path = normalizeStoragePublicUrl(safePatch.image_path)

    const { data, error } = await supabase.from('users').update(safePatch).eq('id', user.id).select().single()
    if (data?.image_path) data.image_path = normalizeStoragePublicUrl(data.image_path)
    return { data, error }
  }

  // ---------------------------
  // AVATAR UPLOAD (Supabase Storage)
  // ---------------------------
  const uploadAvatar = async (file) => {
    const { user } = await getUser()
    if (!user) return { publicUrl: null, error: new Error('No auth user') }
    if (!file) return { publicUrl: null, error: new Error('No file') }

    const envBucket = (import.meta.env.VITE_SUPABASE_AVATAR_BUCKET || '').trim()
    const buckets = [...new Set([envBucket, 'avatars', 'Biom', 'biom'].filter(Boolean))]

    const ext = (file.name.split('.').pop() || 'png').toLowerCase()
    const path = `ProfileImage/${user.id}/${Date.now()}.${ext}`

    let lastErr = null

    for (const bucket of buckets) {
      const { error: upErr } = await supabase.storage.from(bucket).upload(path, file, { upsert: true })
      if (upErr) {
        lastErr = upErr
        if (String(upErr?.message || '').toLowerCase().includes('bucket not found')) continue
        return { publicUrl: null, error: upErr }
      }

      const { data } = supabase.storage.from(bucket).getPublicUrl(path)
      const publicUrl = normalizeStoragePublicUrl(data?.publicUrl || '')
      return { publicUrl, error: null }
    }

    return {
      publicUrl: null,
      error:
        lastErr ||
        new Error('Bucket not found. –°–æ–∑–¥–∞–π bucket –≤ Storage (–Ω–∞–ø—Ä–∏–º–µ—Ä "avatars") –∏ —É–∫–∞–∂–∏ VITE_SUPABASE_AVATAR_BUCKET.')
    }
  }

  // ---------------------------
  // TELEGRAM
  // ---------------------------
  const linkTelegramViaEdgeFunction = async (telegramAuthData) => {
    const { data, error } = await supabase.functions.invoke('telegram-verify', { body: telegramAuthData })
    return { data, error }
  }

  const getMyTelegramLink = async () => {
    const { user } = await getUser()
    if (!user) return { data: null, error: null }

    const { data, error } = await supabase.from('user_telegram').select('*').eq('user_id', user.id).maybeSingle()
    return { data: data ?? null, error }
  }

  return {
    // events
    getEvents,
    getCategories,
    getEventPhotos,
    createBusinessEvent,

    // auth
    getSession,
    getUser,
    signInWithGoogle,
    signOut,

    // profile
    ensurePublicUserRow,
    getMyPublicUser,
    updateMyPublicUser,
    uploadAvatar,

    // telegram
    linkTelegramViaEdgeFunction,
    getMyTelegramLink
  }
}
–ü–æ—á–µ–º—É —Ç–µ–ø–µ—Ä—å —Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è –±–æ–ª—å—à–µ –Ω–µ –º–æ–∂–µ—Ç –ø–æ—è–≤–∏—Ç—å—Å—è
–ü–æ—Ç–æ–º—É —á—Ç–æ –≤ HomeView.vue –≤–æ–æ–±—â–µ –Ω–µ—Ç –Ω–∏ tags-shell, –Ω–∏ tags-content, –Ω–∏ –∫–∞–∫–æ–π-–ª–∏–±–æ —Å—Ç–∞—Ä–æ–π –ø–∞–Ω–µ–ª–∏ ‚Äî —Ç–æ–ª—å–∫–æ drawer-root.

–í–∞–∂–Ω–æ: –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è —Å–¥–µ–ª–∞–π –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
–ß—Ç–æ–±—ã –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–ª —Å—Ç–∞—Ä—ã–π dist –∏–∑ –∫–µ—à–∞:

Ctrl + F5 (–∂—ë—Å—Ç–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)

–ª–∏–±–æ DevTools ‚Üí Network ‚Üí Disable cache ‚Üí Reload

–ï—Å–ª–∏ –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –æ–ø—è—Ç—å —É–≤–∏–¥–∏—à—å tags-shell ‚Äî –∑–Ω–∞—á–∏—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä —É–µ–∑–∂–∞–µ—Ç –Ω–µ —Ç–∞ –ø–∞–ø–∫–∞ –∏–ª–∏ –Ω–µ —Ç–æ—Ç dist. –¢–æ–≥–¥–∞ —Å–∫–∏–¥—ã–≤–∞–π —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ /var/www/deploy-biom-user.sh, –∏ —è —Å–∫–∞–∂—É, –∫—É–¥–∞ –æ–Ω —Ä–µ–∞–ª—å–Ω–æ –∫–æ–ø–∏—Ä—É–µ—Ç –±–∏–ª–¥.


–í—ã —Å–∫–∞–∑–∞–ª–∏:
–∑–∞–¥–∞—á–∞ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ biz-card –∏–∑ drawer –≤ menu-button

ChatGPT —Å–∫–∞–∑–∞–ª:

–î—É–º–∞–ª –Ω–∞ –ø—Ä–æ—Ç—è–∂–µ–Ω–∏–∏ 1m 52s
–û–∫ ‚Äî –¥–µ–ª–∞–µ–º —Ç–∞–∫:

Drawer –≤ HomeView –æ—Å—Ç–∞—ë—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ (drawer-root).

biz-card –≤—ã–Ω–æ—Å–∏–º –≤ –º–µ–Ω—é –ø–æ –∫–Ω–æ–ø–∫–µ menu-button –≤ App.vue (–≤–µ—Ä—Ö–Ω—è—è —à–∞–ø–∫–∞).

–£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏: CreateEventModal —Ç–µ–ø–µ—Ä—å –∂–∏–≤—ë—Ç –≤ App.vue, –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –∏–∑ –º–µ–Ω—é, –∞ HomeView –µ–≥–æ –±–æ–ª—å—à–µ –Ω–µ –¥–µ—Ä–∂–∏—Ç.

–ù–∏–∂–µ –ø–æ–ª–Ω—ã–π –∫–æ–¥ —Ñ–∞–π–ª–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å/–¥–æ–±–∞–≤–∏—Ç—å.

1) src/App.vue ‚Äî –ó–ê–ú–ï–ù–ò–¢–¨ –ü–û–õ–ù–û–°–¢–¨–Æ
(–î–æ–±–∞–≤–∏–ª drawer –¥–ª—è menu-button + –ø–µ—Ä–µ–Ω—ë—Å biz-card —Å—é–¥–∞ + CreateEventModal)

<template>
  <div id="app">
    <header class="header">
      <div class="header-container">
        <div class="header-left">
          <!-- MENU BUTTON -->
          <button class="menu-button" aria-label="–ú–µ–Ω—é" @click="openMenu">
            <div class="menu-icon"><span></span><span></span><span></span></div>
          </button>

          <div class="search-container">
            <div class="search-icon">üîç</div>
            <input v-model="searchTerm" type="text" placeholder="–ü–æ–∏—Å–∫" class="search-input" />
          </div>
        </div>

        <button class="profile-button" @click="openProfileModal" aria-label="–ü—Ä–æ—Ñ–∏–ª—å">
          <img
            v-if="showHeaderAvatar"
            class="header-avatar"
            :src="headerAvatarUrl"
            alt="avatar"
            @error="onHeaderImgError"
          />
          <div v-else class="header-placeholder">üë§</div>
        </button>
      </div>
    </header>

    <router-view v-slot="{ Component }">
      <component :is="Component" :global-search-term="searchTerm" />
    </router-view>

    <!-- MENU DRAWER (menu-button) -->
    <teleport to="body">
      <div v-if="menuOpen" class="menu-root" @keydown.esc="closeMenu" tabindex="-1">
        <div class="overlay" @click="closeMenu"></div>

        <aside class="menu-drawer" role="dialog" aria-modal="true" aria-label="–ú–µ–Ω—é">
          <div class="menu-head">
            <div class="menu-title">–ú–µ–Ω—é</div>
            <button class="close-btn" @click="closeMenu" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
          </div>

          <div class="menu-body">
            <!-- ‚úÖ BIZ CARD moved here -->
            <div class="biz-card">
              <div class="biz-top">
                <div class="biz-title">Business –∞–∫–∫–∞—É–Ω—Ç</div>
                <span v-if="isBusiness" class="biz-badge">–ê–∫—Ç–∏–≤–µ–Ω</span>
                <span v-else class="biz-badge off">–ù–µ –∞–∫—Ç–∏–≤–µ–Ω</span>
              </div>

              <div class="biz-text" v-if="isBusiness">
                –¢—ã –º–æ–∂–µ—à—å –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –≤ –ø—Ä–µ–¥–ª–æ–∂–∫—É. –û–Ω–∏ –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∞–¥–º–∏–Ω–æ–º
                (<b>is_published=true</b>).
              </div>
              <div class="biz-text" v-else>
                Business –¥–∞—Å—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è. –û–ø–ª–∞—Ç—É –ø–æ–¥–∫–ª—é—á–∏–º –ø–æ–∑–∂–µ ‚Äî —Å–µ–π—á–∞—Å —Å—Ç–∞—Ç—É—Å –º–µ–Ω—è–µ—Ç—Å—è –≤—Ä—É—á–Ω—É—é
                –≤ –±–∞–∑–µ.
              </div>

              <div class="biz-actions">
                <button v-if="isBusiness" class="biz-btn" @click="openCreateEvent">
                  ‚ûï –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ
                </button>

                <button v-else class="biz-btn secondary" @click="openProfileOrAuth">
                  –£–∑–Ω–∞—Ç—å –ø—Ä–æ Business
                </button>
              </div>
            </div>

            <div class="menu-divider"></div>

            <!-- optional quick actions -->
            <button class="menu-item" @click="openProfileOrAuth">
              üë§ –ü—Ä–æ—Ñ–∏–ª—å / –í—Ö–æ–¥
            </button>
          </div>

          <div class="menu-foot">
            <button class="apply-btn" @click="closeMenu">–ó–∞–∫—Ä—ã—Ç—å</button>
          </div>
        </aside>
      </div>
    </teleport>

    <!-- AUTH / PROFILE -->
    <AuthModal
      v-if="showAuth"
      :telegram-bot-username="telegramBotUsername"
      @close="closeAllModals"
      @google="loginGoogle"
      @telegram-auth="onTelegramAuth"
    />

    <ProfileModal
      v-if="showProfileEdit"
      :profile="profile"
      :telegram-link="telegramLink"
      :saving="saving"
      :loading="profileLoading"
      @close="closeAllModals"
      @save="saveProfile"
      @pick-avatar="onPickAvatar"
      @logout="logout"
    />

    <!-- ‚úÖ Create event modal is now here (single source of truth) -->
    <CreateEventModal
      :open="createEventOpen"
      :categories="categories"
      :create-business-event="createBusinessEvent"
      @close="createEventOpen = false"
      @created="onDraftCreated"
    />
  </div>
</template>

<script>
import { ref, computed, onMounted, watch, nextTick } from 'vue'
import AuthModal from './components/AuthModal.vue'
import ProfileModal from './components/ProfileModal.vue'
import CreateEventModal from './components/CreateEventModal.vue'
import { useSupabase } from './composables/useSupabase.js'

const normalizeStoragePublicUrl = (url) => {
  if (!url || typeof url !== 'string') return ''
  const u = url.trim()
  if (!u) return ''
  if (u.includes('/storage/v1/object/public/')) return u
  if (u.includes('/storage/v1/object/')) return u.replace('/storage/v1/object/', '/storage/v1/object/public/')
  return u
}

export default {
  name: 'App',
  components: { AuthModal, ProfileModal, CreateEventModal },
  setup() {
    const {
      getSession,
      getUser,
      signInWithGoogle,
      signOut,
      ensurePublicUserRow,
      getMyPublicUser,
      updateMyPublicUser,
      uploadAvatar,
      linkTelegramViaEdgeFunction,
      getMyTelegramLink,
      getCategories,
      createBusinessEvent
    } = useSupabase()

    const telegramBotUsername = import.meta.env.VITE_TELEGRAM_BOT_USERNAME || ''
    const searchTerm = ref('')

    const session = ref(null)
    const profile = ref(null)
    const telegramLink = ref(null)

    const showAuth = ref(false)
    const showProfileEdit = ref(false)

    const profileLoading = ref(false)
    const saving = ref(false)
    const pickedAvatarFile = ref(null)

    const headerImgBroken = ref(false)
    const headerAvatarUrl = computed(() => normalizeStoragePublicUrl(profile.value?.image_path || ''))
    const hasHeaderAvatarUrl = computed(() => headerAvatarUrl.value.trim().length > 0)
    const showHeaderAvatar = computed(() => hasHeaderAvatarUrl.value && !headerImgBroken.value)

    const onHeaderImgError = () => {
      headerImgBroken.value = true
    }

    watch(
      () => profile.value?.image_path,
      () => {
        headerImgBroken.value = false
      }
    )

    const isBusiness = computed(() => profile.value?.It_business === true)

    // menu drawer
    const menuOpen = ref(false)
    const openMenu = async () => {
      menuOpen.value = true
      await nextTick()
      document.documentElement.style.overflow = 'hidden'
      document.body.style.overflow = 'hidden'
    }
    const closeMenu = () => {
      menuOpen.value = false
      document.documentElement.style.overflow = ''
      document.body.style.overflow = ''
    }

    // categories for create modal
    const categories = ref([])
    const categoriesLoaded = ref(false)
    const loadCategoriesOnce = async () => {
      if (categoriesLoaded.value) return
      const { data } = await getCategories()
      categories.value = data ?? []
      categoriesLoaded.value = true
    }

    // create event modal
    const createEventOpen = ref(false)
    const openCreateEvent = async () => {
      await loadAuthAndProfile()
      if (!session.value) {
        closeMenu()
        showAuth.value = true
        return
      }
      await loadCategoriesOnce()
      closeMenu()
      createEventOpen.value = true
    }

    const onDraftCreated = () => {
      alert('‚úÖ –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ. –û–Ω–æ –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∞–¥–º–∏–Ω–æ–º.')
    }

    // auth/profile loader
    const loadAuthAndProfile = async () => {
      profileLoading.value = true
      try {
        const { session: s } = await getSession()
        session.value = s

        if (!s) {
          profile.value = null
          telegramLink.value = null
          return
        }

        const { user } = await getUser()
        if (user) await ensurePublicUserRow(user)

        const { data: p } = await getMyPublicUser()
        if (p?.image_path) p.image_path = normalizeStoragePublicUrl(p.image_path)
        profile.value = p

        const { data: tg } = await getMyTelegramLink()
        telegramLink.value = tg
      } finally {
        profileLoading.value = false
      }
    }

    const closeAllModals = () => {
      showAuth.value = false
      showProfileEdit.value = false
    }

    const openProfileModal = async () => {
      showAuth.value = false
      showProfileEdit.value = true
      profileLoading.value = true

      await loadAuthAndProfile()

      if (!session.value) {
        showProfileEdit.value = false
        showAuth.value = true
        profileLoading.value = false
        return
      }
      profileLoading.value = false
    }

    const openProfileOrAuth = async () => {
      await loadAuthAndProfile()
      closeMenu()
      if (!session.value) showAuth.value = true
      else showProfileEdit.value = true
    }

    const loginGoogle = async () => {
      const redirectTo = window.location.origin + import.meta.env.BASE_URL
      const { error } = await signInWithGoogle({ redirectTo })
      if (error) {
        console.error(error)
        alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ Google (—Å–º. –∫–æ–Ω—Å–æ–ª—å)')
      }
    }

    const onTelegramAuth = async (telegramData) => {
      await loadAuthAndProfile()
      if (!session.value) {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏ —á–µ—Ä–µ–∑ Google, –∑–∞—Ç–µ–º –ø–æ–¥—Ç–≤–µ—Ä–¥–∏ Telegram.')
        return
      }

      const { error } = await linkTelegramViaEdgeFunction(telegramData)
      if (error) {
        console.error(error)
        alert('–û—à–∏–±–∫–∞ Telegram –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (—Å–º. –∫–æ–Ω—Å–æ–ª—å)')
        return
      }

      await loadAuthAndProfile()
      showAuth.value = false
      showProfileEdit.value = true
    }

    const onPickAvatar = (file) => {
      pickedAvatarFile.value = file || null
    }

    const saveProfile = async (form) => {
      saving.value = true
      try {
        let avatarUrl = null

        if (pickedAvatarFile.value) {
          const { publicUrl, error } = await uploadAvatar(pickedAvatarFile.value)
          if (error) throw error
          avatarUrl = publicUrl
        }

        const patch = {
          first_name: form.first_name || null,
          last_name: form.last_name || null,
          birth_day: form.birth_day || null,
          phone: form.phone || null,
          email: form.email || null,
          gender: form.gender || null
        }
        if (avatarUrl) patch.image_path = normalizeStoragePublicUrl(avatarUrl)

        const { data, error } = await updateMyPublicUser(patch)
        if (error) throw error

        if (data?.image_path) data.image_path = normalizeStoragePublicUrl(data.image_path)
        profile.value = data

        pickedAvatarFile.value = null
        headerImgBroken.value = false

        alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ')
      } catch (e) {
        console.error('Save profile error:', e)
        alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (—Å–º. –∫–æ–Ω—Å–æ–ª—å)')
      } finally {
        saving.value = false
      }
    }

    const logout = async () => {
      await signOut()
      await loadAuthAndProfile()
      closeAllModals()
      closeMenu()
    }

    onMounted(loadAuthAndProfile)

    return {
      telegramBotUsername,
      searchTerm,

      headerAvatarUrl,
      showHeaderAvatar,
      onHeaderImgError,

      showAuth,
      showProfileEdit,
      profileLoading,
      profile,
      telegramLink,
      saving,

      isBusiness,

      menuOpen,
      openMenu,
      closeMenu,

      categories,
      createEventOpen,
      openCreateEvent,
      onDraftCreated,

      createBusinessEvent,

      openProfileModal,
      openProfileOrAuth,
      closeAllModals,
      loginGoogle,
      onTelegramAuth,
      onPickAvatar,
      saveProfile,
      logout
    }
  }
}
</script>

<style>
.header-placeholder {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: #f2f2f2;
  display: grid;
  place-items: center;
  font-size: 18px;
  color: #9aa0a6;
}

* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: Arial, sans-serif; background: #efefef; color: #14181b; }
#app { min-height: 100vh; }

.header { background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,.1); }
.header-container {
  max-width: 1200px; margin: 0 auto; padding: 16px 20px;
  display: flex; justify-content: space-between; align-items: center;
}
.header-left { display: flex; align-items: center; gap: 16px; }

.menu-button {
  width: 40px; height: 40px; border-radius: 50%;
  background: #fff; border: none; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
}
.menu-icon { display: flex; flex-direction: column; gap: 3px; }
.menu-icon span { width: 18px; height: 2px; background: #14181b; border-radius: 1px; }

.search-container { position: relative; display: flex; align-items: center; }
.search-icon { position: absolute; left: 12px; font-size: 14px; opacity: .6; }
.search-input {
  width: 300px; padding: 10px 12px 10px 36px;
  border: 2px solid #efefef; border-radius: 20px;
  outline: none; font-size: 14px;
}

.profile-button {
  width: 40px; height: 40px; border-radius: 50%;
  background: #fff; border: none; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  overflow: hidden;
}
.header-avatar { width: 40px; height: 40px; object-fit: cover; border-radius: 50%; display: block; }

/* --- MENU DRAWER --- */
.menu-root { position: fixed; inset: 0; z-index: 9999; }
.overlay { position: absolute; inset: 0; background: rgba(0,0,0,.35); backdrop-filter: blur(2px); }

.menu-drawer {
  position: absolute; top: 0; left: 0; height: 100%;
  width: min(420px, 92vw);
  background: #fff;
  border-right: 1px solid #efefef;
  box-shadow: 10px 0 30px rgba(0,0,0,0.12);
  display: flex; flex-direction: column;
  animation: slideInLeft 180ms ease;
}
@keyframes slideInLeft { from { transform: translateX(-18px); opacity: .7; } to { transform: translateX(0); opacity: 1; } }

.menu-head {
  display: flex; align-items: center; gap: 10px;
  padding: 14px;
  border-bottom: 1px solid #f2f2f2;
}
.menu-title { font-weight: 900; font-size: 16px; }
.close-btn {
  margin-left: auto;
  border: 1px solid #efefef;
  background: #fafafa;
  border-radius: 12px;
  padding: 8px 10px;
  cursor: pointer;
}

.menu-body { padding: 14px; overflow: auto; display: flex; flex-direction: column; gap: 12px; }
.menu-foot { padding: 14px; border-top: 1px solid #f2f2f2; display: flex; justify-content: flex-end; }
.apply-btn {
  border: none;
  background: #8a75e3;
  color: #fff;
  border-radius: 14px;
  padding: 12px 16px;
  font-weight: 900;
  cursor: pointer;
}

/* biz-card (moved here) */
.biz-card {
  background: #fcfcff;
  border: 1px solid rgba(138,117,227,.18);
  border-radius: 16px;
  padding: 12px;
  display: grid;
  gap: 10px;
}
.biz-top { display: flex; align-items: center; gap: 10px; }
.biz-title { font-weight: 900; }
.biz-badge {
  margin-left: auto;
  font-size: 12px;
  font-weight: 900;
  padding: 6px 10px;
  border-radius: 999px;
  background: rgba(0, 200, 120, .12);
  border: 1px solid rgba(0, 200, 120, .22);
}
.biz-badge.off { background: rgba(180,180,180,.16); border-color: rgba(180,180,180,.28); }
.biz-text { font-size: 12px; opacity: .8; line-height: 1.25; }

.biz-actions { display: flex; gap: 10px; flex-wrap: wrap; }
.biz-btn {
  border: none;
  border-radius: 14px;
  padding: 11px 12px;
  font-weight: 900;
  cursor: pointer;
  background: #8a75e3;
  color: #fff;
}
.biz-btn.secondary { background: #efefef; color: #14181b; }
.biz-btn:hover { filter: brightness(.98); }

.menu-divider { height: 1px; background: #f2f2f2; margin: 6px 0; }

.menu-item {
  border: 1px solid #efefef;
  background: #fff;
  border-radius: 14px;
  padding: 12px 12px;
  font-weight: 900;
  cursor: pointer;
  text-align: left;
}
.menu-item:hover { background: #fafafa; }
</style>
2) src/views/HomeView.vue ‚Äî –ó–ê–ú–ï–ù–ò–¢–¨ –ü–û–õ–ù–û–°–¢–¨–Æ
(–í–Ω—É—Ç—Ä–∏ drawer –¢–û–õ–¨–ö–û —Ñ–∏–ª—å—Ç—Ä—ã, biz-card —É–±—Ä–∞–Ω)

<template>
  <div class="page">
    <div class="container">
      <div class="topbar">
        <div class="topbar-left">
          <div class="page-title">–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</div>
          <div class="page-sub">
            <span v-if="initialLoaded">{{ filteredEvents.length }}</span>
            <span v-else>‚Ä¶</span>
          </div>
        </div>

        <!-- filter drawer -->
        <button class="filter-btn" @click="openDrawer" aria-label="–û—Ç–∫—Ä—ã—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã">
          <svg viewBox="0 0 24 24" class="filter-icon" aria-hidden="true">
            <path d="M3 5h18l-7 8v5l-4 2v-7L3 5z" fill="currentColor" />
          </svg>
          <span class="filter-btn-text">–§–∏–ª—å—Ç—Ä—ã</span>
        </button>
      </div>

      <div v-if="!initialLoaded" class="state">
        <div class="spinner"></div>
        <div>–ó–∞–≥—Ä—É–∑–∫–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π‚Ä¶</div>
      </div>

      <div v-else-if="error" class="state error">
        <div class="error-title">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</div>
        <div class="error-sub">{{ error }}</div>
        <button class="retry" @click="reload">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
      </div>

      <div v-else-if="filteredEvents.length === 0" class="state">–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>

      <div v-else class="events-shell">
        <TransitionGroup name="list" tag="div" class="events-list">
          <EventCard
            v-for="event in filteredEvents"
            :key="event.id"
            :event="event"
            :photos="photos[event.id] || []"
            :photos-loading="photosLoading"
            :category-map="categoryMap"
            @open-photo="openPhoto"
          />
        </TransitionGroup>
      </div>
    </div>

    <!-- FILTER DRAWER ONLY -->
    <teleport to="body">
      <div v-if="drawerOpen" class="drawer-root" @keydown.esc="closeDrawer" tabindex="-1">
        <div class="overlay" @click="closeDrawer"></div>

        <aside class="drawer" role="dialog" aria-modal="true" aria-label="–§–∏–ª—å—Ç—Ä—ã">
          <div class="drawer-head">
            <div class="drawer-title">–§–∏–ª—å—Ç—Ä—ã</div>
            <button class="close-btn" @click="closeDrawer" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
          </div>

          <div class="drawer-body">
            <FiltersPanel
              :categories="categories"
              :is-all-categories-active="isAllCategoriesActive"
              v-model:selectedCategoryNames="selectedCategoryNames"
              v-model:onlineOnly="onlineOnly"
              v-model:priceMode="priceMode"
              v-model:customPriceMin="customPriceMin"
              v-model:customPriceMax="customPriceMax"
              v-model:dateMode="dateMode"
              v-model:dateOn="dateOn"
              v-model:dateFrom="dateFrom"
              v-model:dateTo="dateTo"
              v-model:datePivot="datePivot"
              @reset="resetAllFilters"
            />
          </div>

          <div class="drawer-foot">
            <button class="apply-btn" @click="closeDrawer">–ü–æ–∫–∞–∑–∞—Ç—å</button>
          </div>
        </aside>
      </div>
    </teleport>

    <EventPhotoModal v-if="photoModalUrl" :url="photoModalUrl" @close="photoModalUrl = ''" />
  </div>
</template>

<script>
import { ref, computed, onMounted, onBeforeUnmount, nextTick } from 'vue'
import EventCard from '../../components/EventCard.vue'
import EventPhotoModal from '../../components/EventPhotoModal.vue'
import FiltersPanel from '../../components/FiltersPanel.vue'
import { useSupabase } from '../../composables/useSupabase'

const sleep = (ms) => new Promise((r) => setTimeout(r, ms))

const withRetry = async (fn, tries = 3) => {
  let lastErr = null
  for (let i = 0; i < tries; i++) {
    try {
      return await fn()
    } catch (e) {
      lastErr = e
      await sleep(350 * (i + 1))
    }
  }
  throw lastErr
}

const toNumberOrNull = (v) => {
  if (v === null || v === undefined) return null
  const n = Number(v)
  return Number.isFinite(n) ? n : null
}

const parseEventDate = (value) => {
  if (!value) return null
  const d = new Date(value)
  if (Number.isNaN(d.getTime())) return null
  return d
}

const parseDateInput = (yyyy_mm_dd) => {
  if (!yyyy_mm_dd) return null
  const [y, m, day] = yyyy_mm_dd.split('-').map((x) => Number(x))
  if (!y || !m || !day) return null
  return new Date(y, m - 1, day)
}

const startOfDay = (d) => new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0, 0, 0, 0)
const endOfDay = (d) => new Date(d.getFullYear(), d.getMonth(), d.getDate(), 23, 59, 59, 999)

const normalizeCategoryNames = (raw, categoryMap) => {
  const map = categoryMap || {}

  const toName = (v) => {
    if (v === null || v === undefined) return ''
    const s = String(v).trim()
    if (!s) return ''
    if (map[s]) return String(map[s]).trim()
    const n = Number(s)
    if (!Number.isNaN(n) && map[String(n)]) return String(map[String(n)]).trim()
    return s
  }

  if (!raw) return []
  if (Array.isArray(raw)) return Array.from(new Set(raw.map(toName).filter(Boolean)))

  if (typeof raw === 'string') {
    const s = raw.trim()
    if (!s) return []
    return Array.from(
      new Set(
        s
          .split(/[,;|]+/g)
          .map((x) => x.trim())
          .filter(Boolean)
          .map(toName)
          .filter(Boolean)
      )
    )
  }

  const one = toName(raw)
  return one ? [one] : []
}

export default {
  name: 'HomeView',
  components: { EventCard, EventPhotoModal, FiltersPanel },
  props: { globalSearchTerm: { type: String, default: '' } },
  setup(props) {
    const { getEvents, getCategories, getEventPhotos } = useSupabase()

    const initialLoaded = ref(false)
    const error = ref(null)

    const allEvents = ref([])
    const visibleEvents = ref([])
    const photos = ref({})

    const categories = ref([])
    const categoryMap = ref({})

    // filters
    const selectedCategoryNames = ref([])
    const onlineOnly = ref(false)

    const priceMode = ref('all')
    const customPriceMin = ref('')
    const customPriceMax = ref('')

    const dateMode = ref('all')
    const dateOn = ref('')
    const dateFrom = ref('')
    const dateTo = ref('')
    const datePivot = ref('')

    const isAllCategoriesActive = computed(() => selectedCategoryNames.value.length === 0)

    // ui
    const drawerOpen = ref(false)
    const openDrawer = async () => {
      drawerOpen.value = true
      await nextTick()
      document.documentElement.style.overflow = 'hidden'
      document.body.style.overflow = 'hidden'
    }
    const closeDrawer = () => {
      drawerOpen.value = false
      document.documentElement.style.overflow = ''
      document.body.style.overflow = ''
    }

    // photo modal
    const photoModalUrl = ref('')
    const openPhoto = (url) => {
      if (!url) return
      photoModalUrl.value = url
    }

    // progressive list
    let progressiveTimer = null
    const stopProgressive = () => {
      if (progressiveTimer) clearInterval(progressiveTimer)
      progressiveTimer = null
    }
    const startProgressive = (list) => {
      stopProgressive()
      visibleEvents.value = []
      const src = Array.isArray(list) ? list : []
      if (!src.length) return
      visibleEvents.value.push(src[0])
      let i = 1
      progressiveTimer = setInterval(() => {
        if (i >= src.length) return stopProgressive()
        visibleEvents.value.push(src[i])
        i++
      }, 140)
    }

    const resetAllFilters = () => {
      selectedCategoryNames.value = []
      onlineOnly.value = false

      priceMode.value = 'all'
      customPriceMin.value = ''
      customPriceMax.value = ''

      dateMode.value = 'all'
      dateOn.value = ''
      dateFrom.value = ''
      dateTo.value = ''
      datePivot.value = ''
    }

    const matchesCategories = (event) => {
      if (selectedCategoryNames.value.length === 0) return true
      const eventCats = normalizeCategoryNames(event?.selectCategory, categoryMap.value)
      if (!eventCats.length) return false
      const set = new Set(selectedCategoryNames.value)
      return eventCats.some((c) => set.has(c))
    }

    const matchesOnline = (event) => {
      if (!onlineOnly.value) return true
      return event?.is_online === true
    }

    const getEventPrice = (event) => {
      if (event?.is_free === true) return 0
      const p = toNumberOrNull(event?.price)
      if (p === null) return null
      return p
    }

    const matchesPrice = (event) => {
      const mode = priceMode.value
      if (mode === 'all') return true

      const price = getEventPrice(event)
      if (mode === 'free') return price === 0
      if (price === null) return false

      if (mode === '100_1000') return price >= 100 && price <= 1000
      if (mode === '1000_3000') return price >= 1000 && price <= 3000
      if (mode === '3000_10000') return price >= 3000 && price <= 10000
      if (mode === 'gt_10000') return price > 10000

      if (mode === 'custom') {
        const min = customPriceMin.value === '' ? null : toNumberOrNull(customPriceMin.value)
        const max = customPriceMax.value === '' ? null : toNumberOrNull(customPriceMax.value)
        const okMin = min === null ? true : price >= min
        const okMax = max === null ? true : price <= max
        return okMin && okMax
      }

      return true
    }

    const matchesDate = (event) => {
      const mode = dateMode.value
      if (mode === 'all') return true

      const d = parseEventDate(event?.date_time_event)
      if (!d) return false

      if (mode === 'today') {
        const now = new Date()
        return d >= startOfDay(now) && d <= endOfDay(now)
      }

      if (mode === 'next7') {
        const now = new Date()
        const from = startOfDay(now)
        const to = endOfDay(new Date(now.getFullYear(), now.getMonth(), now.getDate() + 7))
        return d >= from && d <= to
      }

      if (mode === 'on') {
        const on = parseDateInput(dateOn.value)
        if (!on) return true
        return d >= startOfDay(on) && d <= endOfDay(on)
      }

      if (mode === 'range') {
        const fromD = parseDateInput(dateFrom.value)
        const toD = parseDateInput(dateTo.value)
        if (!fromD && !toD) return true
        const from = fromD ? startOfDay(fromD) : null
        const to = toD ? endOfDay(toD) : null
        const okFrom = from ? d >= from : true
        const okTo = to ? d <= to : true
        return okFrom && okTo
      }

      if (mode === 'after') {
        const pivot = parseDateInput(datePivot.value)
        if (!pivot) return true
        return d >= startOfDay(pivot)
      }

      if (mode === 'before') {
        const pivot = parseDateInput(datePivot.value)
        if (!pivot) return true
        return d <= endOfDay(pivot)
      }

      return true
    }

    const matchesSearch = (event) => {
      const term = (props.globalSearchTerm || '').trim().toLowerCase()
      if (!term) return true
      const t = (event.title || '').toLowerCase()
      const desc = (event.description || '').toLowerCase()
      const a = (event.address || '').toLowerCase()
      const o = (event.organizer || '').toLowerCase()
      return t.includes(term) || desc.includes(term) || a.includes(term) || o.includes(term)
    }

    const filteredEvents = computed(() => {
      return visibleEvents.value.filter(
        (e) => matchesCategories(e) && matchesOnline(e) && matchesPrice(e) && matchesDate(e) && matchesSearch(e)
      )
    })

    // load
    const photosLoading = ref(false)
    const stopPhotosLoading = ref(false)

    const loadCategories = async () => {
      const { data, error: err } = await withRetry(() => getCategories())
      if (err) throw err
      categories.value = data ?? []
      categoryMap.value = (categories.value || []).reduce((acc, c) => {
        acc[String(c.id)] = c.name
        return acc
      }, {})
    }

    const loadEventsProgressive = async () => {
      error.value = null
      stopPhotosLoading.value = true
      photosLoading.value = false
      stopProgressive()

      try {
        const { data: eventsData, error: eventsErr } = await withRetry(() => getEvents())
        if (eventsErr) throw eventsErr

        allEvents.value = eventsData ?? []
        initialLoaded.value = true
        startProgressive(allEvents.value)

        photos.value = {}
        stopPhotosLoading.value = false

        const ids = allEvents.value.map((e) => e.id).filter(Boolean)
        if (!ids.length) return

        photosLoading.value = true
        const batchSize = 5
        for (let i = 0; i < ids.length; i += batchSize) {
          if (stopPhotosLoading.value) break
          const batch = ids.slice(i, i + batchSize)

          const { data: ph, error: phErr } = await withRetry(() => getEventPhotos(batch))
          if (!phErr) {
            const next = { ...photos.value }
            for (const p of ph ?? []) {
              if (!p?.event_id) continue
              if (!next[p.event_id]) next[p.event_id] = []
              next[p.event_id].push(p)
            }
            photos.value = next
          }
          await sleep(120)
        }
      } catch (e) {
        allEvents.value = []
        visibleEvents.value = []
        photos.value = {}
        initialLoaded.value = true
        error.value = e?.message ? String(e.message) : 'TypeError: Failed to fetch'
      } finally {
        photosLoading.value = false
      }
    }

    const reload = async () => {
      await loadEventsProgressive()
    }

    onMounted(async () => {
      try {
        await loadCategories()
      } catch {
        categories.value = []
        categoryMap.value = {}
      }
      await loadEventsProgressive()
    })

    onBeforeUnmount(() => {
      stopProgressive()
      stopPhotosLoading.value = true
      document.documentElement.style.overflow = ''
      document.body.style.overflow = ''
    })

    return {
      initialLoaded,
      error,

      categories,
      categoryMap,

      selectedCategoryNames,
      isAllCategoriesActive,

      onlineOnly,
      priceMode,
      customPriceMin,
      customPriceMax,

      dateMode,
      dateOn,
      dateFrom,
      dateTo,
      datePivot,

      photos,
      photosLoading,

      filteredEvents,

      drawerOpen,
      openDrawer,
      closeDrawer,

      resetAllFilters,
      reload,

      photoModalUrl,
      openPhoto
    }
  }
}
</script>

<style scoped>
.page { padding: 16px 0 40px; }
.container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }

.topbar { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
.topbar-left { display: flex; flex-direction: column; gap: 2px; }
.page-title { font-weight: 900; font-size: 18px; }
.page-sub { font-size: 12px; opacity: .65; font-weight: 700; }

.filter-btn {
  margin-left: auto;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  border: 1px solid #efefef;
  background: #fff;
  border-radius: 14px;
  padding: 10px 12px;
  cursor: pointer;
  box-shadow: 0 2px 10px rgba(0,0,0,0.04);
}
.filter-btn:hover { background: #fafafa; }
.filter-icon { width: 18px; height: 18px; opacity: .9; }
.filter-btn-text { font-size: 13px; font-weight: 800; }

.state { display: grid; place-items: center; gap: 10px; padding: 40px 0; opacity: .75; text-align: center; }
.state.error { opacity: 1; color: #d9534f; }
.error-title { font-weight: 800; }
.error-sub { font-size: 12px; opacity: .8; max-width: 680px; }
.retry { margin-top: 8px; border: none; border-radius: 12px; padding: 10px 14px; cursor: pointer; background: #efefef; }

.spinner {
  width: 26px; height: 26px; border-radius: 50%;
  border: 3px solid #eee; border-top-color: #8a75e3;
  animation: spin .8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

.events-shell {
  background: #fff;
  border: 1px solid #efefef;
  border-radius: 18px;
  padding: 14px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.04);
}
.events-list { display: flex; flex-direction: column; gap: 12px; }

.list-enter-active, .list-leave-active { transition: opacity 240ms ease, transform 240ms ease; }
.list-enter-from, .list-leave-to { opacity: 0; transform: translateY(8px); }

/* FILTER DRAWER */
.drawer-root { position: fixed; inset: 0; z-index: 9998; }
.overlay { position: absolute; inset: 0; background: rgba(0,0,0,.35); backdrop-filter: blur(2px); }

.drawer {
  position: absolute; top: 0; right: 0; height: 100%;
  width: min(420px, 92vw);
  background: #fff;
  border-left: 1px solid #efefef;
  box-shadow: -10px 0 30px rgba(0,0,0,0.12);
  display: flex; flex-direction: column;
  animation: slideIn 180ms ease;
}
@keyframes slideIn { from { transform: translateX(18px); opacity: .7; } to { transform: translateX(0); opacity: 1; } }

.drawer-head {
  display: flex; align-items: center; gap: 10px;
  padding: 14px;
  border-bottom: 1px solid #f2f2f2;
}
.drawer-title { font-weight: 900; font-size: 16px; }
.close-btn {
  margin-left: auto;
  border: 1px solid #efefef;
  background: #fafafa;
  border-radius: 12px;
  padding: 8px 10px;
  cursor: pointer;
}

.drawer-body { padding: 14px; overflow: auto; }
.drawer-foot { padding: 14px; border-top: 1px solid #f2f2f2; display: flex; justify-content: flex-end; }

.apply-btn {
  border: none;
  background: #8a75e3;
  color: #fff;
  border-radius: 14px;
  padding: 12px 16px;
  font-weight: 900;
  cursor: pointer;
}
</style>
3) src/composables/useSupabase.js ‚Äî –ó–ê–ú–ï–ù–ò–¢–¨ –ü–û–õ–ù–û–°–¢–¨–Æ
(–î–æ–±–∞–≤–∏–ª is_published —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –∏ createBusinessEvent)

import { createClient } from '@supabase/supabase-js'

const supabaseUrl = import.meta.env.VITE_SUPABASE_URL
const supabaseKey = import.meta.env.VITE_SUPABASE_ANON_KEY

export const supabase = createClient(supabaseUrl, supabaseKey)

const normalizeStoragePublicUrl = (url) => {
  if (!url || typeof url !== 'string') return ''
  const u = url.trim()
  if (!u) return ''
  if (u.includes('/storage/v1/object/public/')) return u
  if (u.includes('/storage/v1/object/')) return u.replace('/storage/v1/object/', '/storage/v1/object/public/')
  return u
}

const compact = (obj) => {
  const out = {}
  for (const [k, v] of Object.entries(obj || {})) {
    if (v !== undefined) out[k] = v
  }
  return out
}

export const useSupabase = () => {
  // ---------------------------
  // EVENTS (ONLY PUBLISHED)
  // ---------------------------
  const getEvents = async () => {
    const { data, error } = await supabase
      .from('events')
      .select(
        `
        id,
        title,
        description,
        date_time_event,
        address,
        organizer,
        price,
        is_online,
        is_free,
        user_id,
        selectCategory,
        is_published,
        created_at
      `
      )
      .eq('is_published', true)
      .order('created_at', { ascending: false })

    return { data, error }
  }

  const getCategories = async () => {
    const { data, error } = await supabase.from('category').select('id, name').order('name', { ascending: true })
    return { data, error }
  }

  const getEventPhotos = async (eventIds) => {
    if (!Array.isArray(eventIds) || eventIds.length === 0) return { data: [], error: null }

    const { data, error } = await supabase
      .from('event_photos')
      .select('id, event_id, photo_url')
      .in('event_id', eventIds)
      .order('id', { ascending: true })

    return { data: data ?? [], error }
  }

  // ‚úÖ BUSINESS: create draft event (not published)
  const createBusinessEvent = async (payload) => {
    const { user, error: userErr } = await getUser()
    if (userErr) return { data: null, error: userErr }
    if (!user) return { data: null, error: new Error('–ù–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏') }

    const price = Number(payload?.price ?? 0)
    const is_free = payload?.is_free === true || (Number.isFinite(price) && price <= 0)

    const eventInsert = {
      title: payload?.title ?? null,
      description: payload?.description ?? null,
      date_time_event: payload?.date_time_event ?? null,
      address: payload?.address ?? null,
      organizer: payload?.organizer ?? null,
      price: Number.isFinite(price) ? price : 0,
      is_online: !!payload?.is_online,
      is_free,
      user_id: user.id,
      selectCategory: Array.isArray(payload?.selectCategory) ? payload.selectCategory : [],
      is_published: false
    }

    const { data: eventRow, error: insErr } = await supabase.from('events').insert(eventInsert).select().single()
    if (insErr) return { data: null, error: insErr }

    const photoUrl = String(payload?.photo_url ?? '').trim()
    if (photoUrl) {
      const { error: phErr } = await supabase.from('event_photos').insert({
        event_id: eventRow.id,
        photo_url: photoUrl
      })
      if (phErr) return { data: eventRow, error: phErr }
    }

    return { data: eventRow, error: null }
  }

  // ---------------------------
  // AUTH
  // ---------------------------
  const getSession = async () => {
    const { data, error } = await supabase.auth.getSession()
    return { session: data?.session ?? null, error }
  }

  const getUser = async () => {
    const { data, error } = await supabase.auth.getUser()
    return { user: data?.user ?? null, error }
  }

  const signOut = async () => {
    const { error } = await supabase.auth.signOut()
    return { error }
  }

  const signInWithGoogle = async ({ redirectTo }) => {
    const { data, error } = await supabase.auth.signInWithOAuth({
      provider: 'google',
      options: { redirectTo }
    })
    return { data, error }
  }

  // ---------------------------
  // PROFILE (public.users)
  // ---------------------------
  const ensurePublicUserRow = async (authUser) => {
    if (!authUser?.id) return { data: null, error: null }

    const meta = authUser.user_metadata || {}

    const { data: existing, error: exErr } = await supabase
      .from('users')
      .select('id, email, first_name, last_name')
      .eq('id', authUser.id)
      .maybeSingle()

    if (exErr) return { data: null, error: exErr }

    const firstFromMeta = meta.given_name ?? meta.first_name
    const lastFromMeta = meta.family_name ?? meta.last_name

    const payload = compact({
      id: authUser.id,
      email: existing?.email ?? authUser.email ?? null,
      first_name: existing?.first_name ? undefined : firstFromMeta ?? undefined,
      last_name: existing?.last_name ? undefined : lastFromMeta ?? undefined
    })

    const { data, error } = await supabase.from('users').upsert(payload, { onConflict: 'id' }).select().single()
    return { data, error }
  }

  const getMyPublicUser = async () => {
    const { user } = await getUser()
    if (!user) return { data: null, error: null }

    const { data, error } = await supabase.from('users').select('*').eq('id', user.id).single()
    if (data?.image_path) data.image_path = normalizeStoragePublicUrl(data.image_path)
    return { data, error }
  }

  const updateMyPublicUser = async (patch) => {
    const { user } = await getUser()
    if (!user) return { data: null, error: new Error('No auth user') }

    const safePatch = { ...patch }
    delete safePatch.It_business

    for (const k of Object.keys(safePatch)) {
      if (safePatch[k] === '') safePatch[k] = null
    }
    if (safePatch.image_path) safePatch.image_path = normalizeStoragePublicUrl(safePatch.image_path)

    const { data, error } = await supabase.from('users').update(safePatch).eq('id', user.id).select().single()
    if (data?.image_path) data.image_path = normalizeStoragePublicUrl(data.image_path)
    return { data, error }
  }

  // ---------------------------
  // AVATAR UPLOAD
  // ---------------------------
  const uploadAvatar = async (file) => {
    const { user } = await getUser()
    if (!user) return { publicUrl: null, error: new Error('No auth user') }
    if (!file) return { publicUrl: null, error: new Error('No file') }

    const envBucket = (import.meta.env.VITE_SUPABASE_AVATAR_BUCKET || '').trim()
    const buckets = [...new Set([envBucket, 'avatars', 'Biom', 'biom'].filter(Boolean))]

    const ext = (file.name.split('.').pop() || 'png').toLowerCase()
    const path = `ProfileImage/${user.id}/${Date.now()}.${ext}`

    let lastErr = null

    for (const bucket of buckets) {
      const { error: upErr } = await supabase.storage.from(bucket).upload(path, file, { upsert: true })
      if (upErr) {
        lastErr = upErr
        if (String(upErr?.message || '').toLowerCase().includes('bucket not found')) continue
        return { publicUrl: null, error: upErr }
      }

      const { data } = supabase.storage.from(bucket).getPublicUrl(path)
      const publicUrl = normalizeStoragePublicUrl(data?.publicUrl || '')
      return { publicUrl, error: null }
    }

    return {
      publicUrl: null,
      error:
        lastErr ||
        new Error('Bucket not found. –°–æ–∑–¥–∞–π bucket –≤ Storage (–Ω–∞–ø—Ä–∏–º–µ—Ä "avatars") –∏ —É–∫–∞–∂–∏ VITE_SUPABASE_AVATAR_BUCKET.')
    }
  }

  // ---------------------------
  // TELEGRAM
  // ---------------------------
  const linkTelegramViaEdgeFunction = async (telegramAuthData) => {
    const { data, error } = await supabase.functions.invoke('telegram-verify', { body: telegramAuthData })
    return { data, error }
  }

  const getMyTelegramLink = async () => {
    const { user } = await getUser()
    if (!user) return { data: null, error: null }

    const { data, error } = await supabase.from('user_telegram').select('*').eq('user_id', user.id).maybeSingle()
    return { data: data ?? null, error }
  }

  return {
    getEvents,
    getCategories,
    getEventPhotos,
    createBusinessEvent,

    getSession,
    getUser,
    signInWithGoogle,
    signOut,

    ensurePublicUserRow,
    getMyPublicUser,
    updateMyPublicUser,
    uploadAvatar,

    linkTelegramViaEdgeFunction,
    getMyTelegramLink
  }
}
4) src/components/CreateEventModal.vue ‚Äî –î–û–ë–ê–í–ò–¢–¨ (–µ—Å–ª–∏ –µ—â—ë –Ω–µ—Ç)
(–ï—Å–ª–∏ —É —Ç–µ–±—è —É–∂–µ –µ—Å—Ç—å ‚Äî —Å–∫–∞–∂–∏, —è –∞–¥–∞–ø—Ç–∏—Ä—É—é –ø–æ–¥ —Ç–µ–∫—É—â–∏–π)

<template>
  <teleport to="body">
    <div v-if="open" class="root" @keydown.esc="close" tabindex="-1">
      <div class="overlay" @click="close"></div>

      <div class="modal" role="dialog" aria-modal="true" aria-label="–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ">
        <div class="head">
          <div class="title">–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</div>
          <button class="x" @click="close" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
        </div>

        <div class="body">
          <div class="hint">
            –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è —Å <b>is_published=false</b> –∏ –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∞–¥–º–∏–Ω–æ–º.
          </div>

          <div class="grid">
            <div class="field">
              <div class="label">–ù–∞–∑–≤–∞–Ω–∏–µ *</div>
              <input class="input" v-model="form.title" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –í–µ—á–µ—Ä –Ω–∞—Å—Ç–æ–ª–æ–∫" />
            </div>

            <div class="field">
              <div class="label">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è *</div>
              <input class="input" type="datetime-local" v-model="form.date_time_event" />
            </div>

            <div class="field">
              <div class="label">–ê–¥—Ä–µ—Å</div>
              <input class="input" v-model="form.address" placeholder="–ì–æ—Ä–æ–¥, —É–ª–∏—Ü–∞, –¥–æ–º / –∏–ª–∏ —Å—Å—ã–ª–∫–∞" />
            </div>

            <div class="field">
              <div class="label">–û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä</div>
              <input class="input" v-model="form.organizer" placeholder="–ò–º—è/–ø—Ä–æ–µ–∫—Ç" />
            </div>

            <div class="field">
              <div class="label">–¶–µ–Ω–∞ (‚ÇΩ)</div>
              <input class="input" type="number" min="0" inputmode="numeric" v-model="form.price" placeholder="0" />
              <div class="mini"><span class="badge" v-if="isFree">üÜì –ë–µ—Å–ø–ª–∞—Ç–Ω–æ</span></div>
            </div>

            <div class="field inline">
              <label class="check">
                <input type="checkbox" v-model="form.is_online" />
                <span class="ui"></span>
                <span class="text">–û–Ω–ª–∞–π–Ω (is_online)</span>
              </label>
            </div>
          </div>

          <div class="field">
            <div class="label">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</div>
            <div class="tags">
              <button
                v-for="c in categories"
                :key="c.id"
                class="tag"
                :class="{ active: selectedCategories.includes(c.name) }"
                @click="toggleCategory(c.name)"
                type="button"
              >
                {{ c.name }}
              </button>
            </div>
            <div class="mini">–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ.</div>
          </div>

          <div class="field">
            <div class="label">–û–ø–∏—Å–∞–Ω–∏–µ *</div>
            <textarea class="textarea" v-model="form.description" placeholder="–û–ø–∏—à–∏, —á—Ç–æ –±—É–¥–µ—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å"></textarea>
          </div>

          <div class="field">
            <div class="label">–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</div>
            <input class="input" v-model="form.photo_url" placeholder="https://..." />
          </div>

          <div v-if="error" class="error">{{ error }}</div>
        </div>

        <div class="foot">
          <button class="btn secondary" @click="close">–û—Ç–º–µ–Ω–∞</button>
          <button class="btn primary" :disabled="saving" @click="submit">
            {{ saving ? '–û—Ç–ø—Ä–∞–≤–ª—è—é‚Ä¶' : '–û—Ç–ø—Ä–∞–≤–∏—Ç—å' }}
          </button>
        </div>
      </div>
    </div>
  </teleport>
</template>

<script>
const trimOrNull = (v) => {
  const s = String(v ?? '').trim()
  return s ? s : null
}

export default {
  name: 'CreateEventModal',
  emits: ['close', 'created'],
  props: {
    open: { type: Boolean, default: false },
    categories: { type: Array, default: () => [] },
    createBusinessEvent: { type: Function, required: true }
  },
  data() {
    return {
      saving: false,
      error: '',
      selectedCategories: [],
      form: {
        title: '',
        description: '',
        date_time_event: '',
        address: '',
        organizer: '',
        price: '0',
        is_online: false,
        photo_url: ''
      }
    }
  },
  computed: {
    isFree() {
      const n = Number(this.form.price)
      return Number.isFinite(n) && n <= 0
    }
  },
  methods: {
    close() {
      if (this.saving) return
      this.$emit('close')
    },
    toggleCategory(name) {
      const n = String(name || '').trim()
      if (!n) return
      const idx = this.selectedCategories.indexOf(n)
      if (idx >= 0) this.selectedCategories.splice(idx, 1)
      else this.selectedCategories.push(n)
    },
    async submit() {
      this.error = ''
      const title = trimOrNull(this.form.title)
      const description = trimOrNull(this.form.description)
      const dt = trimOrNull(this.form.date_time_event)

      if (!title) return (this.error = '–£–∫–∞–∂–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ.')
      if (!dt) return (this.error = '–£–∫–∞–∂–∏ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è.')
      if (!description) return (this.error = '–£–∫–∞–∂–∏ –æ–ø–∏—Å–∞–Ω–∏–µ.')

      const priceNum = Number(this.form.price)
      const price = Number.isFinite(priceNum) ? priceNum : 0
      const is_free = price <= 0

      const payload = {
        title,
        description,
        date_time_event: dt,
        address: trimOrNull(this.form.address),
        organizer: trimOrNull(this.form.organizer),
        price,
        is_online: !!this.form.is_online,
        is_free,
        selectCategory: [...this.selectedCategories],
        photo_url: trimOrNull(this.form.photo_url)
      }

      this.saving = true
      try {
        const { data, error } = await this.createBusinessEvent(payload)
        if (error) {
          this.error = String(error.message || error)
          return
        }
        this.$emit('created', data)
        this.$emit('close')
      } finally {
        this.saving = false
      }
    }
  }
}
</script>

<style scoped>
.root { position: fixed; inset: 0; z-index: 10000; }
.overlay { position: absolute; inset: 0; background: rgba(0,0,0,.38); backdrop-filter: blur(2px); }

.modal {
  position: absolute;
  left: 50%;
  top: 50%;
  width: min(760px, 94vw);
  max-height: 90vh;
  transform: translate(-50%, -50%);
  background: #fff;
  border: 1px solid #efefef;
  border-radius: 18px;
  box-shadow: 0 18px 60px rgba(0,0,0,.18);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.head {
  padding: 14px;
  border-bottom: 1px solid #f2f2f2;
  display: flex;
  align-items: center;
  gap: 12px;
}
.title { font-weight: 900; font-size: 16px; }
.x {
  margin-left: auto;
  border: 1px solid #efefef;
  background: #fafafa;
  border-radius: 12px;
  padding: 8px 10px;
  cursor: pointer;
}

.body { padding: 14px; overflow: auto; display: flex; flex-direction: column; gap: 12px; }

.hint {
  background: #fcfcff;
  border: 1px solid rgba(138,117,227,.18);
  border-radius: 14px;
  padding: 10px 12px;
  font-size: 13px;
  opacity: .9;
}

.grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
@media (max-width: 720px) { .grid { grid-template-columns: 1fr; } }

.field { display: flex; flex-direction: column; gap: 6px; }
.field.inline { justify-content: flex-end; }

.label { font-size: 12px; font-weight: 800; opacity: .7; }
.input, .textarea {
  border: 1px solid #efefef;
  border-radius: 12px;
  padding: 10px 10px;
  font-size: 14px;
  background: #fff;
  outline: none;
}
.input:focus, .textarea:focus { border-color: rgba(138,117,227,.55); box-shadow: 0 0 0 3px rgba(138,117,227,.12); }
.textarea { min-height: 120px; resize: vertical; }

.mini { font-size: 12px; opacity: .7; }
.badge {
  display: inline-flex;
  align-items: center;
  padding: 6px 10px;
  border-radius: 999px;
  background: rgba(138,117,227,.12);
  border: 1px solid rgba(138,117,227,.22);
  width: fit-content;
}

.tags { display: flex; flex-wrap: wrap; gap: 8px; }
.tag {
  border: 1px solid #efefef;
  background: #fff;
  border-radius: 999px;
  padding: 7px 10px;
  cursor: pointer;
  font-size: 13px;
}
.tag.active { background: #8a75e3; border-color: #8a75e3; color: #fff; }

.check { display: inline-flex; align-items: center; gap: 10px; cursor: pointer; user-select: none; }
.check input { display: none; }
.ui {
  width: 44px; height: 26px; border-radius: 999px;
  border: 1px solid #e9e9e9; background: #f3f3f3;
  position: relative; transition: background 180ms ease, border-color 180ms ease;
}
.ui::after {
  content: '';
  width: 22px; height: 22px; border-radius: 999px;
  background: #fff; position: absolute; top: 1px; left: 1px;
  box-shadow: 0 2px 10px rgba(0,0,0,.08);
  transition: transform 180ms ease;
}
.check input:checked + .ui { background: rgba(138,117,227,.85); border-color: rgba(138,117,227,.55); }
.check input:checked + .ui::after { transform: translateX(18px); }
.text { font-weight: 800; font-size: 13px; }

.error { color: #d9534f; font-weight: 800; font-size: 13px; }

.foot {
  padding: 14px;
  border-top: 1px solid #f2f2f2;
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}
.btn { border-radius: 14px; padding: 12px 16px; font-weight: 900; cursor: pointer; border: none; }
.btn.secondary { background: #efefef; }
.btn.primary { background: #8a75e3; color: #fff; }
.btn:disabled { opacity: .6; cursor: not-allowed; }
</style>
5) src/components/FiltersPanel.vue
–ï—Å–ª–∏ –æ–Ω —É —Ç–µ–±—è —É–∂–µ –µ—Å—Ç—å ‚Äî –æ—Å—Ç–∞–≤—å. –ï—Å–ª–∏ –Ω–µ—Ç, —Å–∫–∞–∂–∏ ‚Äî —è –ø—Ä–∏—à–ª—é –ø–æ–ª–Ω–æ—Å—Ç—å—é.

–ò—Ç–æ–≥
‚úÖ biz-card –±–æ–ª—å—à–µ –Ω–µ –ª–µ–∂–∏—Ç –≤–Ω—É—Ç—Ä–∏ drawer —Ñ–∏–ª—å—Ç—Ä–æ–≤.
‚úÖ –û–Ω –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è —Å—Ç—Ä–æ–≥–æ —á–µ—Ä–µ–∑ menu-button (—Å–ª–µ–≤–∞ –≤ —à–∞–ø–∫–µ).
‚úÖ –ù–∏–∫–∞–∫–æ–≥–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è CreateEventModal: –æ–Ω –æ–¥–∏–Ω, –≤ App.vue.

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å ‚Äî —Å–ª–µ–¥—É—é—â–∏–º —à–∞–≥–æ–º —Å–¥–µ–ª–∞—é –∫–Ω–æ–ø–∫—É menu-button –Ω–µ ‚Äú–±—É—Ä–≥–µ—Ä‚Äù, –∞ –Ω–æ—Ä–º–∞–ª—å–Ω—É—é –∏–∫–æ–Ω–∫—É ‚Äú–º–µ–Ω—é/–±–∏–∑–Ω–µ—Å‚Äù (–∏–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –±—É—Ä–≥–µ—Ä).


–í—ã —Å–∫–∞–∑–∞–ª–∏:
–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
–ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –¥–ª—è –±–∏–∑–Ω–µ—Å –∞–∫–∫–∞—É–Ω—Ç–∞ –≤ 
–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –µ—â—ë –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è, –∫–∞—Ä—Ç–∏–Ω–∫–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –∑–¥–µ—Å—å
create table public.event_photos (
  id bigint generated by default as identity not null,
  event_id bigint not null,
  photo_url text null,
  constraint event_photos_pkey primary key (id),
  constraint event_photos_event_id_fkey foreign KEY (event_id) references events (id)
) TABLESPACE pg_default;

ChatGPT —Å–∫–∞–∑–∞–ª:

–î—É–º–∞–ª –Ω–∞ –ø—Ä–æ—Ç—è–∂–µ–Ω–∏–∏ 12s
–û–∫, –¥–µ–ª–∞–µ–º –Ω–æ—Ä–º–∞–ª—å–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É –∫–∞—Ä—Ç–∏–Ω–∫–∏ —Ñ–∞–π–ª–æ–º –¥–ª—è –±–∏–∑–Ω–µ—Å-–º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è:

–í –º–æ–¥–∞–ª–∫–µ ‚Äú–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ‚Äù –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤—ã–±–æ—Ä —Ñ–∞–π–ª–∞ + –ø—Ä–µ–≤—å—é (–∏ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –ø–æ–ª–µ ‚ÄúURL‚Äù, –µ—Å–ª–∏ —Ö–æ—á–µ—à—å –≤—Å—Ç–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É).

–ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ:

—Å–æ–∑–¥–∞—ë–º —Å–æ–±—ã—Ç–∏–µ –≤ events (–∫–∞–∫ –∏ —Ä–∞–Ω—å—à–µ, is_published=false)

–µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω —Ñ–∞–π–ª ‚Äî –∑–∞–ª–∏–≤–∞–µ–º –≤ Supabase Storage

–±–µ—Ä—ë–º publicUrl –∏ –≤—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –≤ public.event_photos (event_id, photo_url)

–ù–∏–∂–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∫–æ–¥ —Ñ–∞–π–ª–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å.

1) src/composables/useSupabase.js ‚Äî –ó–ê–ú–ï–ù–ò–¢–¨ –ü–û–õ–ù–û–°–¢–¨–Æ
(–¥–æ–±–∞–≤–∏–ª uploadEventPhotoToStorage + createBusinessEvent —Ç–µ–ø–µ—Ä—å –ø—Ä–∏–Ω–∏–º–∞–µ—Ç photo_file)

import { createClient } from '@supabase/supabase-js'

const supabaseUrl = import.meta.env.VITE_SUPABASE_URL
const supabaseKey = import.meta.env.VITE_SUPABASE_ANON_KEY

export const supabase = createClient(supabaseUrl, supabaseKey)

const normalizeStoragePublicUrl = (url) => {
  if (!url || typeof url !== 'string') return ''
  const u = url.trim()
  if (!u) return ''
  if (u.includes('/storage/v1/object/public/')) return u
  if (u.includes('/storage/v1/object/')) return u.replace('/storage/v1/object/', '/storage/v1/object/public/')
  return u
}

const compact = (obj) => {
  const out = {}
  for (const [k, v] of Object.entries(obj || {})) {
    if (v !== undefined) out[k] = v
  }
  return out
}

const getFileExt = (file) => {
  const name = String(file?.name || '')
  const ext = name.includes('.') ? name.split('.').pop() : ''
  const clean = String(ext || '').toLowerCase().replace(/[^a-z0-9]/g, '')
  return clean || 'png'
}

export const useSupabase = () => {
  // ---------------------------
  // EVENTS (ONLY PUBLISHED)
  // ---------------------------
  const getEvents = async () => {
    const { data, error } = await supabase
      .from('events')
      .select(
        `
        id,
        title,
        description,
        date_time_event,
        address,
        organizer,
        price,
        is_online,
        is_free,
        user_id,
        selectCategory,
        is_published,
        created_at
      `
      )
      .eq('is_published', true)
      .order('created_at', { ascending: false })

    return { data, error }
  }

  const getCategories = async () => {
    const { data, error } = await supabase.from('category').select('id, name').order('name', { ascending: true })
    return { data, error }
  }

  const getEventPhotos = async (eventIds) => {
    if (!Array.isArray(eventIds) || eventIds.length === 0) return { data: [], error: null }

    const { data, error } = await supabase
      .from('event_photos')
      .select('id, event_id, photo_url')
      .in('event_id', eventIds)
      .order('id', { ascending: true })

    return { data: data ?? [], error }
  }

  // ---------------------------
  // AUTH
  // ---------------------------
  const getSession = async () => {
    const { data, error } = await supabase.auth.getSession()
    return { session: data?.session ?? null, error }
  }

  const getUser = async () => {
    const { data, error } = await supabase.auth.getUser()
    return { user: data?.user ?? null, error }
  }

  const signOut = async () => {
    const { error } = await supabase.auth.signOut()
    return { error }
  }

  const signInWithGoogle = async ({ redirectTo }) => {
    const { data, error } = await supabase.auth.signInWithOAuth({
      provider: 'google',
      options: { redirectTo }
    })
    return { data, error }
  }

  // ---------------------------
  // PROFILE (public.users)
  // ---------------------------
  const ensurePublicUserRow = async (authUser) => {
    if (!authUser?.id) return { data: null, error: null }

    const meta = authUser.user_metadata || {}

    const { data: existing, error: exErr } = await supabase
      .from('users')
      .select('id, email, first_name, last_name')
      .eq('id', authUser.id)
      .maybeSingle()

    if (exErr) return { data: null, error: exErr }

    const firstFromMeta = meta.given_name ?? meta.first_name
    const lastFromMeta = meta.family_name ?? meta.last_name

    const payload = compact({
      id: authUser.id,
      email: existing?.email ?? authUser.email ?? null,
      first_name: existing?.first_name ? undefined : firstFromMeta ?? undefined,
      last_name: existing?.last_name ? undefined : lastFromMeta ?? undefined
    })

    const { data, error } = await supabase.from('users').upsert(payload, { onConflict: 'id' }).select().single()
    return { data, error }
  }

  const getMyPublicUser = async () => {
    const { user } = await getUser()
    if (!user) return { data: null, error: null }

    const { data, error } = await supabase.from('users').select('*').eq('id', user.id).single()
    if (data?.image_path) data.image_path = normalizeStoragePublicUrl(data.image_path)
    return { data, error }
  }

  const updateMyPublicUser = async (patch) => {
    const { user } = await getUser()
    if (!user) return { data: null, error: new Error('No auth user') }

    const safePatch = { ...patch }
    delete safePatch.It_business

    for (const k of Object.keys(safePatch)) {
      if (safePatch[k] === '') safePatch[k] = null
    }
    if (safePatch.image_path) safePatch.image_path = normalizeStoragePublicUrl(safePatch.image_path)

    const { data, error } = await supabase.from('users').update(safePatch).eq('id', user.id).select().single()
    if (data?.image_path) data.image_path = normalizeStoragePublicUrl(data.image_path)
    return { data, error }
  }

  // ---------------------------
  // AVATAR UPLOAD
  // ---------------------------
  const uploadAvatar = async (file) => {
    const { user } = await getUser()
    if (!user) return { publicUrl: null, error: new Error('No auth user') }
    if (!file) return { publicUrl: null, error: new Error('No file') }

    const envBucket = (import.meta.env.VITE_SUPABASE_AVATAR_BUCKET || '').trim()
    const buckets = [...new Set([envBucket, 'avatars', 'Biom', 'biom'].filter(Boolean))]

    const ext = getFileExt(file)
    const path = `ProfileImage/${user.id}/${Date.now()}.${ext}`

    let lastErr = null

    for (const bucket of buckets) {
      const { error: upErr } = await supabase.storage.from(bucket).upload(path, file, { upsert: true })
      if (upErr) {
        lastErr = upErr
        if (String(upErr?.message || '').toLowerCase().includes('bucket not found')) continue
        return { publicUrl: null, error: upErr }
      }

      const { data } = supabase.storage.from(bucket).getPublicUrl(path)
      const publicUrl = normalizeStoragePublicUrl(data?.publicUrl || '')
      return { publicUrl, error: null }
    }

    return {
      publicUrl: null,
      error:
        lastErr ||
        new Error('Bucket not found. –°–æ–∑–¥–∞–π bucket –≤ Storage (–Ω–∞–ø—Ä–∏–º–µ—Ä "avatars") –∏ —É–∫–∞–∂–∏ VITE_SUPABASE_AVATAR_BUCKET.')
    }
  }

  // ---------------------------
  // EVENT PHOTO UPLOAD (Storage -> event_photos)
  // ---------------------------
  const uploadEventPhotoToStorage = async (eventId, file) => {
    if (!eventId) return { publicUrl: null, error: new Error('No eventId') }
    if (!file) return { publicUrl: null, error: new Error('No file') }

    // –º–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å —Å–≤–æ–π bucket –≤ .env: VITE_SUPABASE_EVENT_PHOTOS_BUCKET
    const envBucket = (import.meta.env.VITE_SUPABASE_EVENT_PHOTOS_BUCKET || '').trim()
    const buckets = [...new Set([envBucket, 'event-photos', 'event_photos', 'events', 'Biom', 'biom'].filter(Boolean))]

    const ext = getFileExt(file)
    const path = `EventPhotos/${eventId}/${Date.now()}.${ext}`

    let lastErr = null
    for (const bucket of buckets) {
      const { error: upErr } = await supabase.storage.from(bucket).upload(path, file, { upsert: true })
      if (upErr) {
        lastErr = upErr
        if (String(upErr?.message || '').toLowerCase().includes('bucket not found')) continue
        return { publicUrl: null, error: upErr }
      }

      const { data } = supabase.storage.from(bucket).getPublicUrl(path)
      const publicUrl = normalizeStoragePublicUrl(data?.publicUrl || '')
      return { publicUrl, error: null }
    }

    return {
      publicUrl: null,
      error:
        lastErr ||
        new Error(
          'Bucket not found for event photos. –°–æ–∑–¥–∞–π bucket –≤ Storage (–Ω–∞–ø—Ä–∏–º–µ—Ä "event-photos") –∏ —É–∫–∞–∂–∏ VITE_SUPABASE_EVENT_PHOTOS_BUCKET.'
        )
    }
  }

  // ‚úÖ BUSINESS: create draft event (not published) + optional image file/url
  const createBusinessEvent = async (payload) => {
    const { user, error: userErr } = await getUser()
    if (userErr) return { data: null, error: userErr }
    if (!user) return { data: null, error: new Error('–ù–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏') }

    const price = Number(payload?.price ?? 0)
    const is_free = payload?.is_free === true || (Number.isFinite(price) && price <= 0)

    const eventInsert = {
      title: payload?.title ?? null,
      description: payload?.description ?? null,
      date_time_event: payload?.date_time_event ?? null,
      address: payload?.address ?? null,
      organizer: payload?.organizer ?? null,
      price: Number.isFinite(price) ? price : 0,
      is_online: !!payload?.is_online,
      is_free,
      user_id: user.id,
      selectCategory: Array.isArray(payload?.selectCategory) ? payload.selectCategory : [],
      is_published: false
    }

    const { data: eventRow, error: insErr } = await supabase.from('events').insert(eventInsert).select().single()
    if (insErr) return { data: null, error: insErr }

    // 1) –µ—Å–ª–∏ –µ—Å—Ç—å —Ñ–∞–π–ª ‚Äî –∑–∞–≥—Ä—É–∂–∞–µ–º –≤ storage –∏ –ø–∏—à–µ–º –≤ event_photos
    const file = payload?.photo_file || null
    if (file) {
      const { publicUrl, error: upErr } = await uploadEventPhotoToStorage(eventRow.id, file)
      if (upErr) return { data: eventRow, error: upErr }

      const { error: phErr } = await supabase.from('event_photos').insert({
        event_id: eventRow.id,
        photo_url: publicUrl
      })
      if (phErr) return { data: eventRow, error: phErr }
    }

    // 2) –µ—Å–ª–∏ –µ—Å—Ç—å URL ‚Äî —Ç–æ–∂–µ –¥–æ–±–∞–≤–∏–º (–º–æ–∂–µ—Ç –±—ã—Ç—å –∫–∞–∫ –¥–æ–ø –≤–∞—Ä–∏–∞–Ω—Ç)
    const photoUrl = String(payload?.photo_url ?? '').trim()
    if (photoUrl) {
      const { error: phErr2 } = await supabase.from('event_photos').insert({
        event_id: eventRow.id,
        photo_url: photoUrl
      })
      if (phErr2) return { data: eventRow, error: phErr2 }
    }

    return { data: eventRow, error: null }
  }

  // ---------------------------
  // TELEGRAM
  // ---------------------------
  const linkTelegramViaEdgeFunction = async (telegramAuthData) => {
    const { data, error } = await supabase.functions.invoke('telegram-verify', { body: telegramAuthData })
    return { data, error }
  }

  const getMyTelegramLink = async () => {
    const { user } = await getUser()
    if (!user) return { data: null, error: null }

    const { data, error } = await supabase.from('user_telegram').select('*').eq('user_id', user.id).maybeSingle()
    return { data: data ?? null, error }
  }

  return {
    // events
    getEvents,
    getCategories,
    getEventPhotos,
    createBusinessEvent,

    // auth
    getSession,
    getUser,
    signInWithGoogle,
    signOut,

    // profile
    ensurePublicUserRow,
    getMyPublicUser,
    updateMyPublicUser,
    uploadAvatar,

    // telegram
    linkTelegramViaEdgeFunction,
    getMyTelegramLink
  }
}
2) src/components/CreateEventModal.vue ‚Äî –ó–ê–ú–ï–ù–ò–¢–¨ –ü–û–õ–ù–û–°–¢–¨–Æ
(–¥–æ–±–∞–≤–∏–ª input file + –ø—Ä–µ–≤—å—é + –æ—Ç–ø—Ä–∞–≤–∫–∞ photo_file)

<template>
  <teleport to="body">
    <div v-if="open" class="root" @keydown.esc="close" tabindex="-1">
      <div class="overlay" @click="close"></div>

      <div class="modal" role="dialog" aria-modal="true" aria-label="–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ">
        <div class="head">
          <div class="title">–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</div>
          <button class="x" @click="close" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
        </div>

        <div class="body">
          <div class="hint">
            –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è —Å <b>is_published=false</b> –∏ –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∞–¥–º–∏–Ω–æ–º.
          </div>

          <div class="grid">
            <div class="field">
              <div class="label">–ù–∞–∑–≤–∞–Ω–∏–µ *</div>
              <input class="input" v-model="form.title" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –í–µ—á–µ—Ä –Ω–∞—Å—Ç–æ–ª–æ–∫" />
            </div>

            <div class="field">
              <div class="label">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è *</div>
              <input class="input" type="datetime-local" v-model="form.date_time_event" />
            </div>

            <div class="field">
              <div class="label">–ê–¥—Ä–µ—Å</div>
              <input class="input" v-model="form.address" placeholder="–ì–æ—Ä–æ–¥, —É–ª–∏—Ü–∞, –¥–æ–º / –∏–ª–∏ —Å—Å—ã–ª–∫–∞" />
            </div>

            <div class="field">
              <div class="label">–û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä</div>
              <input class="input" v-model="form.organizer" placeholder="–ò–º—è/–ø—Ä–æ–µ–∫—Ç" />
            </div>

            <div class="field">
              <div class="label">–¶–µ–Ω–∞ (‚ÇΩ)</div>
              <input class="input" type="number" min="0" inputmode="numeric" v-model="form.price" placeholder="0" />
              <div class="mini"><span class="badge" v-if="isFree">üÜì –ë–µ—Å–ø–ª–∞—Ç–Ω–æ</span></div>
            </div>

            <div class="field inline">
              <label class="check">
                <input type="checkbox" v-model="form.is_online" />
                <span class="ui"></span>
                <span class="text">–û–Ω–ª–∞–π–Ω (is_online)</span>
              </label>
            </div>
          </div>

          <div class="field">
            <div class="label">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</div>
            <div class="tags">
              <button
                v-for="c in categories"
                :key="c.id"
                class="tag"
                :class="{ active: selectedCategories.includes(c.name) }"
                @click="toggleCategory(c.name)"
                type="button"
              >
                {{ c.name }}
              </button>
            </div>
            <div class="mini">–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ.</div>
          </div>

          <!-- ‚úÖ IMAGE -->
          <div class="field">
            <div class="label">–ö–∞—Ä—Ç–∏–Ω–∫–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</div>

            <div class="image-row">
              <label class="file-btn">
                <input class="file-input" type="file" accept="image/*" @change="onPickFile" />
                üì∑ –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª
              </label>

              <button v-if="pickedFile" class="file-clear" type="button" @click="clearFile">
                –£–±—Ä–∞—Ç—å
              </button>
            </div>

            <div v-if="pickedFile" class="preview">
              <img :src="previewUrl" alt="preview" />
              <div class="preview-meta">
                <div class="preview-name">{{ pickedFile.name }}</div>
                <div class="preview-sub">{{ prettySize(pickedFile.size) }}</div>
              </div>
            </div>

            <div class="mini">
              –§–∞–π–ª –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è –≤ Storage, –∞ —Å—Å—ã–ª–∫–∞ –ø–æ–ø–∞–¥—ë—Ç –≤ <b>event_photos.photo_url</b>.
            </div>

            <div class="mini" style="margin-top: 8px; opacity:.75;">
              –ò–ª–∏ –º–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å —Å—Å—ã–ª–∫—É (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):
            </div>
            <input class="input" v-model="form.photo_url" placeholder="https://..." />
          </div>

          <div class="field">
            <div class="label">–û–ø–∏—Å–∞–Ω–∏–µ *</div>
            <textarea class="textarea" v-model="form.description" placeholder="–û–ø–∏—à–∏, —á—Ç–æ –±—É–¥–µ—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å"></textarea>
          </div>

          <div v-if="error" class="error">{{ error }}</div>
        </div>

        <div class="foot">
          <button class="btn secondary" @click="close">–û—Ç–º–µ–Ω–∞</button>
          <button class="btn primary" :disabled="saving" @click="submit">
            {{ saving ? '–û—Ç–ø—Ä–∞–≤–ª—è—é‚Ä¶' : '–û—Ç–ø—Ä–∞–≤–∏—Ç—å' }}
          </button>
        </div>
      </div>
    </div>
  </teleport>
</template>

<script>
const trimOrNull = (v) => {
  const s = String(v ?? '').trim()
  return s ? s : null
}

export default {
  name: 'CreateEventModal',
  emits: ['close', 'created'],
  props: {
    open: { type: Boolean, default: false },
    categories: { type: Array, default: () => [] },
    createBusinessEvent: { type: Function, required: true }
  },
  data() {
    return {
      saving: false,
      error: '',
      selectedCategories: [],
      form: {
        title: '',
        description: '',
        date_time_event: '',
        address: '',
        organizer: '',
        price: '0',
        is_online: false,
        photo_url: ''
      },
      pickedFile: null,
      previewUrl: ''
    }
  },
  computed: {
    isFree() {
      const n = Number(this.form.price)
      return Number.isFinite(n) && n <= 0
    }
  },
  watch: {
    open(v) {
      if (!v) {
        this.cleanupPreview()
      }
    }
  },
  methods: {
    close() {
      if (this.saving) return
      this.$emit('close')
    },
    toggleCategory(name) {
      const n = String(name || '').trim()
      if (!n) return
      const idx = this.selectedCategories.indexOf(n)
      if (idx >= 0) this.selectedCategories.splice(idx, 1)
      else this.selectedCategories.push(n)
    },

    prettySize(bytes) {
      const b = Number(bytes || 0)
      if (b < 1024) return `${b} B`
      const kb = b / 1024
      if (kb < 1024) return `${kb.toFixed(1)} KB`
      const mb = kb / 1024
      return `${mb.toFixed(1)} MB`
    },

    onPickFile(e) {
      const file = e?.target?.files?.[0]
      if (!file) return

      if (!String(file.type || '').startsWith('image/')) {
        this.error = '–ù—É–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.'
        e.target.value = ''
        return
      }

      // –ª–∏–º–∏—Ç (—á—Ç–æ–±—ã –Ω–µ —É–ª–µ—Ç–∞–ª–∏ –æ–≥—Ä–æ–º–Ω—ã–µ) ‚Äî –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å
      const maxMB = 8
      if (file.size > maxMB * 1024 * 1024) {
        this.error = `–°–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π —Ñ–∞–π–ª. –ú–∞–∫—Å–∏–º—É–º ${maxMB}MB.`
        e.target.value = ''
        return
      }

      this.error = ''
      this.pickedFile = file

      this.cleanupPreview()
      this.previewUrl = URL.createObjectURL(file)
    },

    clearFile() {
      this.pickedFile = null
      this.cleanupPreview()
      this.previewUrl = ''
    },

    cleanupPreview() {
      try {
        if (this.previewUrl) URL.revokeObjectURL(this.previewUrl)
      } catch {}
    },

    async submit() {
      this.error = ''

      const title = trimOrNull(this.form.title)
      const description = trimOrNull(this.form.description)
      const dt = trimOrNull(this.form.date_time_event)

      if (!title) return (this.error = '–£–∫–∞–∂–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ.')
      if (!dt) return (this.error = '–£–∫–∞–∂–∏ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è.')
      if (!description) return (this.error = '–£–∫–∞–∂–∏ –æ–ø–∏—Å–∞–Ω–∏–µ.')

      const priceNum = Number(this.form.price)
      const price = Number.isFinite(priceNum) ? priceNum : 0
      const is_free = price <= 0

      const payload = {
        title,
        description,
        date_time_event: dt,
        address: trimOrNull(this.form.address),
        organizer: trimOrNull(this.form.organizer),
        price,
        is_online: !!this.form.is_online,
        is_free,
        selectCategory: [...this.selectedCategories],

        // ‚úÖ file + url
        photo_file: this.pickedFile || null,
        photo_url: trimOrNull(this.form.photo_url)
      }

      this.saving = true
      try {
        const { data, error } = await this.createBusinessEvent(payload)
        if (error) {
          this.error = String(error.message || error)
          return
        }

        // reset
        this.selectedCategories = []
        this.form = {
          title: '',
          description: '',
          date_time_event: '',
          address: '',
          organizer: '',
          price: '0',
          is_online: false,
          photo_url: ''
        }
        this.clearFile()

        this.$emit('created', data)
        this.$emit('close')
      } finally {
        this.saving = false
      }
    }
  }
}
</script>

<style scoped>
.root { position: fixed; inset: 0; z-index: 10000; }
.overlay { position: absolute; inset: 0; background: rgba(0,0,0,.38); backdrop-filter: blur(2px); }

.modal {
  position: absolute;
  left: 50%;
  top: 50%;
  width: min(760px, 94vw);
  max-height: 90vh;
  transform: translate(-50%, -50%);
  background: #fff;
  border: 1px solid #efefef;
  border-radius: 18px;
  box-shadow: 0 18px 60px rgba(0,0,0,.18);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.head {
  padding: 14px;
  border-bottom: 1px solid #f2f2f2;
  display: flex;
  align-items: center;
  gap: 12px;
}
.title { font-weight: 900; font-size: 16px; }
.x {
  margin-left: auto;
  border: 1px solid #efefef;
  background: #fafafa;
  border-radius: 12px;
  padding: 8px 10px;
  cursor: pointer;
}

.body { padding: 14px; overflow: auto; display: flex; flex-direction: column; gap: 12px; }

.hint {
  background: #fcfcff;
  border: 1px solid rgba(138,117,227,.18);
  border-radius: 14px;
  padding: 10px 12px;
  font-size: 13px;
  opacity: .9;
}

.grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
@media (max-width: 720px) { .grid { grid-template-columns: 1fr; } }

.field { display: flex; flex-direction: column; gap: 6px; }
.field.inline { justify-content: flex-end; }

.label { font-size: 12px; font-weight: 800; opacity: .7; }
.input, .textarea {
  border: 1px solid #efefef;
  border-radius: 12px;
  padding: 10px 10px;
  font-size: 14px;
  background: #fff;
  outline: none;
}
.input:focus, .textarea:focus { border-color: rgba(138,117,227,.55); box-shadow: 0 0 0 3px rgba(138,117,227,.12); }
.textarea { min-height: 120px; resize: vertical; }

.mini { font-size: 12px; opacity: .7; line-height: 1.25; }
.badge {
  display: inline-flex;
  align-items: center;
  padding: 6px 10px;
  border-radius: 999px;
  background: rgba(138,117,227,.12);
  border: 1px solid rgba(138,117,227,.22);
  width: fit-content;
}

.tags { display: flex; flex-wrap: wrap; gap: 8px; }
.tag {
  border: 1px solid #efefef;
  background: #fff;
  border-radius: 999px;
  padding: 7px 10px;
  cursor: pointer;
  font-size: 13px;
}
.tag.active { background: #8a75e3; border-color: #8a75e3; color: #fff; }

/* toggle */
.check { display: inline-flex; align-items: center; gap: 10px; cursor: pointer; user-select: none; }
.check input { display: none; }
.ui {
  width: 44px; height: 26px; border-radius: 999px;
  border: 1px solid #e9e9e9; background: #f3f3f3;
  position: relative; transition: background 180ms ease, border-color 180ms ease;
}
.ui::after {
  content: '';
  width: 22px; height: 22px; border-radius: 999px;
  background: #fff; position: absolute; top: 1px; left: 1px;
  box-shadow: 0 2px 10px rgba(0,0,0,.08);
  transition: transform 180ms ease;
}
.check input:checked + .ui { background: rgba(138,117,227,.85); border-color: rgba(138,117,227,.55); }
.check input:checked + .ui::after { transform: translateX(18px); }
.text { font-weight: 800; font-size: 13px; }

.image-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
.file-input { display: none; }
.file-btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  border: 1px solid #efefef;
  background: #fff;
  border-radius: 14px;
  padding: 10px 12px;
  font-weight: 900;
  cursor: pointer;
}
.file-btn:hover { background: #fafafa; }
.file-clear {
  border: 1px solid #efefef;
  background: #fafafa;
  border-radius: 14px;
  padding: 10px 12px;
  font-weight: 900;
  cursor: pointer;
}
.file-clear:hover { background: #f0f0f0; }

.preview {
  margin-top: 8px;
  border: 1px solid #efefef;
  border-radius: 16px;
  overflow: hidden;
  display: grid;
  grid-template-columns: 140px 1fr;
  gap: 0;
  background: #fff;
}
.preview img {
  width: 140px;
  height: 110px;
  object-fit: cover;
  display: block;
  background: #f2f2f2;
}
.preview-meta { padding: 10px; display: grid; gap: 6px; align-content: center; }
.preview-name { font-weight: 900; font-size: 13px; word-break: break-word; }
.preview-sub { font-size: 12px; opacity: .7; }

.error { color: #d9534f; font-weight: 800; font-size: 13px; }

.foot {
  padding: 14px;
  border-top: 1px solid #f2f2f2;
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}
.btn { border-radius: 14px; padding: 12px 16px; font-weight: 900; cursor: pointer; border: none; }
.btn.secondary { background: #efefef; }
.btn.primary { background: #8a75e3; color: #fff; }
.btn:disabled { opacity: .6; cursor: not-allowed; }
</style>
–í–∞–∂–Ω–æ (–æ–¥–∏–Ω —Ä–∞–∑ –≤ Supabase Storage)
–ß—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∫–∞ —Ä–∞–±–æ—Ç–∞–ª–∞, —É —Ç–µ–±—è –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å bucket –¥–ª—è —Ñ–æ—Ç–æ–∫ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π.

–°–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π –≤–∞—Ä–∏–∞–Ω—Ç:

Supabase ‚Üí Storage ‚Üí Create bucket ‚Üí –Ω–∞–∑–æ–≤–∏ event-photos

–í –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö bucket –≤–∫–ª—é—á–∏ Public

(–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –¥–æ–±–∞–≤—å –≤ .env:

VITE_SUPABASE_EVENT_PHOTOS_BUCKET=event-photos

–ö–æ–¥ —É–∂–µ —É–º–µ–µ—Ç –ø—Ä–æ–±–æ–≤–∞—Ç—å bucket‚Äô–∏ –ø–æ —Å–ø–∏—Å–∫—É –∏ —á–µ—Ä–µ–∑ env.

–ï—Å–ª–∏ –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞ –±—É–¥–µ—Ç –æ—à–∏–±–∫–∞ —Ç–∏–ø–∞ Bucket not found –∏–ª–∏ Unauthorized, —Å–∫–∏–Ω—å —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏ –∏–∑ –∫–æ–Ω—Å–æ–ª–∏ ‚Äî —Å–∫–∞–∂—É, –∫–∞–∫–∏–µ –ø–æ–ª–∏—Ç–∏–∫–∏ (RLS/Storage) –≤–∫–ª—é—á–∏—Ç—å, —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞–ª–æ.


–í—ã —Å–∫–∞–∑–∞–ª–∏:
–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
–≤ —Å—Ç—Ä–æ–∫—É pfotoURl –ø–æ–ø–∞–ª–∞ —è–≤–Ω–æ –Ω–µ —Å—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É
–¢–∞–∫–∂–µ –ø–æ –º–µ–ª–æ—á–∏ –∏–∑–º–µ–Ω–∏ –≤–æ—Ç —ç—Ç–æ:
1)–ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è modal –¥–æ–ª–∂–µ–Ω –∑–∞–∫—Ä—ã—Ç—å—Å—è –∏ –≤ —Ü–µ–Ω—Ç—Ä–µ –¥–æ–ª–∂–Ω–∞ –ø–æ—è–≤–∏—Ç—å—Å—è —Ä–∞–º–∫–∞ "–º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –∂–¥—ë—Ç –æ–¥–æ–±—Ä–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞" 
2)—É–±–µ—Ä–∏ –≤—Ç–æ—Ä—É—é –Ω–∞–¥–ø–∏—Å—å –§–∏–ª—å—Ç—Ä—ã –≤ drawer
3) —Å–∫—Ä–æ–π –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π page-title –∏ page-sub
4) –í –º–µ–Ω—é –¥–æ–±–∞–≤—å –æ–ø–∏—Å–∞–Ω–∏–µ –±–∏–∑–Ω–µ—Å –∞–∫–∫–∞—É–Ω—Ç–∞ "–±–∏–∑–Ω–µ—Å –∞–∫–∫–∞—É–Ω—Ç –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è, –µ–≥–æ —Å—Ç–æ–∏–º–æ—Å—Ç—å - 200 —Ä—É–±–ª–µ–π –≤ –º–µ—Å—è—Ü, –¥–ª—è –ø—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω–∏—è –Ω—É–∂–Ω–æ –Ω–∞–ø–∏—Å–∞—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä"

ChatGPT —Å–∫–∞–∑–∞–ª:

–î—É–º–∞–ª –Ω–∞ –ø—Ä–æ—Ç—è–∂–µ–Ω–∏–∏ 51s
–ü–æ–Ω—è–ª. –¢—É—Ç –¥–≤–µ —Ä–∞–∑–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

–í event_photos.photo_url –ø–æ–ø–∞–¥–∞–µ—Ç data:image/... ‚Äî —ç—Ç–æ –Ω–µ —Å—Å—ã–ª–∫–∞, –∏ —Ç–∞–∫ –Ω–µ–ª—å–∑—è —Ö—Ä–∞–Ω–∏—Ç—å, –µ—Å–ª–∏ —Ç—ã —Ö–æ—á–µ—à—å –Ω–æ—Ä–º–∞–ª—å–Ω—ã–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏. –≠—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ—Ç–æ–º—É —á—Ç–æ –ø–æ–ª–µ photo_url —Å–µ–π—á–∞—Å –ø–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø–∏—Å–∞—Ç—å –≤–æ–æ–±—â–µ —á—Ç–æ —É–≥–æ–¥–Ω–æ (–≤–∫–ª—é—á–∞—è data-url). –ú—ã —Å–¥–µ–ª–∞–µ–º —Ç–∞–∫:

–µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω —Ñ–∞–π–ª ‚Üí –≥—Ä—É–∑–∏–º –≤ Supabase Storage ‚Üí –≤ event_photos.photo_url –ø–∏—à–µ–º public URL

–µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Å—Ç–∞–≤–∏–ª —Å—Å—ã–ª–∫—É –≤—Ä—É—á–Ω—É—é ‚Üí —Ä–∞–∑—Ä–µ—à–∞–µ–º —Ç–æ–ª—å–∫–æ http/https, –∞ data:/blob: –∑–∞–ø—Ä–µ—â–∞–µ–º (–ø–æ–∫–∞–∂–µ–º –æ—à–∏–±–∫—É –∏ –Ω–µ –æ—Ç–ø—Ä–∞–≤–∏–º)

–ú–µ–ª–∫–∏–µ –ø—Ä–∞–≤–∫–∏ –ø–æ UI ‚Äî —Å–¥–µ–ª–∞–µ–º.

–ù–∏–∂–µ –ø–æ–ª–Ω—ã–π –∫–æ–¥ —Ñ–∞–π–ª–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å/–¥–æ–±–∞–≤–∏—Ç—å.

1) src/composables/useSupabase.js ‚Äî –ó–ê–ú–ï–ù–ò–¢–¨ –ü–û–õ–ù–û–°–¢–¨–Æ
(–∑–∞–ø—Ä–µ—â–∞–µ–º data:/blob: –≤ photo_url, –∏ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —Ñ–∞–π–ª–∞ –Ω–µ –¥–∞—ë–º ‚Äú–ø—Ä–æ—Å–∫–æ—á–∏—Ç—å‚Äù –º—É—Å–æ—Ä—É)

import { createClient } from '@supabase/supabase-js'

const supabaseUrl = import.meta.env.VITE_SUPABASE_URL
const supabaseKey = import.meta.env.VITE_SUPABASE_ANON_KEY

export const supabase = createClient(supabaseUrl, supabaseKey)

const normalizeStoragePublicUrl = (url) => {
  if (!url || typeof url !== 'string') return ''
  const u = url.trim()
  if (!u) return ''
  if (u.includes('/storage/v1/object/public/')) return u
  if (u.includes('/storage/v1/object/')) return u.replace('/storage/v1/object/', '/storage/v1/object/public/')
  return u
}

const compact = (obj) => {
  const out = {}
  for (const [k, v] of Object.entries(obj || {})) {
    if (v !== undefined) out[k] = v
  }
  return out
}

const getFileExt = (file) => {
  const name = String(file?.name || '')
  const ext = name.includes('.') ? name.split('.').pop() : ''
  const clean = String(ext || '').toLowerCase().replace(/[^a-z0-9]/g, '')
  return clean || 'png'
}

const isHttpUrl = (s) => {
  const str = String(s || '').trim()
  if (!str) return false
  return /^https?:\/\/.+/i.test(str)
}

export const useSupabase = () => {
  // ---------------------------
  // EVENTS (ONLY PUBLISHED)
  // ---------------------------
  const getEvents = async () => {
    const { data, error } = await supabase
      .from('events')
      .select(
        `
        id,
        title,
        description,
        date_time_event,
        address,
        organizer,
        price,
        is_online,
        is_free,
        user_id,
        selectCategory,
        is_published,
        created_at
      `
      )
      .eq('is_published', true)
      .order('created_at', { ascending: false })

    return { data, error }
  }

  const getCategories = async () => {
    const { data, error } = await supabase.from('category').select('id, name').order('name', { ascending: true })
    return { data, error }
  }

  const getEventPhotos = async (eventIds) => {
    if (!Array.isArray(eventIds) || eventIds.length === 0) return { data: [], error: null }

    const { data, error } = await supabase
      .from('event_photos')
      .select('id, event_id, photo_url')
      .in('event_id', eventIds)
      .order('id', { ascending: true })

    return { data: data ?? [], error }
  }

  // ---------------------------
  // AUTH
  // ---------------------------
  const getSession = async () => {
    const { data, error } = await supabase.auth.getSession()
    return { session: data?.session ?? null, error }
  }

  const getUser = async () => {
    const { data, error } = await supabase.auth.getUser()
    return { user: data?.user ?? null, error }
  }

  const signOut = async () => {
    const { error } = await supabase.auth.signOut()
    return { error }
  }

  const signInWithGoogle = async ({ redirectTo }) => {
    const { data, error } = await supabase.auth.signInWithOAuth({
      provider: 'google',
      options: { redirectTo }
    })
    return { data, error }
  }

  // ---------------------------
  // PROFILE (public.users)
  // ---------------------------
  const ensurePublicUserRow = async (authUser) => {
    if (!authUser?.id) return { data: null, error: null }

    const meta = authUser.user_metadata || {}

    const { data: existing, error: exErr } = await supabase
      .from('users')
      .select('id, email, first_name, last_name')
      .eq('id', authUser.id)
      .maybeSingle()

    if (exErr) return { data: null, error: exErr }

    const firstFromMeta = meta.given_name ?? meta.first_name
    const lastFromMeta = meta.family_name ?? meta.last_name

    const payload = compact({
      id: authUser.id,
      email: existing?.email ?? authUser.email ?? null,
      first_name: existing?.first_name ? undefined : firstFromMeta ?? undefined,
      last_name: existing?.last_name ? undefined : lastFromMeta ?? undefined
    })

    const { data, error } = await supabase.from('users').upsert(payload, { onConflict: 'id' }).select().single()
    return { data, error }
  }

  const getMyPublicUser = async () => {
    const { user } = await getUser()
    if (!user) return { data: null, error: null }

    const { data, error } = await supabase.from('users').select('*').eq('id', user.id).single()
    if (data?.image_path) data.image_path = normalizeStoragePublicUrl(data.image_path)
    return { data, error }
  }

  const updateMyPublicUser = async (patch) => {
    const { user } = await getUser()
    if (!user) return { data: null, error: new Error('No auth user') }

    const safePatch = { ...patch }
    delete safePatch.It_business

    for (const k of Object.keys(safePatch)) {
      if (safePatch[k] === '') safePatch[k] = null
    }
    if (safePatch.image_path) safePatch.image_path = normalizeStoragePublicUrl(safePatch.image_path)

    const { data, error } = await supabase.from('users').update(safePatch).eq('id', user.id).select().single()
    if (data?.image_path) data.image_path = normalizeStoragePublicUrl(data.image_path)
    return { data, error }
  }

  // ---------------------------
  // AVATAR UPLOAD
  // ---------------------------
  const uploadAvatar = async (file) => {
    const { user } = await getUser()
    if (!user) return { publicUrl: null, error: new Error('No auth user') }
    if (!file) return { publicUrl: null, error: new Error('No file') }

    const envBucket = (import.meta.env.VITE_SUPABASE_AVATAR_BUCKET || '').trim()
    const buckets = [...new Set([envBucket, 'avatars', 'Biom', 'biom'].filter(Boolean))]

    const ext = getFileExt(file)
    const path = `ProfileImage/${user.id}/${Date.now()}.${ext}`

    let lastErr = null

    for (const bucket of buckets) {
      const { error: upErr } = await supabase.storage.from(bucket).upload(path, file, { upsert: true })
      if (upErr) {
        lastErr = upErr
        if (String(upErr?.message || '').toLowerCase().includes('bucket not found')) continue
        return { publicUrl: null, error: upErr }
      }

      const { data } = supabase.storage.from(bucket).getPublicUrl(path)
      const publicUrl = normalizeStoragePublicUrl(data?.publicUrl || '')
      return { publicUrl, error: null }
    }

    return {
      publicUrl: null,
      error:
        lastErr ||
        new Error('Bucket not found. –°–æ–∑–¥–∞–π bucket –≤ Storage (–Ω–∞–ø—Ä–∏–º–µ—Ä "avatars") –∏ —É–∫–∞–∂–∏ VITE_SUPABASE_AVATAR_BUCKET.')
    }
  }

  // ---------------------------
  // EVENT PHOTO UPLOAD (Storage -> event_photos)
  // ---------------------------
  const uploadEventPhotoToStorage = async (eventId, file) => {
    if (!eventId) return { publicUrl: null, error: new Error('No eventId') }
    if (!file) return { publicUrl: null, error: new Error('No file') }

    const envBucket = (import.meta.env.VITE_SUPABASE_EVENT_PHOTOS_BUCKET || '').trim()
    const buckets = [...new Set([envBucket, 'event-photos', 'event_photos', 'events', 'Biom', 'biom'].filter(Boolean))]

    const ext = getFileExt(file)
    const path = `EventPhotos/${eventId}/${Date.now()}.${ext}`

    let lastErr = null
    for (const bucket of buckets) {
      const { error: upErr } = await supabase.storage.from(bucket).upload(path, file, { upsert: true })
      if (upErr) {
        lastErr = upErr
        if (String(upErr?.message || '').toLowerCase().includes('bucket not found')) continue
        return { publicUrl: null, error: upErr }
      }

      const { data } = supabase.storage.from(bucket).getPublicUrl(path)
      const publicUrl = normalizeStoragePublicUrl(data?.publicUrl || '')
      return { publicUrl, error: null }
    }

    return {
      publicUrl: null,
      error:
        lastErr ||
        new Error(
          'Bucket not found for event photos. –°–æ–∑–¥–∞–π bucket –≤ Storage (–Ω–∞–ø—Ä–∏–º–µ—Ä "event-photos") –∏ —É–∫–∞–∂–∏ VITE_SUPABASE_EVENT_PHOTOS_BUCKET.'
        )
    }
  }

  // ‚úÖ BUSINESS create draft + —Ñ–æ—Ç–æ
  const createBusinessEvent = async (payload) => {
    const { user, error: userErr } = await getUser()
    if (userErr) return { data: null, error: userErr }
    if (!user) return { data: null, error: new Error('–ù–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏') }

    const price = Number(payload?.price ?? 0)
    const is_free = payload?.is_free === true || (Number.isFinite(price) && price <= 0)

    const eventInsert = {
      title: payload?.title ?? null,
      description: payload?.description ?? null,
      date_time_event: payload?.date_time_event ?? null,
      address: payload?.address ?? null,
      organizer: payload?.organizer ?? null,
      price: Number.isFinite(price) ? price : 0,
      is_online: !!payload?.is_online,
      is_free,
      user_id: user.id,
      selectCategory: Array.isArray(payload?.selectCategory) ? payload.selectCategory : [],
      is_published: false
    }

    const { data: eventRow, error: insErr } = await supabase.from('events').insert(eventInsert).select().single()
    if (insErr) return { data: null, error: insErr }

    // 1) FILE -> storage -> event_photos
    const file = payload?.photo_file || null
    if (file) {
      const { publicUrl, error: upErr } = await uploadEventPhotoToStorage(eventRow.id, file)
      if (upErr) return { data: eventRow, error: upErr }

      const { error: phErr } = await supabase.from('event_photos').insert({
        event_id: eventRow.id,
        photo_url: publicUrl
      })
      if (phErr) return { data: eventRow, error: phErr }
    }

    // 2) URL (only http/https)
    const photoUrl = String(payload?.photo_url ?? '').trim()
    if (photoUrl) {
      if (!isHttpUrl(photoUrl)) {
        return { data: eventRow, error: new Error('photo_url –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å—Å—ã–ª–∫–æ–π http/https. data: –∏ blob: –∑–∞–ø—Ä–µ—â–µ–Ω—ã.') }
      }

      const { error: phErr2 } = await supabase.from('event_photos').insert({
        event_id: eventRow.id,
        photo_url: photoUrl
      })
      if (phErr2) return { data: eventRow, error: phErr2 }
    }

    return { data: eventRow, error: null }
  }

  // ---------------------------
  // TELEGRAM
  // ---------------------------
  const linkTelegramViaEdgeFunction = async (telegramAuthData) => {
    const { data, error } = await supabase.functions.invoke('telegram-verify', { body: telegramAuthData })
    return { data, error }
  }

  const getMyTelegramLink = async () => {
    const { user } = await getUser()
    if (!user) return { data: null, error: null }

    const { data, error } = await supabase.from('user_telegram').select('*').eq('user_id', user.id).maybeSingle()
    return { data: data ?? null, error }
  }

  return {
    getEvents,
    getCategories,
    getEventPhotos,
    createBusinessEvent,

    getSession,
    getUser,
    signInWithGoogle,
    signOut,

    ensurePublicUserRow,
    getMyPublicUser,
    updateMyPublicUser,
    uploadAvatar,

    linkTelegramViaEdgeFunction,
    getMyTelegramLink
  }
}
2) src/components/CreateEventModal.vue ‚Äî –ó–ê–ú–ï–ù–ò–¢–¨ –ü–û–õ–ù–û–°–¢–¨–Æ
–ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –º–æ–¥–∞–ª–∫–∞ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è (—É–∂–µ –±—ã–ª–æ)

–ù–∏–∫–∞–∫–∏—Ö data: –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º (–µ—Å–ª–∏ –ø–æ–ª–µ URL –∑–∞–ø–æ–ª–Ω–µ–Ω–æ –Ω–µ http/https ‚Äî –æ—à–∏–±–∫–∞)

–§–∞–π–ª + –ø—Ä–µ–≤—å—é –æ—Å—Ç–∞—é—Ç—Å—è

<template>
  <teleport to="body">
    <div v-if="open" class="root" @keydown.esc="close" tabindex="-1">
      <div class="overlay" @click="close"></div>

      <div class="modal" role="dialog" aria-modal="true" aria-label="–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ">
        <div class="head">
          <div class="title">–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</div>
          <button class="x" @click="close" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
        </div>

        <div class="body">
          <div class="hint">
            –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è –≤ –ø—Ä–µ–¥–ª–æ–∂–∫—É –∏ –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∞–¥–º–∏–Ω–æ–º.
          </div>

          <div class="grid">
            <div class="field">
              <div class="label">–ù–∞–∑–≤–∞–Ω–∏–µ *</div>
              <input class="input" v-model="form.title" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –í–µ—á–µ—Ä –Ω–∞—Å—Ç–æ–ª–æ–∫" />
            </div>

            <div class="field">
              <div class="label">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è *</div>
              <input class="input" type="datetime-local" v-model="form.date_time_event" />
            </div>

            <div class="field">
              <div class="label">–ê–¥—Ä–µ—Å</div>
              <input class="input" v-model="form.address" placeholder="–ì–æ—Ä–æ–¥, —É–ª–∏—Ü–∞, –¥–æ–º / –∏–ª–∏ —Å—Å—ã–ª–∫–∞" />
            </div>

            <div class="field">
              <div class="label">–û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä</div>
              <input class="input" v-model="form.organizer" placeholder="–ò–º—è/–ø—Ä–æ–µ–∫—Ç" />
            </div>

            <div class="field">
              <div class="label">–¶–µ–Ω–∞ (‚ÇΩ)</div>
              <input class="input" type="number" min="0" inputmode="numeric" v-model="form.price" placeholder="0" />
              <div class="mini"><span class="badge" v-if="isFree">üÜì –ë–µ—Å–ø–ª–∞—Ç–Ω–æ</span></div>
            </div>

            <div class="field inline">
              <label class="check">
                <input type="checkbox" v-model="form.is_online" />
                <span class="ui"></span>
                <span class="text">–û–Ω–ª–∞–π–Ω (is_online)</span>
              </label>
            </div>
          </div>

          <div class="field">
            <div class="label">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</div>
            <div class="tags">
              <button
                v-for="c in categories"
                :key="c.id"
                class="tag"
                :class="{ active: selectedCategories.includes(c.name) }"
                @click="toggleCategory(c.name)"
                type="button"
              >
                {{ c.name }}
              </button>
            </div>
            <div class="mini">–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ.</div>
          </div>

          <!-- IMAGE -->
          <div class="field">
            <div class="label">–ö–∞—Ä—Ç–∏–Ω–∫–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</div>

            <div class="image-row">
              <label class="file-btn">
                <input class="file-input" type="file" accept="image/*" @change="onPickFile" />
                üì∑ –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª
              </label>

              <button v-if="pickedFile" class="file-clear" type="button" @click="clearFile">
                –£–±—Ä–∞—Ç—å
              </button>
            </div>

            <div v-if="pickedFile" class="preview">
              <img :src="previewUrl" alt="preview" />
              <div class="preview-meta">
                <div class="preview-name">{{ pickedFile.name }}</div>
                <div class="preview-sub">{{ prettySize(pickedFile.size) }}</div>
              </div>
            </div>

            <div class="mini">
              –§–∞–π–ª –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è –≤ Storage, –∞ —Å—Å—ã–ª–∫–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ <b>event_photos.photo_url</b>.
            </div>

            <div class="mini" style="margin-top: 8px; opacity:.75;">
              –ò–ª–∏ –º–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å —Å—Å—ã–ª–∫—É (—Ç–æ–ª—å–∫–æ http/https):
            </div>
            <input class="input" v-model="form.photo_url" placeholder="https://..." />
          </div>

          <div class="field">
            <div class="label">–û–ø–∏—Å–∞–Ω–∏–µ *</div>
            <textarea class="textarea" v-model="form.description" placeholder="–û–ø–∏—à–∏, —á—Ç–æ –±—É–¥–µ—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å"></textarea>
          </div>

          <div v-if="error" class="error">{{ error }}</div>
        </div>

        <div class="foot">
          <button class="btn secondary" @click="close">–û—Ç–º–µ–Ω–∞</button>
          <button class="btn primary" :disabled="saving" @click="submit">
            {{ saving ? '–û—Ç–ø—Ä–∞–≤–ª—è—é‚Ä¶' : '–û—Ç–ø—Ä–∞–≤–∏—Ç—å' }}
          </button>
        </div>
      </div>
    </div>
  </teleport>
</template>

<script>
const trimOrNull = (v) => {
  const s = String(v ?? '').trim()
  return s ? s : null
}

const isHttpUrl = (s) => /^https?:\/\/.+/i.test(String(s || '').trim())

export default {
  name: 'CreateEventModal',
  emits: ['close', 'created'],
  props: {
    open: { type: Boolean, default: false },
    categories: { type: Array, default: () => [] },
    createBusinessEvent: { type: Function, required: true }
  },
  data() {
    return {
      saving: false,
      error: '',
      selectedCategories: [],
      form: {
        title: '',
        description: '',
        date_time_event: '',
        address: '',
        organizer: '',
        price: '0',
        is_online: false,
        photo_url: ''
      },
      pickedFile: null,
      previewUrl: ''
    }
  },
  computed: {
    isFree() {
      const n = Number(this.form.price)
      return Number.isFinite(n) && n <= 0
    }
  },
  watch: {
    open(v) {
      if (!v) this.cleanupPreview()
    }
  },
  methods: {
    close() {
      if (this.saving) return
      this.$emit('close')
    },
    toggleCategory(name) {
      const n = String(name || '').trim()
      if (!n) return
      const idx = this.selectedCategories.indexOf(n)
      if (idx >= 0) this.selectedCategories.splice(idx, 1)
      else this.selectedCategories.push(n)
    },

    prettySize(bytes) {
      const b = Number(bytes || 0)
      if (b < 1024) return `${b} B`
      const kb = b / 1024
      if (kb < 1024) return `${kb.toFixed(1)} KB`
      const mb = kb / 1024
      return `${mb.toFixed(1)} MB`
    },

    onPickFile(e) {
      const file = e?.target?.files?.[0]
      if (!file) return

      if (!String(file.type || '').startsWith('image/')) {
        this.error = '–ù—É–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.'
        e.target.value = ''
        return
      }

      const maxMB = 8
      if (file.size > maxMB * 1024 * 1024) {
        this.error = `–°–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π —Ñ–∞–π–ª. –ú–∞–∫—Å–∏–º—É–º ${maxMB}MB.`
        e.target.value = ''
        return
      }

      this.error = ''
      this.pickedFile = file

      this.cleanupPreview()
      this.previewUrl = URL.createObjectURL(file)
    },

    clearFile() {
      this.pickedFile = null
      this.cleanupPreview()
      this.previewUrl = ''
    },

    cleanupPreview() {
      try {
        if (this.previewUrl) URL.revokeObjectURL(this.previewUrl)
      } catch {}
    },

    async submit() {
      this.error = ''

      const title = trimOrNull(this.form.title)
      const description = trimOrNull(this.form.description)
      const dt = trimOrNull(this.form.date_time_event)

      if (!title) return (this.error = '–£–∫–∞–∂–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ.')
      if (!dt) return (this.error = '–£–∫–∞–∂–∏ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è.')
      if (!description) return (this.error = '–£–∫–∞–∂–∏ –æ–ø–∏—Å–∞–Ω–∏–µ.')

      const url = trimOrNull(this.form.photo_url)
      if (url && !isHttpUrl(url)) {
        return (this.error = '–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å http/https. –§–æ—Ä–º–∞—Ç—ã data: –∏ blob: –∑–∞–ø—Ä–µ—â–µ–Ω—ã.')
      }

      const priceNum = Number(this.form.price)
      const price = Number.isFinite(priceNum) ? priceNum : 0
      const is_free = price <= 0

      const payload = {
        title,
        description,
        date_time_event: dt,
        address: trimOrNull(this.form.address),
        organizer: trimOrNull(this.form.organizer),
        price,
        is_online: !!this.form.is_online,
        is_free,
        selectCategory: [...this.selectedCategories],
        photo_file: this.pickedFile || null,
        photo_url: url
      }

      this.saving = true
      try {
        const { data, error } = await this.createBusinessEvent(payload)
        if (error) {
          this.error = String(error.message || error)
          return
        }

        // reset
        this.selectedCategories = []
        this.form = {
          title: '',
          description: '',
          date_time_event: '',
          address: '',
          organizer: '',
          price: '0',
          is_online: false,
          photo_url: ''
        }
        this.clearFile()

        this.$emit('created', data)
        this.$emit('close')
      } finally {
        this.saving = false
      }
    }
  }
}
</script>

<style scoped>
.root { position: fixed; inset: 0; z-index: 10000; }
.overlay { position: absolute; inset: 0; background: rgba(0,0,0,.38); backdrop-filter: blur(2px); }

.modal {
  position: absolute; left: 50%; top: 50%;
  width: min(760px, 94vw); max-height: 90vh;
  transform: translate(-50%, -50%);
  background: #fff; border: 1px solid #efefef; border-radius: 18px;
  box-shadow: 0 18px 60px rgba(0,0,0,.18);
  display: flex; flex-direction: column; overflow: hidden;
}

.head { padding: 14px; border-bottom: 1px solid #f2f2f2; display: flex; align-items: center; gap: 12px; }
.title { font-weight: 900; font-size: 16px; }
.x { margin-left: auto; border: 1px solid #efefef; background: #fafafa; border-radius: 12px; padding: 8px 10px; cursor: pointer; }

.body { padding: 14px; overflow: auto; display: flex; flex-direction: column; gap: 12px; }

.hint {
  background: #fcfcff; border: 1px solid rgba(138,117,227,.18);
  border-radius: 14px; padding: 10px 12px; font-size: 13px; opacity: .9;
}

.grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
@media (max-width: 720px) { .grid { grid-template-columns: 1fr; } }

.field { display: flex; flex-direction: column; gap: 6px; }
.field.inline { justify-content: flex-end; }

.label { font-size: 12px; font-weight: 800; opacity: .7; }
.input, .textarea {
  border: 1px solid #efefef; border-radius: 12px; padding: 10px 10px;
  font-size: 14px; background: #fff; outline: none;
}
.input:focus, .textarea:focus { border-color: rgba(138,117,227,.55); box-shadow: 0 0 0 3px rgba(138,117,227,.12); }
.textarea { min-height: 120px; resize: vertical; }

.mini { font-size: 12px; opacity: .7; line-height: 1.25; }
.badge {
  display: inline-flex; align-items: center; padding: 6px 10px; border-radius: 999px;
  background: rgba(138,117,227,.12); border: 1px solid rgba(138,117,227,.22); width: fit-content;
}

.tags { display: flex; flex-wrap: wrap; gap: 8px; }
.tag { border: 1px solid #efefef; background: #fff; border-radius: 999px; padding: 7px 10px; cursor: pointer; font-size: 13px; }
.tag.active { background: #8a75e3; border-color: #8a75e3; color: #fff; }

.check { display: inline-flex; align-items: center; gap: 10px; cursor: pointer; user-select: none; }
.check input { display: none; }
.ui {
  width: 44px; height: 26px; border-radius: 999px; border: 1px solid #e9e9e9; background: #f3f3f3;
  position: relative; transition: background 180ms ease, border-color 180ms ease;
}
.ui::after {
  content: ''; width: 22px; height: 22px; border-radius: 999px; background: #fff;
  position: absolute; top: 1px; left: 1px; box-shadow: 0 2px 10px rgba(0,0,0,.08);
  transition: transform 180ms ease;
}
.check input:checked + .ui { background: rgba(138,117,227,.85); border-color: rgba(138,117,227,.55); }
.check input:checked + .ui::after { transform: translateX(18px); }
.text { font-weight: 800; font-size: 13px; }

.image-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
.file-input { display: none; }
.file-btn {
  display: inline-flex; align-items: center; gap: 8px;
  border: 1px solid #efefef; background: #fff; border-radius: 14px;
  padding: 10px 12px; font-weight: 900; cursor: pointer;
}
.file-btn:hover { background: #fafafa; }
.file-clear {
  border: 1px solid #efefef; background: #fafafa; border-radius: 14px;
  padding: 10px 12px; font-weight: 900; cursor: pointer;
}
.file-clear:hover { background: #f0f0f0; }

.preview {
  margin-top: 8px; border: 1px solid #efefef; border-radius: 16px; overflow: hidden;
  display: grid; grid-template-columns: 140px 1fr; background: #fff;
}
.preview img { width: 140px; height: 110px; object-fit: cover; display: block; background: #f2f2f2; }
.preview-meta { padding: 10px; display: grid; gap: 6px; align-content: center; }
.preview-name { font-weight: 900; font-size: 13px; word-break: break-word; }
.preview-sub { font-size: 12px; opacity: .7; }

.error { color: #d9534f; font-weight: 800; font-size: 13px; }

.foot { padding: 14px; border-top: 1px solid #f2f2f2; display: flex; justify-content: flex-end; gap: 10px; }
.btn { border-radius: 14px; padding: 12px 16px; font-weight: 900; cursor: pointer; border: none; }
.btn.secondary { background: #efefef; }
.btn.primary { background: #8a75e3; color: #fff; }
.btn:disabled { opacity: .6; cursor: not-allowed; }
</style>
3) src/App.vue ‚Äî –ó–ê–ú–ï–ù–ò–¢–¨ –ü–û–õ–ù–û–°–¢–¨–Æ
–ò–∑–º–µ–Ω–µ–Ω–∏—è:

–í –º–µ–Ω—é –¥–æ–±–∞–≤–∏–ª –æ–ø–∏—Å–∞–Ω–∏–µ: ‚Äú–ë–∏–∑–Ω–µ—Å –∞–∫–∫–∞—É–Ω—Ç –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è‚Ä¶ 200 —Ä—É–±/–º–µ—Å‚Ä¶ –Ω–∞–ø–∏—Å–∞—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É‚Äù

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Ä–∞–º–∫—É/—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–Ω–µ alert)

<template>
  <div id="app">
    <header class="header">
      <div class="header-container">
        <div class="header-left">
          <button class="menu-button" aria-label="–ú–µ–Ω—é" @click="openMenu">
            <div class="menu-icon"><span></span><span></span><span></span></div>
          </button>

          <div class="search-container">
            <div class="search-icon">üîç</div>
            <input v-model="searchTerm" type="text" placeholder="–ü–æ–∏—Å–∫" class="search-input" />
          </div>
        </div>

        <button class="profile-button" @click="openProfileModal" aria-label="–ü—Ä–æ—Ñ–∏–ª—å">
          <img
            v-if="showHeaderAvatar"
            class="header-avatar"
            :src="headerAvatarUrl"
            alt="avatar"
            @error="onHeaderImgError"
          />
          <div v-else class="header-placeholder">üë§</div>
        </button>
      </div>
    </header>

    <router-view v-slot="{ Component }">
      <component :is="Component" :global-search-term="searchTerm" />
    </router-view>

    <!-- MENU DRAWER -->
    <teleport to="body">
      <div v-if="menuOpen" class="menu-root" @keydown.esc="closeMenu" tabindex="-1">
        <div class="overlay" @click="closeMenu"></div>

        <aside class="menu-drawer" role="dialog" aria-modal="true" aria-label="–ú–µ–Ω—é">
          <div class="menu-head">
            <div class="menu-title">–ú–µ–Ω—é</div>
            <button class="close-btn" @click="closeMenu" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
          </div>

          <div class="menu-body">
            <div class="biz-card">
              <div class="biz-top">
                <div class="biz-title">Business –∞–∫–∫–∞—É–Ω—Ç</div>
                <span v-if="isBusiness" class="biz-badge">–ê–∫—Ç–∏–≤–µ–Ω</span>
                <span v-else class="biz-badge off">–ù–µ –∞–∫—Ç–∏–≤–µ–Ω</span>
              </div>

              <div class="biz-text">
                –ë–∏–∑–Ω–µ—Å –∞–∫–∫–∞—É–Ω—Ç –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è.
                –°—Ç–æ–∏–º–æ—Å—Ç—å ‚Äî <b>200 —Ä—É–±–ª–µ–π –≤ –º–µ—Å—è—Ü</b>.
                –î–ª—è –ø—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω–∏—è –Ω—É–∂–Ω–æ –Ω–∞–ø–∏—Å–∞—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.
              </div>

              <div class="biz-actions">
                <button v-if="isBusiness" class="biz-btn" @click="openCreateEvent">
                  ‚ûï –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ
                </button>

                <button v-else class="biz-btn secondary" @click="openProfileOrAuth">
                  üë§ –í–æ–π—Ç–∏ / –ü—Ä–æ—Ñ–∏–ª—å
                </button>
              </div>
            </div>

            <div class="menu-divider"></div>

            <button class="menu-item" @click="openProfileOrAuth">üë§ –ü—Ä–æ—Ñ–∏–ª—å / –í—Ö–æ–¥</button>
          </div>

          <div class="menu-foot">
            <button class="apply-btn" @click="closeMenu">–ó–∞–∫—Ä—ã—Ç—å</button>
          </div>
        </aside>
      </div>
    </teleport>

    <!-- CENTER NOTICE -->
    <teleport to="body">
      <div v-if="noticeOpen" class="notice-root">
        <div class="notice-card">
          <div class="notice-title">‚úÖ –ì–æ—Ç–æ–≤–æ</div>
          <div class="notice-text">–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –∂–¥—ë—Ç –æ–¥–æ–±—Ä–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</div>
        </div>
      </div>
    </teleport>

    <!-- AUTH / PROFILE -->
    <AuthModal
      v-if="showAuth"
      :telegram-bot-username="telegramBotUsername"
      @close="closeAllModals"
      @google="loginGoogle"
      @telegram-auth="onTelegramAuth"
    />

    <ProfileModal
      v-if="showProfileEdit"
      :profile="profile"
      :telegram-link="telegramLink"
      :saving="saving"
      :loading="profileLoading"
      @close="closeAllModals"
      @save="saveProfile"
      @pick-avatar="onPickAvatar"
      @logout="logout"
    />

    <CreateEventModal
      :open="createEventOpen"
      :categories="categories"
      :create-business-event="createBusinessEvent"
      @close="createEventOpen = false"
      @created="onDraftCreated"
    />
  </div>
</template>

<script>
import { ref, computed, onMounted, watch, nextTick } from 'vue'
import AuthModal from './components/AuthModal.vue'
import ProfileModal from './components/ProfileModal.vue'
import CreateEventModal from './components/CreateEventModal.vue'
import { useSupabase } from './composables/useSupabase.js'

const normalizeStoragePublicUrl = (url) => {
  if (!url || typeof url !== 'string') return ''
  const u = url.trim()
  if (!u) return ''
  if (u.includes('/storage/v1/object/public/')) return u
  if (u.includes('/storage/v1/object/')) return u.replace('/storage/v1/object/', '/storage/v1/object/public/')
  return u
}

export default {
  name: 'App',
  components: { AuthModal, ProfileModal, CreateEventModal },
  setup() {
    const {
      getSession,
      getUser,
      signInWithGoogle,
      signOut,
      ensurePublicUserRow,
      getMyPublicUser,
      updateMyPublicUser,
      uploadAvatar,
      linkTelegramViaEdgeFunction,
      getMyTelegramLink,
      getCategories,
      createBusinessEvent
    } = useSupabase()

    const telegramBotUsername = import.meta.env.VITE_TELEGRAM_BOT_USERNAME || ''
    const searchTerm = ref('')

    const session = ref(null)
    const profile = ref(null)
    const telegramLink = ref(null)

    const showAuth = ref(false)
    const showProfileEdit = ref(false)

    const profileLoading = ref(false)
    const saving = ref(false)
    const pickedAvatarFile = ref(null)

    const headerImgBroken = ref(false)
    const headerAvatarUrl = computed(() => normalizeStoragePublicUrl(profile.value?.image_path || ''))
    const hasHeaderAvatarUrl = computed(() => headerAvatarUrl.value.trim().length > 0)
    const showHeaderAvatar = computed(() => hasHeaderAvatarUrl.value && !headerImgBroken.value)

    const onHeaderImgError = () => {
      headerImgBroken.value = true
    }

    watch(
      () => profile.value?.image_path,
      () => {
        headerImgBroken.value = false
      }
    )

    const isBusiness = computed(() => profile.value?.It_business === true)

    // menu drawer
    const menuOpen = ref(false)
    const openMenu = async () => {
      menuOpen.value = true
      await nextTick()
      document.documentElement.style.overflow = 'hidden'
      document.body.style.overflow = 'hidden'
    }
    const closeMenu = () => {
      menuOpen.value = false
      document.documentElement.style.overflow = ''
      document.body.style.overflow = ''
    }

    // notice
    const noticeOpen = ref(false)
    let noticeTimer = null
    const showNotice = () => {
      noticeOpen.value = true
      if (noticeTimer) clearTimeout(noticeTimer)
      noticeTimer = setTimeout(() => {
        noticeOpen.value = false
      }, 2600)
    }

    // categories for create modal
    const categories = ref([])
    const categoriesLoaded = ref(false)
    const loadCategoriesOnce = async () => {
      if (categoriesLoaded.value) return
      const { data } = await getCategories()
      categories.value = data ?? []
      categoriesLoaded.value = true
    }

    // create event modal
    const createEventOpen = ref(false)
    const openCreateEvent = async () => {
      await loadAuthAndProfile()
      if (!session.value) {
        closeMenu()
        showAuth.value = true
        return
      }
      await loadCategoriesOnce()
      closeMenu()
      createEventOpen.value = true
    }

    const onDraftCreated = () => {
      // ‚úÖ –≤–º–µ—Å—Ç–æ alert
      showNotice()
    }

    // auth/profile loader
    const loadAuthAndProfile = async () => {
      profileLoading.value = true
      try {
        const { session: s } = await getSession()
        session.value = s

        if (!s) {
          profile.value = null
          telegramLink.value = null
          return
        }

        const { user } = await getUser()
        if (user) await ensurePublicUserRow(user)

        const { data: p } = await getMyPublicUser()
        if (p?.image_path) p.image_path = normalizeStoragePublicUrl(p.image_path)
        profile.value = p

        const { data: tg } = await getMyTelegramLink()
        telegramLink.value = tg
      } finally {
        profileLoading.value = false
      }
    }

    const closeAllModals = () => {
      showAuth.value = false
      showProfileEdit.value = false
    }

    const openProfileModal = async () => {
      showAuth.value = false
      showProfileEdit.value = true
      profileLoading.value = true

      await loadAuthAndProfile()

      if (!session.value) {
        showProfileEdit.value = false
        showAuth.value = true
        profileLoading.value = false
        return
      }
      profileLoading.value = false
    }

    const openProfileOrAuth = async () => {
      await loadAuthAndProfile()
      closeMenu()
      if (!session.value) showAuth.value = true
      else showProfileEdit.value = true
    }

    const loginGoogle = async () => {
      const redirectTo = window.location.origin + import.meta.env.BASE_URL
      const { error } = await signInWithGoogle({ redirectTo })
      if (error) {
        console.error(error)
        alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ Google (—Å–º. –∫–æ–Ω—Å–æ–ª—å)')
      }
    }

    const onTelegramAuth = async (telegramData) => {
      await loadAuthAndProfile()
      if (!session.value) {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏ —á–µ—Ä–µ–∑ Google, –∑–∞—Ç–µ–º –ø–æ–¥—Ç–≤–µ—Ä–¥–∏ Telegram.')
        return
      }

      const { error } = await linkTelegramViaEdgeFunction(telegramData)
      if (error) {
        console.error(error)
        alert('–û—à–∏–±–∫–∞ Telegram –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (—Å–º. –∫–æ–Ω—Å–æ–ª—å)')
        return
      }

      await loadAuthAndProfile()
      showAuth.value = false
      showProfileEdit.value = true
    }

    const onPickAvatar = (file) => {
      pickedAvatarFile.value = file || null
    }

    const saveProfile = async (form) => {
      saving.value = true
      try {
        let avatarUrl = null

        if (pickedAvatarFile.value) {
          const { publicUrl, error } = await uploadAvatar(pickedAvatarFile.value)
          if (error) throw error
          avatarUrl = publicUrl
        }

        const patch = {
          first_name: form.first_name || null,
          last_name: form.last_name || null,
          birth_day: form.birth_day || null,
          phone: form.phone || null,
          email: form.email || null,
          gender: form.gender || null
        }
        if (avatarUrl) patch.image_path = normalizeStoragePublicUrl(avatarUrl)

        const { data, error } = await updateMyPublicUser(patch)
        if (error) throw error

        if (data?.image_path) data.image_path = normalizeStoragePublicUrl(data.image_path)
        profile.value = data

        pickedAvatarFile.value = null
        headerImgBroken.value = false
      } catch (e) {
        console.error('Save profile error:', e)
        alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (—Å–º. –∫–æ–Ω—Å–æ–ª—å)')
      } finally {
        saving.value = false
      }
    }

    const logout = async () => {
      await signOut()
      await loadAuthAndProfile()
      closeAllModals()
      closeMenu()
    }

    onMounted(loadAuthAndProfile)

    return {
      telegramBotUsername,
      searchTerm,

      headerAvatarUrl,
      showHeaderAvatar,
      onHeaderImgError,

      showAuth,
      showProfileEdit,
      profileLoading,
      profile,
      telegramLink,
      saving,

      isBusiness,

      menuOpen,
      openMenu,
      closeMenu,

      noticeOpen,

      categories,
      createEventOpen,
      openCreateEvent,
      onDraftCreated,

      createBusinessEvent,

      openProfileModal,
      openProfileOrAuth,
      closeAllModals,
      loginGoogle,
      onTelegramAuth,
      onPickAvatar,
      saveProfile,
      logout
    }
  }
}
</script>

<style>
.header-placeholder {
  width: 40px; height: 40px; border-radius: 50%;
  background: #f2f2f2; display: grid; place-items: center;
  font-size: 18px; color: #9aa0a6;
}

* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: Arial, sans-serif; background: #efefef; color: #14181b; }
#app { min-height: 100vh; }

.header { background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,.1); }
.header-container {
  max-width: 1200px; margin: 0 auto; padding: 16px 20px;
  display: flex; justify-content: space-between; align-items: center;
}
.header-left { display: flex; align-items: center; gap: 16px; }

.menu-button {
  width: 40px; height: 40px; border-radius: 50%;
  background: #fff; border: none; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
}
.menu-icon { display: flex; flex-direction: column; gap: 3px; }
.menu-icon span { width: 18px; height: 2px; background: #14181b; border-radius: 1px; }

.search-container { position: relative; display: flex; align-items: center; }
.search-icon { position: absolute; left: 12px; font-size: 14px; opacity: .6; }
.search-input {
  width: 300px; padding: 10px 12px 10px 36px;
  border: 2px solid #efefef; border-radius: 20px;
  outline: none; font-size: 14px;
}

.profile-button {
  width: 40px; height: 40px; border-radius: 50%;
  background: #fff; border: none; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  overflow: hidden;
}
.header-avatar { width: 40px; height: 40px; object-fit: cover; border-radius: 50%; display: block; }

/* MENU DRAWER */
.menu-root { position: fixed; inset: 0; z-index: 9999; }
.overlay { position: absolute; inset: 0; background: rgba(0,0,0,.35); backdrop-filter: blur(2px); }

.menu-drawer {
  position: absolute; top: 0; left: 0; height: 100%;
  width: min(420px, 92vw);
  background: #fff;
  border-right: 1px solid #efefef;
  box-shadow: 10px 0 30px rgba(0,0,0,0.12);
  display: flex; flex-direction: column;
  animation: slideInLeft 180ms ease;
}
@keyframes slideInLeft { from { transform: translateX(-18px); opacity: .7; } to { transform: translateX(0); opacity: 1; } }

.menu-head {
  display: flex; align-items: center; gap: 10px;
  padding: 14px; border-bottom: 1px solid #f2f2f2;
}
.menu-title { font-weight: 900; font-size: 16px; }
.close-btn {
  margin-left: auto;
  border: 1px solid #efefef;
  background: #fafafa;
  border-radius: 12px;
  padding: 8px 10px;
  cursor: pointer;
}

.menu-body { padding: 14px; overflow: auto; display: flex; flex-direction: column; gap: 12px; }
.menu-foot { padding: 14px; border-top: 1px solid #f2f2f2; display: flex; justify-content: flex-end; }
.apply-btn {
  border: none; background: #8a75e3; color: #fff;
  border-radius: 14px; padding: 12px 16px;
  font-weight: 900; cursor: pointer;
}

.biz-card {
  background: #fcfcff;
  border: 1px solid rgba(138,117,227,.18);
  border-radius: 16px;
  padding: 12px;
  display: grid;
  gap: 10px;
}
.biz-top { display: flex; align-items: center; gap: 10px; }
.biz-title { font-weight: 900; }
.biz-badge {
  margin-left: auto;
  font-size: 12px; font-weight: 900;
  padding: 6px 10px; border-radius: 999px;
  background: rgba(0, 200, 120, .12);
  border: 1px solid rgba(0, 200, 120, .22);
}
.biz-badge.off { background: rgba(180,180,180,.16); border-color: rgba(180,180,180,.28); }
.biz-text { font-size: 12px; opacity: .85; line-height: 1.25; }

.biz-actions { display: flex; gap: 10px; flex-wrap: wrap; }
.biz-btn {
  border: none; border-radius: 14px;
  padding: 11px 12px; font-weight: 900;
  cursor: pointer; background: #8a75e3; color: #fff;
}
.biz-btn.secondary { background: #efefef; color: #14181b; }
.biz-btn:hover { filter: brightness(.98); }

.menu-divider { height: 1px; background: #f2f2f2; margin: 6px 0; }

.menu-item {
  border: 1px solid #efefef; background: #fff;
  border-radius: 14px; padding: 12px 12px;
  font-weight: 900; cursor: pointer; text-align: left;
}
.menu-item:hover { background: #fafafa; }

/* CENTER NOTICE */
.notice-root {
  position: fixed; inset: 0; z-index: 10001;
  display: grid; place-items: center;
  pointer-events: none;
}
.notice-card {
  pointer-events: none;
  width: min(520px, 92vw);
  background: #fff;
  border: 1px solid rgba(138,117,227,.24);
  box-shadow: 0 18px 60px rgba(0,0,0,.18);
  border-radius: 18px;
  padding: 16px;
  text-align: center;
  animation: pop 180ms ease;
}
@keyframes pop { from { transform: scale(.98); opacity: .6; } to { transform: scale(1); opacity: 1; } }
.notice-title { font-weight: 900; }
.notice-text { margin-top: 6px; opacity: .85; font-weight: 800; }
</style>
4) src/views/HomeView.vue ‚Äî –ó–ê–ú–ï–ù–ò–¢–¨ –ü–û–õ–ù–û–°–¢–¨–Æ
–ò–∑–º–µ–Ω–µ–Ω–∏—è:

—É–±—Ä–∞–ª page-title –∏ page-sub (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—Ö –Ω–µ –≤–∏–¥–∏—Ç)

—É–±—Ä–∞–ª –≤—Ç–æ—Ä—É—é ‚Äú–§–∏–ª—å—Ç—Ä—ã‚Äù ‚Üí —ç—Ç–æ –º—ã —Å–¥–µ–ª–∞–µ–º —á–µ—Ä–µ–∑ FiltersPanel (—Å–º. —Å–ª–µ–¥—É—é—â–∏–π —Ñ–∞–π–ª)

<template>
  <div class="page">
    <div class="container">
      <div class="topbar">
        <button class="filter-btn" @click="openDrawer" aria-label="–û—Ç–∫—Ä—ã—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã">
          <svg viewBox="0 0 24 24" class="filter-icon" aria-hidden="true">
            <path d="M3 5h18l-7 8v5l-4 2v-7L3 5z" fill="currentColor" />
          </svg>
          <span class="filter-btn-text">–§–∏–ª—å—Ç—Ä—ã</span>
        </button>
      </div>

      <div v-if="!initialLoaded" class="state">
        <div class="spinner"></div>
        <div>–ó–∞–≥—Ä—É–∑–∫–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π‚Ä¶</div>
      </div>

      <div v-else-if="error" class="state error">
        <div class="error-title">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</div>
        <div class="error-sub">{{ error }}</div>
        <button class="retry" @click="reload">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
      </div>

      <div v-else-if="filteredEvents.length === 0" class="state">–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>

      <div v-else class="events-shell">
        <TransitionGroup name="list" tag="div" class="events-list">
          <EventCard
            v-for="event in filteredEvents"
            :key="event.id"
            :event="event"
            :photos="photos[event.id] || []"
            :photos-loading="photosLoading"
            :category-map="categoryMap"
            @open-photo="openPhoto"
          />
        </TransitionGroup>
      </div>
    </div>

    <!-- FILTER DRAWER -->
    <teleport to="body">
      <div v-if="drawerOpen" class="drawer-root" @keydown.esc="closeDrawer" tabindex="-1">
        <div class="overlay" @click="closeDrawer"></div>

        <aside class="drawer" role="dialog" aria-modal="true" aria-label="–§–∏–ª—å—Ç—Ä—ã">
          <div class="drawer-head">
            <div class="drawer-title">–§–∏–ª—å—Ç—Ä—ã</div>
            <button class="close-btn" @click="closeDrawer" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
          </div>

          <div class="drawer-body">
            <FiltersPanel
              :categories="categories"
              v-model:selectedCategoryNames="selectedCategoryNames"
              v-model:onlineOnly="onlineOnly"
              v-model:priceMode="priceMode"
              v-model:customPriceMin="customPriceMin"
              v-model:customPriceMax="customPriceMax"
              v-model:dateMode="dateMode"
              v-model:dateOn="dateOn"
              v-model:dateFrom="dateFrom"
              v-model:dateTo="dateTo"
              v-model:datePivot="datePivot"
              @reset="resetAllFilters"
            />
          </div>

          <div class="drawer-foot">
            <button class="apply-btn" @click="closeDrawer">–ü–æ–∫–∞–∑–∞—Ç—å</button>
          </div>
        </aside>
      </div>
    </teleport>

    <EventPhotoModal v-if="photoModalUrl" :url="photoModalUrl" @close="photoModalUrl = ''" />
  </div>
</template>

<script>
import { ref, computed, onMounted, onBeforeUnmount, nextTick } from 'vue'
import EventCard from '../../components/EventCard.vue'
import EventPhotoModal from '../../components/EventPhotoModal.vue'
import FiltersPanel from '../../components/FiltersPanel.vue'
import { useSupabase } from '../../composables/useSupabase'

const sleep = (ms) => new Promise((r) => setTimeout(r, ms))

const withRetry = async (fn, tries = 3) => {
  let lastErr = null
  for (let i = 0; i < tries; i++) {
    try {
      return await fn()
    } catch (e) {
      lastErr = e
      await sleep(350 * (i + 1))
    }
  }
  throw lastErr
}

const toNumberOrNull = (v) => {
  if (v === null || v === undefined) return null
  const n = Number(v)
  return Number.isFinite(n) ? n : null
}

const parseEventDate = (value) => {
  if (!value) return null
  const d = new Date(value)
  if (Number.isNaN(d.getTime())) return null
  return d
}

const parseDateInput = (yyyy_mm_dd) => {
  if (!yyyy_mm_dd) return null
  const [y, m, day] = yyyy_mm_dd.split('-').map((x) => Number(x))
  if (!y || !m || !day) return null
  return new Date(y, m - 1, day)
}

const startOfDay = (d) => new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0, 0, 0, 0)
const endOfDay = (d) => new Date(d.getFullYear(), d.getMonth(), d.getDate(), 23, 59, 59, 999)

const normalizeCategoryNames = (raw, categoryMap) => {
  const map = categoryMap || {}

  const toName = (v) => {
    if (v === null || v === undefined) return ''
    const s = String(v).trim()
    if (!s) return ''
    if (map[s]) return String(map[s]).trim()
    const n = Number(s)
    if (!Number.isNaN(n) && map[String(n)]) return String(map[String(n)]).trim()
    return s
  }

  if (!raw) return []
  if (Array.isArray(raw)) return Array.from(new Set(raw.map(toName).filter(Boolean)))

  if (typeof raw === 'string') {
    const s = raw.trim()
    if (!s) return []
    return Array.from(
      new Set(
        s
          .split(/[,;|]+/g)
          .map((x) => x.trim())
          .filter(Boolean)
          .map(toName)
          .filter(Boolean)
      )
    )
  }

  const one = toName(raw)
  return one ? [one] : []
}

export default {
  name: 'HomeView',
  components: { EventCard, EventPhotoModal, FiltersPanel },
  props: { globalSearchTerm: { type: String, default: '' } },
  setup(props) {
    const { getEvents, getCategories, getEventPhotos } = useSupabase()

    const initialLoaded = ref(false)
    const error = ref(null)

    const allEvents = ref([])
    const visibleEvents = ref([])
    const photos = ref({})

    const categories = ref([])
    const categoryMap = ref({})

    // filters
    const selectedCategoryNames = ref([])
    const onlineOnly = ref(false)

    const priceMode = ref('all')
    const customPriceMin = ref('')
    const customPriceMax = ref('')

    const dateMode = ref('all')
    const dateOn = ref('')
    const dateFrom = ref('')
    const dateTo = ref('')
    const datePivot = ref('')

    // ui
    const drawerOpen = ref(false)
    const openDrawer = async () => {
      drawerOpen.value = true
      await nextTick()
      document.documentElement.style.overflow = 'hidden'
      document.body.style.overflow = 'hidden'
    }
    const closeDrawer = () => {
      drawerOpen.value = false
      document.documentElement.style.overflow = ''
      document.body.style.overflow = ''
    }

    // photo modal
    const photoModalUrl = ref('')
    const openPhoto = (url) => {
      if (!url) return
      photoModalUrl.value = url
    }

    // progressive list
    let progressiveTimer = null
    const stopProgressive = () => {
      if (progressiveTimer) clearInterval(progressiveTimer)
      progressiveTimer = null
    }
    const startProgressive = (list) => {
      stopProgressive()
      visibleEvents.value = []
      const src = Array.isArray(list) ? list : []
      if (!src.length) return
      visibleEvents.value.push(src[0])
      let i = 1
      progressiveTimer = setInterval(() => {
        if (i >= src.length) return stopProgressive()
        visibleEvents.value.push(src[i])
        i++
      }, 140)
    }

    const resetAllFilters = () => {
      selectedCategoryNames.value = []
      onlineOnly.value = false

      priceMode.value = 'all'
      customPriceMin.value = ''
      customPriceMax.value = ''

      dateMode.value = 'all'
      dateOn.value = ''
      dateFrom.value = ''
      dateTo.value = ''
      datePivot.value = ''
    }

    const matchesCategories = (event) => {
      if (selectedCategoryNames.value.length === 0) return true
      const eventCats = normalizeCategoryNames(event?.selectCategory, categoryMap.value)
      if (!eventCats.length) return false
      const set = new Set(selectedCategoryNames.value)
      return eventCats.some((c) => set.has(c))
    }

    const matchesOnline = (event) => {
      if (!onlineOnly.value) return true
      return event?.is_online === true
    }

    const getEventPrice = (event) => {
      if (event?.is_free === true) return 0
      const p = toNumberOrNull(event?.price)
      if (p === null) return null
      return p
    }

    const matchesPrice = (event) => {
      const mode = priceMode.value
      if (mode === 'all') return true

      const price = getEventPrice(event)
      if (mode === 'free') return price === 0
      if (price === null) return false

      if (mode === '100_1000') return price >= 100 && price <= 1000
      if (mode === '1000_3000') return price >= 1000 && price <= 3000
      if (mode === '3000_10000') return price >= 3000 && price <= 10000
      if (mode === 'gt_10000') return price > 10000

      if (mode === 'custom') {
        const min = customPriceMin.value === '' ? null : toNumberOrNull(customPriceMin.value)
        const max = customPriceMax.value === '' ? null : toNumberOrNull(customPriceMax.value)
        const okMin = min === null ? true : price >= min
        const okMax = max === null ? true : price <= max
        return okMin && okMax
      }

      return true
    }

    const matchesDate = (event) => {
      const mode = dateMode.value
      if (mode === 'all') return true

      const d = parseEventDate(event?.date_time_event)
      if (!d) return false

      if (mode === 'today') {
        const now = new Date()
        return d >= startOfDay(now) && d <= endOfDay(now)
      }

      if (mode === 'next7') {
        const now = new Date()
        const from = startOfDay(now)
        const to = endOfDay(new Date(now.getFullYear(), now.getMonth(), now.getDate() + 7))
        return d >= from && d <= to
      }

      if (mode === 'on') {
        const on = parseDateInput(dateOn.value)
        if (!on) return true
        return d >= startOfDay(on) && d <= endOfDay(on)
      }

      if (mode === 'range') {
        const fromD = parseDateInput(dateFrom.value)
        const toD = parseDateInput(dateTo.value)
        if (!fromD && !toD) return true
        const from = fromD ? startOfDay(fromD) : null
        const to = toD ? endOfDay(toD) : null
        const okFrom = from ? d >= from : true
        const okTo = to ? d <= to : true
        return okFrom && okTo
      }

      if (mode === 'after') {
        const pivot = parseDateInput(datePivot.value)
        if (!pivot) return true
        return d >= startOfDay(pivot)
      }

      if (mode === 'before') {
        const pivot = parseDateInput(datePivot.value)
        if (!pivot) return true
        return d <= endOfDay(pivot)
      }

      return true
    }

    const matchesSearch = (event) => {
      const term = (props.globalSearchTerm || '').trim().toLowerCase()
      if (!term) return true
      const t = (event.title || '').toLowerCase()
      const desc = (event.description || '').toLowerCase()
      const a = (event.address || '').toLowerCase()
      const o = (event.organizer || '').toLowerCase()
      return t.includes(term) || desc.includes(term) || a.includes(term) || o.includes(term)
    }

    const filteredEvents = computed(() => {
      return visibleEvents.value.filter(
        (e) => matchesCategories(e) && matchesOnline(e) && matchesPrice(e) && matchesDate(e) && matchesSearch(e)
      )
    })

    // load
    const photosLoading = ref(false)
    const stopPhotosLoading = ref(false)

    const loadCategories = async () => {
      const { data, error: err } = await withRetry(() => getCategories())
      if (err) throw err
      categories.value = data ?? []
      categoryMap.value = (categories.value || []).reduce((acc, c) => {
        acc[String(c.id)] = c.name
        return acc
      }, {})
    }

    const loadEventsProgressive = async () => {
      error.value = null
      stopPhotosLoading.value = true
      photosLoading.value = false
      stopProgressive()

      try {
        const { data: eventsData, error: eventsErr } = await withRetry(() => getEvents())
        if (eventsErr) throw eventsErr

        allEvents.value = eventsData ?? []
        initialLoaded.value = true
        startProgressive(allEvents.value)

        photos.value = {}
        stopPhotosLoading.value = false

        const ids = allEvents.value.map((e) => e.id).filter(Boolean)
        if (!ids.length) return

        photosLoading.value = true
        const batchSize = 5
        for (let i = 0; i < ids.length; i += batchSize) {
          if (stopPhotosLoading.value) break
          const batch = ids.slice(i, i + batchSize)

          const { data: ph, error: phErr } = await withRetry(() => getEventPhotos(batch))
          if (!phErr) {
            const next = { ...photos.value }
            for (const p of ph ?? []) {
              if (!p?.event_id) continue
              if (!next[p.event_id]) next[p.event_id] = []
              next[p.event_id].push(p)
            }
            photos.value = next
          }
          await sleep(120)
        }
      } catch (e) {
        allEvents.value = []
        visibleEvents.value = []
        photos.value = {}
        initialLoaded.value = true
        error.value = e?.message ? String(e.message) : 'TypeError: Failed to fetch'
      } finally {
        photosLoading.value = false
      }
    }

    const reload = async () => {
      await loadEventsProgressive()
    }

    onMounted(async () => {
      try {
        await loadCategories()
      } catch {
        categories.value = []
        categoryMap.value = {}
      }
      await loadEventsProgressive()
    })

    onBeforeUnmount(() => {
      stopProgressive()
      stopPhotosLoading.value = true
      document.documentElement.style.overflow = ''
      document.body.style.overflow = ''
    })

    return {
      initialLoaded,
      error,

      categories,
      categoryMap,

      selectedCategoryNames,
      onlineOnly,
      priceMode,
      customPriceMin,
      customPriceMax,
      dateMode,
      dateOn,
      dateFrom,
      dateTo,
      datePivot,

      photos,
      photosLoading,

      filteredEvents,

      drawerOpen,
      openDrawer,
      closeDrawer,

      resetAllFilters,
      reload,

      photoModalUrl,
      openPhoto
    }
  }
}
</script>

<style scoped>
.page { padding: 16px 0 40px; }
.container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }

.topbar { display: flex; align-items: center; margin-bottom: 12px; }
.filter-btn {
  margin-left: auto;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  border: 1px solid #efefef;
  background: #fff;
  border-radius: 14px;
  padding: 10px 12px;
  cursor: pointer;
  box-shadow: 0 2px 10px rgba(0,0,0,0.04);
}
.filter-btn:hover { background: #fafafa; }
.filter-icon { width: 18px; height: 18px; opacity: .9; }
.filter-btn-text { font-size: 13px; font-weight: 800; }

.state { display: grid; place-items: center; gap: 10px; padding: 40px 0; opacity: .75; text-align: center; }
.state.error { opacity: 1; color: #d9534f; }
.error-title { font-weight: 800; }
.error-sub { font-size: 12px; opacity: .8; max-width: 680px; }
.retry { margin-top: 8px; border: none; border-radius: 12px; padding: 10px 14px; cursor: pointer; background: #efefef; }

.spinner {
  width: 26px; height: 26px; border-radius: 50%;
  border: 3px solid #eee; border-top-color: #8a75e3;
  animation: spin .8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

.events-shell {
  background: #fff;
  border: 1px solid #efefef;
  border-radius: 18px;
  padding: 14px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.04);
}
.events-list { display: flex; flex-direction: column; gap: 12px; }

.list-enter-active, .list-leave-active { transition: opacity 240ms ease, transform 240ms ease; }
.list-enter-from, .list-leave-to { opacity: 0; transform: translateY(8px); }

/* FILTER DRAWER */
.drawer-root { position: fixed; inset: 0; z-index: 9998; }
.overlay { position: absolute; inset: 0; background: rgba(0,0,0,.35); backdrop-filter: blur(2px); }

.drawer {
  position: absolute; top: 0; right: 0; height: 100%;
  width: min(420px, 92vw);
  background: #fff;
  border-left: 1px solid #efefef;
  box-shadow: -10px 0 30px rgba(0,0,0,0.12);
  display: flex; flex-direction: column;
  animation: slideIn 180ms ease;
}
@keyframes slideIn { from { transform: translateX(18px); opacity: .7; } to { transform: translateX(0); opacity: 1; } }

.drawer-head {
  display: flex; align-items: center; gap: 10px;
  padding: 14px;
  border-bottom: 1px solid #f2f2f2;
}
.drawer-title { font-weight: 900; font-size: 16px; }
.close-btn {
  margin-left: auto;
  border: 1px solid #efefef;
  background: #fafafa;
  border-radius: 12px;
  padding: 8px 10px;
  cursor: pointer;
}

.drawer-body { padding: 14px; overflow: auto; }
.drawer-foot { padding: 14px; border-top: 1px solid #f2f2f2; display: flex; justify-content: flex-end; }

.apply-btn {
  border: none;
  background: #8a75e3;
  color: #fff;
  border-radius: 14px;
  padding: 12px 16px;
  font-weight: 900;
  cursor: pointer;
}
</style>
5) src/components/FiltersPanel.vue ‚Äî –î–û–ë–ê–í–ò–¢–¨ / –ó–ê–ú–ï–ù–ò–¢–¨
–≠—Ç–æ –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç ‚Äú–≤—Ç–æ—Ä—É—é –Ω–∞–¥–ø–∏—Å—å –§–∏–ª—å—Ç—Ä—ã‚Äù ‚Äî –∑–¥–µ—Å—å –±–æ–ª—å—à–µ –Ω–µ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∞ ‚Äú–§–∏–ª—å—Ç—Ä—ã‚Äù, —Ç–æ–ª—å–∫–æ –∫–æ–Ω—Ç–µ–Ω—Ç.

<template>
  <div class="panel">
    <div class="row">
      <div class="spacer"></div>
      <button class="reset" type="button" @click="$emit('reset')">–°–±—Ä–æ—Å–∏—Ç—å</button>
    </div>

    <section class="card">
      <div class="h">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</div>

      <div class="tags">
        <button class="tag" :class="{ active: selectedCategoryNames.length === 0 }" type="button" @click="setAll()">
          –í—Å–µ
        </button>

        <button
          v-for="c in categories"
          :key="c.id"
          class="tag"
          :class="{ active: selectedCategoryNames.includes(c.name) }"
          type="button"
          @click="toggleCategory(c.name)"
        >
          {{ c.name }}
        </button>
      </div>
    </section>

    <section class="card">
      <div class="h">–û–Ω–ª–∞–π–Ω</div>
      <label class="toggle">
        <input type="checkbox" :checked="onlineOnly" @change="$emit('update:onlineOnly', $event.target.checked)" />
        <span class="ui"></span>
        <span class="txt">–¢–æ–ª—å–∫–æ –æ–Ω–ª–∞–π–Ω</span>
      </label>
      <div class="sub">–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è, –≥–¥–µ <b>is_online=true</b>.</div>
    </section>

    <section class="card">
      <div class="h">–¶–µ–Ω–∞</div>
      <div class="chips">
        <button class="chip" :class="{ active: priceMode === 'all' }" type="button" @click="setPrice('all')">
          –õ—é–±–∞—è
        </button>
        <button class="chip" :class="{ active: priceMode === 'free' }" type="button" @click="setPrice('free')">
          –ë–µ—Å–ø–ª–∞—Ç–Ω–æ
        </button>
        <button class="chip" :class="{ active: priceMode === 'custom' }" type="button" @click="setPrice('custom')">
          –°–≤–æ–π –¥–∏–∞–ø–∞–∑–æ–Ω
        </button>
      </div>

      <div class="chips">
        <button class="chip" :class="{ active: priceMode === '100_1000' }" type="button" @click="setPrice('100_1000')">
          100‚Äì1000
        </button>
        <button class="chip" :class="{ active: priceMode === '1000_3000' }" type="button" @click="setPrice('1000_3000')">
          1000‚Äì3000
        </button>
        <button
          class="chip"
          :class="{ active: priceMode === '3000_10000' }"
          type="button"
          @click="setPrice('3000_10000')"
        >
          3000‚Äì10000
        </button>
        <button class="chip" :class="{ active: priceMode === 'gt_10000' }" type="button" @click="setPrice('gt_10000')">
          &gt; 10000
        </button>
      </div>

      <div v-if="priceMode === 'custom'" class="range">
        <input class="input" type="number" inputmode="numeric" placeholder="–û—Ç" :value="customPriceMin" @input="$emit('update:customPriceMin', $event.target.value)" />
        <input class="input" type="number" inputmode="numeric" placeholder="–î–æ" :value="customPriceMax" @input="$emit('update:customPriceMax', $event.target.value)" />
      </div>

      <div class="sub">–ï—Å–ª–∏ <b>is_free=true</b> –∏–ª–∏ price=0 ‚Äî —ç—Ç–æ ‚Äú–ë–µ—Å–ø–ª–∞—Ç–Ω–æ‚Äù.</div>
    </section>

    <section class="card">
      <div class="h">–î–∞—Ç–∞</div>

      <div class="chips">
        <button class="chip" :class="{ active: dateMode === 'all' }" type="button" @click="setDate('all')">–í—Å–µ –≤—Ä–µ–º—è</button>
        <button class="chip" :class="{ active: dateMode === 'today' }" type="button" @click="setDate('today')">–°–µ–≥–æ–¥–Ω—è</button>
        <button class="chip" :class="{ active: dateMode === 'next7' }" type="button" @click="setDate('next7')">7 –¥–Ω–µ–π</button>
      </div>

      <div class="chips">
        <button class="chip" :class="{ active: dateMode === 'on' }" type="button" @click="setDate('on')">–û–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–∞—è</button>
        <button class="chip" :class="{ active: dateMode === 'range' }" type="button" @click="setDate('range')">–î–∏–∞–ø–∞–∑–æ–Ω</button>
        <button class="chip" :class="{ active: dateMode === 'after' }" type="button" @click="setDate('after')">–ü–æ—Å–ª–µ</button>
        <button class="chip" :class="{ active: dateMode === 'before' }" type="button" @click="setDate('before')">–î–æ</button>
      </div>

      <div v-if="dateMode === 'on'" class="range">
        <input class="input" type="date" :value="dateOn" @input="$emit('update:dateOn', $event.target.value)" />
      </div>

      <div v-if="dateMode === 'range'" class="range">
        <input class="input" type="date" :value="dateFrom" @input="$emit('update:dateFrom', $event.target.value)" />
        <input class="input" type="date" :value="dateTo" @input="$emit('update:dateTo', $event.target.value)" />
      </div>

      <div v-if="dateMode === 'after' || dateMode === 'before'" class="range">
        <input class="input" type="date" :value="datePivot" @input="$emit('update:datePivot', $event.target.value)" />
      </div>
    </section>
  </div>
</template>

<script>
export default {
  name: 'FiltersPanel',
  emits: [
    'reset',
    'update:selectedCategoryNames',
    'update:onlineOnly',
    'update:priceMode',
    'update:customPriceMin',
    'update:customPriceMax',
    'update:dateMode',
    'update:dateOn',
    'update:dateFrom',
    'update:dateTo',
    'update:datePivot'
  ],
  props: {
    categories: { type: Array, default: () => [] },
    selectedCategoryNames: { type: Array, default: () => [] },
    onlineOnly: { type: Boolean, default: false },
    priceMode: { type: String, default: 'all' },
    customPriceMin: { type: String, default: '' },
    customPriceMax: { type: String, default: '' },
    dateMode: { type: String, default: 'all' },
    dateOn: { type: String, default: '' },
    dateFrom: { type: String, default: '' },
    dateTo: { type: String, default: '' },
    datePivot: { type: String, default: '' }
  },
  methods: {
    setAll() {
      this.$emit('update:selectedCategoryNames', [])
    },
    toggleCategory(name) {
      const n = String(name || '').trim()
      if (!n) return
      const set = new Set(this.selectedCategoryNames)
      if (set.has(n)) set.delete(n)
      else set.add(n)
      this.$emit('update:selectedCategoryNames', Array.from(set))
    },
    setPrice(mode) {
      this.$emit('update:priceMode', mode)
    },
    setDate(mode) {
      this.$emit('update:dateMode', mode)
    }
  }
}
</script>

<style scoped>
.panel { display: grid; gap: 12px; }

.row { display: flex; align-items: center; }
.spacer { flex: 1; }
.reset {
  border: 1px solid #efefef;
  background: #fafafa;
  border-radius: 12px;
  padding: 8px 10px;
  cursor: pointer;
  font-weight: 900;
}
.reset:hover { background: #f0f0f0; }

.card {
  background: #fff;
  border: 1px solid #efefef;
  border-radius: 16px;
  padding: 12px;
  box-shadow: 0 2px 10px rgba(0,0,0,.03);
}
.h { font-weight: 900; margin-bottom: 10px; }

.tags { display: flex; flex-wrap: wrap; gap: 8px; }
.tag {
  border: 1px solid #efefef;
  background: #fff;
  border-radius: 999px;
  padding: 8px 10px;
  cursor: pointer;
  font-weight: 800;
  font-size: 13px;
}
.tag.active { background: #8a75e3; border-color: #8a75e3; color: #fff; }

.toggle { display: inline-flex; align-items: center; gap: 10px; cursor: pointer; user-select: none; }
.toggle input { display: none; }
.ui {
  width: 44px; height: 26px; border-radius: 999px;
  border: 1px solid #e9e9e9; background: #f3f3f3; position: relative;
  transition: background 180ms ease, border-color 180ms ease;
}
.ui::after {
  content: ''; width: 22px; height: 22px; border-radius: 999px;
  background: #fff; position: absolute; top: 1px; left: 1px;
  box-shadow: 0 2px 10px rgba(0,0,0,.08);
  transition: transform 180ms ease;
}
.toggle input:checked + .ui { background: rgba(138,117,227,.85); border-color: rgba(138,117,227,.55); }
.toggle input:checked + .ui::after { transform: translateX(18px); }
.txt { font-weight: 900; }

.chips { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px; }
.chip {
  border: 1px solid #efefef;
  background: #fff;
  border-radius: 999px;
  padding: 8px 10px;
  cursor: pointer;
  font-weight: 900;
  font-size: 12px;
}
.chip.active { background: rgba(138,117,227,.12); border-color: rgba(138,117,227,.35); }

.range { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 10px 0 6px; }
.input {
  border: 1px solid #efefef;
  border-radius: 12px;
  padding: 10px;
  outline: none;
}
.input:focus { border-color: rgba(138,117,227,.55); box-shadow: 0 0 0 3px rgba(138,117,227,.12); }

.sub { font-size: 12px; opacity: .7; margin-top: 6px; line-height: 1.2; }
</style>
–í–ê–ñ–ù–û: –ø–æ—á–µ–º—É —É —Ç–µ–±—è –≤ –ë–î –æ–∫–∞–∑–∞–ª—Å—è data:image/png;base64,...
–ü–æ—Ç–æ–º—É —á—Ç–æ —Ä–∞–Ω—å—à–µ/—Å–µ–π—á–∞—Å –≤—Å—Ç–∞–≤–ª—è–ª–∞—Å—å ‚Äú–∫–∞—Ä—Ç–∏–Ω–∫–∞‚Äù –∫–∞–∫ data-url (–∏–ª–∏ —Å–∫—Ä–∏–ø—Ç –µ—ë —Ç–∞–∫ —Å–æ—Ö—Ä–∞–Ω—è–ª). –¢–µ–ø–µ—Ä—å:

–ø–æ–ª–µ URL –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ç–æ–ª—å–∫–æ http(s)://...

file ‚Üí Storage ‚Üí photo_url = publicUrl

–ï—Å–ª–∏ –ø–æ—Å–ª–µ —ç—Ç–∏—Ö –ø—Ä–∞–≤–æ–∫ —Ñ–æ—Ç–æ –≤—Å—ë —Ä–∞–≤–Ω–æ –Ω–µ –≥—Ä—É–∑–∏—Ç—Å—è (–Ω–∞–ø—Ä–∏–º–µ—Ä Unauthorized), –∑–Ω–∞—á–∏—Ç —É Storage bucket –Ω–µ—Ç public/–ø–æ–ª–∏—Ç–∏–∫. –°–∫–∞–∂–∏, –∫–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è bucket –¥–ª—è —Ñ–æ—Ç–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π ‚Äî —è –¥–∞–º —Ç–æ—á–Ω—ã–µ policies (2-3 —Å—Ç—Ä–æ—á–∫–∏).


–í—ã —Å–∫–∞–∑–∞–ª–∏:
–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
—Ç–∞–∫, –µ—â—ë —Ä–∞–∑, —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ —Å –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –¥–æ–ª–∂–Ω—ã —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è –≤–æ—Ç —Å—é–¥–∞

create table public.event_photos (
  id bigint generated by default as identity not null,
  event_id bigint not null,
  photo_url text null,
  constraint event_photos_pkey primary key (id),
  constraint event_photos_event_id_fkey foreign KEY (event_id) references events (id)
) TABLESPACE pg_default;

–í —ç—Ç—É —Ç–∞–±–ª–∏—Ü—É, —Å–¥–µ–ª–∞–π —Ç–∞–∫, —á—Ç–æ–±—ã –æ–Ω–∏ —Å—é–¥–∞ –∏ —Å–æ—Ö—Ä–∞–Ω—è–ª–∏—Å—å
–≤ photo_url

ChatGPT —Å–∫–∞–∑–∞–ª:

–î—É–º–∞–ª –Ω–∞ –ø—Ä–æ—Ç—è–∂–µ–Ω–∏–∏ 10s
–ü–æ–Ω—è–ª. –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –¥–æ–ª–∂–Ω—ã —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è –∏–º–µ–Ω–Ω–æ –≤ public.event_photos, –∞ –≤ photo_url –¥–æ–ª–∂–Ω–∞ –ø–æ–ø–∞–¥–∞—Ç—å –Ω–æ—Ä–º–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞, –∞ –Ω–µ data:image....

–°—Ä–∞–∑—É –≤–∞–∂–Ω–æ–µ: –≤ —Ç–≤–æ—é —Ç–∞–±–ª–∏—Ü—É —É–∂–µ ‚Äú—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è‚Äù ‚Äî –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –º—É—Å–æ—Ä, –ø–æ—Ç–æ–º—É —á—Ç–æ:

–≥–¥–µ-—Ç–æ –≤ UI/–∫–æ–¥–µ –≤ photo_url –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∞—Å—å —Å—Ç—Ä–æ–∫–∞ –≤–∏–¥–∞ data:image/... (–æ–±—ã—á–Ω–æ —ç—Ç–æ ‚Äú–ø—Ä–µ–≤—å—é‚Äù –∏–ª–∏ –≤—Å—Ç–∞–≤–∫–∞ base64),

–ª–∏–±–æ –æ—Å—Ç–∞–ª–∏—Å—å —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏, —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –¥–æ —Ñ–∏–∫—Å–∞.

–Ø —Å–¥–µ–ª–∞—é —Ç–∞–∫, —á—Ç–æ–±—ã:

—Ñ–æ—Ç–æ –º–æ–∂–Ω–æ –±—ã–ª–æ –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–º (–Ω–∏–∫–∞–∫–∏—Ö ‚ÄúURL‚Äù –ø–æ–ª–µ–π, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –ø—É—Ç–∞–Ω–∏—Ü—ã –∏ —Å–ª—É—á–∞–π–Ω—ã—Ö data:)

—Ñ–∞–π–ª –≥—Ä—É–∑–∏—Ç—Å—è –≤ Supabase Storage, –ø–æ–ª—É—á–∞–µ–º public URL

–≤—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –≤ event_photos: { event_id, photo_url: publicUrl }

–ù–∏–∂–µ –ø–æ–ª–Ω—ã–π –∫–æ–¥ –¥–≤—É—Ö —Ñ–∞–π–ª–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å.

1) src/composables/useSupabase.js ‚Äî –ó–ê–ú–ï–ù–ò–¢–¨ –ü–û–õ–ù–û–°–¢–¨–Æ
import { createClient } from '@supabase/supabase-js'

const supabaseUrl = import.meta.env.VITE_SUPABASE_URL
const supabaseKey = import.meta.env.VITE_SUPABASE_ANON_KEY

export const supabase = createClient(supabaseUrl, supabaseKey)

const normalizeStoragePublicUrl = (url) => {
  if (!url || typeof url !== 'string') return ''
  const u = url.trim()
  if (!u) return ''
  if (u.includes('/storage/v1/object/public/')) return u
  if (u.includes('/storage/v1/object/')) return u.replace('/storage/v1/object/', '/storage/v1/object/public/')
  return u
}

const getFileExt = (file) => {
  const name = String(file?.name || '')
  const ext = name.includes('.') ? name.split('.').pop() : ''
  const clean = String(ext || '').toLowerCase().replace(/[^a-z0-9]/g, '')
  return clean || 'png'
}

export const useSupabase = () => {
  // ---------------------------
  // EVENTS (ONLY PUBLISHED)
  // ---------------------------
  const getEvents = async () => {
    const { data, error } = await supabase
      .from('events')
      .select(
        `
        id,
        title,
        description,
        date_time_event,
        address,
        organizer,
        price,
        is_online,
        is_free,
        user_id,
        selectCategory,
        is_published,
        created_at
      `
      )
      .eq('is_published', true)
      .order('created_at', { ascending: false })

    return { data, error }
  }

  const getCategories = async () => {
    const { data, error } = await supabase.from('category').select('id, name').order('name', { ascending: true })
    return { data, error }
  }

  const getEventPhotos = async (eventIds) => {
    if (!Array.isArray(eventIds) || eventIds.length === 0) return { data: [], error: null }

    const { data, error } = await supabase
      .from('event_photos')
      .select('id, event_id, photo_url')
      .in('event_id', eventIds)
      .order('id', { ascending: true })

    return { data: data ?? [], error }
  }

  // ---------------------------
  // AUTH
  // ---------------------------
  const getUser = async () => {
    const { data, error } = await supabase.auth.getUser()
    return { user: data?.user ?? null, error }
  }

  // ---------------------------
  // EVENT PHOTO UPLOAD (Storage -> event_photos)
  // ---------------------------
  const uploadEventPhotoToStorage = async (eventId, file) => {
    if (!eventId) return { publicUrl: null, error: new Error('No eventId') }
    if (!file) return { publicUrl: null, error: new Error('No file') }

    // ‚úÖ –∑–∞–¥–∞–π –æ–¥–∏–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π bucket –≤ .env
    // VITE_SUPABASE_EVENT_PHOTOS_BUCKET=event-photos
    const bucket = (import.meta.env.VITE_SUPABASE_EVENT_PHOTOS_BUCKET || 'event-photos').trim()

    const ext = getFileExt(file)
    const path = `EventPhotos/${eventId}/${Date.now()}.${ext}`

    const { error: upErr } = await supabase.storage.from(bucket).upload(path, file, { upsert: true })
    if (upErr) return { publicUrl: null, error: upErr }

    const { data } = supabase.storage.from(bucket).getPublicUrl(path)
    const publicUrl = normalizeStoragePublicUrl(data?.publicUrl || '')
    if (!publicUrl) return { publicUrl: null, error: new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å publicUrl') }

    return { publicUrl, error: null }
  }

  // ‚úÖ BUSINESS create draft event + save photo into public.event_photos
  const createBusinessEvent = async (payload) => {
    const { user, error: userErr } = await getUser()
    if (userErr) return { data: null, error: userErr }
    if (!user) return { data: null, error: new Error('–ù–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏') }

    const price = Number(payload?.price ?? 0)
    const is_free = payload?.is_free === true || (Number.isFinite(price) && price <= 0)

    const eventInsert = {
      title: payload?.title ?? null,
      description: payload?.description ?? null,
      date_time_event: payload?.date_time_event ?? null,
      address: payload?.address ?? null,
      organizer: payload?.organizer ?? null,
      price: Number.isFinite(price) ? price : 0,
      is_online: !!payload?.is_online,
      is_free,
      user_id: user.id,
      selectCategory: Array.isArray(payload?.selectCategory) ? payload.selectCategory : [],
      is_published: false
    }

    // 1) —Å–æ–∑–¥–∞—ë–º event
    const { data: eventRow, error: insErr } = await supabase.from('events').insert(eventInsert).select().single()
    if (insErr) return { data: null, error: insErr }

    // 2) –µ—Å–ª–∏ –µ—Å—Ç—å —Ñ–∞–π–ª -> –≥—Ä—É–∑–∏–º –≤ Storage -> –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ public.event_photos.photo_url
    const file = payload?.photo_file || null
    if (file) {
      const { publicUrl, error: upErr } = await uploadEventPhotoToStorage(eventRow.id, file)
      if (upErr) return { data: eventRow, error: upErr }

      const { error: phErr } = await supabase.from('event_photos').insert({
        event_id: eventRow.id,
        photo_url: publicUrl
      })
      if (phErr) return { data: eventRow, error: phErr }
    }

    return { data: eventRow, error: null }
  }

  return {
    getEvents,
    getCategories,
    getEventPhotos,
    createBusinessEvent
  }
}
–í–ê–ñ–ù–û: —á—Ç–æ–±—ã —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–ª–æ, bucket event-photos –¥–æ–ª–∂–µ–Ω —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å –∏ –±—ã—Ç—å Public (–∏–ª–∏ –∏–º–µ—Ç—å –ø–æ–ª–∏—Ç–∏–∫–∏ –Ω–∞ —á—Ç–µ–Ω–∏–µ/–∑–∞–ø–∏—Å—å).
–í .env –¥–æ–±–∞–≤—å:
VITE_SUPABASE_EVENT_PHOTOS_BUCKET=event-photos

2) src/components/CreateEventModal.vue ‚Äî –ó–ê–ú–ï–ù–ò–¢–¨ –ü–û–õ–ù–û–°–¢–¨–Æ
–Ø —É–±—Ä–∞–ª –ø–æ–ª–µ ‚ÄúURL‚Äù –≤–æ–æ–±—â–µ, —á—Ç–æ–±—ã —Ç—ã —Ñ–∏–∑–∏—á–µ—Å–∫–∏ –Ω–µ –º–æ–≥ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å data:image... –≤ –ë–î. –¢–æ–ª—å–∫–æ —Ñ–∞–π–ª.

<template>
  <teleport to="body">
    <div v-if="open" class="root" @keydown.esc="close" tabindex="-1">
      <div class="overlay" @click="close"></div>

      <div class="modal" role="dialog" aria-modal="true" aria-label="–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ">
        <div class="head">
          <div class="title">–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</div>
          <button class="x" @click="close" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
        </div>

        <div class="body">
          <div class="hint">
            –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è –≤ –ø—Ä–µ–¥–ª–æ–∂–∫—É –∏ –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∞–¥–º–∏–Ω–æ–º.
          </div>

          <div class="grid">
            <div class="field">
              <div class="label">–ù–∞–∑–≤–∞–Ω–∏–µ *</div>
              <input class="input" v-model="form.title" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –í–µ—á–µ—Ä –Ω–∞—Å—Ç–æ–ª–æ–∫" />
            </div>

            <div class="field">
              <div class="label">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è *</div>
              <input class="input" type="datetime-local" v-model="form.date_time_event" />
            </div>

            <div class="field">
              <div class="label">–ê–¥—Ä–µ—Å</div>
              <input class="input" v-model="form.address" placeholder="–ì–æ—Ä–æ–¥, —É–ª–∏—Ü–∞, –¥–æ–º / –∏–ª–∏ —Å—Å—ã–ª–∫–∞" />
            </div>

            <div class="field">
              <div class="label">–û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä</div>
              <input class="input" v-model="form.organizer" placeholder="–ò–º—è/–ø—Ä–æ–µ–∫—Ç" />
            </div>

            <div class="field">
              <div class="label">–¶–µ–Ω–∞ (‚ÇΩ)</div>
              <input class="input" type="number" min="0" inputmode="numeric" v-model="form.price" placeholder="0" />
              <div class="mini"><span class="badge" v-if="isFree">üÜì –ë–µ—Å–ø–ª–∞—Ç–Ω–æ</span></div>
            </div>

            <div class="field inline">
              <label class="check">
                <input type="checkbox" v-model="form.is_online" />
                <span class="ui"></span>
                <span class="text">–û–Ω–ª–∞–π–Ω (is_online)</span>
              </label>
            </div>
          </div>

          <div class="field">
            <div class="label">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</div>
            <div class="tags">
              <button
                v-for="c in categories"
                :key="c.id"
                class="tag"
                :class="{ active: selectedCategories.includes(c.name) }"
                @click="toggleCategory(c.name)"
                type="button"
              >
                {{ c.name }}
              </button>
            </div>
            <div class="mini">–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ.</div>
          </div>

          <!-- ‚úÖ ONLY FILE -->
          <div class="field">
            <div class="label">–ö–∞—Ä—Ç–∏–Ω–∫–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</div>

            <div class="image-row">
              <label class="file-btn">
                <input class="file-input" type="file" accept="image/*" @change="onPickFile" />
                üì∑ –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª
              </label>

              <button v-if="pickedFile" class="file-clear" type="button" @click="clearFile">
                –£–±—Ä–∞—Ç—å
              </button>
            </div>

            <div v-if="pickedFile" class="preview">
              <img :src="previewUrl" alt="preview" />
              <div class="preview-meta">
                <div class="preview-name">{{ pickedFile.name }}</div>
                <div class="preview-sub">{{ prettySize(pickedFile.size) }}</div>
              </div>
            </div>

            <div class="mini">
              –§–∞–π–ª –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è –≤ Storage, –∞ —Å—Å—ã–ª–∫–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ <b>public.event_photos.photo_url</b>.
            </div>
          </div>

          <div class="field">
            <div class="label">–û–ø–∏—Å–∞–Ω–∏–µ *</div>
            <textarea class="textarea" v-model="form.description" placeholder="–û–ø–∏—à–∏, —á—Ç–æ –±—É–¥–µ—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å"></textarea>
          </div>

          <div v-if="error" class="error">{{ error }}</div>
        </div>

        <div class="foot">
          <button class="btn secondary" @click="close">–û—Ç–º–µ–Ω–∞</button>
          <button class="btn primary" :disabled="saving" @click="submit">
            {{ saving ? '–û—Ç–ø—Ä–∞–≤–ª—è—é‚Ä¶' : '–û—Ç–ø—Ä–∞–≤–∏—Ç—å' }}
          </button>
        </div>
      </div>
    </div>
  </teleport>
</template>

<script>
const trimOrNull = (v) => {
  const s = String(v ?? '').trim()
  return s ? s : null
}

export default {
  name: 'CreateEventModal',
  emits: ['close', 'created'],
  props: {
    open: { type: Boolean, default: false },
    categories: { type: Array, default: () => [] },
    createBusinessEvent: { type: Function, required: true }
  },
  data() {
    return {
      saving: false,
      error: '',
      selectedCategories: [],
      form: {
        title: '',
        description: '',
        date_time_event: '',
        address: '',
        organizer: '',
        price: '0',
        is_online: false
      },
      pickedFile: null,
      previewUrl: ''
    }
  },
  computed: {
    isFree() {
      const n = Number(this.form.price)
      return Number.isFinite(n) && n <= 0
    }
  },
  watch: {
    open(v) {
      if (!v) this.cleanupPreview()
    }
  },
  methods: {
    close() {
      if (this.saving) return
      this.$emit('close')
    },
    toggleCategory(name) {
      const n = String(name || '').trim()
      if (!n) return
      const idx = this.selectedCategories.indexOf(n)
      if (idx >= 0) this.selectedCategories.splice(idx, 1)
      else this.selectedCategories.push(n)
    },

    prettySize(bytes) {
      const b = Number(bytes || 0)
      if (b < 1024) return `${b} B`
      const kb = b / 1024
      if (kb < 1024) return `${kb.toFixed(1)} KB`
      const mb = kb / 1024
      return `${mb.toFixed(1)} MB`
    },

    onPickFile(e) {
      const file = e?.target?.files?.[0]
      if (!file) return

      if (!String(file.type || '').startsWith('image/')) {
        this.error = '–ù—É–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.'
        e.target.value = ''
        return
      }

      const maxMB = 8
      if (file.size > maxMB * 1024 * 1024) {
        this.error = `–°–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π —Ñ–∞–π–ª. –ú–∞–∫—Å–∏–º—É–º ${maxMB}MB.`
        e.target.value = ''
        return
      }

      this.error = ''
      this.pickedFile = file

      this.cleanupPreview()
      this.previewUrl = URL.createObjectURL(file)
    },

    clearFile() {
      this.pickedFile = null
      this.cleanupPreview()
      this.previewUrl = ''
    },

    cleanupPreview() {
      try {
        if (this.previewUrl) URL.revokeObjectURL(this.previewUrl)
      } catch {}
    },

    async submit() {
      this.error = ''

      const title = trimOrNull(this.form.title)
      const description = trimOrNull(this.form.description)
      const dt = trimOrNull(this.form.date_time_event)

      if (!title) return (this.error = '–£–∫–∞–∂–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ.')
      if (!dt) return (this.error = '–£–∫–∞–∂–∏ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è.')
      if (!description) return (this.error = '–£–∫–∞–∂–∏ –æ–ø–∏—Å–∞–Ω–∏–µ.')

      const priceNum = Number(this.form.price)
      const price = Number.isFinite(priceNum) ? priceNum : 0
      const is_free = price <= 0

      const payload = {
        title,
        description,
        date_time_event: dt,
        address: trimOrNull(this.form.address),
        organizer: trimOrNull(this.form.organizer),
        price,
        is_online: !!this.form.is_online,
        is_free,
        selectCategory: [...this.selectedCategories],
        photo_file: this.pickedFile || null
      }

      this.saving = true
      try {
        const { data, error } = await this.createBusinessEvent(payload)
        if (error) {
          this.error = String(error.message || error)
          return
        }

        // reset
        this.selectedCategories = []
        this.form = {
          title: '',
          description: '',
          date_time_event: '',
          address: '',
          organizer: '',
          price: '0',
          is_online: false
        }
        this.clearFile()

        this.$emit('created', data)
        this.$emit('close')
      } finally {
        this.saving = false
      }
    }
  }
}
</script>

<style scoped>
.root { position: fixed; inset: 0; z-index: 10000; }
.overlay { position: absolute; inset: 0; background: rgba(0,0,0,.38); backdrop-filter: blur(2px); }

.modal {
  position: absolute; left: 50%; top: 50%;
  width: min(760px, 94vw); max-height: 90vh;
  transform: translate(-50%, -50%);
  background: #fff; border: 1px solid #efefef; border-radius: 18px;
  box-shadow: 0 18px 60px rgba(0,0,0,.18);
  display: flex; flex-direction: column; overflow: hidden;
}

.head { padding: 14px; border-bottom: 1px solid #f2f2f2; display: flex; align-items: center; gap: 12px; }
.title { font-weight: 900; font-size: 16px; }
.x { margin-left: auto; border: 1px solid #efefef; background: #fafafa; border-radius: 12px; padding: 8px 10px; cursor: pointer; }

.body { padding: 14px; overflow: auto; display: flex; flex-direction: column; gap: 12px; }

.hint {
  background: #fcfcff; border: 1px solid rgba(138,117,227,.18);
  border-radius: 14px; padding: 10px 12px; font-size: 13px; opacity: .9;
}

.grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
@media (max-width: 720px) { .grid { grid-template-columns: 1fr; } }

.field { display: flex; flex-direction: column; gap: 6px; }
.field.inline { justify-content: flex-end; }

.label { font-size: 12px; font-weight: 800; opacity: .7; }
.input, .textarea {
  border: 1px solid #efefef; border-radius: 12px; padding: 10px 10px;
  font-size: 14px; background: #fff; outline: none;
}
.input:focus, .textarea:focus { border-color: rgba(138,117,227,.55); box-shadow: 0 0 0 3px rgba(138,117,227,.12); }
.textarea { min-height: 120px; resize: vertical; }

.mini { font-size: 12px; opacity: .7; line-height: 1.25; }
.badge {
  display: inline-flex; align-items: center; padding: 6px 10px; border-radius: 999px;
  background: rgba(138,117,227,.12); border: 1px solid rgba(138,117,227,.22); width: fit-content;
}

.tags { display: flex; flex-wrap: wrap; gap: 8px; }
.tag { border: 1px solid #efefef; background: #fff; border-radius: 999px; padding: 7px 10px; cursor: pointer; font-size: 13px; }
.tag.active { background: #8a75e3; border-color: #8a75e3; color: #fff; }

.check { display: inline-flex; align-items: center; gap: 10px; cursor: pointer; user-select: none; }
.check input { display: none; }
.ui {
  width: 44px; height: 26px; border-radius: 999px; border: 1px solid #e9e9e9; background: #f3f3f3;
  position: relative; transition: background 180ms ease, border-color 180ms ease;
}
.ui::after {
  content: ''; width: 22px; height: 22px; border-radius: 999px; background: #fff;
  position: absolute; top: 1px; left: 1px; box-shadow: 0 2px 10px rgba(0,0,0,.08);
  transition: transform 180ms ease;
}
.check input:checked + .ui { background: rgba(138,117,227,.85); border-color: rgba(138,117,227,.55); }
.check input:checked + .ui::after { transform: translateX(18px); }
.text { font-weight: 800; font-size: 13px; }

.image-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
.file-input { display: none; }
.file-btn {
  display: inline-flex; align-items: center; gap: 8px;
  border: 1px solid #efefef; background: #fff; border-radius: 14px;
  padding: 10px 12px; font-weight: 900; cursor: pointer;
}
.file-btn:hover { background: #fafafa; }
.file-clear {
  border: 1px solid #efefef; background: #fafafa; border-radius: 14px;
  padding: 10px 12px; font-weight: 900; cursor: pointer;
}
.file-clear:hover { background: #f0f0f0; }

.preview {
  margin-top: 8px; border: 1px solid #efefef; border-radius: 16px; overflow: hidden;
  display: grid; grid-template-columns: 140px 1fr; background: #fff;
}
.preview img { width: 140px; height: 110px; object-fit: cover; display: block; background: #f2f2f2; }
.preview-meta { padding: 10px; display: grid; gap: 6px; align-content: center; }
.preview-name { font-weight: 900; font-size: 13px; word-break: break-word; }
.preview-sub { font-size: 12px; opacity: .7; }

.error { color: #d9534f; font-weight: 800; font-size: 13px; }

.foot { padding: 14px; border-top: 1px solid #f2f2f2; display: flex; justify-content: flex-end; gap: 10px; }
.btn { border-radius: 14px; padding: 12px 16px; font-weight: 900; cursor: pointer; border: none; }
.btn.secondary { background: #efefef; }
.btn.primary { background: #8a75e3; color: #fff; }
.btn:disabled { opacity: .6; cursor: not-allowed; }
</style>
–ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å –≤ Supabase, —á—Ç–æ–±—ã —Ç–æ—á–Ω–æ ‚Äú—Å–æ—Ö—Ä–∞–Ω—è–ª–æ—Å—å‚Äù
Storage ‚Üí Create bucket ‚Üí event-photos

–í–∫–ª—é—á–∏—Ç—å Public (–Ω–∞ –≤—Ä–µ–º—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ ‚Äî —Å–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π –≤–∞—Ä–∏–∞–Ω—Ç)

–í .env:

VITE_SUPABASE_EVENT_PHOTOS_BUCKET=event-photos

–ü–æ—á–µ–º—É —É —Ç–µ–±—è –≤—Å—ë –µ—â—ë –≤–∏–¥–Ω—ã data:image... –≤ —Ç–∞–±–ª–∏—Ü–µ
–≠—Ç–æ —Å—Ç–∞—Ä—ã–µ —Å—Ç—Ä–æ–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –∑–∞–ø–∏—Å–∞–Ω—ã –≤ –ë–î. –ù–æ–≤—ã–π –∫–æ–¥ –∏—Ö –Ω–µ ‚Äú–ø–æ–ø—Ä–∞–≤–∏—Ç‚Äù –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å –±—ã—Å—Ç—Ä–æ –æ—á–∏—Å—Ç–∏—Ç—å –º—É—Å–æ—Ä:

–≤—Ä—É—á–Ω—É—é —É–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–æ–∫–∏, –≥–¥–µ photo_url –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å data:

–∏–ª–∏ SQL:

delete from public.event_photos
where photo_url like 'data:%';
–ï—Å–ª–∏ –ø–æ—Å–ª–µ —ç—Ç–∏—Ö –ø—Ä–∞–≤–æ–∫ –≤ event_photos –≤–æ–æ–±—â–µ –Ω–∏—á–µ–≥–æ –Ω–µ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è ‚Äî –∑–Ω–∞—á–∏—Ç –∑–∞–≥—Ä—É–∑–∫–∞ –≤ Storage –ø–∞–¥–∞–µ—Ç –∏–∑-–∑–∞ –ø—Ä–∞–≤ (Unauthorized) –∏–ª–∏ bucket –Ω–µ public. –¢–æ–≥–¥–∞ —Å–∫–∏–Ω—å —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏ –∏–∑ –∫–æ–Ω—Å–æ–ª–∏ (Network/Console) ‚Äî —Å–∫–∞–∂—É —Ç–æ—á–Ω—ã–µ policies –Ω–∞ Storage.


–í—ã —Å–∫–∞–∑–∞–ª–∏:
—Ç—ã —Å–µ–π—á–∞—Å –≤—ã–ø–∏—Å–∞–ª useSupabase –Ω–µ–ø–æ–ª–Ω–æ—Å—Ç—å—é, –æ–Ω —É –º–µ–Ω—è –Ω–∞ 300 —Å—Ç—Ä–æ–∫, —Ç—ã –≤—ã–ø–∏—Å–∞–ª –≤—Å–µ–≥–æ 150, –æ–Ω–æ –ø–æ–ª–µ—Ç–∏—Ç –≤—Å—ë, –≤—ã–ø–∏—à–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é

ChatGPT —Å–∫–∞–∑–∞–ª:
–û–∫, —Ç—ã –ø—Ä–∞–≤ ‚Äî –Ω–µ–ª—å–∑—è ‚Äú–æ–±—Ä–µ–∑–∞—Ç—å‚Äù useSupabase.js, –∏–Ω–∞—á–µ —É —Ç–µ–±—è –æ—Ç–≤–∞–ª—è—Ç—Å—è –ø—Ä–æ—Ñ–∏–ª—å/—Ç–µ–ª–µ–≥–∞/–∞–≤–∞—Ç–∞—Ä/–ª–æ–≥–∏–Ω –∏ —Ç.–¥.

–ù–∏–∂–µ –ø–æ–ª–Ω—ã–π src/composables/useSupabase.js —Ü–µ–ª–∏–∫–æ–º, —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤—Å–µ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ (auth, –ø—Ä–æ—Ñ–∏–ª—å, –∞–≤–∞—Ç–∞—Ä, —Ç–µ–ª–µ–≥—Ä–∞–º, events, categories, photos) –∏ —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ª–æ–≥–∏–∫–æ–π —Ñ–æ—Ç–æ –¥–ª—è –±–∏–∑–Ω–µ—Å-–∏–≤–µ–Ω—Ç–∞:

–§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –≤ Storage (bucket –±–µ—Ä—ë–º –∏–∑ VITE_SUPABASE_EVENT_PHOTOS_BUCKET, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é event-photos)

–í —Ç–∞–±–ª–∏—Ü—É public.event_photos –≤—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è —Å—Ç—Ä–æ–∫–∞ { event_id, photo_url: publicUrl }

data: –∏ blob: –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–æ–ø–∞–¥–∞—é—Ç –≤ photo_url

src/composables/useSupabase.js ‚Äî –ó–ê–ú–ï–ù–ò–¢–¨ –ü–û–õ–ù–û–°–¢–¨–Æ
import { createClient } from '@supabase/supabase-js'

const supabaseUrl = import.meta.env.VITE_SUPABASE_URL
const supabaseKey = import.meta.env.VITE_SUPABASE_ANON_KEY

export const supabase = createClient(supabaseUrl, supabaseKey)

/**
 * –î–µ–ª–∞–µ—Ç URL –∏–∑ Storage "public", –µ—Å–ª–∏ –æ–Ω –≤–¥—Ä—É–≥ –ø—Ä–∏—à—ë–ª –±–µ–∑ /public/.
 * –¢–∞–∫–∂–µ —á–∏—Å—Ç–∏—Ç –ø—Ä–æ–±–µ–ª—ã.
 */
const normalizeStoragePublicUrl = (url) => {
  if (!url || typeof url !== 'string') return ''
  const u = url.trim()
  if (!u) return ''
  if (u.includes('/storage/v1/object/public/')) return u
  if (u.includes('/storage/v1/object/')) return u.replace('/storage/v1/object/', '/storage/v1/object/public/')
  return u
}

const compact = (obj) => {
  const out = {}
  for (const [k, v] of Object.entries(obj || {})) {
    if (v !== undefined) out[k] = v
  }
  return out
}

const getFileExt = (file) => {
  const name = String(file?.name || '')
  const ext = name.includes('.') ? name.split('.').pop() : ''
  const clean = String(ext || '')
    .toLowerCase()
    .replace(/[^a-z0-9]/g, '')
  return clean || 'png'
}

const isBadUrlScheme = (url) => {
  const s = String(url || '').trim().toLowerCase()
  return s.startsWith('data:') || s.startsWith('blob:')
}

export const useSupabase = () => {
  // ---------------------------
  // EVENTS (ONLY PUBLISHED)
  // ---------------------------
  const getEvents = async () => {
    const { data, error } = await supabase
      .from('events')
      .select(
        `
        id,
        title,
        description,
        date_time_event,
        address,
        organizer,
        price,
        is_online,
        is_free,
        user_id,
        selectCategory,
        is_published,
        created_at
      `
      )
      .eq('is_published', true)
      .order('created_at', { ascending: false })

    return { data, error }
  }

  const getCategories = async () => {
    const { data, error } = await supabase.from('category').select('id, name').order('name', { ascending: true })
    return { data, error }
  }

  const getEventPhotos = async (eventIds) => {
    if (!Array.isArray(eventIds) || eventIds.length === 0) return { data: [], error: null }

    const { data, error } = await supabase
      .from('event_photos')
      .select('id, event_id, photo_url')
      .in('event_id', eventIds)
      .order('id', { ascending: true })

    return { data: data ?? [], error }
  }

  // ---------------------------
  // AUTH
  // ---------------------------
  const getSession = async () => {
    const { data, error } = await supabase.auth.getSession()
    return { session: data?.session ?? null, error }
  }

  const getUser = async () => {
    const { data, error } = await supabase.auth.getUser()
    return { user: data?.user ?? null, error }
  }

  const signOut = async () => {
    const { error } = await supabase.auth.signOut()
    return { error }
  }

  const signInWithGoogle = async ({ redirectTo }) => {
    const { data, error } = await supabase.auth.signInWithOAuth({
      provider: 'google',
      options: { redirectTo }
    })
    return { data, error }
  }

  // ---------------------------
  // PROFILE (public.users)
  // ---------------------------
  const ensurePublicUserRow = async (authUser) => {
    if (!authUser?.id) return { data: null, error: null }

    const meta = authUser.user_metadata || {}

    const { data: existing, error: exErr } = await supabase
      .from('users')
      .select('id, email, first_name, last_name')
      .eq('id', authUser.id)
      .maybeSingle()

    if (exErr) return { data: null, error: exErr }

    const firstFromMeta = meta.given_name ?? meta.first_name
    const lastFromMeta = meta.family_name ?? meta.last_name

    const payload = compact({
      id: authUser.id,
      email: existing?.email ?? authUser.email ?? null,
      first_name: existing?.first_name ? undefined : firstFromMeta ?? undefined,
      last_name: existing?.last_name ? undefined : lastFromMeta ?? undefined
    })

    const { data, error } = await supabase.from('users').upsert(payload, { onConflict: 'id' }).select().single()
    return { data, error }
  }

  const getMyPublicUser = async () => {
    const { user } = await getUser()
    if (!user) return { data: null, error: null }

    const { data, error } = await supabase.from('users').select('*').eq('id', user.id).single()
    if (data?.image_path) data.image_path = normalizeStoragePublicUrl(data.image_path)
    return { data, error }
  }

  const updateMyPublicUser = async (patch) => {
    const { user } = await getUser()
    if (!user) return { data: null, error: new Error('No auth user') }

    const safePatch = { ...patch }
    // –∑–∞–ø—Ä–µ—â–∞–µ–º –º–µ–Ω—è—Ç—å –±–∏–∑–Ω–µ—Å-—Ñ–ª–∞–≥ –∏–∑ –∫–ª–∏–µ–Ω—Ç–∞
    delete safePatch.It_business

    for (const k of Object.keys(safePatch)) {
      if (safePatch[k] === '') safePatch[k] = null
    }
    if (safePatch.image_path) safePatch.image_path = normalizeStoragePublicUrl(safePatch.image_path)

    const { data, error } = await supabase.from('users').update(safePatch).eq('id', user.id).select().single()
    if (data?.image_path) data.image_path = normalizeStoragePublicUrl(data.image_path)
    return { data, error }
  }

  // ---------------------------
  // AVATAR UPLOAD (Storage -> users.image_path)
  // ---------------------------
  const uploadAvatar = async (file) => {
    const { user } = await getUser()
    if (!user) return { publicUrl: null, error: new Error('No auth user') }
    if (!file) return { publicUrl: null, error: new Error('No file') }

    const envBucket = (import.meta.env.VITE_SUPABASE_AVATAR_BUCKET || '').trim()
    const buckets = [...new Set([envBucket, 'avatars', 'Biom', 'biom'].filter(Boolean))]

    const ext = getFileExt(file)
    const path = `ProfileImage/${user.id}/${Date.now()}.${ext}`

    let lastErr = null

    for (const bucket of buckets) {
      const { error: upErr } = await supabase.storage.from(bucket).upload(path, file, { upsert: true })
      if (upErr) {
        lastErr = upErr
        if (String(upErr?.message || '').toLowerCase().includes('bucket not found')) continue
        return { publicUrl: null, error: upErr }
      }

      const { data } = supabase.storage.from(bucket).getPublicUrl(path)
      const publicUrl = normalizeStoragePublicUrl(data?.publicUrl || '')
      return { publicUrl, error: null }
    }

    return {
      publicUrl: null,
      error:
        lastErr ||
        new Error('Bucket not found. –°–æ–∑–¥–∞–π bucket –≤ Storage (–Ω–∞–ø—Ä–∏–º–µ—Ä "avatars") –∏ —É–∫–∞–∂–∏ VITE_SUPABASE_AVATAR_BUCKET.')
    }
  }

  // ---------------------------
  // EVENT PHOTO UPLOAD (Storage -> event_photos.photo_url)
  // ---------------------------
  const uploadEventPhotoToStorage = async (eventId, file) => {
    if (!eventId) return { publicUrl: null, error: new Error('No eventId') }
    if (!file) return { publicUrl: null, error: new Error('No file') }

    // ‚úÖ –û–î–ò–ù –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã: —ç—Ç–æ—Ç bucket
    // .env: VITE_SUPABASE_EVENT_PHOTOS_BUCKET=event-photos
    const bucket = (import.meta.env.VITE_SUPABASE_EVENT_PHOTOS_BUCKET || 'event-photos').trim()

    const ext = getFileExt(file)
    const path = `EventPhotos/${eventId}/${Date.now()}.${ext}`

    const { error: upErr } = await supabase.storage.from(bucket).upload(path, file, { upsert: true })
    if (upErr) return { publicUrl: null, error: upErr }

    const { data } = supabase.storage.from(bucket).getPublicUrl(path)
    const publicUrl = normalizeStoragePublicUrl(data?.publicUrl || '')

    if (!publicUrl) return { publicUrl: null, error: new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å publicUrl') }
    if (isBadUrlScheme(publicUrl)) return { publicUrl: null, error: new Error('Bad url scheme for photo') }

    return { publicUrl, error: null }
  }

  // ---------------------------
  // BUSINESS EVENTS: create draft (is_published=false) + optional photo file
  // ---------------------------
  const createBusinessEvent = async (payload) => {
    const { user, error: userErr } = await getUser()
    if (userErr) return { data: null, error: userErr }
    if (!user) return { data: null, error: new Error('–ù–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏') }

    const price = Number(payload?.price ?? 0)
    const is_free = payload?.is_free === true || (Number.isFinite(price) && price <= 0)

    const eventInsert = {
      title: payload?.title ?? null,
      description: payload?.description ?? null,
      date_time_event: payload?.date_time_event ?? null,
      address: payload?.address ?? null,
      organizer: payload?.organizer ?? null,
      price: Number.isFinite(price) ? price : 0,
      is_online: !!payload?.is_online,
      is_free,
      user_id: user.id,
      selectCategory: Array.isArray(payload?.selectCategory) ? payload.selectCategory : [],
      is_published: false
    }

    // 1) —Å–æ–∑–¥–∞—ë–º —Å–æ–±—ã—Ç–∏–µ
    const { data: eventRow, error: insErr } = await supabase.from('events').insert(eventInsert).select().single()
    if (insErr) return { data: null, error: insErr }

    // 2) –µ—Å–ª–∏ –µ—Å—Ç—å —Ñ–∞–π–ª ‚Äî –≥—Ä—É–∑–∏–º –≤ Storage –∏ –ø–∏—à–µ–º –≤ public.event_photos.photo_url
    const file = payload?.photo_file || null
    if (file) {
      const { publicUrl, error: upErr } = await uploadEventPhotoToStorage(eventRow.id, file)
      if (upErr) return { data: eventRow, error: upErr }

      // ‚úÖ –í–û–¢ –°–Æ–î–ê —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–æ—Ç–æ
      const { error: phErr } = await supabase.from('event_photos').insert({
        event_id: eventRow.id,
        photo_url: publicUrl
      })
      if (phErr) return { data: eventRow, error: phErr }
    }

    return { data: eventRow, error: null }
  }

  // ---------------------------
  // TELEGRAM
  // ---------------------------
  const linkTelegramViaEdgeFunction = async (telegramAuthData) => {
    const { data, error } = await supabase.functions.invoke('telegram-verify', { body: telegramAuthData })
    return { data, error }
  }

  const getMyTelegramLink = async () => {
    const { user } = await getUser()
    if (!user) return { data: null, error: null }

    const { data, error } = await supabase.from('user_telegram').select('*').eq('user_id', user.id).maybeSingle()
    return { data: data ?? null, error }
  }

  return {
    // events
    getEvents,
    getCategories,
    getEventPhotos,
    createBusinessEvent,

    // auth
    getSession,
    getUser,
    signInWithGoogle,
    signOut,

    // profile
    ensurePublicUserRow,
    getMyPublicUser,
    updateMyPublicUser,
    uploadAvatar,

    // telegram
    linkTelegramViaEdgeFunction,
    getMyTelegramLink
  }
}
–ú–∏–Ω–∏-—á–µ–∫–ª–∏—Å—Ç, —á—Ç–æ–±—ã photo_url —Å—Ç–∞–ª —Å—Å—ã–ª–∫–æ–π
Supabase ‚Üí Storage ‚Üí bucket event-photos (–∏–ª–∏ –∫–∞–∫–æ–π —Ç—ã —É–∫–∞–∂–µ—à—å –≤ .env)

bucket –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å Public (—Å–∞–º—ã–π –±—ã—Å—Ç—Ä—ã–π –≤–∞—Ä–∏–∞–Ω—Ç)

.env (–≤ –ø—Ä–æ–µ–∫—Ç–µ):

VITE_SUPABASE_EVENT_PHOTOS_BUCKET=event-photos

–ü–æ—á–µ–º—É –≤ —Ç–∞–±–ª–∏—Ü–µ –≤—Å—ë –µ—â—ë data:image...
–≠—Ç–æ —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏, —É–∂–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ —Ä–∞–Ω–µ–µ. –ù–æ–≤—ã–π –∫–æ–¥ –∏—Ö –Ω–µ –ø–µ—Ä–µ–ø–∏—à–µ—Ç.
–ï—Å–ª–∏ —Ö–æ—á–µ—à—å —É–±—Ä–∞—Ç—å –º—É—Å–æ—Ä:

delete from public.event_photos
where photo_url like 'data:%' or photo_url like 'blob:%';
–ï—Å–ª–∏ –ø–æ—Å–ª–µ –∑–∞–º–µ–Ω—ã useSupabase.js —É —Ç–µ–±—è —á—Ç–æ-—Ç–æ ‚Äú–Ω–µ —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è‚Äù –∏–∑-–∑–∞ –ø—É—Ç–µ–π –∏–º–ø–æ—Ä—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä —É —Ç–µ–±—è src/useSupabase.js –≤–º–µ—Å—Ç–æ src/composables/useSupabase.js) ‚Äî —Å–∫–∞–∂–∏, –∫–∞–∫–æ–π —Ç–æ—á–Ω—ã–π –ø—É—Ç—å —É —Ñ–∞–π–ª–∞, –∏ —è –ø–æ–¥–≥–æ–Ω—é –ø–æ–¥ —Ç–≤–æ—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –±–µ–∑ –ª–∏—à–Ω–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤.


–í—ã —Å–∫–∞–∑–∞–ª–∏:
–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
–≤—Å—ë —Ä–∞–≤–Ω–æ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è(( –≤ —Ç–∞–±–ª–∏—Ü—É, —Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –∫–∞—Ä—Ç–∏–Ω–∫–∞ —Ç–æ–∂–µ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è
–∫–æ–≥–¥–∞ data:image..., –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç
–≤ —Ç–∞–±–ª–∏—Ü–µ event_photos –µ—Å—Ç—å —Ç—Ä–∏ –∫–æ–ª–æ–Ω–∫–∏ id, event_id –∏ photo_url, –≤–æ—Ç —Ç–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –∫–æ—Ç–æ—Ä—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –¥–æ–ª–∂–Ω—ã —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è –≤ photo_url , –∏—Å–ø–æ–ª—å–∑—É–π data:image.....

ChatGPT —Å–∫–∞–∑–∞–ª:
–ü–æ–Ω—è–ª. –†–∞–∑ —É —Ç–µ–±—è —Å data:image... –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç, –∑–Ω–∞—á–∏—Ç —É —Ç–µ–±—è —Å–µ–π—á–∞—Å:

Storage / public URL –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç (—á–∞—â–µ –≤—Å–µ–≥–æ –∏–∑-–∑–∞ bucket/policies/RLS),

–Ω–æ –≤—Å—Ç–∞–≤–∫–∞ –≤ public.event_photos –ø—Ä–æ—Ö–æ–¥–∏—Ç, –∏ –∫–∞—Ä—Ç–æ—á–∫–∞ —É–º–µ–µ—Ç —Ä–∏—Å–æ–≤–∞—Ç—å data:image....

–¢–æ–≥–¥–∞ –¥–µ–ª–∞–µ–º —Ä–æ–≤–Ω–æ –∫–∞–∫ —Ç—ã –ø—Ä–æ—Å–∏—à—å: –±–µ—Ä—ë–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ñ–∞–π–ª ‚Üí –ø—Ä–µ–≤—Ä–∞—â–∞–µ–º –≤ data:image/...;base64,... ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ public.event_photos.photo_url.

–ù–∏–∂–µ useSupabase.js –ü–û–õ–ù–û–°–¢–¨–Æ (–≤—Å—ë, —á—Ç–æ –±—ã–ª–æ: events, categories, photos, auth, profile, avatar upload, telegram) ‚Äî –∏ createBusinessEvent —Ç–µ–ø–µ—Ä—å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç data:image –≤ event_photos.photo_url.

src/composables/useSupabase.js ‚Äî –ó–ê–ú–ï–ù–ò–¢–¨ –ü–û–õ–ù–û–°–¢–¨–Æ
import { createClient } from '@supabase/supabase-js'

const supabaseUrl = import.meta.env.VITE_SUPABASE_URL
const supabaseKey = import.meta.env.VITE_SUPABASE_ANON_KEY

export const supabase = createClient(supabaseUrl, supabaseKey)

/**
 * –î–µ–ª–∞–µ—Ç URL –∏–∑ Storage "public", –µ—Å–ª–∏ –æ–Ω –≤–¥—Ä—É–≥ –ø—Ä–∏—à—ë–ª –±–µ–∑ /public/.
 * (–æ—Å—Ç–∞–≤–ª—è—é, —Ç.–∫. –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏ –¥–ª—è –∞–≤–∞—Ç–∞—Ä–æ–≤/—Å—Ç–∞—Ä—ã—Ö —Å—Å—ã–ª–æ–∫)
 */
const normalizeStoragePublicUrl = (url) => {
  if (!url || typeof url !== 'string') return ''
  const u = url.trim()
  if (!u) return ''
  if (u.includes('/storage/v1/object/public/')) return u
  if (u.includes('/storage/v1/object/')) return u.replace('/storage/v1/object/', '/storage/v1/object/public/')
  return u
}

const compact = (obj) => {
  const out = {}
  for (const [k, v] of Object.entries(obj || {})) {
    if (v !== undefined) out[k] = v
  }
  return out
}

const getFileExt = (file) => {
  const name = String(file?.name || '')
  const ext = name.includes('.') ? name.split('.').pop() : ''
  const clean = String(ext || '').toLowerCase().replace(/[^a-z0-9]/g, '')
  return clean || 'png'
}

/**
 * ‚úÖ File -> data:image/... base64
 * –≠—Ç–æ —Ç–æ, —á—Ç–æ —Ç—ã —Ö–æ—á–µ—à—å —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –≤ event_photos.photo_url
 */
const readFileAsDataUrl = (file) =>
  new Promise((resolve, reject) => {
    try {
      const reader = new FileReader()
      reader.onload = () => resolve(String(reader.result || ''))
      reader.onerror = () => reject(reader.error || new Error('FileReader error'))
      reader.readAsDataURL(file)
    } catch (e) {
      reject(e)
    }
  })

export const useSupabase = () => {
  // ---------------------------
  // EVENTS (ONLY PUBLISHED)
  // ---------------------------
  const getEvents = async () => {
    const { data, error } = await supabase
      .from('events')
      .select(
        `
        id,
        title,
        description,
        date_time_event,
        address,
        organizer,
        price,
        is_online,
        is_free,
        user_id,
        selectCategory,
        is_published,
        created_at
      `
      )
      .eq('is_published', true)
      .order('created_at', { ascending: false })

    return { data, error }
  }

  const getCategories = async () => {
    const { data, error } = await supabase.from('category').select('id, name').order('name', { ascending: true })
    return { data, error }
  }

  const getEventPhotos = async (eventIds) => {
    if (!Array.isArray(eventIds) || eventIds.length === 0) return { data: [], error: null }

    const { data, error } = await supabase
      .from('event_photos')
      .select('id, event_id, photo_url')
      .in('event_id', eventIds)
      .order('id', { ascending: true })

    return { data: data ?? [], error }
  }

  // ---------------------------
  // AUTH
  // ---------------------------
  const getSession = async () => {
    const { data, error } = await supabase.auth.getSession()
    return { session: data?.session ?? null, error }
  }

  const getUser = async () => {
    const { data, error } = await supabase.auth.getUser()
    return { user: data?.user ?? null, error }
  }

  const signOut = async () => {
    const { error } = await supabase.auth.signOut()
    return { error }
  }

  const signInWithGoogle = async ({ redirectTo }) => {
    const { data, error } = await supabase.auth.signInWithOAuth({
      provider: 'google',
      options: { redirectTo }
    })
    return { data, error }
  }

  // ---------------------------
  // PROFILE (public.users)
  // ---------------------------
  const ensurePublicUserRow = async (authUser) => {
    if (!authUser?.id) return { data: null, error: null }

    const meta = authUser.user_metadata || {}

    const { data: existing, error: exErr } = await supabase
      .from('users')
      .select('id, email, first_name, last_name')
      .eq('id', authUser.id)
      .maybeSingle()

    if (exErr) return { data: null, error: exErr }

    const firstFromMeta = meta.given_name ?? meta.first_name
    const lastFromMeta = meta.family_name ?? meta.last_name

    const payload = compact({
      id: authUser.id,
      email: existing?.email ?? authUser.email ?? null,
      first_name: existing?.first_name ? undefined : firstFromMeta ?? undefined,
      last_name: existing?.last_name ? undefined : lastFromMeta ?? undefined
    })

    const { data, error } = await supabase.from('users').upsert(payload, { onConflict: 'id' }).select().single()
    return { data, error }
  }

  const getMyPublicUser = async () => {
    const { user } = await getUser()
    if (!user) return { data: null, error: null }

    const { data, error } = await supabase.from('users').select('*').eq('id', user.id).single()
    if (data?.image_path) data.image_path = normalizeStoragePublicUrl(data.image_path)
    return { data, error }
  }

  const updateMyPublicUser = async (patch) => {
    const { user } = await getUser()
    if (!user) return { data: null, error: new Error('No auth user') }

    const safePatch = { ...patch }
    // –∑–∞–ø—Ä–µ—â–∞–µ–º –º–µ–Ω—è—Ç—å –±–∏–∑–Ω–µ—Å-—Ñ–ª–∞–≥ –∏–∑ –∫–ª–∏–µ–Ω—Ç–∞
    delete safePatch.It_business

    for (const k of Object.keys(safePatch)) {
      if (safePatch[k] === '') safePatch[k] = null
    }
    if (safePatch.image_path) safePatch.image_path = normalizeStoragePublicUrl(safePatch.image_path)

    const { data, error } = await supabase.from('users').update(safePatch).eq('id', user.id).select().single()
    if (data?.image_path) data.image_path = normalizeStoragePublicUrl(data.image_path)
    return { data, error }
  }

  // ---------------------------
  // AVATAR UPLOAD (Storage -> users.image_path)
  // ---------------------------
  const uploadAvatar = async (file) => {
    const { user } = await getUser()
    if (!user) return { publicUrl: null, error: new Error('No auth user') }
    if (!file) return { publicUrl: null, error: new Error('No file') }

    const envBucket = (import.meta.env.VITE_SUPABASE_AVATAR_BUCKET || '').trim()
    const buckets = [...new Set([envBucket, 'avatars', 'Biom', 'biom'].filter(Boolean))]

    const ext = getFileExt(file)
    const path = `ProfileImage/${user.id}/${Date.now()}.${ext}`

    let lastErr = null

    for (const bucket of buckets) {
      const { error: upErr } = await supabase.storage.from(bucket).upload(path, file, { upsert: true })
      if (upErr) {
        lastErr = upErr
        if (String(upErr?.message || '').toLowerCase().includes('bucket not found')) continue
        return { publicUrl: null, error: upErr }
      }

      const { data } = supabase.storage.from(bucket).getPublicUrl(path)
      const publicUrl = normalizeStoragePublicUrl(data?.publicUrl || '')
      return { publicUrl, error: null }
    }

    return {
      publicUrl: null,
      error:
        lastErr ||
        new Error('Bucket not found. –°–æ–∑–¥–∞–π bucket –≤ Storage (–Ω–∞–ø—Ä–∏–º–µ—Ä "avatars") –∏ —É–∫–∞–∂–∏ VITE_SUPABASE_AVATAR_BUCKET.')
    }
  }

  // ---------------------------
  // BUSINESS EVENTS: create draft + photo saved to public.event_photos.photo_url as data:image...
  // ---------------------------
  const createBusinessEvent = async (payload) => {
    const { user, error: userErr } = await getUser()
    if (userErr) return { data: null, error: userErr }
    if (!user) return { data: null, error: new Error('–ù–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏') }

    const price = Number(payload?.price ?? 0)
    const is_free = payload?.is_free === true || (Number.isFinite(price) && price <= 0)

    const eventInsert = {
      title: payload?.title ?? null,
      description: payload?.description ?? null,
      date_time_event: payload?.date_time_event ?? null,
      address: payload?.address ?? null,
      organizer: payload?.organizer ?? null,
      price: Number.isFinite(price) ? price : 0,
      is_online: !!payload?.is_online,
      is_free,
      user_id: user.id,
      selectCategory: Array.isArray(payload?.selectCategory) ? payload.selectCategory : [],
      is_published: false
    }

    // 1) —Å–æ–∑–¥–∞—ë–º event
    const { data: eventRow, error: insErr } = await supabase.from('events').insert(eventInsert).select().single()
    if (insErr) return { data: null, error: insErr }

    // 2) ‚úÖ —Ñ–æ—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –í –¢–ê–ë–õ–ò–¶–£ public.event_photos, –≤ photo_url –∫–ª–∞–¥—ë–º data:image...
    const file = payload?.photo_file || null
    if (file) {
      // –ø–æ–¥—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ –Ω–∞ —Ç–∏–ø
      const mime = String(file?.type || '')
      if (!mime.startsWith('image/')) {
        return { data: eventRow, error: new Error('–§–∞–π–ª –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º') }
      }

      const dataUrl = await readFileAsDataUrl(file)
      if (!dataUrl || !dataUrl.startsWith('data:image/')) {
        return { data: eventRow, error: new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å data:image url') }
      }

      const { error: phErr } = await supabase.from('event_photos').insert({
        event_id: eventRow.id,
        photo_url: dataUrl
      })
      if (phErr) return { data: eventRow, error: phErr }
    }

    return { data: eventRow, error: null }
  }

  // ---------------------------
  // TELEGRAM
  // ---------------------------
  const linkTelegramViaEdgeFunction = async (telegramAuthData) => {
    const { data, error } = await supabase.functions.invoke('telegram-verify', { body: telegramAuthData })
    return { data, error }
  }

  const getMyTelegramLink = async () => {
    const { user } = await getUser()
    if (!user) return { data: null, error: null }

    const { data, error } = await supabase.from('user_telegram').select('*').eq('user_id', user.id).maybeSingle()
    return { data: data ?? null, error }
  }

  return {
    // events
    getEvents,
    getCategories,
    getEventPhotos,
    createBusinessEvent,

    // auth
    getSession,
    getUser,
    signInWithGoogle,
    signOut,

    // profile
    ensurePublicUserRow,
    getMyPublicUser,
    updateMyPublicUser,
    uploadAvatar,

    // telegram
    linkTelegramViaEdgeFunction,
    getMyTelegramLink
  }
}
–ß—Ç–æ –≤–∞–∂–Ω–æ –∑–Ω–∞—Ç—å (—á—Ç–æ–±—ã –Ω–µ —É–¥–∏–≤–ª—è—Ç—å—Å—è –ø–æ—Ç–æ–º)
data:image;base64,... –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω—ã–º. –ï—Å–ª–∏ —Ç—ã –∑–∞–≥—Ä—É–∑–∏—à—å, –Ω–∞–ø—Ä–∏–º–µ—Ä, —Ñ–æ—Ç–æ 5‚Äì10MB ‚Äî —Å—Ç—Ä–æ–∫–∞ —Å—Ç–∞–Ω–µ—Ç –æ–≥—Ä–æ–º–Ω–æ–π.

–ü–æ—ç—Ç–æ–º—É –≤ CreateEventModal.vue –æ—Å—Ç–∞–≤—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ —Ä–∞–∑–º–µ—Ä—É (8MB) (–æ–Ω–æ —É —Ç–µ–±—è —É–∂–µ –µ—Å—Ç—å).

–ï—Å–ª–∏ –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –≤—Å—ë —Ä–∞–≤–Ω–æ ‚Äú–Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è‚Äù
–¢–æ–≥–¥–∞ —ç—Ç–æ —É–∂–µ –Ω–µ Storage, –∞ RLS –Ω–∞ —Ç–∞–±–ª–∏—Ü–µ event_photos (INSERT –∑–∞–ø—Ä–µ—â—ë–Ω).
–ù–æ —Ç—ã —Å–∞–º —Å–∫–∞–∑–∞–ª: ‚Äú–∫–æ–≥–¥–∞ data:image ‚Äî —Ä–∞–±–æ—Ç–∞–µ—Ç‚Äù ‚Üí –∑–Ω–∞—á–∏—Ç INSERT —Ç—É–¥–∞ —É —Ç–µ–±—è —Ä–∞–∑—Ä–µ—à—ë–Ω, –∏ –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –∫–æ–¥–∞ —Ç–æ—á–Ω–æ –¥–æ–ª–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å.

–•–æ—á–µ—à—å ‚Äî —Å–∫–∏–Ω—å (—Å–∫—Ä–∏–Ω–æ–º) Console ‚Üí Network ‚Üí –∑–∞–ø—Ä–æ—Å insert –≤ event_photos (payload + response). –ü–æ –Ω–µ–º—É –∑–∞ 10 —Å–µ–∫—É–Ω–¥ –≤–∏–¥–Ω–æ, –ø–æ—á–µ–º—É –Ω–µ –≤—Å—Ç–∞–≤–∏–ª–æ—Å—å (403, RLS, payload –ø—É—Å—Ç–æ–π –∏ —Ç.–¥.).


–í—ã —Å–∫–∞–∑–∞–ª–∏:
–î–∞–ª—å—à–µ –Ω—É–∂–Ω–æ –º–Ω–µ –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã –≤—ã–ø–æ–ª–Ω—è–ª–∏—Å—å —Å–ª–µ–¥—É—é—â–∏–µ –∑–∞–¥–∞—á–∏

1) –î–æ–±–∞–≤–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–µ –æ–¥–Ω—É —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è, –∞ —Å—Ä–∞–∑—É –Ω–µ—Å–∫–æ–ª—å–∫–æ, –≤ —Ç–µ–ª–µ—Ñ–æ–Ω–Ω–æ–π –≤–µ—Ä—Å—Å–∏–∏ –∏—Ö –º–æ–∂–Ω–æ —Å–∫—Ä–æ–ª–ª–∏—Ç—å

2) –ø–æ–¥–µ–ª—å—Ç—å—Å—è –∫–Ω–æ–ø–∫–∞ –Ω–∞ –∫–∞–∂–¥–æ–º –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏ 
3) –¥–æ–±–∞–≤–∏—Ç—å –≤–∫–ª–∞–¥–∫—É –∏–∑–±—Ä–∞–Ω–Ω–æ–µ, –∫—É–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Å–≤–æ–∏ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–µ—Å—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è, –¥–æ–±–∞–≤–∏—Ç—å –∑–Ω–∞—á–µ–∫ –ª–∞–π–∫–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è, –Ω–∞ —Å–∞–º–æ–π –∫–∞—Ä—Ç–æ—á–∫–µ, —ç—Ç–æ –∏ –µ—Å—Ç—å –∏–∑–±—Ä–∞–Ω–Ω–æ–µ 
4)–ï—Å–ª–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –û–Ω–ª–∞–π–Ω, –æ–Ω–æ –¥–æ–ª–∂–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –ø–æ–≤–µ—Ä—Ö —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∫–∞—Ä—Ç–æ—á–∫–∏,  
5) –Ω–∞–¥–ø–∏—Å—å –§–∏–ª—å—Ç—Ä—ã —É–±—Ä–∞—Ç—å, –æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –∑–Ω–∞—á–µ–∫,  —Å–∞–º—É –∫–Ω–æ–ø–∫—É —Ñ–∏–ª—å—Ç—Ä–æ–≤ —É–±—Ä–∞—Ç—å –≤ –ª–µ–≤—É—é —á–∞—Å—Ç—å —ç–∫—Ä–∞–Ω–∞ –Ω–∞–ª–µ–≤–æ, —Å–ø—Ä–∞–≤–∞ –ø–æ—á–∏–Ω–∏—Ç—å –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –ø—Ä–æ—Ñ–∏–ª—å, –æ–Ω –Ω–µ –≤–∏–¥–µ–Ω, —É—Ö–æ–¥–∏—Ç –∑–∞ —Å—Ç—Ä–æ–∫—É –ø–æ–∏—Å–∫–∞  
6) –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ë–∏–∑–Ω–µ—Å –∞–∫–∫–∞—É–Ω—Ç –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤ –ø—Ä–æ—Ñ–∏–ª—å 

ChatGPT —Å–∫–∞–∑–∞–ª:

–î—É–º–∞–ª –Ω–∞ –ø—Ä–æ—Ç—è–∂–µ–Ω–∏–∏ 3m 29s
–û–∫, –¥–µ–ª–∞–µ–º. –ù–∏–∂–µ –ø–æ–ª–Ω—ã–π –∫–æ–¥ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å/–¥–æ–±–∞–≤–∏—Ç—å, —á—Ç–æ–±—ã –∑–∞—Ä–∞–±–æ—Ç–∞–ª–∏ –ø—É–Ω–∫—Ç—ã 1‚Äì6:

‚úÖ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–æ—Ç–æ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ event_photos.photo_url –∫–∞–∫ data:image...)

‚úÖ –∫–Ω–æ–ø–∫–∞ ‚Äú–ø–æ–¥–µ–ª–∏—Ç—å—Å—è‚Äù –Ω–∞ –∫–∞–∂–¥–æ–π –∫–∞—Ä—Ç–æ—á–∫–µ

‚úÖ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ (–ª–∞–π–∫ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ + –≤–∫–ª–∞–¥–∫–∞ ‚Äú–ò–∑–±—Ä–∞–Ω–Ω–æ–µ‚Äù, —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ localStorage)

‚úÖ –±–µ–π–¥–∂ ‚Äú–û–Ω–ª–∞–π–Ω‚Äù –ø–æ–≤–µ—Ä—Ö —Ñ–æ—Ç–æ

‚úÖ –≤ —Ö–µ–¥–µ—Ä–µ: —É–±–∏—Ä–∞–µ–º —Ç–µ–∫—Å—Ç ‚Äú–§–∏–ª—å—Ç—Ä—ã‚Äù, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∏–∫–æ–Ω–∫—É, –ø–µ—Ä–µ–Ω–æ—Å–∏–º –∫–Ω–æ–ø–∫—É –≤–ª–µ–≤–æ, –ø—Ä–æ—Ñ–∏–ª—å –≤–ø—Ä–∞–≤–æ –∏ —á–∏–Ω–∏–º –º–æ–±–∏–ª–∫—É

‚úÖ –∏–Ω—Ñ–æ –ø—Ä–æ –±–∏–∑–Ω–µ—Å-–∞–∫–∫–∞—É–Ω—Ç –ø–µ—Ä–µ–Ω–æ—Å–∏–º –≤ –ø—Ä–æ—Ñ–∏–ª—å

1) src/composables/useSupabase.js ‚Äî –ó–ê–ú–ï–ù–ò–¢–¨ –ü–û–õ–ù–û–°–¢–¨–Æ
–î–æ–±–∞–≤–∏–ª createBusinessEvent(payload) —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ñ–æ—Ç–æ (photo_files: File[]) –∏ –∑–∞–ø–∏—Å—å—é –∫–∞–∂–¥–æ–π —Ñ–æ—Ç–∫–∏ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π –≤ event_photos.

import { createClient } from '@supabase/supabase-js'

const supabaseUrl = import.meta.env.VITE_SUPABASE_URL
const supabaseKey = import.meta.env.VITE_SUPABASE_ANON_KEY

export const supabase = createClient(supabaseUrl, supabaseKey)

const normalizeStoragePublicUrl = (url) => {
  if (!url || typeof url !== 'string') return ''
  const u = url.trim()
  if (!u) return ''
  if (u.includes('/storage/v1/object/public/')) return u
  if (u.includes('/storage/v1/object/')) return u.replace('/storage/v1/object/', '/storage/v1/object/public/')
  return u
}

const compact = (obj) => {
  const out = {}
  for (const [k, v] of Object.entries(obj || {})) {
    if (v !== undefined) out[k] = v
  }
  return out
}

// ‚úÖ File -> data:image/... base64
const readFileAsDataUrl = (file) =>
  new Promise((resolve, reject) => {
    try {
      const reader = new FileReader()
      reader.onload = () => resolve(String(reader.result || ''))
      reader.onerror = () => reject(reader.error || new Error('FileReader error'))
      reader.readAsDataURL(file)
    } catch (e) {
      reject(e)
    }
  })

export const useSupabase = () => {
  // ---------------------------
  // EVENTS
  // ---------------------------
  const getEvents = async () => {
    const { data, error } = await supabase
      .from('events')
      .select(
        `
        id,
        title,
        description,
        date_time_event,
        address,
        organizer,
        price,
        is_online,
        is_free,
        user_id,
        selectCategory,
        is_published,
        created_at
      `
      )
      .eq('is_published', true)
      .order('created_at', { ascending: false })

    return { data, error }
  }

  const searchEvents = async (searchTerm) => {
    const term = (searchTerm || '').trim()
    if (!term) return getEvents()

    const { data, error } = await supabase
      .from('events')
      .select(
        `
        id,
        title,
        description,
        date_time_event,
        address,
        organizer,
        price,
        is_online,
        is_free,
        user_id,
        selectCategory,
        is_published,
        created_at
      `
      )
      .eq('is_published', true)
      .ilike('title', `%${term}%`)
      .order('created_at', { ascending: false })

    return { data, error }
  }

  const getCategories = async () => {
    const { data, error } = await supabase.from('category').select('id, name').order('name', { ascending: true })
    return { data, error }
  }

  const getEventPhotos = async (eventIds) => {
    if (!Array.isArray(eventIds) || eventIds.length === 0) return { data: [], error: null }

    const { data, error } = await supabase
      .from('event_photos')
      .select('id, event_id, photo_url')
      .in('event_id', eventIds)
      .order('id', { ascending: true })

    return { data: data ?? [], error }
  }

  // ---------------------------
  // BUSINESS: CREATE EVENT + MULTI PHOTOS (data:image -> event_photos.photo_url)
  // ---------------------------
  const createBusinessEvent = async (payload) => {
    const { data: uData, error: uErr } = await supabase.auth.getUser()
    if (uErr) return { data: null, error: uErr }
    const user = uData?.user
    if (!user) return { data: null, error: new Error('–ù–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏') }

    const price = Number(payload?.price ?? 0)
    const is_free = payload?.is_free === true || (Number.isFinite(price) && price <= 0)

    const eventInsert = {
      title: payload?.title ?? null,
      description: payload?.description ?? null,
      date_time_event: payload?.date_time_event ?? null,
      address: payload?.address ?? null,
      organizer: payload?.organizer ?? null,
      price: Number.isFinite(price) ? price : 0,
      is_online: !!payload?.is_online,
      is_free,
      user_id: user.id,
      selectCategory: Array.isArray(payload?.selectCategory) ? payload.selectCategory : [],
      is_published: false
    }

    const { data: eventRow, error: insErr } = await supabase.from('events').insert(eventInsert).select().single()
    if (insErr) return { data: null, error: insErr }

    const files = Array.isArray(payload?.photo_files) ? payload.photo_files : []
    if (files.length) {
      // –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É (—á—Ç–æ–± –Ω–µ —É–ª–µ—Ç–µ—Ç—å –≤ –∫–æ—Å–º–æ—Å)
      const maxFiles = 8
      const slice = files.slice(0, maxFiles)

      // –≥—Ä—É–∑–∏–º –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ, —á—Ç–æ–±—ã –Ω–µ –≤—ã–∑—ã–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã
      for (const f of slice) {
        const mime = String(f?.type || '')
        if (!mime.startsWith('image/')) continue

        const dataUrl = await readFileAsDataUrl(f)
        if (!dataUrl || !dataUrl.startsWith('data:image/')) continue

        const { error: phErr } = await supabase.from('event_photos').insert({
          event_id: eventRow.id,
          photo_url: dataUrl
        })
        if (phErr) return { data: eventRow, error: phErr }
      }
    }

    return { data: eventRow, error: null }
  }

  // ---------------------------
  // AUTH
  // ---------------------------
  const getSession = async () => {
    const { data, error } = await supabase.auth.getSession()
    return { session: data?.session ?? null, error }
  }

  const getUser = async () => {
    const { data, error } = await supabase.auth.getUser()
    return { user: data?.user ?? null, error }
  }

  const signOut = async () => {
    const { error } = await supabase.auth.signOut()
    return { error }
  }

  const signInWithGoogle = async ({ redirectTo }) => {
    const { data, error } = await supabase.auth.signInWithOAuth({
      provider: 'google',
      options: { redirectTo }
    })
    return { data, error }
  }

  // ---------------------------
  // PROFILE (public.users)
  // ---------------------------
  const ensurePublicUserRow = async (authUser) => {
    if (!authUser?.id) return { data: null, error: null }

    const meta = authUser.user_metadata || {}

    const { data: existing, error: exErr } = await supabase
      .from('users')
      .select('id, email, first_name, last_name')
      .eq('id', authUser.id)
      .maybeSingle()

    if (exErr) return { data: null, error: exErr }

    const firstFromMeta = meta.given_name ?? meta.first_name
    const lastFromMeta = meta.family_name ?? meta.last_name

    const payload = compact({
      id: authUser.id,
      email: existing?.email ?? authUser.email ?? null,
      first_name: existing?.first_name ? undefined : firstFromMeta ?? undefined,
      last_name: existing?.last_name ? undefined : lastFromMeta ?? undefined
    })

    const { data, error } = await supabase.from('users').upsert(payload, { onConflict: 'id' }).select().single()
    return { data, error }
  }

  const getMyPublicUser = async () => {
    const { user } = await getUser()
    if (!user) return { data: null, error: null }

    const { data, error } = await supabase.from('users').select('*').eq('id', user.id).single()
    if (data?.image_path) data.image_path = normalizeStoragePublicUrl(data.image_path)
    return { data, error }
  }

  const updateMyPublicUser = async (patch) => {
    const { user } = await getUser()
    if (!user) return { data: null, error: new Error('No auth user') }

    const safePatch = { ...patch }
    delete safePatch.It_business

    for (const k of Object.keys(safePatch)) {
      if (safePatch[k] === '') safePatch[k] = null
    }
    if (safePatch.image_path) safePatch.image_path = normalizeStoragePublicUrl(safePatch.image_path)

    const { data, error } = await supabase.from('users').update(safePatch).eq('id', user.id).select().single()
    if (data?.image_path) data.image_path = normalizeStoragePublicUrl(data.image_path)
    return { data, error }
  }

  // ---------------------------
  // AVATAR UPLOAD (Storage)
  // ---------------------------
  const uploadAvatar = async (file) => {
    const { user } = await getUser()
    if (!user) return { publicUrl: null, error: new Error('No auth user') }
    if (!file) return { publicUrl: null, error: new Error('No file') }

    const envBucket = (import.meta.env.VITE_SUPABASE_AVATAR_BUCKET || '').trim()
    const buckets = [...new Set([envBucket, 'avatars', 'Biom', 'biom'].filter(Boolean))]

    const ext = (file.name.split('.').pop() || 'png').toLowerCase()
    const path = `ProfileImage/${user.id}/${Date.now()}.${ext}`

    let lastErr = null

    for (const bucket of buckets) {
      const { error: upErr } = await supabase.storage.from(bucket).upload(path, file, { upsert: true })
      if (upErr) {
        lastErr = upErr
        if (String(upErr?.message || '').toLowerCase().includes('bucket not found')) continue
        return { publicUrl: null, error: upErr }
      }

      const { data } = supabase.storage.from(bucket).getPublicUrl(path)
      const publicUrl = normalizeStoragePublicUrl(data?.publicUrl || '')
      return { publicUrl, error: null }
    }

    return {
      publicUrl: null,
      error:
        lastErr ||
        new Error('Bucket not found. –°–æ–∑–¥–∞–π bucket –≤ Storage (–Ω–∞–ø—Ä–∏–º–µ—Ä "avatars") –∏ —É–∫–∞–∂–∏ VITE_SUPABASE_AVATAR_BUCKET.')
    }
  }

  // ---------------------------
  // TELEGRAM
  // ---------------------------
  const linkTelegramViaEdgeFunction = async (telegramAuthData) => {
    const { data, error } = await supabase.functions.invoke('telegram-verify', { body: telegramAuthData })
    return { data, error }
  }

  const getMyTelegramLink = async () => {
    const { user } = await getUser()
    if (!user) return { data: null, error: null }

    const { data, error } = await supabase.from('user_telegram').select('*').eq('user_id', user.id).maybeSingle()
    return { data: data ?? null, error }
  }

  return {
    // events
    getEvents,
    searchEvents,
    getCategories,
    getEventPhotos,
    createBusinessEvent,

    // auth
    getSession,
    getUser,
    signInWithGoogle,
    signOut,

    // profile
    ensurePublicUserRow,
    getMyPublicUser,
    updateMyPublicUser,
    uploadAvatar,

    // telegram
    linkTelegramViaEdgeFunction,
    getMyTelegramLink
  }
}
2) src/components/EventCard.vue ‚Äî –ó–ê–ú–ï–ù–ò–¢–¨ –ü–û–õ–ù–û–°–¢–¨–Æ
–î–æ–±–∞–≤–∏–ª:

‚ù§Ô∏è –ª–∞–π–∫ (–∏–∑–±—Ä–∞–Ω–Ω–æ–µ)

üîó –ø–æ–¥–µ–ª–∏—Ç—å—Å—è

üü¢ ‚Äú–û–Ω–ª–∞–π–Ω‚Äù –ø–æ–≤–µ—Ä—Ö —Ñ–æ—Ç–æ

üì± –Ω–∞ –º–æ–±–∏–ª–∫–µ –º–∏–Ω–∏-—Ñ–æ—Ç–æ —Å–∫—Ä–æ–ª–ª—è—Ç—Å—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ

<template>
  <div class="card">
    <!-- LEFT: PHOTO -->
    <div class="photo-wrap">
      <button class="photo" @click="handleOpenPhoto" aria-label="–û—Ç–∫—Ä—ã—Ç—å —Ñ–æ—Ç–æ">
        <div v-if="!imageUrl" class="photo-skeleton" :class="{ shimmer: photosLoading }"></div>
        <img v-else :src="imageUrl" alt="event photo" />
        <div v-if="event?.is_online" class="online-pill">–û–Ω–ª–∞–π–Ω</div>
      </button>

      <button
        class="like-btn"
        :class="{ active: isFavorite }"
        @click.stop="$emit('toggle-favorite', event.id)"
        aria-label="–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ"
        title="–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ"
      >
        {{ isFavorite ? '‚ù§Ô∏è' : 'ü§ç' }}
      </button>
    </div>

    <!-- RIGHT: INFO -->
    <div class="info">
      <div class="top-row">
        <div class="title">{{ event.title }}</div>

        <div class="actions">
          <button class="action" @click="$emit('share', event)" aria-label="–ü–æ–¥–µ–ª–∏—Ç—å—Å—è" title="–ü–æ–¥–µ–ª–∏—Ç—å—Å—è">
            ‚Üó
          </button>
        </div>
      </div>

      <div class="badges">
        <span v-if="event.is_free" class="badge">üÜì –ë–µ—Å–ø–ª–∞—Ç–Ω–æ</span>

        <span v-for="(c, idx) in categoryNames" :key="idx" class="badge">
          {{ c }}
        </span>
      </div>

      <div v-if="event.description" class="desc">
        {{ event.description }}
      </div>

      <div class="meta">
        <div class="meta-item">
          <span class="k">üìÖ</span>
          <span class="v">{{ formattedDateTime }}</span>
        </div>

        <div class="meta-item">
          <span class="k">üìç</span>
          <span class="v">{{ event.address || '‚Äî' }}</span>
        </div>

        <div class="meta-item">
          <span class="k">üë§</span>
          <span class="v">{{ event.organizer || '‚Äî' }}</span>
        </div>

        <div class="meta-item">
          <span class="k">üí∞</span>
          <span class="v price">{{ formattedPrice }}</span>
        </div>
      </div>

      <!-- thumbnails -->
      <div v-if="morePhotos.length" class="thumbs" aria-label="–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏">
        <button
          v-for="p in morePhotos"
          :key="p.id"
          class="thumb"
          @click="emitOpenPhoto(p.photo_url)"
          aria-label="–û—Ç–∫—Ä—ã—Ç—å —Ñ–æ—Ç–æ"
        >
          <img :src="p.photo_url" alt="thumb" />
        </button>
      </div>
    </div>
  </div>
</template>

<script>
export default {
  name: 'EventCard',
  emits: ['open-photo', 'toggle-favorite', 'share'],
  props: {
    event: { type: Object, required: true },
    photos: { type: Array, default: () => [] },
    photosLoading: { type: Boolean, default: false },
    isFavorite: { type: Boolean, default: false }
  },
  computed: {
    imageUrl() {
      const first = Array.isArray(this.photos) ? this.photos[0] : null
      return (first?.photo_url || '').trim()
    },
    morePhotos() {
      if (!Array.isArray(this.photos)) return []
      return this.photos.slice(1).filter((p) => p?.photo_url)
    },
    categoryNames() {
      // ‚úÖ selectCategory —É —Ç–µ–±—è text[] (–ø–æ —Å–∫—Ä–∏–Ω–∞–º)
      const arr = this.event?.selectCategory
      if (Array.isArray(arr)) return arr.filter(Boolean)
      // –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π (–µ—Å–ª–∏ –≤–¥—Ä—É–≥ —Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è)
      if (typeof arr === 'string' && arr.trim()) return [arr.trim()]
      return []
    },
    formattedDateTime() {
      if (!this.event?.date_time_event) return '‚Äî'
      const d = new Date(this.event.date_time_event)
      if (Number.isNaN(d.getTime())) return String(this.event.date_time_event)
      return d.toLocaleString('ru-RU', {
        day: 'numeric',
        month: 'long',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      })
    },
    formattedPrice() {
      if (this.event?.is_free) return '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ'
      if (this.event?.price === 0 || this.event?.price === null) return '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ'
      return `${this.event.price} ‚ÇΩ`
    }
  },
  methods: {
    emitOpenPhoto(url) {
      if (!url) return
      this.$emit('open-photo', url)
    },
    handleOpenPhoto() {
      if (!this.imageUrl) return
      this.emitOpenPhoto(this.imageUrl)
    }
  }
}
</script>

<style scoped>
.card {
  display: grid;
  grid-template-columns: 220px 1fr;
  gap: 14px;
  padding: 14px;
  border-radius: 18px;
  border: 1px solid #efefef;
  background: #fff;
  box-shadow: 0 2px 10px rgba(0,0,0,0.04);
}

.photo-wrap { position: relative; width: 220px; }
.photo {
  width: 220px;
  height: 160px;
  border-radius: 16px;
  overflow: hidden;
  border: none;
  padding: 0;
  background: #f5f5f5;
  cursor: pointer;
  position: relative;
}

.photo img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

.online-pill{
  position: absolute;
  left: 10px;
  top: 10px;
  background: rgba(0,0,0,.62);
  color: #fff;
  font-weight: 900;
  font-size: 12px;
  padding: 6px 10px;
  border-radius: 999px;
  backdrop-filter: blur(4px);
}

.like-btn{
  position: absolute;
  right: 10px;
  top: 10px;
  width: 38px;
  height: 38px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.45);
  background: rgba(255,255,255,.82);
  cursor: pointer;
  display: grid;
  place-items: center;
  font-size: 16px;
}
.like-btn.active{
  background: rgba(255,255,255,.92);
  border-color: rgba(255,255,255,.75);
}

.photo-skeleton {
  width: 100%;
  height: 100%;
  background: #f0f0f0;
}

.shimmer { position: relative; overflow: hidden; }
.shimmer::after {
  content: "";
  position: absolute;
  inset: 0;
  transform: translateX(-100%);
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.7), transparent);
  animation: shimmer 1.2s infinite;
}
@keyframes shimmer { to { transform: translateX(100%); } }

.info { display: flex; flex-direction: column; gap: 10px; }

.top-row{
  display:flex;
  align-items:flex-start;
  gap: 10px;
}
.title { font-size: 18px; font-weight: 900; line-height: 1.15; flex: 1; }

.actions{ display:flex; gap: 8px; }
.action{
  width: 36px;
  height: 36px;
  border-radius: 12px;
  border: 1px solid #efefef;
  background: #fafafa;
  cursor: pointer;
  font-weight: 900;
}

.badges { display: flex; flex-wrap: wrap; gap: 8px; }

.badge {
  font-size: 12px;
  font-weight: 700;
  padding: 6px 10px;
  border-radius: 999px;
  background: rgba(138,117,227,0.12);
  border: 1px solid rgba(138,117,227,0.22);
}

.desc {
  font-size: 14px;
  opacity: 0.85;
  line-height: 1.35;
  white-space: pre-wrap;
}

.meta {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px 14px;
}

.meta-item {
  display: flex;
  gap: 8px;
  align-items: flex-start;
  font-size: 14px;
}
.k { width: 18px; opacity: 0.9; }
.v { opacity: 0.9; }
.price { font-weight: 900; }

.thumbs {
  display: flex;
  gap: 8px;
  margin-top: 4px;
  flex-wrap: wrap;
}

.thumb {
  width: 52px;
  height: 52px;
  border-radius: 12px;
  overflow: hidden;
  border: 1px solid #efefef;
  background: #fff;
  padding: 0;
  cursor: pointer;
}
.thumb img { width: 100%; height: 100%; object-fit: cover; display: block; }

@media (max-width: 760px) {
  .card { grid-template-columns: 1fr; }
  .photo-wrap { width: 100%; }
  .photo { width: 100%; height: 200px; }

  /* ‚úÖ –Ω–∞ –º–æ–±–∏–ª–µ —Ñ–æ—Ç–∫–∏ —Å–∫—Ä–æ–ª–ª—è—Ç—Å—è */
  .thumbs{
    flex-wrap: nowrap;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    padding-bottom: 4px;
  }
  .thumb{ flex: 0 0 auto; }
}
</style>
3) src/views/HomeView.vue ‚Äî –ó–ê–ú–ï–ù–ò–¢–¨ –ü–û–õ–ù–û–°–¢–¨–Æ
–î–æ–±–∞–≤–∏–ª –≤–∫–ª–∞–¥–∫–∏ ‚Äú–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è / –ò–∑–±—Ä–∞–Ω–Ω–æ–µ‚Äù, –∏–∑–±—Ä–∞–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ localStorage, –ª–∞–π–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç, share —Ä–∞–±–æ—Ç–∞–µ—Ç.

<template>
  <div class="page">
    <div class="container">
      <!-- Tabs -->
      <div class="tabs">
        <button class="tab" :class="{ active: activeTab === 'all' }" @click="activeTab = 'all'">
          –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è <span class="count">{{ filteredEvents.length }}</span>
        </button>
        <button class="tab" :class="{ active: activeTab === 'fav' }" @click="activeTab = 'fav'">
          –ò–∑–±—Ä–∞–Ω–Ω–æ–µ <span class="count">{{ favoriteEvents.length }}</span>
        </button>
      </div>

      <!-- STATES -->
      <div v-if="!initialLoaded" class="state">
        <div class="spinner"></div>
        <div>–ó–∞–≥—Ä—É–∑–∫–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π‚Ä¶</div>
      </div>

      <div v-else-if="error" class="state error">
        <div class="error-title">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</div>
        <div class="error-sub">{{ error }}</div>
        <button class="retry" @click="reload">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
      </div>

      <div v-else-if="activeList.length === 0" class="state">
        {{ activeTab === 'fav' ? '–ò–∑–±—Ä–∞–Ω–Ω–æ–µ –ø—É—Å—Ç–æ–µ' : '–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã' }}
      </div>

      <!-- EVENTS LIST -->
      <div v-else class="events-shell">
        <div class="events-list">
          <EventCard
            v-for="event in activeList"
            :key="event.id"
            :event="event"
            :photos="photos[event.id] || []"
            :photos-loading="photosLoading"
            :is-favorite="favoriteSet.has(event.id)"
            @open-photo="openPhoto"
            @toggle-favorite="toggleFavorite"
            @share="shareEvent"
          />
        </div>
      </div>
    </div>

    <EventPhotoModal v-if="photoModalUrl" :url="photoModalUrl" @close="photoModalUrl = ''" />
  </div>
</template>

<script>
import { ref, computed, onMounted, watch } from 'vue'
import EventCard from '../components/Event
–¢—Ä–∞–Ω—Å–ª—è—Ü–∏—è –ø—Ä–µ—Ä–≤–∞–Ω–∞. –û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è...